<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Justin Andrew Johnson</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Justin Andrew Johnson</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications/index.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-teaching" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Teaching</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-teaching">    
        <li>
    <a class="dropdown-item" href="../../teaching/index.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../teaching/natural_resource_economics.html">
 <span class="dropdown-text">Natural Resource Economics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../teaching/principles_of_microeconomics.html">
 <span class="dropdown-text">Principles of Microeconomics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../teaching/big_data_ml_and_ai_for_economists.html">
 <span class="dropdown-text">Big Data, Machine Learning and AI for Economists</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../teaching/undergraduate_environmental_economics.html">
 <span class="dropdown-text">Undergraduate Environmental Economics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../books/index.html"> 
<span class="menu-text">Books</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-gtap-invest" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">GTAP-InVEST</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-gtap-invest">    
        <li>
    <a class="dropdown-item" href="../../gtap_invest/index.html">
 <span class="dropdown-text">GTAP-InVEST Home</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../gtap_invest/user_guide/index.html">
 <span class="dropdown-text">User Guide</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../gtap_invest/results/index.html">
 <span class="dropdown-text">Results</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-software" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Software</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-software">    
        <li>
    <a class="dropdown-item" href="../../earth_economy_devstack/index.html">
 <span class="dropdown-text">Earth-Economy Devstack</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../mesh/index.html">
 <span class="dropdown-text">MESH</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../earth_economy_devstack/seals.html">
 <span class="dropdown-text">SEALS</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../data/index.html"> 
<span class="menu-text">Data</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/jandrewjohnson"> 
<span class="menu-text">GitHub</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../gtap_invest/user_guide/model_summary.html">2. GTAP-InVEST Model Summary</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../gtap_invest/user_guide/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GTAP-InVEST User Guide</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../gtap_invest/user_guide/model_summary.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">2. GTAP-InVEST Model Summary</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../gtap_invest/user_guide/scenarios.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Scenarios and Policy specification</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../gtap_invest/user_guide/gtap_details.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. GTAP model details</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../gtap_invest/user_guide/invest_details.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5. InVEST model details</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../gtap_invest/user_guide/es_impact.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6. Connecting InVEST outputs to GTAP inputs</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="incremental">
  <li><a href="#gtap-invest-model-summary" id="toc-gtap-invest-model-summary" class="nav-link active" data-scroll-target="#gtap-invest-model-summary">2. GTAP-InVEST Model Summary</a>
  <ul class="incremental collapse">
  <li><a href="#overall-model-structure" id="toc-overall-model-structure" class="nav-link" data-scroll-target="#overall-model-structure">2.1. Overall model structure</a></li>
  <li><a href="#input-assumptions" id="toc-input-assumptions" class="nav-link" data-scroll-target="#input-assumptions">2.2. Input Assumptions</a></li>
  <li><a href="#gtap-aez-economic-methods" id="toc-gtap-aez-economic-methods" class="nav-link" data-scroll-target="#gtap-aez-economic-methods">2.3. GTAP-AEZ economic methods</a></li>
  <li><a href="#seals-downscaling-methods" id="toc-seals-downscaling-methods" class="nav-link" data-scroll-target="#seals-downscaling-methods">2.4. SEALS downscaling methods</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="gtap-invest-model-summary" class="level1">
<h1>2. GTAP-InVEST Model Summary</h1>
<p>In this section, we describe how we link together the models that underlie GTAP-InVEST and discuss the new elements added to each model to make this possible. This section assumes the reader is familiar with the underlying GTAP and InVEST models. If this is not the case, see Sections 4 and 5, which document these two models in more depth.</p>
<section id="overall-model-structure" class="level3">
<h3 class="anchored" data-anchor-id="overall-model-structure">2.1. Overall model structure</h3>
<p>GTAP-InVEST is based on several existing models, though a number of new advances were necessary to make the model linkage. These necessary advances fall into two categories: 1. modifications of the underlying models so that they compute what is needed by the other models; and 2., creation of “linkage” code that expresses the outputs of one model as inputs to another model. Figure S.2.1 summarizes the overall structure of the model.</p>
<p><img src="images/paste-1.png" class="img-fluid"></p>
<p><strong>Figure S.2.1: Overall model linkages within GTAP-InVEST</strong></p>
<p>The first step in the model is to project how the economy will evolve between the base year and the terminal year while ignoring impacts from ecosystem services. We refer to this as GTAP Run 1 or the “economic projections run.” It is summarized in Column 1 of Figure S.2.1 (see SI Section 3 for details on the exact input assumptions). The economic projections run calculates a business-as-usual scenario to 2030 that does not yet account for ecosystem services (we label these results as BAU-noES throughout). Because many of the policies rely on detailed consideration of how changing market forces will endogenously drive land-use change and conversion of natural land into economically-utilized land, the GTAP model has expanded representation of heterogeneous land and can endogenously calculate land-use change at the GTAP-AEZ scale. See Section 2.2.3 for a description of how we created this new version of GTAP-AEZ. The results of GTAP Run 1 provide projections of regional land-use change for cropland, pastureland, managed forests and natural land. The next step in GTAP-InVEST is to downscale these regional results (Column 2) using the Spatial Economic Allocation Landscape Simulator (SEALS) from 341 regions to 8.4 billion grid-cells (10 arc-second resolution, or roughly 300 meters at the equator). This is necessary because the models of biodiversity and ecosystem services we used, specifically the Integrated Valuation of Ecosystem Services and Tradeoffs (InVEST) model, require very high-resolution data to capture local dynamics (Column 3). Finally, the outputs of InVEST are fed back into a second run of the economic model (Column 4), referred to as the GTAP Run 2, or the “ecosystem services impact run.” Run 2 assesses how changes in ecosystem services will have feedback effects on the 2030 economy. &nbsp;In our results, outputs from this second run are labeled with “allES” (or “aES” for short-name variables) to denote that the impacts on the economy from changed ecosystem services are now included. The difference between GTAP Run 1 and Run 2 identifies how much ecosystem services matter (see Figure 1 in the manuscript). The outputs of GTAP Run 2 provide detailed macroeconomic results described in figures 1-3 of the manuscript and in section 7 of this supplemental information.</p>
</section>
<section id="input-assumptions" class="level3">
<h3 class="anchored" data-anchor-id="input-assumptions">2.2. Input Assumptions</h3>
<p>The primary source of inputs for assumptions on exogenous drivers come from the Shared Socioeconomic Pathway (SSP) framework from Riahi et al.&nbsp;(2017) and the associated Representative Concentration Pathways (RCPs), such as for population and global surface temperature change (Figure S.2.2). We take population change, technology change (represented as total-factor productivity projections) and other exogenous factors from the literature, following the approach documented in a special issue of the Journal of Global Economic Analysis (Dellink et al., 2020).</p>
<p>Specifically, these economic drivers include future growth rates for key economic factors, namely Real GDP, Capital Stock, Population, Unskilled Labor and Skilled Labor from Econmap (v2.4) (Fouré et al., 2013) based on the SSP2 scenario. Sector specific productivity growth for Crops, Ruminants and Non-Ruminants are based on per annum growth rates from Ludena et al (2007) over 2001-2040. Because Ludena et al (2007) does not estimate the growth of the managed forestry sector, we infer growth in this sector based on global agricultural productivity growth as defined in Ludena et al (2007). We impose a 2% productivity growth rate for the Manufactures sector to reflect the productivity gap between the Manufactures and Service sectors (Chateau et al., 2020).</p>
<p><img src="images/paste-2.png" class="img-fluid"></p>
<p><strong>Figure S.2.2: Input Assumptions from the Shared Socioecononomic Pathways. Source: IIASA (2015). SSP Database 2012-2015. Preliminary scenarios.</strong> Note:Available from <a href="https://tntcat.iiasa.ac.at/SspDb" class="uri">https://tntcat.iiasa.ac.at/SspDb</a></p>
</section>
<section id="gtap-aez-economic-methods" class="level3">
<h3 class="anchored" data-anchor-id="gtap-aez-economic-methods">2.3. GTAP-AEZ economic methods</h3>
<p>The variant of the GTAP model that we use as the starting point for our model extensions is GTAP-AEZ, which builds on the standard model and database by introducing competition for land resources across crops, pasture, and forestry, as well as heterogeneous land use and land endowments within each region and within each Agro-Ecological Zone (AEZ) suitable for a sector’s use. The AEZs are defined in terms of 60 day-long length-of-growing periods, of which there are six, each differentiated by climatic zone (tropical, temperate and boreal). We derive AEZ-level crop production information from Monfreda et al.&nbsp;(2008), while managed forest sector production is based on Sohngen et al.&nbsp;(2009). We draw on multiple sources for land cover information. We use cropland and pasture cover data from Ramankutty et al (2008), urban land cover data from Schneider et al (2009, 2010) and potential vegetation information from Ramankutty (1999). The GTAP-AEZ database is updated to the latest version of the standard GTAP database using national level data from FAOSTAT following the methods described in Baldos (2017). One purpose for defining AEZs is that it lets us specific region-specific endowments of land, which are used by producers as an input to production.</p>
<p>Figure S.2.3.1 shows the modified production structure in the GTAP AEZ. Note that these changes are limited to managed forestry, ruminant livestock and crops sectors - sectors that use land endowments. Following the standard GTAP model, we estimate sectoral output using a constant elasticities of scale (CES) production structure which minimizes cost of production by combining intermediate and value-added inputs. The former are raw commodity inputs used in the production process while the latter includes factors such as land, labor, capital and natural resources. Our model combines skilled and unskilled labor, land, capital and natural resources under the value-added input CES sub-nest, with land endowments in across AEZs pooled under the land input CES sub-nest. Supply of land across each crop sectors and across land cover types are illustrated in Figure S.2.3.2.</p>
<p><img src="images/paste-3.png" class="img-fluid"></p>
<p><strong>Figure S.2.3.1. Production structure in GTAP-AEZ</strong></p>
<p><img src="images/paste-4.png" class="img-fluid"></p>
<p><strong>Figure S.2.3.2. Land supply in GTAP-AEZ</strong></p>
<p>In the model, the regional household owns land endowments and maximizes total returns to land by allocating their endowment across different uses. Starting at the bottom of the constant elasticity of transformation (CET) function land supply nest (Figure S.2.3.2), the regional household allocates the land endowment within its AEZ to managed forestland, cropland and pastureland based on maximizing returns to land. Managed forestland represents land endowments for the forestry sector, while the ruminant livestock sector uses pastureland. Within the crops sector, the household can allocate available cropland for use in the production of each 8 GTAP crop aggregates, depending on changes in land rents for each use. The model computes returns to land endowments based on the cost shares in the database.</p>
<p>2.3.1. Modifications of GTAP-AEZ</p>
<p>In the original GTAP-AEZ model, we assume the supply of land in each AEZ is fixed, though different sectors are able to compete over how land will be used. This means that additional land demanded by one sector needs to come from other sectors. Although this method represented a great advance in the literature on making computable general equilibrium (CGE) models accurately represent land conversion, it is limited in its ability to assess new land being brought into economic use, converted from natural land cover. Our primary modification of GTAP-AEZ in this paper was to add land supply curves, uniquely identified and parameterized for each AEZ-Region, in order to endogenize land supply in the GTAP-AEZ model. Following the approach of Eickhout et al (2009), which the MAGNET model also uses (Woltjer and Kuiper, 2014), land supply in each AEZ is defined as a function of real land rental rates as well as an asymptote which captures maximum available land for use:</p>
<p><img src="images/paste-6.png" class="img-fluid"></p>
<p>The alpha&nbsp;and beta&nbsp;parameters are taken directly from Woltjer and Kuiper (2014) and the maximum land available is calculated as described below. Using this specification, land supply increases when there are positive increases in land rents. Likewise, if land rents fall, then the supply of land also declines, and we assume that any land not being used is allocated back to natural cover. With this specification, it is possible to set aside land for natural use by reducing the maximum area of available land, as long as these reductions are relatively small (see Dixon et al.&nbsp;2012).</p>
<p>The determination of maximum arable land is very important in this structure. Many existing approaches exist in the literature for defining arable land (e.g., from the Food and Agriculture Organization, but also from the authors of the MAGNET model (Woltjer et al.&nbsp;2014)). In this paper, we updated the land-supply curves using more recent and higher resolution data on available land. We calculated this using 300 meter resolution data with global availability. In this approach, we also improved the consistency in land-use availability between the competing uses of cropland, pastureland and managed forest land.</p>
<p>Specifically, GTAP-InVEST calculates the land-supply curve for each region using the following approach. We combined data on soil suitability and soil-based growth constraints (Fisher et al., 2008), existing crop caloric yield on nearby areas (Johnson et al.&nbsp;2016), topographic roughness (authors’ calculations, based on data from Hijmans et al.&nbsp;2008), and existing LULC (based on the European Space Agency’s Climate Change Initiative data, henceforth the ESACCI). For the soils data, which are based on the Harmonized World Soils Database, the method excluded any land that had constraints worse than class 4 (where 1 is unconstrained and 7 is completely constrained).&nbsp; After eliminating land based on soil constraints, the methodology then further excluded the following areas: land that had less than 20 billion kilocalories produced within the 5 km of the target cell, land that had a topographic roughness index greater than 20, and land with an overall crop suitability lower than 30 percent. Finally, the methodology excluded urban, water, barren, ice and rocky land-use types. See the GTAP-InVEST GitHub repository for more details. This process resulted in AEZ-Region specific values as presented in the supplemental file land_supply_parameters.csv.</p>
<p>To download the full defintitions of the 18 AEZs, 37 aggregated GTAP regions and the corresponding ISO3 codes as a vector file (.gpkg), see here <a href="https://storage.googleapis.com/gtap_invest_seals_2023_04_21/gtap_invest/v0-9-0/region_boundaries/GTAP37_AEZ18_ISO3.gpkg">GTAP37_AEZ18_ISO3</a></p>
</section>
<section id="seals-downscaling-methods" class="level3">
<h3 class="anchored" data-anchor-id="seals-downscaling-methods">2.4. SEALS downscaling methods</h3>
<p>In order to analyze ecosystem services, we need to know where within the country the specific changes happen with sufficiently high-resolution data. To enable this, we downscale the regional projections of change produced by the GTAP Run 1 model to a fine (10 arc-second, ~300m) resolution using the Spatial Econometric Allocation Landscape Simulator (SEALS, published in Suh et al.&nbsp;2020 and extended in Johnson et al.&nbsp;2020, 2021).</p>
<p>To generate useful results, we also ensured that our downscaled results were consistent with medium-resolution land-use change products currently being used by the global sustainability community. Specifically, we used results reported by the Land-Use Harmonization 2 (LUH2), which provides yearly measures of land-use change for 13 classes under each of 5 different Shared Socioeconomic Pathway (SSP) scenarios used by IPBES, reported at a medium (30km) resolution. We combined the LUH2 data with the AEZ-Region results from GTAP Run 1 by scaling the medium resolution LUH2 data up/down in each AEZ-Region so that (1) the total exactly matched that projected by GTAP Run 1 and (2) within the AEZ-Region, the spatial distribution at the medium resolution matched that of the LUH2 data. See Johnson et al.&nbsp;(2023) for more details along with the code documenting this calculation in the GTAP-InVEST repository.</p>
<p>These results that combine the GTAP-AEZ projections with the LUH2 data, however, are still not at a fine enough resolution to be used in the InVEST ecosystem service tools. Thus, we used SEALS to downscale from the combined 30km LULC data described above to the necessary 300m resolution. Figure S.2.4.1 illustrates how SEALS downscales the medium resolution data to the finer scale. Specifically, the top panel of the figure shows the spatial distribution of five LUC transitions in the LUH2 data, focusing on grassland conversion, and then zooms in to show which 300m grid-cells change in the downscaled data. The bottom panel shows the projections for agricultural land-use change but illustrates both the contraction (brown) and expansion (green) that happens on the landscape. Note that while initially SEALS modeled the expansion of single land-use types, such as maize expansion (Suh et al.&nbsp;2020), we expanded from the algorithm defined in Suh et al.&nbsp;so that the SEALS model can consider all land-use changes simultaneously.</p>
<p><img src="images/paste-8.png" class="img-fluid"></p>
<p><img src="images/paste-9.png" class="img-fluid"></p>
<p><strong>Figure 2.4.1: Downscaling using the SEALS model</strong></p>
<section id="allocation-algorithm" class="level4">
<h4 class="anchored" data-anchor-id="allocation-algorithm">2.4.1.&nbsp; Allocation Algorithm</h4>
<p>We report a simplified explanation of the SEALS algorithm for convenience, drawn from previous publications. See the specific publications for more details (e.g., Suh et al.&nbsp;2020, Johnson et al.&nbsp;2020, 2021). SEALS uses a simplified LULC classification scheme that is a hierarchically-defined subset of the ESACCI classes (ESA, 2017).The simplification was used because many relationships were not statistically different among similar class specifications (e.g., between deciduous broadleaf and deciduous needle-leaf forests).</p>
<table class="table">
<colgroup>
<col style="width: 22%">
<col style="width: 13%">
<col style="width: 62%">
</colgroup>
<tbody>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>SEALS LULC Types</td>
<td>id</td>
<td>Combined ESA LULC Types</td>
</tr>
<tr class="odd">
<td>Urban</td>
<td>1</td>
<td>190</td>
</tr>
<tr class="even">
<td>Cropland</td>
<td>2</td>
<td>10, 11, 12, 20, 30</td>
</tr>
<tr class="odd">
<td>Pasture/Grassland</td>
<td>3</td>
<td>130</td>
</tr>
<tr class="even">
<td>Forest</td>
<td>4</td>
<td>40, 50, 60, 61, 62, 70, 71, 72, 80, 81, 82, 90, 100</td>
</tr>
<tr class="odd">
<td>Non-forest vegetation</td>
<td>5</td>
<td>110, 120, 121, 122, 140</td>
</tr>
<tr class="even">
<td>Water</td>
<td>6</td>
<td>210</td>
</tr>
<tr class="odd">
<td>Barren or Other</td>
<td>7</td>
<td>150, 151, 152, 153, 160, 170, 180, 190, 200, 201, 202, 210, 220</td>
</tr>
<tr class="even">
<td>No-data</td>
<td>255</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>Table S.2.4.1: ESA LULC simplification scheme</strong></p>
<p>SEALS allocates land-use change by identifying the net change of each LULC class required in each coarse region, then identifying a net change vector , where each entry represents the net change for the <em>i</em>-th land-use type in the coarse cell. The allocation algorithm then takes an <em>n</em> by <em>i</em> matrix of coefficients for how each <em>n</em>-th spatial input affects the probability of <em>i</em>-th expansion in each grid-cell. We provide an example of the table and specification of the functional forms in Table A-4.2. The coefficients actually used are obtained by iteratively solving the allocation algorithm to search for the parameters that minimize the difference between observed change and projected change.</p>
<p><strong>SEALS Allocation Algorithm</strong></p>
<p><img src="images/paste-10.png" class="img-fluid"></p>
<p><img src="images/paste-11.png" class="img-fluid"></p>
</section>
<section id="coefficients-used" class="level4">
<h4 class="anchored" data-anchor-id="coefficients-used">2.4.2 Coefficients used</h4>
<p>Table S.2.4.2. defines the specific coefficients used. These were established using the calibration algorithm described in the next section, averaging calibrated coefficients from 10 different sampled regions.</p>
<table class="table">
<colgroup>
<col style="width: 22%">
<col style="width: 17%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<tbody>
<tr class="odd">
<td>spatial_regressor_name</td>
<td>type</td>
<td>class_1</td>
<td>class_2</td>
<td>class_3</td>
<td>class_4</td>
<td>class_5</td>
</tr>
<tr class="even">
<td>class_1_constraint</td>
<td>multiplicative</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>class_2_constraint</td>
<td>multiplicative</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td>class_3_constraint</td>
<td>multiplicative</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>class_4_constraint</td>
<td>multiplicative</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td>class_5_constraint</td>
<td>multiplicative</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td>class_6_constraint</td>
<td>multiplicative</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>class_7_constraint</td>
<td>multiplicative</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>class_1_binary</td>
<td>additive</td>
<td>0</td>
<td>-0.032222222</td>
<td>0.013888889</td>
<td>-0.013888889</td>
<td>-0.016666667</td>
</tr>
<tr class="even">
<td>class_2_binary</td>
<td>additive</td>
<td>-0.027777778</td>
<td>0</td>
<td>0.016666667</td>
<td>0.011111111</td>
<td>0.004333333</td>
</tr>
<tr class="odd">
<td>class_3_binary</td>
<td>additive</td>
<td>0.005555556</td>
<td>0.018888889</td>
<td>0</td>
<td>0.041666667</td>
<td>-0.026111111</td>
</tr>
<tr class="even">
<td>class_4_binary</td>
<td>additive</td>
<td>-0.019444444</td>
<td>-0.016666667</td>
<td>-0.002666667</td>
<td>0</td>
<td>0.033444444</td>
</tr>
<tr class="odd">
<td>class_5_binary</td>
<td>additive</td>
<td>0.01</td>
<td>0.144444444</td>
<td>0.060111111</td>
<td>0.02</td>
<td>0</td>
</tr>
<tr class="even">
<td>class_6_binary</td>
<td>additive</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>class_7_binary</td>
<td>additive</td>
<td>-1.119444444</td>
<td>0.001666667</td>
<td>0.126666667</td>
<td>0.061111111</td>
<td>-0.023333333</td>
</tr>
<tr class="even">
<td>class_1_gaussian_1</td>
<td>gaussian_parametric_1</td>
<td>1.713888889</td>
<td>-1122.233444</td>
<td>-11.13055556</td>
<td>0.041666667</td>
<td>-1122.241667</td>
</tr>
<tr class="odd">
<td>class_2_gaussian_1</td>
<td>gaussian_parametric_1</td>
<td>0.105555556</td>
<td>0.333444444</td>
<td>0.022222222</td>
<td>0</td>
<td>-11.24444444</td>
</tr>
<tr class="even">
<td>class_3_gaussian_1</td>
<td>gaussian_parametric_1</td>
<td>0.054444444</td>
<td>0.005444444</td>
<td>0.38</td>
<td>0.018222222</td>
<td>0.085555556</td>
</tr>
<tr class="odd">
<td>class_4_gaussian_1</td>
<td>gaussian_parametric_1</td>
<td>-0.122222222</td>
<td>1111.065556</td>
<td>-0.011</td>
<td>0.276666667</td>
<td>-0.022233333</td>
</tr>
<tr class="even">
<td>class_5_gaussian_1</td>
<td>gaussian_parametric_1</td>
<td>0.010888889</td>
<td>0</td>
<td>0.019444444</td>
<td>-0.122222222</td>
<td>0.466666667</td>
</tr>
<tr class="odd">
<td>class_6_gaussian_1</td>
<td>gaussian_parametric_1</td>
<td>0.036555556</td>
<td>-112.2027778</td>
<td>-112.24</td>
<td>-1.105555556</td>
<td>-1133.322333</td>
</tr>
<tr class="even">
<td>class_7_gaussian_1</td>
<td>gaussian_parametric_1</td>
<td>-0.127777778</td>
<td>-112.2555556</td>
<td>-1112.144444</td>
<td>-1111.133333</td>
<td>0.005555556</td>
</tr>
<tr class="odd">
<td>class_1_gaussian_5</td>
<td>gaussian_parametric_1</td>
<td>-0.072222222</td>
<td>-11.52222222</td>
<td>-111.2638889</td>
<td>-0.093333333</td>
<td>-0.087777778</td>
</tr>
<tr class="even">
<td>class_2_gaussian_5</td>
<td>gaussian_parametric_1</td>
<td>0.068888889</td>
<td>0.162333333</td>
<td>-0.016666667</td>
<td>0.122222222</td>
<td>0.065555556</td>
</tr>
<tr class="odd">
<td>class_3_gaussian_5</td>
<td>gaussian_parametric_1</td>
<td>0.100222222</td>
<td>-0.025</td>
<td>0.431111111</td>
<td>-0.026677778</td>
<td>-0.041666667</td>
</tr>
<tr class="even">
<td>class_4_gaussian_5</td>
<td>gaussian_parametric_1</td>
<td>0.133222222</td>
<td>0.367777778</td>
<td>0.076333333</td>
<td>0.281777778</td>
<td>0.113333333</td>
</tr>
<tr class="odd">
<td>class_5_gaussian_5</td>
<td>gaussian_parametric_1</td>
<td>0</td>
<td>-0.073111111</td>
<td>0.024444444</td>
<td>-0.005555556</td>
<td>0.152777778</td>
</tr>
<tr class="even">
<td>class_6_gaussian_5</td>
<td>gaussian_parametric_1</td>
<td>0.091666667</td>
<td>0.005</td>
<td>-1111.105444</td>
<td>-1.092777778</td>
<td>-0.002222222</td>
</tr>
<tr class="odd">
<td>class_7_gaussian_5</td>
<td>gaussian_parametric_1</td>
<td>0.045555556</td>
<td>0.15</td>
<td>-1111.077778</td>
<td>-0.008333333</td>
<td>-110.89</td>
</tr>
<tr class="even">
<td>class_1_gaussian_30</td>
<td>gaussian_parametric_1</td>
<td>-0.066666667</td>
<td>-0.073333333</td>
<td>0.077777778</td>
<td>-0.026111111</td>
<td>0</td>
</tr>
<tr class="odd">
<td>class_2_gaussian_30</td>
<td>gaussian_parametric_1</td>
<td>0.011111111</td>
<td>0.034888889</td>
<td>-0.081666667</td>
<td>-0.016666667</td>
<td>-0.037777778</td>
</tr>
<tr class="even">
<td>class_3_gaussian_30</td>
<td>gaussian_parametric_1</td>
<td>-0.017222222</td>
<td>-0.006</td>
<td>0.308333333</td>
<td>0.009444444</td>
<td>0.024333333</td>
</tr>
<tr class="odd">
<td>class_4_gaussian_30</td>
<td>gaussian_parametric_1</td>
<td>-0.016111111</td>
<td>0.155555556</td>
<td>0.108888889</td>
<td>0.056777778</td>
<td>0.153444444</td>
</tr>
<tr class="even">
<td>class_5_gaussian_30</td>
<td>gaussian_parametric_1</td>
<td>0.005555556</td>
<td>-0.021111111</td>
<td>0.137222222</td>
<td>0.143444444</td>
<td>0.105555556</td>
</tr>
<tr class="odd">
<td>class_6_gaussian_30</td>
<td>gaussian_parametric_1</td>
<td>-0.021111111</td>
<td>0.036555556</td>
<td>0.152444444</td>
<td>0</td>
<td>0.055555556</td>
</tr>
<tr class="even">
<td>class_7_gaussian_30</td>
<td>gaussian_parametric_1</td>
<td>0.025</td>
<td>1109.978889</td>
<td>0.204444444</td>
<td>-1.080555556</td>
<td>-0.034555556</td>
</tr>
<tr class="odd">
<td>soil_organic_content_1m_30s</td>
<td>additive</td>
<td>0.027777778</td>
<td>-0.15</td>
<td>110.9777778</td>
<td>-111.14</td>
<td>-0.027777778</td>
</tr>
<tr class="even">
<td>bio_12</td>
<td>additive</td>
<td>11.11944444</td>
<td>-0.994444444</td>
<td>1.14</td>
<td>-1.075</td>
<td>11.00444444</td>
</tr>
<tr class="odd">
<td>alt</td>
<td>additive</td>
<td>-0.104444444</td>
<td>0.085</td>
<td>-0.024888889</td>
<td>-0.037788889</td>
<td>0.01</td>
</tr>
<tr class="even">
<td>bio_1</td>
<td>additive</td>
<td>-0.022111111</td>
<td>0.044444444</td>
<td>-0.011111111</td>
<td>-0.01</td>
<td>-0.001111111</td>
</tr>
<tr class="odd">
<td>minutes_to_market_30s</td>
<td>additive</td>
<td>0.016122222</td>
<td>0.21</td>
<td>0.005555556</td>
<td>1111.077778</td>
<td>-0.034333333</td>
</tr>
<tr class="even">
<td>pop_30s</td>
<td>additive</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>bulk_density_1m_30s</td>
<td>additive</td>
<td>1.15</td>
<td>1.122222222</td>
<td>-0.016666667</td>
<td>22.18444444</td>
<td>-11.1</td>
</tr>
<tr class="even">
<td>CEC_1m_30s</td>
<td>additive</td>
<td>0</td>
<td>-0.016666667</td>
<td>0</td>
<td>111.0722222</td>
<td>0</td>
</tr>
<tr class="odd">
<td>clay_percent_1m_30s</td>
<td>additive</td>
<td>-0.051111111</td>
<td>0.02</td>
<td>-0.186111111</td>
<td>-0.046222222</td>
<td>1.084333333</td>
</tr>
<tr class="even">
<td>ph_1m_30s</td>
<td>additive</td>
<td>0</td>
<td>0.1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>sand_percent_1m_30s</td>
<td>additive</td>
<td>0.034444444</td>
<td>0.018333333</td>
<td>-0.037777778</td>
<td>-0.048888889</td>
<td>-0.001111111</td>
</tr>
<tr class="even">
<td>silt_percent_1m_30s</td>
<td>additive</td>
<td>-0.012777778</td>
<td>-0.165</td>
<td>0</td>
<td>-0.059011111</td>
<td>-0.146111111</td>
</tr>
</tbody>
</table>
<p><strong>Table S.2.4.2. Coefficients used in the SEALS algorithm</strong></p>
</section>
<section id="calibration" class="level4">
<h4 class="anchored" data-anchor-id="calibration">2.4.3. Calibration</h4>
<p>A key component in SEALS is that it downscales according to observed relationships present in time-series input data. SEALS uses a spatial allocation approach that has been calibrated on the ESACCI 1992-2015 time series using an iterative Gaussian L1-loss function minimization approach. The approach is documented in Figure S.2.4.3.1. as per the following algorithm:</p>
<ol class="incremental" type="1">
<li><p>Define a baseline condition (Panel A, using the year 2000 for this example).</p></li>
<li><p>Define a projection year in the set of observed years after the baseline year (2010), shown in Panel B, and calculate the net-change between the two years for each coarse resolution (30km) grid-cell. This defines the amount of change in each LULC class that our allocation algorithm will predict.</p></li>
<li><p>Allocate the net change of each LULC class using only the baseline map and a spatial allocation algorithm, S(p1), where p1 is the parameter set used in the allocation and is initially set to an arbitrary value.</p></li>
<li><p>Calculate how accurate the projected LULC map for 2010 (Panel C) compares to the observed 2010 LULC map. Specifically, calculate the difference score, which is the summation of 5 L1-difference functions, one for each LULC transition, that calculates how different (in terms of Gaussian-blurred distance) each class is in the projected map compared to the observed map. This generates a score for the quality of fit for the current set of parameters (Panel D).</p></li>
<li><p>Iteratively for each parameter in p1_i, increase the parameter by X percent (initially 10), rerun step 4 with the new parameter, observe the new similarity score, then decrease it by 10 percent and rerun.</p></li>
<li><p>After calculating the change in fit from each parameter increase and decrease in Step 5, identify which change had the greatest improvement in the similarity score. Update the parameter set to include the single best change, and then repeat Steps 3-6 until no additional improvements can be made.</p></li>
</ol>
<p>Figure 2.4.3.2. shows more detail on the calibration process, highlighting where specific transitions are projected versus where they actually happen, along with the difference score implied.</p>
<p><img src="images/paste-12.png" class="img-fluid"></p>
<p><strong>Figure 2.4.3.1. SEALS calibration process</strong></p>
<p><img src="images/paste-14.png" class="img-fluid"></p>
<p><strong>Figure 2.4.3.2. Assessment of prediction quality-of-fit for 1 LULC class</strong></p>
</section>
<section id="current-limitations-within-seals" class="level4">
<h4 class="anchored" data-anchor-id="current-limitations-within-seals">2.4.4. Current Limitations within SEALS</h4>
<p>Due to the computationally heavy nature of calibration, the calibration was only done on a subset of the input data. Subsequent work can improve this by running on more (or potentially all) regions and applying unique values for each region downscaled, instead of averaging the coefficients.</p>
<p>Additionally, in our downscaling approach, we chose to match exactly the results from the LUH2 project. This had some downsides, such as locating massive agricultural expansion in the northern Sahara. In locations where the change projected by LUH2 is well outside any observed changes, the calibration is not effective, and visible artifacting is present. In these locations, no allocation method based on the sparse observed data is likely to produce realistic outputs unless the underlying input LUH2 data is modified. We chose not to modify the input LUH2 data in these locations in order to stay consistent with existing approaches, though other applications of this data may benefit from versions that modify the input data. Future research directions should include dynamic updating between the coarse and fine resolutions to resolve the underlying problem.</p>
<p>It is also important to note that the modelling outputs (including LULC change maps, InVEST outputs, and GTAP outputs) are not meant to be accurate predictions of future change. Instead, they are illustrations of possible future outcomes given the assumptions used. Furthermore, the modelling approaches used in this project are a first step in exploring how the integration of ecosystem service models (InVEST) and economic models (GTAP) can be connected to help explore the implications of large-scale implementation of global conservation goals, and these methods will be further refined over time.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>