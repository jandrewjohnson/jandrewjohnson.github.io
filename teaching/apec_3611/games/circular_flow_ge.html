<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Circular Flow ‚Äî Full General Equilibrium</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;color:#2d3748;min-height:100vh;padding:12px 12px 0}
h1{text-align:center;font-size:1.5rem;font-weight:700;margin-bottom:2px;color:#1a202c}
.sub{text-align:center;color:#718096;font-size:.85rem;margin-bottom:8px;max-width:900px;margin-left:auto;margin-right:auto;line-height:1.4}
.wrap{max-width:1520px;margin:0 auto}
.canvas-panel{background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:8px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:10px;position:relative}
.canvas-panel canvas{width:100%;display:block;border-radius:6px}
.pa{position:absolute;top:12px;right:12px;z-index:10;display:flex;gap:4px;opacity:0;transition:opacity .2s}
.canvas-panel:hover .pa{opacity:1}
.pb{background:rgba(255,255,255,.85);backdrop-filter:blur(4px);border:1px solid rgba(226,232,240,.7);border-radius:6px;padding:4px 8px;font-size:.7rem;color:#a0aec0;cursor:pointer;display:flex;align-items:center;gap:4px;font-family:'Segoe UI',system-ui,sans-serif;transition:all .15s;line-height:1}
.pb:hover{color:#4a5568;border-color:#4299e1}.pb.cp{color:#38a169;border-color:#c6f6d5}
.pb svg{width:12px;height:12px;flex-shrink:0}
.bottom-strip{display:grid;grid-template-columns:auto 1fr;gap:10px;margin-bottom:12px;align-items:start}
@media(max-width:900px){.bottom-strip{grid-template-columns:1fr}}
.game-panel{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:12px;min-width:280px;max-width:320px}
.game-panel h3{font-size:.88rem;margin-bottom:8px;color:#1a202c;display:flex;align-items:center;gap:6px}
.mode-toggle{display:flex;border-radius:6px;overflow:hidden;border:1px solid #e2e8f0;margin-bottom:10px}
.mode-btn{flex:1;padding:6px 10px;font-size:.78rem;font-weight:600;cursor:pointer;border:none;background:#f7fafc;color:#718096;transition:all .15s;font-family:inherit}
.mode-btn.active{background:#4299e1;color:#fff}
.challenge-card{background:linear-gradient(135deg,#ebf8ff,#f0fff4);border:1.5px solid #bee3f8;border-radius:8px;padding:10px;margin-bottom:10px;display:none}
.challenge-card.show{display:block}
.cc-title{font-size:.82rem;font-weight:700;color:#2b6cb0;margin-bottom:4px}
.cc-desc{font-size:.76rem;color:#4a5568;line-height:1.4;margin-bottom:6px}
.cc-target{font-size:.68rem;color:#718096;background:#fff;border-radius:4px;padding:4px 6px;border:1px solid #e2e8f0;line-height:1.5}
.guess-section{display:none;margin-bottom:8px}.guess-section.show{display:block}
.guess-label{font-size:.76rem;font-weight:600;margin-bottom:2px;display:flex;justify-content:space-between}
.guess-val{font-weight:700;color:#e53e3e;font-size:.82rem}
input[type=range].gs{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:linear-gradient(to right,#bee3f8,#e53e3e,#bee3f8);border-radius:3px;outline:none;margin-bottom:4px}
input[type=range].gs::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#e53e3e;cursor:pointer;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.25)}
.score-display{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.score-chip{font-size:.72rem;background:#fff;border:1px solid #e2e8f0;border-radius:4px;padding:2px 6px}
.score-chip b{color:#d69e2e}
.chal-btns{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.chal-btn{padding:5px 10px;font-size:.74rem;font-weight:600;border:1.5px solid #4299e1;border-radius:6px;background:#ebf8ff;color:#2b6cb0;cursor:pointer;transition:all .15s;font-family:inherit}
.chal-btn:hover{background:#4299e1;color:#fff}
.chal-btn.next{border-color:#38a169;background:#f0fff4;color:#276749}.chal-btn.next:hover{background:#38a169;color:#fff}
.chal-btn.finish{border-color:#805ad5;background:#faf5ff;color:#553c9a}.chal-btn.finish:hover{background:#805ad5;color:#fff}
.overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:100;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
.overlay.show{display:flex}
.overlay-card{background:#fff;border-radius:16px;padding:28px 36px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:popIn .4s ease;max-width:460px;width:90%}
@keyframes popIn{0%{transform:scale(.7);opacity:0}100%{transform:scale(1);opacity:1}}
.overlay-card h2{font-size:1.5rem;margin-bottom:4px}
.overlay-card .stars{font-size:2rem;margin:8px 0}
.overlay-card p{font-size:.88rem;color:#4a5568;margin-bottom:12px}
.v-stats{display:flex;gap:12px;justify-content:center;margin-bottom:14px;flex-wrap:wrap}
.v-stat{text-align:center}.v-stat .n{font-size:1.3rem;font-weight:700;color:#2b6cb0}.v-stat .l{font-size:.68rem;color:#718096}
.v-btn{padding:8px 20px;border-radius:8px;border:none;background:#4299e1;color:#fff;font-size:.88rem;font-weight:600;cursor:pointer;font-family:inherit;margin:4px}
.v-btn:hover{background:#3182ce}.v-btn.green{background:#38a169}.v-btn.green:hover{background:#2f855a}
.v-btn.purple{background:#805ad5}.v-btn.purple:hover{background:#6b46c1}
.val-code{background:#f7fafc;border:2px dashed #4299e1;border-radius:8px;padding:8px 12px;margin:10px 0;font-family:'Courier New',monospace;font-size:.92rem;font-weight:700;color:#2b6cb0;letter-spacing:1px;user-select:all;cursor:text}
.sum-table{width:100%;border-collapse:collapse;font-size:.76rem;margin:10px 0}
.sum-table th{background:#f7fafc;padding:4px 8px;text-align:left;border-bottom:1px solid #e2e8f0;color:#718096;font-weight:600}
.sum-table td{padding:4px 8px;border-bottom:1px solid #edf2f7}.sum-table .star-col{text-align:center}
.controls{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
@media(max-width:900px){.controls{grid-template-columns:1fr 1fr}}
.ctrl-sec{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:10px}
.ctrl-sec.locked{opacity:.5;pointer-events:none;position:relative}
.ctrl-sec.locked::after{content:'üîí Set by Challenge';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.8rem;color:#e53e3e;font-weight:600;background:rgba(255,255,255,.9);padding:4px 10px;border-radius:6px;white-space:nowrap}
.ctrl-title{font-size:.7rem;text-transform:uppercase;letter-spacing:1px;color:#718096;font-weight:600;margin-bottom:6px}
.sg{margin-bottom:6px}.sg-label{display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:1px}
.sg-val{color:#2b6cb0;font-weight:600;font-size:.76rem}
input[type=range]{width:100%;height:4px;-webkit-appearance:none;appearance:none;background:#e2e8f0;border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:#4299e1;cursor:pointer}
.eq-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.eq-chip{background:#f0fff4;border:1px solid #c6f6d5;border-radius:5px;padding:2px 7px;font-size:.74rem}
.eq-chip b{font-weight:600;color:#276749}
</style>
</head>
<body>
<div class="wrap">
<h1>Circular Flow ‚Äî Full General Equilibrium</h1>
<p class="sub">Two factors (labor &amp; capital), Cobb-Douglas production f=A¬∑L<sup>Œ≤</sup>K<sup>Œ≥</sup>, endogenous income M = wL + rKÃÑ + œÄ + P·µßœâY. Three markets clear simultaneously.</p>
<div class="canvas-panel">
  <div class="pa">
    <button class="pb" id="btnCopy"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span id="cpLbl">Copy</span></button>
    <button class="pb" id="btnSave"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Save</span></button>
  </div>
  <canvas id="C"></canvas>
</div>
<div class="bottom-strip">
  <div class="game-panel">
    <h3>üéØ Mode</h3>
    <div class="mode-toggle">
      <button class="mode-btn active" id="mExplore" onclick="setMode('explore')">üìä Explore</button>
      <button class="mode-btn" id="mChallenge" onclick="setMode('challenge')">üéÆ Challenge</button>
    </div>
    <div class="challenge-card" id="chalCard"><div class="cc-title" id="chalTitle"></div><div class="cc-desc" id="chalDesc"></div><div class="cc-target" id="chalTarget"></div></div>
    <div class="guess-section" id="guessSection">
      <div class="guess-label"><span>Price guess (P)</span><span class="guess-val" id="gPval">$3</span></div>
      <input type="range" class="gs" id="gP" min=".3" max="15" value="3" step=".05">
      <div class="guess-label"><span>Wage guess (w)</span><span class="guess-val" id="gWval">$5</span></div>
      <input type="range" class="gs" id="gW" min=".3" max="20" value="5" step=".1">
      <div class="guess-label"><span>Rental rate guess (r)</span><span class="guess-val" id="gRval">$3</span></div>
      <input type="range" class="gs" id="gR" min=".1" max="15" value="3" step=".1">
      <div class="score-display">
        <span class="score-chip">‚è± <b id="scTime">0s</b></span>
        <span class="score-chip">üìã <b id="scChal">0/8</b></span>
        <span class="score-chip">üèÜ <b id="scStars">0</b>‚≠ê</span>
      </div>
    </div>
    <div class="chal-btns" id="chalBtns" style="display:none">
      <button class="chal-btn next" onclick="nextChallenge()">‚ñ∂ Next</button>
      <button class="chal-btn finish" onclick="showResults()" id="btnFinish" style="display:none">üìä Results</button>
    </div>
  </div>
  <div class="controls" id="paramControls">
    <div class="ctrl-sec" id="secHH">
      <div class="ctrl-title">üè† Household</div>
      <div class="sg"><div class="sg-label"><span>Pref Œ± (X share)</span><span class="sg-val" id="vAlpha">0.50</span></div><input type="range" id="sAlpha" min=".2" max=".8" value=".5" step=".05"></div>
      <div class="sg"><div class="sg-label"><span>Price of Y (P·µß)</span><span class="sg-val" id="vPy">2.00</span></div><input type="range" id="sPy" min="1" max="5" value="2" step=".25"></div>
      <div class="sg"><div class="sg-label"><span>Y endowment (œâY)</span><span class="sg-val" id="vWY">5.0</span></div><input type="range" id="sWY" min="1" max="15" value="5" step=".5"></div>
      <div class="sg"><div class="sg-label"><span># Consumers</span><span class="sg-val" id="vNC">100</span></div><input type="range" id="sNC" min="20" max="200" value="100" step="10"></div>
    </div>
    <div class="ctrl-sec" id="secFI">
      <div class="ctrl-title">üè≠ Firm (f = AL<sup>Œ≤</sup>K<sup>Œ≥</sup>)</div>
      <div class="sg"><div class="sg-label"><span>TFP (A)</span><span class="sg-val" id="vA">5.0</span></div><input type="range" id="sA" min="1" max="15" value="5" step=".5"></div>
      <div class="sg"><div class="sg-label"><span>Labor share Œ≤</span><span class="sg-val" id="vBeta">0.40</span></div><input type="range" id="sBeta" min=".15" max=".55" value=".4" step=".05"></div>
      <div class="sg"><div class="sg-label"><span>Capital share Œ≥</span><span class="sg-val" id="vGamma">0.30</span></div><input type="range" id="sGamma" min=".1" max=".5" value=".3" step=".05"></div>
      <div class="sg"><div class="sg-label"><span># Firms</span><span class="sg-val" id="vNF">50</span></div><input type="range" id="sNF" min="10" max="150" value="50" step="5"></div>
    </div>
    <div class="ctrl-sec" id="secFM">
      <div class="ctrl-title">‚öôÔ∏è Factor Endowments</div>
      <div class="sg"><div class="sg-label"><span>Capital per HH (KÃÑ)</span><span class="sg-val" id="vKbar">1.0</span></div><input type="range" id="sKbar" min=".2" max="3" value="1" step=".1"></div>
      <div class="sg"><div class="sg-label"><span>Labor supply Œµ</span><span class="sg-val" id="vLSE">1.0</span></div><input type="range" id="sLSE" min=".3" max="3" value="1" step=".1"></div>
      <div class="eq-row"><div class="eq-chip"><b>P*</b> <span id="eqP">‚Äî</span></div><div class="eq-chip"><b>w*</b> <span id="eqW">‚Äî</span></div><div class="eq-chip"><b>r*</b> <span id="eqR">‚Äî</span></div></div>
      <div class="eq-row"><div class="eq-chip"><b>Q*</b> <span id="eqQ">‚Äî</span></div><div class="eq-chip"><b>L*</b> <span id="eqL">‚Äî</span></div><div class="eq-chip"><b>K*</b> <span id="eqK">‚Äî</span></div></div>
    </div>
    <div class="ctrl-sec" id="secEq">
      <div class="ctrl-title">üìä Equilibrium Flows</div>
      <div class="eq-row"><div class="eq-chip"><b>M*</b> <span id="eqM">‚Äî</span></div><div class="eq-chip"><b>Œ≤+Œ≥</b> <span id="eqBG">‚Äî</span></div></div>
      <div class="eq-row"><div class="eq-chip"><b>wL</b> <span id="eqWB">‚Äî</span></div><div class="eq-chip"><b>rK</b> <span id="eqRK">‚Äî</span></div><div class="eq-chip"><b>œÄ</b> <span id="eqProf">‚Äî</span></div></div>
      <div class="eq-row"><div class="eq-chip"><b>Utility</b> <span id="eqU">‚Äî</span></div></div>
    </div>
  </div>
</div></div>
<!-- Victory -->
<div class="overlay" id="victoryOverlay"><div class="overlay-card">
  <h2 style="color:#38a169">üéâ Equilibrium Found!</h2>
  <div class="stars" id="victoryStars"></div><p id="victoryMsg"></p>
  <div class="v-stats">
    <div class="v-stat"><div class="n" id="vTime">‚Äî</div><div class="l">seconds</div></div>
    <div class="v-stat"><div class="n" id="vAccP">‚Äî</div><div class="l">P* acc</div></div>
    <div class="v-stat"><div class="n" id="vAccW">‚Äî</div><div class="l">w* acc</div></div>
    <div class="v-stat"><div class="n" id="vAccR">‚Äî</div><div class="l">r* acc</div></div>
    <div class="v-stat"><div class="n" id="vScore">‚Äî</div><div class="l">score</div></div>
  </div>
  <button class="v-btn green" onclick="closeVictory()">Next ‚Üí</button>
</div></div>
<!-- Results -->
<div class="overlay" id="resultsOverlay"><div class="overlay-card">
  <h2 style="color:#2b6cb0">üìä Results</h2>
  <div class="stars" id="totalStarsDisp"></div><p id="totalScoreMsg"></p>
  <table class="sum-table"><thead><tr><th>#</th><th>Challenge</th><th>Time</th><th>Score</th><th class="star-col">Stars</th></tr></thead><tbody id="resultsBody"></tbody></table>
  <div class="val-code" id="valCode"></div>
  <p style="font-size:.7rem;color:#a0aec0;margin-bottom:8px">Copy validation code to submit results.</p>
  <button class="v-btn" onclick="document.getElementById('resultsOverlay').classList.remove('show')">Close</button>
  <button class="v-btn purple" onclick="restartAll()">üîÑ Restart</button>
</div></div>
<script>
// ====== CANVAS ======
const C=document.getElementById('C'),X=C.getContext('2d');
let CW,CH;
function resizeCanvas(){const pw=C.parentElement.clientWidth-16;CW=pw;CH=Math.min(pw*.68,innerHeight-240);const d=Math.max(2,devicePixelRatio||2);C.width=CW*d;C.height=CH*d;C.style.width=CW+'px';C.style.height=CH+'px';X.setTransform(d,0,0,d,0,0);}
resizeCanvas();addEventListener('resize',()=>{resizeCanvas();updateAll()});
document.getElementById('btnCopy').addEventListener('click',()=>{C.toBlob(b=>{navigator.clipboard.write([new ClipboardItem({'image/png':b})]).then(()=>{const l=document.getElementById('cpLbl');l.textContent='Copied!';document.getElementById('btnCopy').classList.add('cp');setTimeout(()=>{l.textContent='Copy';document.getElementById('btnCopy').classList.remove('cp')},1500)})})});
document.getElementById('btnSave').addEventListener('click',()=>{const a=document.createElement('a');a.download='circular_flow_ge.png';a.href=C.toDataURL('image/png');a.click()});

const S={};
['Alpha','Py','WY','NC','A','Beta','Gamma','NF','Kbar','LSE'].forEach(k=>S[k]=document.getElementById('s'+k));
const gPsl=document.getElementById('gP'),gWsl=document.getElementById('gW'),gRsl=document.getElementById('gR');

// ====== GAME STATE ======
let mode='explore',trueEq={P:0,w:0,r:0};
let chalStart=0,totalSolved=0,chalIdx=0,solved=false,victoryParticles=[],totalStars=0;
const results=[];

// ====== CHALLENGES ======
const challenges=[
  {name:'Baseline',desc:'Standard economy. Find P*, w*, and r*.',Alpha:.5,Py:2,WY:5,NC:100,A:5,Beta:.4,Gamma:.3,NF:50,Kbar:1,LSE:1,iP:1,iW:3,iR:1},
  {name:'High TFP',desc:'Technology doubles (A=10). Output soars ‚Äî how do prices adjust?',Alpha:.5,Py:2,WY:5,NC:100,A:10,Beta:.4,Gamma:.3,NF:50,Kbar:1,LSE:1,iP:5,iW:3,iR:6},
  {name:'Capital Scarcity',desc:'Capital halved (KÃÑ=0.5). Rental rate should jump.',Alpha:.5,Py:2,WY:5,NC:100,A:5,Beta:.4,Gamma:.3,NF:50,Kbar:.5,LSE:1,iP:1,iW:3,iR:1},
  {name:'Strong X Demand',desc:'Preference Œ±=0.7 ‚Äî more spending on X.',Alpha:.7,Py:2,WY:5,NC:100,A:5,Beta:.4,Gamma:.3,NF:50,Kbar:1,LSE:1,iP:2,iW:3,iR:2},
  {name:'Elastic Labor',desc:'Workers very responsive (Œµ=2.5).',Alpha:.5,Py:2,WY:5,NC:100,A:5,Beta:.4,Gamma:.3,NF:50,Kbar:1,LSE:2.5,iP:1,iW:10,iR:1},
  {name:'Many Firms',desc:'80 firms ‚Äî how does competition affect prices?',Alpha:.5,Py:2,WY:5,NC:100,A:5,Beta:.4,Gamma:.3,NF:80,Kbar:1,LSE:1,iP:5,iW:3,iR:5},
  {name:'Capital-Intensive',desc:'Production uses more K (Œ≥=0.45) than L (Œ≤=0.25).',Alpha:.5,Py:2,WY:5,NC:100,A:5,Beta:.25,Gamma:.45,NF:50,Kbar:1,LSE:1,iP:1,iW:8,iR:1},
  {name:'Poor Endowment',desc:'Low Y endowment (œâY=2). Less demand for X.',Alpha:.5,Py:2,WY:2,NC:100,A:5,Beta:.4,Gamma:.3,NF:50,Kbar:1,LSE:1,iP:4,iW:8,iR:5},
];

function setMode(m){
  mode=m;
  document.getElementById('mExplore').classList.toggle('active',m==='explore');
  document.getElementById('mChallenge').classList.toggle('active',m==='challenge');
  const show=m==='challenge';
  document.getElementById('chalCard').classList.toggle('show',show);
  document.getElementById('guessSection').classList.toggle('show',show);
  document.getElementById('chalBtns').style.display=show?'flex':'none';
  ['secHH','secFI','secFM'].forEach(id=>document.getElementById(id).classList.toggle('locked',show));
  if(show){solved=false;totalStars=0;totalSolved=0;results.length=0;startChallenge(0);}
  else{solved=false;updateAll();}
}
function startChallenge(idx){
  if(idx>=challenges.length){showResults();return;}
  chalIdx=idx;const ch=challenges[chalIdx];
  S.Alpha.value=ch.Alpha;S.Py.value=ch.Py;S.WY.value=ch.WY;S.NC.value=ch.NC;
  S.A.value=ch.A;S.Beta.value=ch.Beta;S.Gamma.value=ch.Gamma;S.NF.value=ch.NF;S.Kbar.value=ch.Kbar;S.LSE.value=ch.LSE;
  trueEq=solveGE();
  const pM=Math.max(12,trueEq.P*2.5),wM=Math.max(15,trueEq.w*2.5),rM=Math.max(10,trueEq.r*2.5);
  gPsl.max=pM.toFixed(1);gWsl.max=wM.toFixed(1);gRsl.max=rM.toFixed(1);
  gPsl.value=ch.iP;gWsl.value=ch.iW;gRsl.value=ch.iR;
  document.getElementById('chalTitle').textContent=`Challenge ${chalIdx+1}/${challenges.length}: ${ch.name}`;
  document.getElementById('chalDesc').textContent=ch.desc;
  document.getElementById('chalTarget').textContent=`Œ±=${ch.Alpha} P·µß=$${ch.Py} œâY=${ch.WY} nC=${ch.NC} A=${ch.A} Œ≤=${ch.Beta} Œ≥=${ch.Gamma} nF=${ch.NF} KÃÑ=${ch.Kbar} Œµ=${ch.LSE}`;
  document.getElementById('scChal').textContent=`${totalSolved}/${challenges.length}`;
  document.getElementById('scStars').textContent=totalStars;
  document.getElementById('btnFinish').style.display=totalSolved>0?'inline-block':'none';
  chalStart=Date.now();solved=false;updateAll();
}
function nextChallenge(){startChallenge(chalIdx+1);}

// ====== ECONOMICS ======
function firmOpt(p,w,r,A,beta,gamma){
  const bg=beta+gamma,ratio=(gamma*w)/(beta*r);
  const rhs=w/(p*A*beta*Math.pow(ratio,gamma));
  if(rhs<=0||!isFinite(rhs))return{L:0,K:0,q:0,profit:0};
  const L=Math.pow(rhs,1/(bg-1));
  if(!isFinite(L)||L<=0||L>1e8)return{L:0,K:0,q:0,profit:0};
  const K=L*ratio,q=A*Math.pow(L,beta)*Math.pow(K,gamma);
  return{L,K,q,profit:p*q-w*L-r*K};
}

function solveGE(){
  const alpha=+S.Alpha.value,Py=+S.Py.value,wY=+S.WY.value,nC=+S.NC.value;
  const A=+S.A.value,beta=+S.Beta.value,gamma=+S.Gamma.value,nF=+S.NF.value;
  const Kbar=+S.Kbar.value,lse=+S.LSE.value;
  function inner(p){
    let w=3,r=2;
    for(let i=0;i<400;i++){
      const f=firmOpt(p,w,r,A,beta,gamma);
      if(f.L===0){w*=.95;r*=.95;continue;}
      const Ld=nF*f.L,Kd=nF*f.K;
      const Ls=nC*Math.pow(w/10,lse),Ks=nC*Kbar;
      w*=(1+.05*(Ld-Ls)/Math.max(.1,(Ld+Ls)/2));
      r*=(1+.05*(Kd-Ks)/Math.max(.1,(Kd+Ks)/2));
      w=Math.max(.01,w);r=Math.max(.01,r);
      if(Math.abs(Ld-Ls)/Math.max(1,(Ld+Ls)/2)<.0005&&Math.abs(Kd-Ks)/Math.max(1,(Kd+Ks)/2)<.0005){
        const M=w*Math.pow(w/10,lse)+r*Kbar+nF*f.profit/nC+Py*wY;
        return{w,r,M,Qd:nC*alpha*M/p,Qs:nF*f.q,f,Ld,Kd,Ls,Ks,ok:true};
      }
    }
    return{ok:false};
  }
  let lo=.05,hi=50;
  for(let i=0;i<80;i++){
    const mid=(lo+hi)/2,res=inner(mid);
    if(!res.ok){lo=mid;continue;}
    if(Math.abs(res.Qd-res.Qs)<.5)return{P:mid,w:res.w,r:res.r,M:res.M,Q:res.Qs,L:res.Ld,K:res.Kd,profit:res.f.profit,Lf:res.f.L,Kf:res.f.K,qf:res.f.q};
    if(res.Qd>res.Qs)lo=mid;else hi=mid;
  }
  const mid=(lo+hi)/2,res=inner(mid);
  return{P:mid,w:res.ok?res.w:1,r:res.ok?res.r:1,M:res.ok?res.M:10,Q:res.ok?res.Qs:100,L:res.ok?res.Ld:50,K:res.ok?res.Kd:50,profit:0,Lf:1,Kf:1,qf:2};
}

function evalGuess(gP,gW,gR){
  const P=getParams();
  const f=firmOpt(gP,gW,gR,P.A,P.beta,P.gamma);
  const Ld=P.nF*f.L,Kd=P.nF*f.K,Qs=P.nF*f.q;
  const Ls=P.nC*Math.pow(gW/10,P.lse),Ks=P.nC*P.Kbar;
  const M=gW*Math.pow(gW/10,P.lse)+gR*P.Kbar+P.nF*f.profit/P.nC+P.Py*P.wY;
  const Qd=P.nC*P.alpha*M/gP;
  return{Qd,Qs,Ld,Ls,Kd,Ks,M,exG:Qd-Qs,exL:Ld-Ls,exK:Kd-Ks,f,gP,gW,gR};
}
function getParams(){return{alpha:+S.Alpha.value,Py:+S.Py.value,wY:+S.WY.value,nC:+S.NC.value,A:+S.A.value,beta:+S.Beta.value,gamma:+S.Gamma.value,nF:+S.NF.value,Kbar:+S.Kbar.value,lse:+S.LSE.value};}
function consUtil(x,y,a){return x>0&&y>0?Math.pow(x,a)*Math.pow(y,1-a):0}
function indiffY(x,U,a){return x>0?Math.pow(U/Math.pow(x,a),1/(1-a)):null}

// ====== SCORING ======
function compScore(t,pA,wA,rA){return Math.round(((pA+wA+rA)/3)*7+Math.max(0,100-t)*3)}
function compStars(t){return t<30?3:t<60?2:1}

// ====== MINI-GRAPH HELPERS ======
function miniAxes(ox,oy,gw,gh,maxX,maxY,xLbl,yLbl,bc){
  const mg={t:14,r:6,b:24,l:28},pw=gw-mg.l-mg.r,ph=gh-mg.t-mg.b;
  const toX=x=>ox+mg.l+(x/maxX)*pw,toY=y=>oy+mg.t+ph-(y/maxY)*ph;
  X.fillStyle='rgba(255,255,255,.92)';X.strokeStyle=bc||'#cbd5e0';X.lineWidth=1.5;
  X.beginPath();X.roundRect(ox,oy,gw,gh,6);X.fill();X.stroke();
  X.strokeStyle='#edf2f7';X.lineWidth=.5;
  for(let i=1;i<4;i++){const x2=ox+mg.l+(i/4)*pw;X.beginPath();X.moveTo(x2,oy+mg.t);X.lineTo(x2,oy+mg.t+ph);X.stroke();const y2=oy+mg.t+(i/4)*ph;X.beginPath();X.moveTo(ox+mg.l,y2);X.lineTo(ox+mg.l+pw,y2);X.stroke();}
  X.strokeStyle='#a0aec0';X.lineWidth=1;X.beginPath();X.moveTo(ox+mg.l,oy+mg.t);X.lineTo(ox+mg.l,oy+mg.t+ph);X.lineTo(ox+mg.l+pw,oy+mg.t+ph);X.stroke();
  X.fillStyle='#718096';X.font='7px Segoe UI';X.textAlign='center';X.fillText(xLbl,ox+mg.l+pw/2,oy+gh-2);
  X.save();X.translate(ox+5,oy+mg.t+ph/2);X.rotate(-Math.PI/2);X.fillText(yLbl,0,0);X.restore();
  X.font='6.5px Segoe UI';for(let i=0;i<=4;i+=2){X.textAlign='center';X.fillText(maxX>100?(i*maxX/4).toFixed(0):(i*maxX/4).toFixed(1),toX(i*maxX/4),oy+mg.t+ph+10);X.textAlign='right';X.fillText(maxY>20?(i*maxY/4).toFixed(0):(i*maxY/4).toFixed(1),ox+mg.l-3,toY(i*maxY/4)+2.5);}
  return{toX,toY};
}
function mPlot(toX,toY,maxX,maxY,fn,color,lw,dash){X.strokeStyle=color;X.lineWidth=lw||1.5;X.setLineDash(dash||[]);X.beginPath();let s=false;for(let x=.3;x<=maxX;x+=maxX/150){const y=fn(x);if(y>=0&&y<=maxY*1.1){if(!s){X.moveTo(toX(x),toY(y));s=true;}else X.lineTo(toX(x),toY(y));}}X.stroke();X.setLineDash([]);}
function mDot(toX,toY,x,y,c,r2){X.fillStyle=c;X.beginPath();X.arc(toX(x),toY(y),r2,0,Math.PI*2);X.fill();X.strokeStyle='#fff';X.lineWidth=1;X.stroke();}
function mDash(toX,toY,x1,y1,x2,y2){X.strokeStyle='#a0aec0';X.lineWidth=.7;X.setLineDash([3,2]);X.beginPath();X.moveTo(toX(x1),toY(y1));X.lineTo(toX(x2),toY(y2));X.stroke();X.setLineDash([]);}
function mHLine(toX,toY,maxX,y,c){X.strokeStyle=c;X.lineWidth=1;X.beginPath();X.moveTo(toX(0),toY(y));X.lineTo(toX(maxX),toY(y));X.stroke();}
function drawExA(toX,toY,maxX,qd,qs,py,lab){
  const ex=qd-qs;if(Math.abs(ex)<5)return;
  const dir=ex>0?1:-1,mag=Math.min(Math.abs(ex)/200,1);
  const mid=(qd+qs)/2,ax=toX(Math.min(Math.max(mid,maxX*.1),maxX*.9)),ay=toY(py),sz=8+mag*12;
  X.save();X.globalAlpha=.7+mag*.3;X.fillStyle=ex>0?'#e53e3e':'#3182ce';
  X.beginPath();X.moveTo(ax+dir*sz,ay);X.lineTo(ax,ay-sz*.35);X.lineTo(ax,ay+sz*.35);X.closePath();X.fill();
  X.font=`bold ${7+mag*2}px Segoe UI`;X.textAlign='center';
  X.fillText(ex>0?'Excess '+lab+'·µà':'Excess '+lab+'À¢',ax,ay-sz*.5-4);
  X.globalAlpha=1;X.restore();
}

// ====== MINI GRAPHS ======
function drawHHGraph(ox,oy,gw,gh,eq){
  const P=getParams(),Px=eq.P,M=eq.M;
  const maxX=Math.max(20,M/Px*1.3),maxY=Math.max(20,M/P.Py*1.3);
  const{toX,toY}=miniAxes(ox,oy,gw,gh,maxX,maxY,'Good X','Good Y','#4299e1');
  const xInt=M/Px,yInt=M/P.Py;
  X.fillStyle='rgba(49,130,206,.06)';X.beginPath();X.moveTo(toX(0),toY(0));X.lineTo(toX(0),toY(Math.min(yInt,maxY)));X.lineTo(toX(Math.min(xInt,maxX)),toY(0));X.closePath();X.fill();
  X.strokeStyle='#e53e3e';X.lineWidth=1.5;X.beginPath();X.moveTo(toX(0),toY(Math.min(yInt,maxY)));X.lineTo(toX(Math.min(xInt,maxX)),toY(0));X.stroke();
  const xS=P.alpha*M/Px,yS=(1-P.alpha)*M/P.Py,U=consUtil(xS,yS,P.alpha);
  if(U>0)mPlot(toX,toY,maxX,maxY,x=>indiffY(x,U,P.alpha)||0,'#3182ce',1.5);
  if(xS<=maxX&&yS<=maxY){mDash(toX,toY,xS,yS,xS,0);mDash(toX,toY,xS,yS,0,yS);mDot(toX,toY,xS,yS,'#d69e2e',4);}
  X.fillStyle='#e53e3e';X.font='bold 7px Segoe UI';X.textAlign='left';X.fillText('Budget',toX(1),toY(Math.min(yInt*.8,maxY*.8))-3);
  X.fillStyle='#3182ce';X.fillText('IC',toX(Math.min(xS*1.3,maxX*.7)),toY(Math.min(indiffY(xS*1.3,U,P.alpha)||yS,maxY*.8))-6);
}

function drawFirmGraph(ox,oy,gw,gh,eq){
  const P=getParams(),maxL=Math.max(5,eq.Lf*3),maxQ=Math.max(5,eq.qf*1.8);
  const{toX,toY}=miniAxes(ox,oy,gw,gh,maxL,maxQ,'Labor (Lf)','Output (qf)','#d69e2e');
  mPlot(toX,toY,maxL,maxQ,L=>P.A*Math.pow(L,P.beta)*Math.pow(eq.Kf,P.gamma),'#d69e2e',1.8);
  if(eq.Lf<=maxL&&eq.qf<=maxQ){mDash(toX,toY,eq.Lf,eq.qf,eq.Lf,0);mDash(toX,toY,eq.Lf,eq.qf,0,eq.qf);mDot(toX,toY,eq.Lf,eq.qf,'#d69e2e',4);}
  X.fillStyle='#d69e2e';X.font='bold 7px Segoe UI';X.textAlign='left';
  const lx=maxL*.6,ly=Math.min(P.A*Math.pow(lx,P.beta)*Math.pow(eq.Kf,P.gamma),maxQ*.85);
  X.fillText('f(L,KÃÑf)',toX(lx),toY(ly)-8);
}

function drawGMGraph(ox,oy,gw,gh,eq,ex){
  const P=getParams(),maxQ=Math.max(200,eq.Q*2),maxP=Math.max(5,eq.P*2.5);
  const{toX,toY}=miniAxes(ox,oy,gw,gh,maxQ,maxP,'Mkt Qty (Q)','Price ($)','#38a169');
  // Demand: Qd(p) = nC*alpha*M(p)/p ‚Äî approximate by shifting around eq
  // Supply: Qs(p) via firm opt ‚Äî approximate as increasing
  // For visualization, plot Qd and Qs as functions of p by solving at various p levels
  // Simplified: Qs(P) ‚âà nF * A * L(P)^beta * K^gamma where L,K are from firm opt
  // Actually let's just show the eq dot and excess arrows in challenge mode
  const eqDot=eq.P<=maxP&&eq.Q<=maxQ;
  if(eqDot&&mode==='explore'){mDash(toX,toY,eq.Q,eq.P,eq.Q,0);mDash(toX,toY,eq.Q,eq.P,0,eq.P);mDot(toX,toY,eq.Q,eq.P,'#319795',4);}
  // Plot approximate curves by evaluating at a range of prices
  X.strokeStyle='#3182ce';X.lineWidth=1.5;X.beginPath();let started=false;
  for(let pp=maxP*.95;pp>=maxP*.05;pp-=maxP/80){
    // Approximate Qd: at true factor prices, Qd = nC*alpha*M/p where M ‚âà eq.M (income changes slowly)
    const qd=P.nC*P.alpha*eq.M/pp;if(qd>0&&qd<=maxQ){if(!started){X.moveTo(toX(qd),toY(pp));started=true;}else X.lineTo(toX(qd),toY(pp));}
  }X.stroke();
  X.strokeStyle='#e53e3e';X.lineWidth=1.5;X.beginPath();started=false;
  for(let pp=maxP*.05;pp<=maxP*.95;pp+=maxP/80){
    const f=firmOpt(pp,eq.w,eq.r,P.A,P.beta,P.gamma);const qs=P.nF*f.q;
    if(qs>0&&qs<=maxQ){if(!started){X.moveTo(toX(qs),toY(pp));started=true;}else X.lineTo(toX(qs),toY(pp));}
  }X.stroke();
  if(mode==='challenge'&&ex&&!solved){
    mHLine(toX,toY,maxQ,ex.gP,'rgba(229,62,62,.4)');
    drawExA(toX,toY,maxQ,ex.Qd,ex.Qs,ex.gP,'Q');
  }
  const dLQ=maxQ*.15,dLP=Math.min(P.nC*P.alpha*eq.M/dLQ,maxP*.85);
  X.fillStyle='#3182ce';X.font='bold 7px Segoe UI';X.textAlign='left';X.fillText('D(p)',toX(dLQ),toY(dLP)-6);
  const sQ=maxQ*.6,sP_f=firmOpt(maxP*.4,eq.w,eq.r,P.A,P.beta,P.gamma);
  if(sP_f.q>0){X.fillStyle='#e53e3e';X.fillText('S(p)',toX(Math.min(P.nF*sP_f.q,maxQ*.7)),toY(maxP*.4)-6);}
}

function drawLaborGraph(ox,oy,gw,gh,eq,ex){
  const P=getParams(),maxL=Math.max(50,eq.L*2.5),maxW=Math.max(5,eq.w*2.5);
  const{toX,toY}=miniAxes(ox,oy,gw,gh,maxL,maxW,'Labor (L)','Wage ($)','#805ad5');
  mPlot(toX,toY,maxL,maxW,L=>L>0?eq.P*P.A*P.beta*Math.pow(L/P.nF,P.beta-1)*Math.pow(eq.Kf,P.gamma):maxW,'#805ad5',1.8);
  mPlot(toX,toY,maxL,maxW,L=>10*Math.pow(L/P.nC,1/P.lse),'#d69e2e',1.8);
  if(mode==='challenge'&&ex&&!solved){mHLine(toX,toY,maxL,ex.gW,'rgba(229,62,62,.4)');drawExA(toX,toY,maxL,ex.Ld,ex.Ls,ex.gW,'L');}
  if(eq.w<=maxW&&eq.L<=maxL){mDash(toX,toY,eq.L,eq.w,eq.L,0);mDash(toX,toY,eq.L,eq.w,0,eq.w);mDot(toX,toY,eq.L,eq.w,'#553c9a',4);}
  const ldL=maxL*.1,ldW=Math.min(eq.P*P.A*P.beta*Math.pow(ldL/P.nF,P.beta-1)*Math.pow(eq.Kf,P.gamma),maxW*.85);
  X.fillStyle='#805ad5';X.font='bold 7px Segoe UI';X.textAlign='left';X.fillText('L·µà(w)',toX(ldL),toY(ldW)-8);
  const lsL=maxL*.55,lsW=Math.min(10*Math.pow(lsL/P.nC,1/P.lse),maxW*.85);
  X.fillStyle='#d69e2e';X.fillText('LÀ¢(w)',toX(lsL),toY(lsW)-8);
  X.fillStyle='#553c9a';X.font='italic 6px Segoe UI';X.fillText('w = P¬∑MP‚Çó',toX(maxL*.35),toY(maxW*.05));
}

function drawCapitalGraph(ox,oy,gw,gh,eq,ex){
  const P=getParams(),Ks=P.nC*P.Kbar;
  const maxK=Math.max(80,Ks*2),maxR=Math.max(3,eq.r*2.5);
  const{toX,toY}=miniAxes(ox,oy,gw,gh,maxK,maxR,'Capital (K)','Rent ($)','#c05621');
  mPlot(toX,toY,maxK,maxR,K=>K>0?eq.P*P.A*P.gamma*Math.pow(eq.Lf,P.beta)*Math.pow(K/P.nF,P.gamma-1):maxR,'#c05621',1.8);
  X.strokeStyle='#2b6cb0';X.lineWidth=1.5;X.setLineDash([4,3]);
  X.beginPath();X.moveTo(toX(Ks),toY(0));X.lineTo(toX(Ks),toY(maxR*.95));X.stroke();X.setLineDash([]);
  if(mode==='challenge'&&ex&&!solved){mHLine(toX,toY,maxK,ex.gR,'rgba(229,62,62,.4)');drawExA(toX,toY,maxK,ex.Kd,ex.Ks,ex.gR,'K');}
  if(eq.r<=maxR&&Ks<=maxK){mDash(toX,toY,Ks,eq.r,0,eq.r);mDot(toX,toY,Ks,eq.r,'#c05621',4);}
  const kdK=maxK*.12,kdR=Math.min(eq.P*P.A*P.gamma*Math.pow(eq.Lf,P.beta)*Math.pow(kdK/P.nF,P.gamma-1),maxR*.85);
  X.fillStyle='#c05621';X.font='bold 7px Segoe UI';X.textAlign='left';X.fillText('K·µà(r)',toX(kdK),toY(kdR)-8);
  X.fillStyle='#2b6cb0';X.fillText('KÃÑ',toX(Ks)+4,toY(maxR*.7));
  X.fillStyle='#c05621';X.font='italic 6px Segoe UI';X.fillText('r = P¬∑MP‚Çñ',toX(maxK*.35),toY(maxR*.05));
}

// ====== MAIN DRAW ======
let flowAnim=0;
function drawAll(eq,ex){
  X.fillStyle='#fff';X.fillRect(0,0,CW,CH);
  const cx=CW/2,cy=CH/2,s=Math.min(CW/1100,CH/700);
  const hh={x:cx-220*s,y:cy,w:130*s,h:75*s},fi={x:cx+220*s,y:cy,w:130*s,h:75*s};
  const gm={x:cx,y:cy-165*s,w:160*s,h:42*s},fm={x:cx,y:cy+155*s,w:200*s,h:42*s};
  const xAt=(b,f)=>b.x-b.w/2+b.w*f,topE=b=>b.y-b.h/2,botE=b=>b.y+b.h/2,lftE=b=>b.x-b.w/2,rgtE=b=>b.x+b.w/2;
  function qB(t,a,b,c){const u=1-t;return u*u*a+2*u*t*b+t*t*c;}
  function qBD(t,a,b,c){return 2*(1-t)*(b-a)+2*t*(c-b);}
  if(mode==='challenge'&&ex&&!solved){
    [[gm,ex.exG,eq.Q],[fm,ex.exL,eq.L]].forEach(([bx,exv,ref])=>{
      const rel=Math.abs(exv)/(ref||1);if(rel>.05){
        const col=exv>0?'rgba(229,62,62,':'rgba(49,130,206,';
        const grd=X.createRadialGradient(bx.x,bx.y,bx.w*.3,bx.x,bx.y,bx.w*1.2);
        grd.addColorStop(0,col+(Math.min(rel,.6)*.5)+')');grd.addColorStop(1,col+'0)');
        X.fillStyle=grd;X.fillRect(bx.x-bx.w,bx.y-bx.h*2,bx.w*2,bx.h*4);
      }
    });
  }
  function drawArc(x1,y1,cpx,cpy,x2,y2,color,dash,fr,lbl){
    X.strokeStyle=color;X.lineWidth=2*s;X.setLineDash(dash?[6*s,4*s]:[]);X.beginPath();X.moveTo(x1,y1);X.quadraticCurveTo(cpx,cpy,x2,y2);X.stroke();X.setLineDash([]);
    const t=.95,ax=qB(t,x1,cpx,x2),ay=qB(t,y1,cpy,y2),dx=qBD(t,x1,cpx,x2),dy=qBD(t,y1,cpy,y2),ang=Math.atan2(dy,dx),sz2=7*s;
    X.save();X.translate(ax,ay);X.rotate(ang);X.fillStyle=color;X.beginPath();X.moveTo(0,0);X.lineTo(-sz2,-sz2*.4);X.lineTo(-sz2,sz2*.4);X.closePath();X.fill();X.restore();
    const n=Math.max(2,Math.min(6,Math.round(fr)));
    for(let i=0;i<n;i++){const pt=((flowAnim*.1+i/n)%1);const px=qB(pt,x1,cpx,x2),py=qB(pt,y1,cpy,y2);X.beginPath();X.arc(px,py,2.5*s,0,Math.PI*2);X.fillStyle=color;X.globalAlpha=.6;X.fill();X.globalAlpha=1;}
    if(lbl){const mt=.5,mx=qB(mt,x1,cpx,x2),my=qB(mt,y1,cpy,y2),ndx=mx-cx,ndy=my-cy,nd=Math.sqrt(ndx*ndx+ndy*ndy)||1,isM=!dash,push=isM?-18*s:22*s,lx2=mx+(ndx/nd)*push,ly2=my+(ndy/nd)*push;X.save();X.font=`600 ${8.5*s}px 'Segoe UI',sans-serif`;const lines=lbl.split('\n');let mxW=0;lines.forEach(l=>{const m2=X.measureText(l);if(m2.width>mxW)mxW=m2.width;});const lh=10*s,th=lines.length*lh,px2=4*s,py2=2*s;X.fillStyle='rgba(255,255,255,.85)';X.beginPath();X.roundRect(lx2-mxW/2-px2,ly2-th/2-py2,mxW+px2*2,th+py2*2,3*s);X.fill();X.fillStyle=color;X.textAlign='center';X.textBaseline='middle';lines.forEach((l,i)=>X.fillText(l,lx2,ly2+(i-(lines.length-1)/2)*lh));X.restore();}
  }
  function arc(x1,y1,x2,y2){return[x1,y1,x1,y2,x2,y2];}function arcR(x1,y1,x2,y2){return[x1,y1,x2,y1,x2,y2];}
  const yAt=(b,f)=>b.y-b.h/2+b.h*f;
  const fr=Math.max(1,eq.P*eq.Q/500);
  drawArc(...arc(xAt(hh,2/3),topE(hh),lftE(gm),yAt(gm,2/3)),'#c53030',false,fr,'Expenditure ($)');
  drawArc(...arcR(rgtE(gm),yAt(gm,2/3),xAt(fi,1/3),topE(fi)),'#c53030',false,fr,'Revenue ($)');
  drawArc(...arc(xAt(fi,1/3),botE(fi),rgtE(fm),yAt(fm,1/3)),'#c53030',false,fr,'Wages, Rent,\nProfit');
  drawArc(...arcR(lftE(fm),yAt(fm,1/3),xAt(hh,2/3),botE(hh)),'#c53030',false,fr,'Income ($)');
  drawArc(...arc(xAt(fi,2/3),topE(fi),rgtE(gm),yAt(gm,1/3)),'#2b6cb0',true,fr,'Goods &\nServices');
  drawArc(...arcR(lftE(gm),yAt(gm,1/3),xAt(hh,1/3),topE(hh)),'#2b6cb0',true,fr,'Goods &\nServices');
  drawArc(...arc(xAt(hh,1/3),botE(hh),lftE(fm),yAt(fm,2/3)),'#2b6cb0',true,fr,'Labor, Capital');
  drawArc(...arcR(rgtE(fm),yAt(fm,2/3),xAt(fi,2/3),botE(fi)),'#2b6cb0',true,fr,'Factors of\nProduction');
  function drawBox(b,fill,stroke,txt,m1,m2){X.fillStyle=fill;X.strokeStyle=stroke;X.lineWidth=2*s;X.beginPath();X.roundRect(b.x-b.w/2,b.y-b.h/2,b.w,b.h,10*s);X.fill();X.stroke();X.fillStyle=stroke;X.font=`bold ${12*s}px Segoe UI`;X.textAlign='center';X.textBaseline='middle';X.fillText(txt,b.x,b.y-14*s);if(m1){X.font=`italic ${8.5*s}px 'Segoe UI',serif`;X.fillStyle='#4a5568';X.fillText(m1,b.x,b.y+4*s);if(m2)X.fillText(m2,b.x,b.y+16*s);}}
  function drawPill(b,fill,stroke,txt,sub){X.fillStyle=fill;X.strokeStyle=stroke;X.lineWidth=2*s;X.beginPath();X.roundRect(b.x-b.w/2,b.y-b.h/2,b.w,b.h,b.h/2);X.fill();X.stroke();X.fillStyle=stroke;X.font=`bold ${11*s}px Segoe UI`;X.textAlign='center';X.textBaseline='middle';X.fillText(txt,b.x,b.y-(sub?5*s:0));if(sub){X.font=`${7.5*s}px Segoe UI`;X.globalAlpha=.55;X.fillText(sub,b.x,b.y+8*s);X.globalAlpha=1;}}
  drawBox(hh,'#ebf4ff','#4299e1','Households','max U(X, Y)','s.t.  P‚ÇìX + P·µßY ‚â§ M');
  drawBox(fi,'#fef3e2','#d69e2e','Firms','max p¬∑f(L,K) ‚àí wL ‚àí rK');
  if(mode==='challenge'&&!solved){
    drawPill(gm,'#f0fff4','#38a169','Product Market',`P = $${(+gPsl.value).toFixed(2)}`);
    drawPill(fm,'#faf5ff','#805ad5','Factor Markets',`w=$${(+gWsl.value).toFixed(2)}  r=$${(+gRsl.value).toFixed(2)}`);
  } else {
    drawPill(gm,'#f0fff4','#38a169','Product Market',`P* = $${eq.P.toFixed(2)}`);
    drawPill(fm,'#faf5ff','#805ad5','Factor Markets',`w*=$${eq.w.toFixed(2)}  r*=$${eq.r.toFixed(2)}`);
  }
  if(solved&&victoryParticles.length>0){victoryParticles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life-=.02;if(p.life>0){X.globalAlpha=p.life;X.fillStyle=p.color;X.beginPath();X.arc(p.x,p.y,p.r,0,Math.PI*2);X.fill();X.globalAlpha=1;}});victoryParticles=victoryParticles.filter(p=>p.life>0);}
  const gw=160*s,gh=120*s,gmGH=105*s;
  drawHHGraph(hh.x-hh.w/2-gw-10*s,hh.y-gh/2,gw,gh,eq);
  drawFirmGraph(fi.x+fi.w/2+10*s,fi.y-gh/2,gw,gh,eq);
  drawGMGraph(gm.x-gw/2,gm.y-gm.h/2-gmGH-8*s,gw,gmGH,eq,ex);
  const fmY=fm.y+fm.h/2+8*s;
  drawLaborGraph(fm.x-gw-5*s,fmY,gw,gmGH,eq,ex);
  drawCapitalGraph(fm.x+5*s,fmY,gw,gmGH,eq,ex);
  // Legend
  const lx=12*s,ly=CH-36*s;
  X.save();X.font=`600 ${7*s}px Segoe UI`;X.textAlign='left';
  X.strokeStyle='#c53030';X.lineWidth=2*s;X.beginPath();X.moveTo(lx,ly);X.lineTo(lx+18*s,ly);X.stroke();
  X.fillStyle='#c53030';X.fillText('Nominal ($)',lx+22*s,ly+2.5*s);
  X.strokeStyle='#2b6cb0';X.setLineDash([5*s,3*s]);X.beginPath();X.moveTo(lx,ly+11*s);X.lineTo(lx+18*s,ly+11*s);X.stroke();X.setLineDash([]);
  X.fillStyle='#2b6cb0';X.fillText('Real (goods, factors)',lx+22*s,ly+13.5*s);
  X.restore();
  X.save();X.font=`italic ${6*s}px Segoe UI`;X.textAlign='right';X.fillStyle='#a0aec0';
  X.fillText('HH own firms; œÄ distributed as dividends. DRS: Œ≤+Œ≥<1 ‚Üí œÄ>0',CW-10*s,CH-12*s);
  X.restore();
}

// ====== UPDATE ======
function updateAll(){
  document.getElementById('vAlpha').textContent=(+S.Alpha.value).toFixed(2);
  document.getElementById('vPy').textContent=(+S.Py.value).toFixed(2);
  document.getElementById('vWY').textContent=(+S.WY.value).toFixed(1);
  document.getElementById('vNC').textContent=S.NC.value;
  document.getElementById('vA').textContent=(+S.A.value).toFixed(1);
  document.getElementById('vBeta').textContent=(+S.Beta.value).toFixed(2);
  document.getElementById('vGamma').textContent=(+S.Gamma.value).toFixed(2);
  document.getElementById('vNF').textContent=S.NF.value;
  document.getElementById('vKbar').textContent=(+S.Kbar.value).toFixed(1);
  document.getElementById('vLSE').textContent=(+S.LSE.value).toFixed(1);
  const eq=solveGE();
  const P=getParams(),bg=P.beta+P.gamma;
  document.getElementById('eqBG').textContent=bg.toFixed(2);
  let ex=null;
  if(mode==='challenge'){
    const gP=+gPsl.value,gW=+gWsl.value,gR=+gRsl.value;
    document.getElementById('gPval').textContent=`$${gP.toFixed(2)}`;
    document.getElementById('gWval').textContent=`$${gW.toFixed(2)}`;
    document.getElementById('gRval').textContent=`$${gR.toFixed(2)}`;
    ex=evalGuess(gP,gW,gR);
    if(!solved)document.getElementById('scTime').textContent=((Date.now()-chalStart)/1000).toFixed(0)+'s';
    document.getElementById('scChal').textContent=`${totalSolved}/${challenges.length}`;
    document.getElementById('scStars').textContent=totalStars;
    const pA=Math.max(0,(1-Math.abs(gP-trueEq.P)/trueEq.P)*100);
    const wA=Math.max(0,(1-Math.abs(gW-trueEq.w)/trueEq.w)*100);
    const rA=Math.max(0,(1-Math.abs(gR-trueEq.r)/trueEq.r)*100);
    if(!solved&&pA>93&&wA>93&&rA>93)triggerVictory(pA,wA,rA);
    ['eqP','eqW','eqR','eqQ','eqL','eqK','eqM','eqWB','eqRK','eqProf','eqU'].forEach(id=>document.getElementById(id).textContent='???');
  } else {
    document.getElementById('eqP').textContent=`$${eq.P.toFixed(2)}`;
    document.getElementById('eqW').textContent=`$${eq.w.toFixed(2)}`;
    document.getElementById('eqR').textContent=`$${eq.r.toFixed(2)}`;
    document.getElementById('eqQ').textContent=eq.Q.toFixed(0);
    document.getElementById('eqL').textContent=eq.L.toFixed(0);
    document.getElementById('eqK').textContent=eq.K.toFixed(0);
    document.getElementById('eqM').textContent=`$${eq.M.toFixed(1)}`;
    const wL=eq.w*(eq.L/P.nC),rK=eq.r*P.Kbar;
    document.getElementById('eqWB').textContent=`$${(eq.w*eq.L).toFixed(0)}`;
    document.getElementById('eqRK').textContent=`$${(eq.r*eq.K).toFixed(0)}`;
    document.getElementById('eqProf').textContent=`$${(P.nF*eq.profit).toFixed(0)}`;
    const xS=P.alpha*eq.M/eq.P,yS=(1-P.alpha)*eq.M/P.Py;
    document.getElementById('eqU').textContent=consUtil(xS,yS,P.alpha).toFixed(1);
  }
  drawAll(eq,ex);
}
Object.values(S).forEach(sl=>sl.addEventListener('input',updateAll));
[gPsl,gWsl,gRsl].forEach(sl=>sl.addEventListener('input',updateAll));

// ====== VICTORY ======
function triggerVictory(pA,wA,rA){
  solved=true;totalSolved++;
  const elapsed=+((Date.now()-chalStart)/1000).toFixed(1);
  const stars=compStars(elapsed),score=compScore(elapsed,pA,wA,rA);
  totalStars+=stars;
  results.push({name:challenges[chalIdx].name,time:elapsed,stars,score});
  for(let i=0;i<60;i++){victoryParticles.push({x:CW/2,y:CH/2,vx:(Math.cos(i/60*Math.PI*2))*4+((i%3)-1)*2,vy:(Math.sin(i/60*Math.PI*2))*4-2,r:2+((i*7)%4),life:1,color:['#38a169','#d69e2e','#4299e1','#805ad5','#e53e3e'][i%5]});}
  document.getElementById('btnFinish').style.display='inline-block';
  setTimeout(()=>{
    document.getElementById('vTime').textContent=elapsed+'s';
    document.getElementById('vAccP').textContent=pA.toFixed(1)+'%';
    document.getElementById('vAccW').textContent=wA.toFixed(1)+'%';
    document.getElementById('vAccR').textContent=rA.toFixed(1)+'%';
    document.getElementById('vScore').textContent=score;
    document.getElementById('victoryStars').textContent='‚≠ê'.repeat(stars)+'‚òÜ'.repeat(3-stars);
    document.getElementById('victoryMsg').textContent=stars===3?'Perfect!':stars===2?'Great work!':'Solved it!';
    document.getElementById('victoryOverlay').classList.add('show');
  },600);
}
function closeVictory(){document.getElementById('victoryOverlay').classList.remove('show');nextChallenge();}

// ====== RESULTS ======
function showResults(){
  document.getElementById('victoryOverlay').classList.remove('show');
  const tbody=document.getElementById('resultsBody');tbody.innerHTML='';let ts=0;
  results.forEach((r,i)=>{ts+=r.score;tbody.innerHTML+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.time}s</td><td>${r.score}</td><td class="star-col">${'‚≠ê'.repeat(r.stars)}</td></tr>`;});
  for(let i=results.length;i<challenges.length;i++)tbody.innerHTML+=`<tr style="opacity:.4"><td>${i+1}</td><td>${challenges[i].name}</td><td>‚Äî</td><td>‚Äî</td><td class="star-col">‚Äî</td></tr>`;
  document.getElementById('totalStarsDisp').textContent='‚≠ê'.repeat(totalStars)+'‚òÜ'.repeat(challenges.length*3-totalStars);
  document.getElementById('totalScoreMsg').textContent=`Total: ${ts}/${challenges.length*1000}  ‚Ä¢  ${totalStars}/${challenges.length*3} stars`;
  const raw=results.map(r=>`${r.score}-${r.time}`).join('|');
  let h=0;for(let i=0;i<raw.length;i++){h=((h<<5)-h+raw.charCodeAt(i))|0;}
  const hex=(h>>>0).toString(16).toUpperCase().padStart(8,'0');
  document.getElementById('valCode').textContent=`GE-${totalStars}S-${ts}P-${hex.slice(0,4)}-${hex.slice(4)}`;
  document.getElementById('resultsOverlay').classList.add('show');
}
function restartAll(){document.getElementById('resultsOverlay').classList.remove('show');totalStars=0;totalSolved=0;results.length=0;startChallenge(0);}

// ====== ANIMATION ======
let lastT=0;
function animLoop(ts){
  if(ts-lastT>35){lastT=ts;flowAnim+=.03;
    const eq=solveGE();let ex2=null;
    if(mode==='challenge'){ex2=evalGuess(+gPsl.value,+gWsl.value,+gRsl.value);if(!solved)document.getElementById('scTime').textContent=((Date.now()-chalStart)/1000).toFixed(0)+'s';}
    drawAll(eq,ex2);
  }
  requestAnimationFrame(animLoop);
}
updateAll();requestAnimationFrame(animLoop);
</script>
</body>
</html>
