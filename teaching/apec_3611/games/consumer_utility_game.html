<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Master: The Consumer Game</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            margin: 0;
            padding: 15px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1500px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #2c5282 0%, #2b6cb0 100%);
            border-radius: 12px;
            color: white;
        }
        
        .title-section h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 4px 0;
        }
        
        .title-section .subtitle {
            font-size: 0.85rem;
            color: #bee3f8;
            margin: 0;
        }
        
        .score-section {
            display: flex;
            gap: 25px;
            align-items: center;
        }
        
        .score-box {
            text-align: center;
        }
        
        .score-label {
            font-size: 0.7rem;
            color: #bee3f8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .score-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .score-value.good { color: #68d391; }
        .score-value.bad { color: #fc8181; }
        .score-value.month { color: #fbd38d; }
        
        .game-controls {
            display: flex;
            gap: 10px;
        }
        
        .game-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }
        
        .btn-start:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4); }
        
        .btn-pause {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }
        
        .btn-reset {
            background: #4a5568;
            color: white;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            gap: 15px;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 14px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .panel-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a202c;
        }
        
        .panel-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .badge-control { background: rgba(66, 153, 225, 0.15); color: #2b6cb0; }
        .badge-market { background: rgba(128, 90, 213, 0.15); color: #805ad5; }
        .badge-history { background: rgba(236, 201, 75, 0.15); color: #b7791f; }
        
        /* Bundle Display */
        .bundle-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .good-box {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid;
        }
        
        .good-box.good-x {
            background: linear-gradient(135deg, rgba(229, 62, 62, 0.08) 0%, rgba(252, 129, 129, 0.05) 100%);
            border-color: #e53e3e;
        }
        
        .good-box.good-y {
            background: linear-gradient(135deg, rgba(49, 130, 206, 0.08) 0%, rgba(99, 179, 237, 0.05) 100%);
            border-color: #3182ce;
        }
        
        .good-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .good-x .good-label { color: #c53030; }
        .good-y .good-label { color: #2b6cb0; }
        
        .good-value {
            font-size: 2.2rem;
            font-weight: 700;
            font-family: 'Monaco', 'Consolas', monospace;
            line-height: 1.2;
        }
        
        .good-x .good-value { color: #e53e3e; }
        .good-y .good-value { color: #3182ce; }
        
        .good-price {
            font-size: 0.75rem;
            color: #718096;
            margin-top: 3px;
        }
        
        /* Control Buttons */
        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .ctrl-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }
        
        .ctrl-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .ctrl-btn .label {
            font-size: 0.65rem;
            font-weight: 500;
        }
        
        .btn-x-up {
            background: linear-gradient(135deg, #fc8181 0%, #f56565 100%);
            color: white;
        }
        
        .btn-x-down {
            background: linear-gradient(135deg, #feb2b2 0%, #fc8181 100%);
            color: #742a2a;
        }
        
        .btn-y-up {
            background: linear-gradient(135deg, #63b3ed 0%, #4299e1 100%);
            color: white;
        }
        
        .btn-y-down {
            background: linear-gradient(135deg, #90cdf4 0%, #63b3ed 100%);
            color: #2a4365;
        }
        
        .ctrl-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Budget Bar */
        .budget-section {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .budget-label {
            font-size: 0.75rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .budget-values {
            font-size: 0.85rem;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .budget-spent { color: #e53e3e; }
        .budget-total { color: #38a169; }
        
        .budget-bar {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .budget-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s ease, background 0.3s ease;
        }
        
        .budget-fill.under { background: linear-gradient(90deg, #48bb78 0%, #68d391 100%); }
        .budget-fill.near { background: linear-gradient(90deg, #ed8936 0%, #f6ad55 100%); }
        .budget-fill.over { background: linear-gradient(90deg, #e53e3e 0%, #fc8181 100%); }
        
        .budget-warning {
            font-size: 0.7rem;
            color: #e53e3e;
            text-align: center;
            margin-top: 5px;
            font-weight: 600;
        }
        
        /* Action Points */
        .action-points {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .ap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .ap-label {
            font-size: 0.75rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ap-value {
            font-size: 1rem;
            font-weight: 700;
            color: #805ad5;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .ap-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .ap-fill {
            height: 100%;
            background: linear-gradient(90deg, #805ad5 0%, #b794f4 100%);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .ap-recharge {
            font-size: 0.7rem;
            color: #a0aec0;
            text-align: right;
            margin-top: 4px;
        }
        
        /* Utility Display */
        .utility-display {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, rgba(56, 161, 105, 0.1) 0%, rgba(72, 187, 120, 0.05) 100%);
            border: 2px solid #38a169;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .utility-label {
            font-size: 0.7rem;
            color: #276749;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .utility-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #38a169;
            font-family: 'Monaco', 'Consolas', monospace;
            line-height: 1.2;
        }
        
        .utility-value.invalid {
            color: #e53e3e;
            font-size: 1.5rem;
        }
        
        .utility-optimal {
            font-size: 0.75rem;
            color: #718096;
            margin-top: 5px;
        }
        
        .utility-optimal span {
            color: #d69e2e;
            font-weight: 600;
        }
        
        /* Indifference Curve Graph */
        .graph-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        canvas {
            display: block;
            width: 100%;
            border-radius: 8px;
        }
        
        .market-info {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .info-box {
            background: #f7fafc;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .info-label {
            font-size: 0.65rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Monaco', 'Consolas', monospace;
            margin-top: 2px;
        }
        
        .info-value.price-x { color: #e53e3e; }
        .info-value.price-y { color: #3182ce; }
        .info-value.income { color: #38a169; }
        .info-value.mrs { color: #805ad5; }
        
        /* News Ticker */
        .news-ticker {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 45px;
        }
        
        .news-icon {
            font-size: 1.2rem;
        }
        
        .news-text {
            color: #e2e8f0;
            font-size: 0.85rem;
            flex: 1;
        }
        
        .news-text.shock-good { color: #68d391; }
        .news-text.shock-bad { color: #fc8181; }
        .news-text.shock-neutral { color: #fbd38d; }
        
        /* Utility History */
        .history-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .monthly-utility {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 12px;
        }
        
        .monthly-label {
            font-size: 0.7rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .monthly-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        .monthly-value.high { color: #38a169; }
        .monthly-value.medium { color: #d69e2e; }
        .monthly-value.low { color: #e53e3e; }
        
        .efficiency-meter {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .efficiency-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .efficiency-label {
            font-size: 0.7rem;
            color: #718096;
            text-transform: uppercase;
        }
        
        .efficiency-value {
            font-size: 0.85rem;
            font-weight: 700;
            color: #805ad5;
        }
        
        .efficiency-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .efficiency-fill {
            height: 100%;
            background: linear-gradient(90deg, #e53e3e 0%, #ed8936 30%, #ecc94b 50%, #48bb78 80%, #38a169 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .chart-container {
            flex: 1;
            min-height: 220px;
        }
        
        .high-score {
            background: linear-gradient(135deg, rgba(214, 158, 46, 0.15) 0%, rgba(236, 201, 75, 0.1) 100%);
            border: 1px solid rgba(214, 158, 46, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            text-align: center;
        }
        
        .hs-label {
            font-size: 0.7rem;
            color: #b7791f;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .hs-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #d69e2e;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        
        /* Speed control */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .speed-label {
            font-size: 0.75rem;
            color: #718096;
        }
        
        .speed-buttons {
            display: flex;
            gap: 5px;
        }
        
        .speed-btn {
            padding: 5px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .speed-btn.active {
            background: #3182ce;
            color: white;
            border-color: #3182ce;
        }
        
        .speed-btn:hover:not(.active) {
            background: #edf2f7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title-section">
                <h1>üõí Budget Master: The Consumer Game</h1>
                <p class="subtitle">Maximize your utility by choosing the optimal bundle as prices and income change!</p>
            </div>
            <div class="score-section">
                <div class="score-box">
                    <div class="score-label">Month</div>
                    <div class="score-value month" id="current-month">1</div>
                </div>
                <div class="score-box">
                    <div class="score-label">Total Utility</div>
                    <div class="score-value good" id="cumulative-utility">0</div>
                </div>
                <div class="game-controls">
                    <button class="game-btn btn-start" id="start-btn" onclick="toggleGame()">‚ñ∂Ô∏è Start</button>
                    <button class="game-btn btn-reset" onclick="resetGame()">üîÑ Reset</button>
                </div>
            </div>
        </div>
        
        <div class="main-layout">
            <!-- Consumption Controls Panel -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üéÆ Consumption Choices</div>
                    <span class="panel-badge badge-control">Your Bundle</span>
                </div>
                
                <div class="bundle-display">
                    <div class="good-box good-x">
                        <div class="good-label">Good X</div>
                        <div class="good-value" id="current-x">20</div>
                        <div class="good-price">@ $<span id="display-px">2.00</span></div>
                    </div>
                    <div class="good-box good-y">
                        <div class="good-label">Good Y</div>
                        <div class="good-value" id="current-y">20</div>
                        <div class="good-price">@ $<span id="display-py">2.00</span></div>
                    </div>
                </div>
                
                <div class="control-grid">
                    <button class="ctrl-btn btn-x-up" id="btn-x-up" onclick="changeBundle(1, 0)">
                        <span>X +5</span>
                        <span class="label">More X</span>
                    </button>
                    <button class="ctrl-btn btn-y-up" id="btn-y-up" onclick="changeBundle(0, 1)">
                        <span>Y +5</span>
                        <span class="label">More Y</span>
                    </button>
                    <button class="ctrl-btn btn-x-down" id="btn-x-down" onclick="changeBundle(-1, 0)">
                        <span>X -5</span>
                        <span class="label">Less X</span>
                    </button>
                    <button class="ctrl-btn btn-y-down" id="btn-y-down" onclick="changeBundle(0, -1)">
                        <span>Y -5</span>
                        <span class="label">Less Y</span>
                    </button>
                </div>
                
                <div class="budget-section">
                    <div class="budget-header">
                        <span class="budget-label">Budget Constraint</span>
                        <span class="budget-values">
                            <span class="budget-spent" id="budget-spent">$80</span> / 
                            <span class="budget-total" id="budget-total">$100</span>
                        </span>
                    </div>
                    <div class="budget-bar">
                        <div class="budget-fill under" id="budget-fill" style="width: 80%"></div>
                    </div>
                    <div class="budget-warning" id="budget-warning" style="display: none;">
                        ‚ö†Ô∏è Over budget! Utility counts as 0 this month!
                    </div>
                </div>
                
                <div class="action-points">
                    <div class="ap-header">
                        <span class="ap-label">Action Points</span>
                        <span class="ap-value" id="ap-value">5 / 5</span>
                    </div>
                    <div class="ap-bar">
                        <div class="ap-fill" id="ap-fill" style="width: 100%"></div>
                    </div>
                    <div class="ap-recharge">+1 AP every 2.5 seconds</div>
                </div>
                
                <div class="utility-display">
                    <div class="utility-label">Current Utility</div>
                    <div class="utility-value" id="current-utility">20.0</div>
                    <div class="utility-optimal">Optimal: <span id="optimal-utility">25.0</span></div>
                </div>
                
                <div class="speed-control">
                    <span class="speed-label">Game Speed:</span>
                    <div class="speed-buttons">
                        <button class="speed-btn" onclick="setSpeed(0.5)">0.5x</button>
                        <button class="speed-btn active" onclick="setSpeed(1)">1x</button>
                        <button class="speed-btn" onclick="setSpeed(2)">2x</button>
                        <button class="speed-btn" onclick="setSpeed(3)">3x</button>
                    </div>
                </div>
            </div>
            
            <!-- Indifference Curve Panel -->
            <div class="panel graph-section">
                <div class="panel-header">
                    <div class="panel-title">üìä Budget & Preferences</div>
                    <span class="panel-badge badge-market">Indifference Map</span>
                </div>
                
                <canvas id="ic-canvas" width="700" height="380"></canvas>
                
                <div class="market-info">
                    <div class="info-box">
                        <div class="info-label">Price of X</div>
                        <div class="info-value price-x" id="info-px">$2.00</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Price of Y</div>
                        <div class="info-value price-y" id="info-py">$2.00</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Income</div>
                        <div class="info-value income" id="info-income">$100</div>
                    </div>
                    <div class="info-box">
                        <div class="info-label">Your MRS</div>
                        <div class="info-value mrs" id="info-mrs">1.00</div>
                    </div>
                </div>
                
                <div class="news-ticker" id="news-ticker">
                    <span class="news-icon">üì∞</span>
                    <span class="news-text" id="news-text">Game paused. Press Start to begin shopping!</span>
                </div>
            </div>
            
            <!-- Utility History Panel -->
            <div class="panel history-section">
                <div class="panel-header">
                    <div class="panel-title">üìà Utility History</div>
                    <span class="panel-badge badge-history">Performance</span>
                </div>
                
                <div class="monthly-utility">
                    <div class="monthly-label">This Month's Utility</div>
                    <div class="monthly-value high" id="monthly-utility">0.0</div>
                </div>
                
                <div class="efficiency-meter">
                    <div class="efficiency-header">
                        <span class="efficiency-label">Efficiency (U / U*)</span>
                        <span class="efficiency-value" id="efficiency-value">100%</span>
                    </div>
                    <div class="efficiency-bar">
                        <div class="efficiency-fill" id="efficiency-fill" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="history-canvas" width="260" height="220"></canvas>
                </div>
                
                <div class="high-score">
                    <div class="hs-label">üèÜ Best Run (12 months)</div>
                    <div class="hs-value" id="high-score">0</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const icCanvas = document.getElementById('ic-canvas');
        const historyCanvas = document.getElementById('history-canvas');
        const icCtx = icCanvas.getContext('2d');
        const historyCtx = historyCanvas.getContext('2d');
        
        // Game State
        let gameRunning = false;
        let gameSpeed = 1;
        let currentMonth = 1;
        let cumulativeUtility = 0;
        let highScore = 0;
        let monthlyUtilities = [];
        
        // Action Points
        let actionPoints = 5;
        const maxActionPoints = 5;
        let lastAPRecharge = Date.now();
        const apRechargeTime = 2500; // 2.5 seconds
        
        // Player's bundle
        let playerX = 20;
        let playerY = 20;
        
        // Market Parameters
        let marketParams = {
            priceX: 2.00,
            priceY: 2.00,
            income: 100,
            alpha: 0.5  // Cobb-Douglas preference parameter
        };
        
        // Shock news messages
        const shockMessages = {
            priceXUp: [
                "‚ö†Ô∏è Tariffs imposed on Good X! Price rises!",
                "‚ö†Ô∏è Supply shortage drives up X prices!",
                "‚ö†Ô∏è Popular demand spikes Good X price!",
                "‚ö†Ô∏è Production costs increase for Good X!"
            ],
            priceXDown: [
                "‚úÖ New competitor enters X market! Prices fall!",
                "‚úÖ Technological breakthrough reduces X costs!",
                "‚úÖ Good X goes on sale!",
                "‚úÖ Oversupply pushes down X prices!"
            ],
            priceYUp: [
                "‚ö†Ô∏è Good Y faces supply disruption!",
                "‚ö†Ô∏è Import restrictions raise Y prices!",
                "‚ö†Ô∏è Raw material costs spike for Good Y!",
                "‚ö†Ô∏è Seasonal demand increases Y price!"
            ],
            priceYDown: [
                "‚úÖ Bumper harvest reduces Y prices!",
                "‚úÖ Trade deal lowers Y import costs!",
                "‚úÖ Good Y manufacturer offers rebates!",
                "‚úÖ Competition drives down Y prices!"
            ],
            incomeUp: [
                "üí∞ You got a raise! Income increases!",
                "üí∞ Bonus payment received!",
                "üí∞ Tax refund arrives!",
                "üí∞ Investment dividends pay out!",
                "üí∞ Side gig income boosts budget!"
            ],
            incomeDown: [
                "üìâ Hours cut at work. Income falls.",
                "üìâ Unexpected medical bill reduces budget.",
                "üìâ Car repair eats into savings.",
                "üìâ Rent increase squeezes budget.",
                "üìâ Inflation erodes purchasing power."
            ],
            preferenceShift: [
                "üîÑ Your tastes are shifting...",
                "üîÑ New hobby changes your preferences!",
                "üîÑ Health kick affects what you want!"
            ]
        };
        
        // Utility function: U = X^Œ± * Y^(1-Œ±)
        function utility(x, y) {
            if (x <= 0 || y <= 0) return 0;
            return Math.pow(x, marketParams.alpha) * Math.pow(y, 1 - marketParams.alpha);
        }
        
        // Optimal bundle given prices and income
        function optimalBundle() {
            const x = (marketParams.alpha * marketParams.income) / marketParams.priceX;
            const y = ((1 - marketParams.alpha) * marketParams.income) / marketParams.priceY;
            return { x, y, utility: utility(x, y) };
        }
        
        // Check if bundle is affordable
        function isAffordable(x, y) {
            return (marketParams.priceX * x + marketParams.priceY * y) <= marketParams.income * 1.001;
        }
        
        // Calculate spending
        function spending(x, y) {
            return marketParams.priceX * x + marketParams.priceY * y;
        }
        
        // MRS = (Œ±/1-Œ±) * (Y/X)
        function MRS(x, y) {
            if (x <= 0) return Infinity;
            return (marketParams.alpha / (1 - marketParams.alpha)) * (y / x);
        }
        
        // Get indifference curve Y for given X and utility level
        function getICY(x, u) {
            if (x <= 0) return null;
            const y = Math.pow(u / Math.pow(x, marketParams.alpha), 1 / (1 - marketParams.alpha));
            return isFinite(y) ? y : null;
        }
        
        // Generate random shock
        function generateShock() {
            const shockType = Math.random();
            let message = "";
            let messageClass = "shock-neutral";
            
            if (shockType < 0.25) {
                // Price X shock
                const direction = Math.random() < 0.5 ? 1 : -1;
                const magnitude = 0.25 + Math.random() * 0.75;
                marketParams.priceX = Math.max(0.5, Math.min(5, marketParams.priceX + direction * magnitude));
                message = direction > 0 ? 
                    shockMessages.priceXUp[Math.floor(Math.random() * shockMessages.priceXUp.length)] :
                    shockMessages.priceXDown[Math.floor(Math.random() * shockMessages.priceXDown.length)];
                messageClass = direction > 0 ? "shock-bad" : "shock-good";
            } else if (shockType < 0.5) {
                // Price Y shock
                const direction = Math.random() < 0.5 ? 1 : -1;
                const magnitude = 0.25 + Math.random() * 0.75;
                marketParams.priceY = Math.max(0.5, Math.min(5, marketParams.priceY + direction * magnitude));
                message = direction > 0 ?
                    shockMessages.priceYUp[Math.floor(Math.random() * shockMessages.priceYUp.length)] :
                    shockMessages.priceYDown[Math.floor(Math.random() * shockMessages.priceYDown.length)];
                messageClass = direction > 0 ? "shock-bad" : "shock-good";
            } else if (shockType < 0.8) {
                // Income shock
                const direction = Math.random() < 0.5 ? 1 : -1;
                const magnitude = 10 + Math.random() * 20;
                marketParams.income = Math.max(50, Math.min(200, marketParams.income + direction * magnitude));
                message = direction > 0 ?
                    shockMessages.incomeUp[Math.floor(Math.random() * shockMessages.incomeUp.length)] :
                    shockMessages.incomeDown[Math.floor(Math.random() * shockMessages.incomeDown.length)];
                messageClass = direction > 0 ? "shock-good" : "shock-bad";
            } else if (shockType < 0.9) {
                // Preference shock
                const shift = (Math.random() - 0.5) * 0.15;
                marketParams.alpha = Math.max(0.3, Math.min(0.7, marketParams.alpha + shift));
                message = shockMessages.preferenceShift[Math.floor(Math.random() * shockMessages.preferenceShift.length)];
                messageClass = "shock-neutral";
            } else {
                // No shock
                message = "üìä Markets stable this month. No major changes.";
                messageClass = "shock-neutral";
            }
            
            document.getElementById('news-text').textContent = message;
            document.getElementById('news-text').className = `news-text ${messageClass}`;
        }
        
        // Draw IC graph
        function drawICGraph() {
            const margin = { top: 25, right: 20, bottom: 40, left: 50 };
            const width = icCanvas.width - margin.left - margin.right;
            const height = icCanvas.height - margin.top - margin.bottom;
            
            icCtx.fillStyle = '#ffffff';
            icCtx.fillRect(0, 0, icCanvas.width, icCanvas.height);
            
            const maxX = 80;
            const maxY = 80;
            
            const toX = (x) => margin.left + (x / maxX) * width;
            const toY = (y) => margin.top + height - (y / maxY) * height;
            
            // Grid
            icCtx.strokeStyle = '#edf2f7';
            icCtx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const x = margin.left + (i / 4) * width;
                const y = margin.top + (i / 4) * height;
                icCtx.beginPath();
                icCtx.moveTo(x, margin.top);
                icCtx.lineTo(x, margin.top + height);
                icCtx.stroke();
                icCtx.beginPath();
                icCtx.moveTo(margin.left, y);
                icCtx.lineTo(margin.left + width, y);
                icCtx.stroke();
            }
            
            // Axes
            icCtx.strokeStyle = '#a0aec0';
            icCtx.lineWidth = 2;
            icCtx.beginPath();
            icCtx.moveTo(margin.left, margin.top);
            icCtx.lineTo(margin.left, margin.top + height);
            icCtx.lineTo(margin.left + width, margin.top + height);
            icCtx.stroke();
            
            // Labels
            icCtx.fillStyle = '#718096';
            icCtx.font = '10px Segoe UI';
            icCtx.textAlign = 'center';
            for (let i = 0; i <= 4; i++) {
                icCtx.fillText((i * maxX / 4).toFixed(0), toX(i * maxX / 4), margin.top + height + 15);
            }
            icCtx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                icCtx.fillText((i * maxY / 4).toFixed(0), margin.left - 5, toY(i * maxY / 4) + 4);
            }
            
            icCtx.fillStyle = '#4a5568';
            icCtx.font = '11px Segoe UI';
            icCtx.textAlign = 'center';
            icCtx.fillText('Good X', margin.left + width / 2, icCanvas.height - 5);
            icCtx.save();
            icCtx.translate(12, margin.top + height / 2);
            icCtx.rotate(-Math.PI / 2);
            icCtx.fillText('Good Y', 0, 0);
            icCtx.restore();
            
            // Budget constraint intercepts
            const xInt = marketParams.income / marketParams.priceX;
            const yInt = marketParams.income / marketParams.priceY;
            
            // Feasible region
            icCtx.fillStyle = 'rgba(72, 187, 120, 0.1)';
            icCtx.beginPath();
            icCtx.moveTo(toX(0), toY(0));
            icCtx.lineTo(toX(0), toY(Math.min(yInt, maxY)));
            if (xInt <= maxX && yInt <= maxY) {
                icCtx.lineTo(toX(xInt), toY(0));
            } else if (xInt > maxX) {
                const yAtMaxX = (marketParams.income - marketParams.priceX * maxX) / marketParams.priceY;
                icCtx.lineTo(toX(maxX), toY(Math.max(0, yAtMaxX)));
                icCtx.lineTo(toX(maxX), toY(0));
            }
            icCtx.closePath();
            icCtx.fill();
            
            // Budget line
            icCtx.strokeStyle = '#e53e3e';
            icCtx.lineWidth = 3;
            icCtx.beginPath();
            icCtx.moveTo(toX(0), toY(Math.min(yInt, maxY)));
            icCtx.lineTo(toX(Math.min(xInt, maxX)), toY(0));
            icCtx.stroke();
            
            // Optimal bundle IC (dashed, gold)
            const opt = optimalBundle();
            if (opt.utility > 0) {
                icCtx.strokeStyle = 'rgba(214, 158, 46, 0.5)';
                icCtx.lineWidth = 2;
                icCtx.setLineDash([6, 4]);
                icCtx.beginPath();
                let started = false;
                for (let x = 0.5; x <= maxX; x += 0.5) {
                    const y = getICY(x, opt.utility);
                    if (y !== null && y > 0 && y <= maxY) {
                        if (!started) { icCtx.moveTo(toX(x), toY(y)); started = true; }
                        else icCtx.lineTo(toX(x), toY(y));
                    }
                }
                icCtx.stroke();
                icCtx.setLineDash([]);
            }
            
            // Player's IC
            const playerU = utility(playerX, playerY);
            const affordable = isAffordable(playerX, playerY);
            
            if (playerU > 0) {
                icCtx.strokeStyle = affordable ? '#3182ce' : '#a0aec0';
                icCtx.lineWidth = 3;
                icCtx.beginPath();
                let started = false;
                for (let x = 0.5; x <= maxX; x += 0.5) {
                    const y = getICY(x, playerU);
                    if (y !== null && y > 0 && y <= maxY) {
                        if (!started) { icCtx.moveTo(toX(x), toY(y)); started = true; }
                        else icCtx.lineTo(toX(x), toY(y));
                    }
                }
                icCtx.stroke();
            }
            
            // Optimal point
            if (opt.x <= maxX && opt.y <= maxY) {
                icCtx.fillStyle = 'rgba(214, 158, 46, 0.3)';
                icCtx.beginPath();
                icCtx.arc(toX(opt.x), toY(opt.y), 12, 0, Math.PI * 2);
                icCtx.fill();
                
                icCtx.fillStyle = '#d69e2e';
                icCtx.beginPath();
                icCtx.arc(toX(opt.x), toY(opt.y), 5, 0, Math.PI * 2);
                icCtx.fill();
                icCtx.strokeStyle = '#ffffff';
                icCtx.lineWidth = 1.5;
                icCtx.stroke();
            }
            
            // Player's point
            if (playerX <= maxX && playerY <= maxY) {
                // Glow
                const gradient = icCtx.createRadialGradient(toX(playerX), toY(playerY), 0, toX(playerX), toY(playerY), 18);
                gradient.addColorStop(0, affordable ? 'rgba(49, 130, 206, 0.5)' : 'rgba(229, 62, 62, 0.5)');
                gradient.addColorStop(1, affordable ? 'rgba(49, 130, 206, 0)' : 'rgba(229, 62, 62, 0)');
                icCtx.fillStyle = gradient;
                icCtx.beginPath();
                icCtx.arc(toX(playerX), toY(playerY), 18, 0, Math.PI * 2);
                icCtx.fill();
                
                // Point
                icCtx.fillStyle = affordable ? '#3182ce' : '#e53e3e';
                icCtx.beginPath();
                icCtx.arc(toX(playerX), toY(playerY), 8, 0, Math.PI * 2);
                icCtx.fill();
                icCtx.strokeStyle = '#ffffff';
                icCtx.lineWidth = 2;
                icCtx.stroke();
                
                // Dashed lines to axes
                icCtx.strokeStyle = '#a0aec0';
                icCtx.lineWidth = 1;
                icCtx.setLineDash([4, 3]);
                icCtx.beginPath();
                icCtx.moveTo(toX(playerX), toY(playerY));
                icCtx.lineTo(toX(playerX), toY(0));
                icCtx.stroke();
                icCtx.beginPath();
                icCtx.moveTo(toX(playerX), toY(playerY));
                icCtx.lineTo(toX(0), toY(playerY));
                icCtx.stroke();
                icCtx.setLineDash([]);
            }
            
            // Labels
            icCtx.font = 'bold 10px Segoe UI';
            icCtx.fillStyle = '#e53e3e';
            icCtx.textAlign = 'left';
            icCtx.fillText('Budget', toX(Math.min(xInt * 0.7, maxX * 0.6)), toY((yInt - (yInt/xInt) * Math.min(xInt * 0.7, maxX * 0.6))) - 8);
            
            if (opt.x <= maxX && opt.y <= maxY) {
                icCtx.fillStyle = '#d69e2e';
                icCtx.fillText('Optimal', toX(opt.x) + 10, toY(opt.y) - 5);
            }
            
            icCtx.fillStyle = '#3182ce';
            icCtx.fillText('You', toX(playerX) + 12, toY(playerY) + 4);
        }
        
        // Draw utility history chart
        function drawHistoryChart() {
            const margin = { top: 20, right: 15, bottom: 25, left: 40 };
            const width = historyCanvas.width - margin.left - margin.right;
            const height = historyCanvas.height - margin.top - margin.bottom;
            
            historyCtx.fillStyle = '#ffffff';
            historyCtx.fillRect(0, 0, historyCanvas.width, historyCanvas.height);
            
            const maxMonths = 12;
            const utilities = monthlyUtilities.slice(-maxMonths);
            
            // Calculate scale
            let maxU = 30;
            utilities.forEach(u => { if (u > maxU) maxU = u; });
            maxU = Math.ceil(maxU / 10) * 10 + 10;
            
            const toX = (i) => margin.left + ((i + 0.5) / maxMonths) * width;
            const toY = (u) => margin.top + height - (u / maxU) * height;
            const barWidth = (width / maxMonths) * 0.7;
            
            // Grid
            historyCtx.strokeStyle = '#edf2f7';
            historyCtx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = margin.top + (i / 4) * height;
                historyCtx.beginPath();
                historyCtx.moveTo(margin.left, y);
                historyCtx.lineTo(margin.left + width, y);
                historyCtx.stroke();
            }
            
            // Axes
            historyCtx.strokeStyle = '#a0aec0';
            historyCtx.lineWidth = 2;
            historyCtx.beginPath();
            historyCtx.moveTo(margin.left, margin.top);
            historyCtx.lineTo(margin.left, margin.top + height);
            historyCtx.lineTo(margin.left + width, margin.top + height);
            historyCtx.stroke();
            
            // Y-axis labels
            historyCtx.fillStyle = '#718096';
            historyCtx.font = '9px Segoe UI';
            historyCtx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const val = (i / 4) * maxU;
                historyCtx.fillText(val.toFixed(0), margin.left - 5, toY(val) + 3);
            }
            
            // X-axis label
            historyCtx.fillStyle = '#4a5568';
            historyCtx.font = '10px Segoe UI';
            historyCtx.textAlign = 'center';
            historyCtx.fillText('Month', margin.left + width / 2, historyCanvas.height - 3);
            
            // Get optimal utility for comparison
            const opt = optimalBundle();
            
            // Draw bars
            utilities.forEach((u, i) => {
                const x = toX(i) - barWidth / 2;
                const efficiency = opt.utility > 0 ? u / opt.utility : 0;
                
                let gradient;
                if (efficiency >= 0.9) {
                    gradient = historyCtx.createLinearGradient(x, toY(u), x, toY(0));
                    gradient.addColorStop(0, '#38a169');
                    gradient.addColorStop(1, '#68d391');
                } else if (efficiency >= 0.7) {
                    gradient = historyCtx.createLinearGradient(x, toY(u), x, toY(0));
                    gradient.addColorStop(0, '#d69e2e');
                    gradient.addColorStop(1, '#ecc94b');
                } else {
                    gradient = historyCtx.createLinearGradient(x, toY(u), x, toY(0));
                    gradient.addColorStop(0, '#e53e3e');
                    gradient.addColorStop(1, '#fc8181');
                }
                
                historyCtx.fillStyle = gradient;
                historyCtx.fillRect(x, toY(u), barWidth, toY(0) - toY(u));
                
                // Month number
                historyCtx.fillStyle = '#718096';
                historyCtx.font = '8px Segoe UI';
                historyCtx.textAlign = 'center';
                const monthNum = currentMonth - utilities.length + i + 1;
                if (monthNum > 0) {
                    historyCtx.fillText(monthNum.toString(), toX(i), margin.top + height + 12);
                }
            });
        }
        
        // Update display
        function updateDisplay() {
            const opt = optimalBundle();
            const playerU = utility(playerX, playerY);
            const affordable = isAffordable(playerX, playerY);
            const spent = spending(playerX, playerY);
            const efficiency = opt.utility > 0 ? (playerU / opt.utility) : 0;
            const effectiveUtility = affordable ? playerU : 0;
            
            // Update bundle display
            document.getElementById('current-x').textContent = playerX;
            document.getElementById('current-y').textContent = playerY;
            document.getElementById('display-px').textContent = marketParams.priceX.toFixed(2);
            document.getElementById('display-py').textContent = marketParams.priceY.toFixed(2);
            
            // Update budget
            document.getElementById('budget-spent').textContent = `$${spent.toFixed(0)}`;
            document.getElementById('budget-total').textContent = `$${marketParams.income.toFixed(0)}`;
            
            const budgetPct = (spent / marketParams.income) * 100;
            const budgetFill = document.getElementById('budget-fill');
            budgetFill.style.width = `${Math.min(budgetPct, 100)}%`;
            budgetFill.className = 'budget-fill ' + (budgetPct <= 85 ? 'under' : budgetPct <= 100 ? 'near' : 'over');
            
            document.getElementById('budget-warning').style.display = affordable ? 'none' : 'block';
            
            // Update utility display
            const utilityEl = document.getElementById('current-utility');
            if (affordable) {
                utilityEl.textContent = playerU.toFixed(1);
                utilityEl.className = 'utility-value';
            } else {
                utilityEl.textContent = 'OVER BUDGET!';
                utilityEl.className = 'utility-value invalid';
            }
            document.getElementById('optimal-utility').textContent = opt.utility.toFixed(1);
            
            // Update market info
            document.getElementById('info-px').textContent = `$${marketParams.priceX.toFixed(2)}`;
            document.getElementById('info-py').textContent = `$${marketParams.priceY.toFixed(2)}`;
            document.getElementById('info-income').textContent = `$${marketParams.income.toFixed(0)}`;
            document.getElementById('info-mrs').textContent = MRS(playerX, playerY).toFixed(2);
            
            // Update action points
            document.getElementById('ap-value').textContent = `${actionPoints} / ${maxActionPoints}`;
            document.getElementById('ap-fill').style.width = `${(actionPoints / maxActionPoints) * 100}%`;
            
            // Update buttons
            document.getElementById('btn-x-up').disabled = actionPoints < 1;
            document.getElementById('btn-x-down').disabled = actionPoints < 1 || playerX <= 5;
            document.getElementById('btn-y-up').disabled = actionPoints < 1;
            document.getElementById('btn-y-down').disabled = actionPoints < 1 || playerY <= 5;
            
            // Update monthly utility display
            const monthlyEl = document.getElementById('monthly-utility');
            monthlyEl.textContent = effectiveUtility.toFixed(1);
            monthlyEl.className = 'monthly-value ' + (efficiency >= 0.9 ? 'high' : efficiency >= 0.7 ? 'medium' : 'low');
            
            // Update efficiency
            const effPct = Math.min(100, efficiency * 100);
            document.getElementById('efficiency-value').textContent = `${effPct.toFixed(0)}%`;
            document.getElementById('efficiency-fill').style.width = `${effPct}%`;
            
            // Draw graphs
            drawICGraph();
            drawHistoryChart();
            
            return effectiveUtility;
        }
        
        // Change bundle
        function changeBundle(dx, dy) {
            if (actionPoints < 1) return;
            
            const newX = playerX + dx * 5;
            const newY = playerY + dy * 5;
            
            if (newX < 5 || newY < 5) return;
            
            actionPoints--;
            playerX = newX;
            playerY = newY;
            updateDisplay();
        }
        
        // Game loop
        let lastUpdate = Date.now();
        let monthProgress = 0;
        const monthDuration = 5000; // 5 seconds per month at 1x speed
        
        function gameLoop() {
            if (!gameRunning) {
                requestAnimationFrame(gameLoop);
                return;
            }
            
            const now = Date.now();
            const delta = now - lastUpdate;
            lastUpdate = now;
            
            // Recharge action points
            if (now - lastAPRecharge >= apRechargeTime / gameSpeed) {
                if (actionPoints < maxActionPoints) {
                    actionPoints++;
                    updateDisplay();
                }
                lastAPRecharge = now;
            }
            
            // Progress month
            monthProgress += delta * gameSpeed;
            
            if (monthProgress >= monthDuration) {
                monthProgress = 0;
                
                // Calculate this month's utility
                const affordable = isAffordable(playerX, playerY);
                const monthUtility = affordable ? utility(playerX, playerY) : 0;
                
                // Record utility
                monthlyUtilities.push(monthUtility);
                cumulativeUtility += monthUtility;
                currentMonth++;
                
                // Update cumulative display
                document.getElementById('cumulative-utility').textContent = cumulativeUtility.toFixed(0);
                document.getElementById('current-month').textContent = currentMonth;
                
                // Check high score at month 12
                if (currentMonth === 13) {
                    if (cumulativeUtility > highScore) {
                        highScore = cumulativeUtility;
                        document.getElementById('high-score').textContent = highScore.toFixed(0);
                    }
                    // Reset for next round
                    document.getElementById('news-text').textContent = `üéâ Year complete! Total utility: ${cumulativeUtility.toFixed(0)}. Starting new year...`;
                    document.getElementById('news-text').className = 'news-text shock-good';
                    currentMonth = 1;
                    cumulativeUtility = 0;
                    monthlyUtilities = [];
                } else {
                    // Generate random shock
                    generateShock();
                }
                
                updateDisplay();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Toggle game
        function toggleGame() {
            gameRunning = !gameRunning;
            const btn = document.getElementById('start-btn');
            
            if (gameRunning) {
                btn.textContent = '‚è∏Ô∏è Pause';
                btn.className = 'game-btn btn-pause';
                lastUpdate = Date.now();
                lastAPRecharge = Date.now();
                document.getElementById('news-text').textContent = 'üõí Game started! Adjust your consumption bundle to maximize utility!';
                document.getElementById('news-text').className = 'news-text shock-neutral';
            } else {
                btn.textContent = '‚ñ∂Ô∏è Resume';
                btn.className = 'game-btn btn-start';
                document.getElementById('news-text').textContent = '‚è∏Ô∏è Game paused.';
                document.getElementById('news-text').className = 'news-text shock-neutral';
            }
        }
        
        // Reset game
        function resetGame() {
            gameRunning = false;
            currentMonth = 1;
            cumulativeUtility = 0;
            monthlyUtilities = [];
            actionPoints = maxActionPoints;
            playerX = 20;
            playerY = 20;
            monthProgress = 0;
            
            // Reset market params
            marketParams = {
                priceX: 2.00,
                priceY: 2.00,
                income: 100,
                alpha: 0.5
            };
            
            document.getElementById('start-btn').textContent = '‚ñ∂Ô∏è Start';
            document.getElementById('start-btn').className = 'game-btn btn-start';
            document.getElementById('current-month').textContent = '1';
            document.getElementById('cumulative-utility').textContent = '0';
            document.getElementById('cumulative-utility').className = 'score-value good';
            document.getElementById('news-text').textContent = 'Game reset. Press Start to begin shopping!';
            document.getElementById('news-text').className = 'news-text shock-neutral';
            
            updateDisplay();
        }
        
        // Set game speed
        function setSpeed(speed) {
            gameSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === `${speed}x`) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Initialize
        updateDisplay();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
