<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üêü Fishing Commons 3D</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=JetBrains+Mono:wght@500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--ui-bg:rgba(11,29,53,0.92);--ui-border:rgba(79,195,247,0.25);--text:#e0e8f0;--text-dim:#7a9ab5;--boat-you:#4fc3f7;--boat-bot:#ef5350;--gold:#f6c643;--green:#4caf50;--red:#ef5350;--sidebar:300px;--rbar:280px}
body{background:#0b1d35;color:var(--text);font-family:'Fredoka',sans-serif;overflow:hidden;height:100vh;touch-action:none;user-select:none}
#gameWrap{display:contents}
#canvasWrap{display:contents}
#c{display:block;position:absolute;top:0;left:var(--sidebar);width:calc(100% - var(--sidebar) - var(--rbar));height:100%}
.sidebar,.rbar{position:absolute;top:0;height:100vh;background:var(--ui-bg);z-index:10;overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;backdrop-filter:blur(8px)}
.sidebar{left:0;width:var(--sidebar);border-right:1px solid var(--ui-border)}
.rbar{right:0;width:var(--rbar);border-left:1px solid var(--ui-border)}
.sidebar::-webkit-scrollbar,.rbar::-webkit-scrollbar{width:3px}
.sidebar::-webkit-scrollbar-thumb,.rbar::-webkit-scrollbar-thumb{background:rgba(79,195,247,.2);border-radius:2px}
.sb-section{padding:7px 10px;border-bottom:1px solid rgba(79,195,247,.1)}
.sb-title{font-size:.65rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:4px}
.sb-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.sb-label{font-size:.68rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.2px}
.sb-val{font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:700}
.stock-bar-outer{width:100%;height:10px;background:rgba(255,255,255,.08);border-radius:5px;overflow:hidden;position:relative;margin:3px 0}
.stock-bar-inner{height:100%;border-radius:5px;transition:width .3s,background .3s}
.allee-marker{position:absolute;top:0;height:100%;width:2px;background:rgba(255,165,0,.6);z-index:2}
.set-group{display:flex;align-items:center;gap:3px;margin-bottom:2px}
.set-label{font-size:.62rem;color:var(--text-dim);letter-spacing:.2px;text-transform:uppercase;white-space:nowrap;min-width:55px}
.set-btn{width:24px;height:24px;border:1px solid var(--ui-border);border-radius:4px;background:rgba(255,255,255,.06);color:var(--text);font-family:'Fredoka';font-size:.75rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.set-btn:hover{background:rgba(79,195,247,.2);border-color:var(--boat-you)}
.set-val{font-family:'JetBrains Mono',monospace;font-size:.75rem;font-weight:700;min-width:26px;text-align:center;color:var(--boat-you)}
.policy-grid{display:flex;flex-wrap:wrap;gap:3px}
.policy-btn{padding:3px 7px;border:1px solid var(--ui-border);border-radius:4px;background:rgba(255,255,255,.05);color:var(--text-dim);font-family:'Fredoka';font-size:.62rem;font-weight:600;cursor:pointer;transition:all .12s;white-space:nowrap}
.policy-btn:hover{background:rgba(79,195,247,.15);color:var(--text)}
.policy-btn.active{background:rgba(79,195,247,.2);border-color:var(--boat-you);color:var(--boat-you)}
.chk-group{display:flex;align-items:center;gap:4px;margin-top:2px}
.chk-group label{font-size:.62rem;color:var(--text-dim);text-transform:uppercase;cursor:pointer}
.chk-group input[type="checkbox"]{accent-color:var(--boat-you);cursor:pointer;width:14px;height:14px}
.graph-box{margin-bottom:4px}
.graph-title{font-size:.55rem;text-transform:uppercase;letter-spacing:.4px;color:var(--text-dim);margin-bottom:2px;display:flex;justify-content:space-between}
.graph-title .gt-val{color:var(--text);font-family:'JetBrains Mono',monospace;font-weight:700;font-size:.6rem}
.graph-box canvas{width:100%;height:44px;display:block;border-radius:3px;background:rgba(15,40,71,.3)}
.welfare-box{background:rgba(246,198,67,.06);border:1px solid rgba(246,198,67,.25);border-radius:6px;padding:6px 8px}
.welfare-box .wf-val{font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:700;color:var(--gold)}
.timer-bar{width:100%;height:6px;background:rgba(255,255,255,.08);border-radius:3px;margin:3px 0;overflow:hidden}
.timer-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--boat-you),var(--gold));transition:width .5s}
.insight-text{font-size:.6rem;line-height:1.3;color:var(--text-dim)}.insight-text strong{color:var(--gold)}
.controls-hint{font-size:.58rem;color:var(--text-dim);line-height:1.3;padding:6px 10px}
.controls-hint kbd{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:3px;padding:1px 3px;font-family:'JetBrains Mono';font-size:.55rem}
.placing-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(76,175,80,.2);border:2px solid var(--green);border-radius:12px;padding:14px 24px;font-size:1rem;font-weight:600;color:var(--green);pointer-events:none;display:none;z-index:15;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
.game-alert{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--ui-bg);border:2px solid var(--gold);border-radius:14px;padding:24px 32px;text-align:center;backdrop-filter:blur(12px);display:none;pointer-events:auto;z-index:20;max-width:520px;min-width:340px}
.game-alert.show{display:block;animation:popIn .3s ease}
@keyframes popIn{from{opacity:0;transform:translate(-50%,-50%) scale(.9)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
.game-alert h2{font-size:1.3rem;margin-bottom:8px}
.game-alert p{color:var(--text-dim);font-size:.82rem;margin-bottom:8px;line-height:1.35}
.game-alert .score-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;text-align:left;margin:10px 0;font-size:.75rem}
.game-alert .sg-label{color:var(--text-dim);text-transform:uppercase;font-size:.58rem;letter-spacing:.4px}
.game-alert .sg-val{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:.88rem}
.game-alert .verify{font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--text-dim);background:rgba(255,255,255,.05);padding:4px 8px;border-radius:4px;margin-top:8px;word-break:break-all}
.game-alert .highscore{color:var(--gold);font-weight:700;font-size:.78rem;margin-top:6px}
.restart-btn{padding:8px 20px;border:2px solid var(--boat-you);border-radius:7px;background:rgba(79,195,247,.15);color:var(--boat-you);font-family:'Fredoka';font-size:.88rem;font-weight:700;cursor:pointer;margin-top:8px}
.restart-btn:hover{background:rgba(79,195,247,.3)}
.boat-info{position:absolute;pointer-events:auto;z-index:15;background:var(--ui-bg);border:1px solid var(--ui-border);border-radius:8px;padding:10px 14px;backdrop-filter:blur(8px);display:none;min-width:240px;font-size:.75rem;line-height:1.35}
.boat-info.show{display:block}
.boat-info h3{font-size:.9rem;margin-bottom:4px;color:var(--boat-you)}
.boat-info .bi-row{display:flex;justify-content:space-between;gap:8px}
.boat-info .bi-label{color:var(--text-dim);text-transform:uppercase;font-size:.56rem}
.boat-info .bi-val{font-family:'JetBrains Mono',monospace;font-weight:700}
.boat-info .bi-bar{height:5px;background:rgba(255,255,255,.08);border-radius:3px;margin:3px 0}
.boat-info .bi-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.boat-info .bi-close{position:absolute;top:4px;right:6px;cursor:pointer;color:var(--text-dim);font-size:.9rem}
body.basic-mode .adv-only{display:none!important}
body.basic-mode .rbar{width:230px}
body.basic-mode #c{width:calc(100% - var(--sidebar) - 230px);left:var(--sidebar)}
.how-to-play{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--ui-bg);border:2px solid var(--boat-you);border-radius:14px;padding:28px 36px;text-align:left;backdrop-filter:blur(12px);z-index:25;max-width:560px;min-width:380px;pointer-events:auto;animation:popIn .3s ease}
.how-to-play h2{font-size:1.4rem;color:var(--boat-you);margin-bottom:10px;text-align:center}
.how-to-play p{color:var(--text-dim);font-size:.8rem;margin-bottom:8px;line-height:1.45}
.how-to-play .htp-section{margin-bottom:10px}
.how-to-play .htp-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.6px;color:var(--gold);font-weight:700;margin-bottom:3px}
.how-to-play kbd{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);border-radius:3px;padding:2px 5px;font-family:'JetBrains Mono';font-size:.65rem}
.how-to-play .start-btn{display:block;margin:12px auto 0;padding:10px 28px;border:2px solid var(--boat-you);border-radius:8px;background:rgba(79,195,247,.15);color:var(--boat-you);font-family:'Fredoka';font-size:1rem;font-weight:700;cursor:pointer;transition:all .15s}
.how-to-play .start-btn:hover{background:rgba(79,195,247,.3)}
/* Mobile touch controls overlay */
.touch-controls{display:none;position:absolute;z-index:12;pointer-events:none}
.touch-col{position:absolute;bottom:16px;display:flex;flex-direction:column;gap:8px;pointer-events:auto;touch-action:none}
.touch-col.tc-left{left:14px}
.touch-col.tc-right{right:14px;flex-direction:row;gap:10px}
.touch-btn{width:52px;height:52px;border:2px solid rgba(79,195,247,.5);border-radius:14px;background:rgba(11,29,53,.5);color:var(--boat-you);font-size:1.3rem;font-weight:700;display:flex;align-items:center;justify-content:center;touch-action:none;user-select:none;backdrop-filter:blur(4px)}
.touch-btn:active,.touch-btn.pressed{background:rgba(79,195,247,.35);border-color:var(--boat-you)}
/* Mobile layout */
@media(max-width:900px){
    body{overflow:auto;height:auto}
    #gameWrap{display:flex;flex-direction:column;width:100%;min-height:100vh}
    #canvasWrap{order:1;position:relative;flex-shrink:0}
    body.basic-mode .rbar{width:100%}
    body.basic-mode #c{width:100%;left:0}
    .sidebar,.rbar{position:relative;width:100%!important;height:auto;border:none;border-bottom:1px solid var(--ui-border);flex-shrink:0}
    .sidebar{order:2;flex-direction:row;flex-wrap:wrap}
    .sidebar .sb-section{flex:1 1 auto;min-width:140px}
    .rbar{order:3;flex-direction:row;flex-wrap:wrap}
    .rbar .sb-section{flex:1 1 auto;min-width:140px}
    #c{position:relative!important;left:0!important;width:100%!important;height:55vw!important;min-height:240px;max-height:400px}
    .touch-controls{display:block;position:absolute;top:0;left:0;width:100%;height:100%}
    .game-alert,.how-to-play{position:fixed;max-width:92vw;min-width:0;max-height:85vh;overflow-y:auto;padding:16px 18px}
    .how-to-play{min-width:0;max-width:92vw;padding:16px 18px}
    .how-to-play h2{font-size:1.1rem;margin-bottom:6px}
    .how-to-play p{font-size:.7rem;margin-bottom:5px;line-height:1.35}
    .how-to-play .htp-section{margin-bottom:6px}
    .how-to-play .htp-label{font-size:.55rem;margin-bottom:2px}
    .how-to-play kbd{font-size:.55rem;padding:1px 3px}
    .how-to-play .start-btn{padding:8px 20px;font-size:.85rem;margin-top:8px}
    .game-alert h2{font-size:1.1rem;margin-bottom:5px}
    .game-alert p{font-size:.72rem;margin-bottom:5px}
    .game-alert .score-grid{gap:2px 8px;font-size:.65rem;margin:6px 0}
    .game-alert .sg-label{font-size:.5rem}
    .game-alert .sg-val{font-size:.75rem}
    .game-alert .verify{font-size:.5rem;padding:3px 6px}
    .restart-btn{padding:6px 14px;font-size:.78rem}
    .boat-info{position:fixed;max-width:85vw;font-size:.65rem}
    .placing-indicator{position:fixed}
    .controls-hint{display:none}
}
</style>
</head>
<body>
<div id="gameWrap">
<div id="canvasWrap" style="position:relative">
<canvas id="c"></canvas>
<div class="touch-controls" id="touchControls">
    <div class="touch-col tc-left">
        <div class="touch-btn" data-tdir="w">‚ñ≤</div>
        <div class="touch-btn" data-tdir="s">‚ñº</div>
    </div>
    <div class="touch-col tc-right">
        <div class="touch-btn" data-tdir="a">‚óÄ</div>
        <div class="touch-btn" data-tdir="d">‚ñ∂</div>
    </div>
</div>
</div>
<div class="sidebar">
    <div class="sb-section">
        <div class="sb-title">Scenarios</div>
        <div class="policy-grid" id="scenarioGrid">
            <div class="policy-btn active" data-scenario="freeplay">0: Free Play</div>
            <div class="policy-btn" data-scenario="simple">1: Simple</div>
            <div class="policy-btn" data-scenario="solo">2: Solo</div>
            <div class="policy-btn" data-scenario="freeentry">3: Free Entry</div>
            <div class="policy-btn" data-scenario="fast">4: Speed</div>
            <div class="policy-btn" data-scenario="policy">5: Policy</div>
            <div class="policy-btn" data-scenario="hype">6: Hype</div>
            <div class="policy-btn" data-scenario="pirate">7: Pirate</div>
            <div class="policy-btn" data-scenario="sharks">8: Sharks</div>
        </div>
        <div id="scenarioBestScores" style="margin-top:4px;font-size:.42rem;color:var(--text-dim);line-height:1.4;font-family:'JetBrains Mono',monospace"></div>
    </div>
    <div class="sb-section">
        <div class="sb-title">Policy</div>
        <div class="policy-grid">
            <div class="policy-btn active" data-policy="open">üåä Open</div>
            <div class="policy-btn" data-policy="tax">üí∞ Tax</div>
            <div class="policy-btn" data-policy="sanctuary">üèùÔ∏è Sanctuary</div>
        </div>
        <div class="set-group" style="margin-top:3px"><span class="set-label">Tax</span><div class="set-btn" id="taxMinus">‚àí</div><span class="set-val" id="taxVal">$0</span><div class="set-btn" id="taxPlus">+</div></div>
    </div>
    <div class="sb-section adv-only" data-mode="advanced">
        <div class="sb-title">Parameters</div>
        <div class="set-group"><span class="set-label">Boats</span><div class="set-btn" id="boatMinus">‚àí</div><span class="set-val" id="boatVal">2</span><div class="set-btn" id="boatPlus">+</div></div>
        <div class="set-group"><span class="set-label">Speed</span><div class="set-btn" id="spdMinus">‚àí</div><span class="set-val" id="spdVal">8</span><div class="set-btn" id="spdPlus">+</div></div>
        <div class="set-group"><span class="set-label">Momentum</span><div class="set-btn" id="momMinus">‚àí</div><span class="set-val" id="momVal">2</span><div class="set-btn" id="momPlus">+</div></div>
        <div class="set-group"><span class="set-label">Size</span><div class="set-btn" id="sizeMinus">‚àí</div><span class="set-val" id="sizeVal">6</span><div class="set-btn" id="sizePlus">+</div></div>
        <div class="set-group"><span class="set-label">Fish Spd</span><div class="set-btn" id="fishSpdMinus">‚àí</div><span class="set-val" id="fishSpdVal">3</span><div class="set-btn" id="fishSpdPlus">+</div></div>
        <div class="set-group"><span class="set-label">Greed</span><div class="set-btn" id="greedMinus">‚àí</div><span class="set-val" id="greedVal">1</span><div class="set-btn" id="greedPlus">+</div></div>
        <div class="set-group"><span class="set-label">Hype</span><div class="set-btn" id="hypeMinus">‚àí</div><span class="set-val" id="hypeVal">3</span><div class="set-btn" id="hypePlus">+</div></div>
        <div class="set-group"><span class="set-label">Growth</span><div class="set-btn" id="growMinus">‚àí</div><span class="set-val" id="growVal">4</span><div class="set-btn" id="growPlus">+</div></div>
        <div class="set-group"><span class="set-label">Cap</span><div class="set-btn" id="capMinus">‚àí</div><span class="set-val" id="capVal">200</span><div class="set-btn" id="capPlus">+</div></div>
        <div class="set-group"><span class="set-label">Allee</span><div class="set-btn" id="alleeMinus">‚àí</div><span class="set-val" id="alleeVal">40%</span><div class="set-btn" id="alleePlus">+</div></div>
        <div class="set-group"><span class="set-label">Demand</span><div class="set-btn" id="demMinus">‚àí</div><span class="set-val" id="demVal">8</span><div class="set-btn" id="demPlus">+</div></div>
        <div class="set-group"><span class="set-label">School</span><div class="set-btn" id="schoolMinus">‚àí</div><span class="set-val" id="schoolVal">0</span><div class="set-btn" id="schoolPlus">+</div></div>
        <div class="chk-group"><input type="checkbox" id="spawnChk"><label for="spawnChk">Allow firms to enter</label></div>
        <div class="chk-group"><input type="checkbox" id="ramChk"><label for="ramChk">Enable ramming</label></div>
        <div class="chk-group"><input type="checkbox" id="sharkChk"><label for="sharkChk">Enable sharks</label></div>
        <div class="set-group"><span class="set-label">ü¶à Thresh</span><div class="set-btn" id="sharkThreshMinus">‚àí</div><span class="set-val" id="sharkThreshVal">100</span><div class="set-btn" id="sharkThreshPlus">+</div></div>
        <div class="set-group"><span class="set-label">ü¶à Speed</span><div class="set-btn" id="sharkSpdMinus">‚àí</div><span class="set-val" id="sharkSpdVal">7</span><div class="set-btn" id="sharkSpdPlus">+</div></div>
        <div style="margin-top:2px"><span class="sb-label">Shark Spawn</span>
            <div class="stock-bar-outer" style="height:8px"><div class="stock-bar-inner" id="sharkBar" style="width:0%;background:linear-gradient(90deg,#ff5722,#d32f2f)"></div></div>
            <div style="display:flex;justify-content:space-between;font-size:.38rem;font-family:'JetBrains Mono',monospace;color:var(--text-dim)"><span id="sharkProgress">0%</span><span id="sharkCount">ü¶à 0</span></div>
        </div>
        <div style="margin-top:3px"><div class="set-btn" id="resetFishBtn" style="width:auto;padding:2px 7px;font-size:.44rem">üîÑ Reset Fish</div></div>
    </div>
    <div class="sb-section adv-only" data-mode="advanced"><div class="insight-text" id="insightPanel"></div></div>
    <div class="sb-section" style="padding:4px 7px">
        <div class="chk-group"><input type="checkbox" id="fpvChk"><label for="fpvChk">First-person camera</label></div>
    </div>
    <div class="sb-section" style="padding:4px 7px">
        <div class="set-btn" id="modeToggleBtn" style="width:100%;padding:4px 8px;font-size:.5rem;text-align:center;cursor:pointer;border-color:var(--gold);color:var(--gold)">‚öôÔ∏è Advanced Mode</div>
    </div>
    <div class="controls-hint"><kbd>WASD</kbd> move ¬∑ <kbd>MMB</kbd> rotate ¬∑ <kbd>Scroll</kbd> zoom ¬∑ Click boat</div>
</div>
<div class="rbar">
    <div class="sb-section">
        <div class="sb-title">‚è±Ô∏è Scenario</div>
        <div class="sb-row"><span class="sb-label" id="scenarioName">Free Play</span><span class="sb-val" id="scenarioTimer" style="color:var(--boat-you)">1:00</span></div>
        <div class="timer-bar"><div class="timer-bar-fill" id="timerBar" style="width:100%"></div></div>
        <div class="sb-row"><span class="sb-label" id="scenarioProgress" style="font-family:'JetBrains Mono',monospace;font-size:.44rem;color:var(--text-dim)">0% complete</span><span class="sb-val" style="color:var(--gold)" id="highScore">‚Äî</span></div>
        <div style="font-size:.38rem;color:var(--text-dim);text-align:right">High Score</div>
    </div>
    <div class="sb-section">
        <div class="sb-row"><span class="sb-label">Profit</span><span class="sb-val" style="color:var(--gold)" id="yourProfit">$0</span></div>
        <div class="sb-row"><span class="sb-label">$/sec</span><span class="sb-val" style="color:var(--gold)" id="profitRate">0</span></div>
        <div class="sb-row"><span class="sb-label">Market Price</span><span class="sb-val" style="color:var(--green)" id="marketPriceBasic">$20.0</span></div>
    </div>
    <div class="sb-section">
        <div class="welfare-box">
            <div class="sb-row"><span class="sb-label">Total Welfare</span><span class="wf-val" id="totalWelfare">$0</span></div>
            <div class="sb-row" style="margin-top:2px"><span class="sb-label">Catch Revenue</span><span class="sb-val" style="color:var(--green);font-size:.78rem" id="catchRevenue">$0</span></div>
            <div class="sb-row"><span class="sb-label">Fish Stock NPV</span><span class="sb-val" style="color:var(--boat-you);font-size:.78rem" id="fishNPV">$0</span></div>
            <div class="set-group" style="margin-top:3px"><span class="set-label" style="font-size:.55rem">Discount</span><div class="set-btn" id="discMinus" style="width:20px;height:20px;font-size:.65rem">‚àí</div><span class="set-val" id="discVal" style="font-size:.65rem">5%</span><div class="set-btn" id="discPlus" style="width:20px;height:20px;font-size:.65rem">+</div></div>
        </div>
    </div>
    <div class="sb-section">
        <div class="sb-title">Fish Stock</div>
        <div class="stock-bar-outer"><div class="stock-bar-inner" id="stockBar"></div><div class="allee-marker" id="alleeMarker" style="left:40%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:.42rem;font-family:'JetBrains Mono',monospace;color:var(--text-dim)"><span id="stockCount" style="color:var(--text);font-weight:700">200/200</span><span id="stockStatus">üü¢</span></div>
    </div>
    <div class="sb-section adv-only" data-mode="advanced">
        <div class="sb-title">Details</div>
        <div class="sb-row"><span class="sb-label">Catch</span><span class="sb-val" style="color:var(--boat-you)" id="yourCatch">0</span></div>
        <div class="sb-row"><span class="sb-label">Time</span><span class="sb-val" id="gameTime">0:00</span></div>
        <div class="sb-row"><span class="sb-label">Boats (active/total)</span><span class="sb-val" style="color:var(--boat-bot)" id="activeBoats">0</span></div>
        <div class="sb-row"><span class="sb-label">Price</span><span class="sb-val" style="color:var(--green)" id="fishPrice">$12.0</span></div>
    </div>
    <div class="sb-section adv-only" data-mode="advanced">
        <div class="sb-title">Charts</div>
        <div class="graph-box"><div class="graph-title"><span>Welfare $/s</span><span class="gt-val" id="gWelfareVal">0</span></div><canvas id="gWelfare"></canvas></div>
        <div class="graph-box"><div class="graph-title"><span>Your $/s</span><span class="gt-val" id="gProfitVal">0</span></div><canvas id="gProfit"></canvas></div>
        <div class="graph-box"><div class="graph-title"><span>Fish</span><span class="gt-val" id="gStockVal">200</span></div><canvas id="gStock"></canvas></div>
        <div class="graph-box"><div class="graph-title"><span>Growth</span><span class="gt-val" id="gGrowthVal">0</span></div><canvas id="gGrowth"></canvas></div>
        <div class="graph-box"><div class="graph-title"><span>S&amp;D</span><span class="gt-val" id="gMarketVal">$12</span></div><canvas id="gMarket" style="height:60px"></canvas></div>
        <div class="graph-box"><div class="graph-title"><span>Price</span><span class="gt-val" id="gPriceVal">$12</span></div><canvas id="gPrice"></canvas></div>
        <div class="graph-box"><div class="graph-title"><span>Boats</span><span class="gt-val" id="gBoatsVal">0</span></div><canvas id="gBoats"></canvas></div>
    </div>
</div>
</div><!-- /gameWrap -->
<div class="placing-indicator" id="placingIndicator">üèùÔ∏è Click ocean to place sanctuary</div>
<div class="how-to-play" id="howToPlay">
    <h2>üêü Fishing Commons</h2>
    <div class="htp-section">
        <div class="htp-label">Goal</div>
        <p>You are a fishing boat captain. Catch fish to earn profit ‚Äî but if everyone overfishes, the stock collapses and nobody wins. Balance your greed against the health of the commons.</p>
    </div>
    <div class="htp-section">
        <div class="htp-label">Controls</div>
        <p><kbd>W</kbd> / <kbd>‚Üë</kbd> accelerate forward ¬∑ <kbd>S</kbd> / <kbd>‚Üì</kbd> reverse<br>
        <kbd>A</kbd> / <kbd>‚Üê</kbd> turn left ¬∑ <kbd>D</kbd> / <kbd>‚Üí</kbd> turn right<br>
        <kbd>MMB</kbd> drag to rotate camera ¬∑ <kbd>Scroll</kbd> to zoom<br>
        On mobile: use the on-screen d-pad</p>
    </div>
    <div class="htp-section">
        <div class="htp-label">How It Works</div>
        <p>Sail near fish to catch them automatically. Each fish earns the market price (shown on the right). As more fish are caught, the price drops. AI boats will enter and exit the fishery based on profitability.</p>
    </div>
    <div class="htp-section">
        <div class="htp-label">Scenarios</div>
        <p>Try each scenario on the left ‚Äî from solo fishing to managing policy with taxes and sanctuaries. Each has a 90-second timer. Your profit is your score!</p>
    </div>
    <button class="start-btn" id="startPlayBtn">üé£ Start Fishing!</button>
</div>
<div class="boat-info" id="boatInfo">
    <span class="bi-close" id="biClose">‚úï</span>
    <h3 id="biName">Boat #1</h3>
    <div class="bi-row"><span class="bi-label">Status</span><span class="bi-val" id="biStatus">Fishing</span></div>
    <div class="bi-row"><span class="bi-label">Catch</span><span class="bi-val" id="biCatch">0</span></div>
    <div class="bi-row"><span class="bi-label">Revenue/s</span><span class="bi-val" id="biRevenue">$0</span></div>
    <div class="bi-row"><span class="bi-label">Cost/s</span><span class="bi-val" id="biCost">$3</span></div>
    <div class="bi-row"><span class="bi-label">Econ Profit/s</span><span class="bi-val" id="biProfit">$0</span></div>
    <div class="bi-row"><span class="bi-label">Greed</span><span class="bi-val" id="biGreed">0.5</span></div>
    <div style="margin-top:3px"><span class="bi-label">Shutdown Risk</span>
        <div class="bi-bar"><div class="bi-bar-fill" id="biShutdownBar" style="width:0%;background:#ef5350"></div></div>
    </div>
    <div><span class="bi-label">Exit Risk</span>
        <div class="bi-bar"><div class="bi-bar-fill" id="biExitBar" style="width:0%;background:#ff9800"></div></div>
    </div>
    <div style="margin-top:2px;font-size:.42rem;color:var(--text-dim)" id="biHistory"></div>
</div>
<div class="game-alert" id="collapseAlert"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
(function(){
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THREE.JS SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const W3=800, H3=800;
const WORLD_CX=W3/2, WORLD_CZ=H3/2, WORLD_R=380;
const SIDEBAR_W=300,RBAR_W=280;
let advancedMode=false; // declared early for resize handler
const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
if(window.innerWidth<=900){
    const w=window.innerWidth;
    const h=Math.min(420,Math.max(260,w*0.55));
    renderer.setSize(w,h);
} else {
    renderer.setSize(window.innerWidth-SIDEBAR_W-RBAR_W,window.innerHeight);
}
renderer.setClearColor(0x0b1d35);

const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x0b1d35,0.0008);

const camera=new THREE.PerspectiveCamera(50,
    window.innerWidth<=900?(window.innerWidth/Math.min(420,Math.max(260,window.innerWidth*0.55))):((window.innerWidth-SIDEBAR_W-RBAR_W)/window.innerHeight),
    1,5000);
camera.position.set(W3/2,700,H3/2+500);
camera.lookAt(W3/2,0,H3/2);

window.addEventListener('resize',()=>{
    if(window.innerWidth<=900){
        // Mobile: canvas fills width, fixed height
        const cvs=document.getElementById('c');
        const w=window.innerWidth;
        const h=Math.min(420,Math.max(260,window.innerWidth*0.55));
        camera.aspect=w/h;
        camera.updateProjectionMatrix();
        renderer.setSize(w,h);
    } else {
        const rbarW=advancedMode?280:230;
        camera.aspect=(window.innerWidth-SIDEBAR_W-rbarW)/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth-SIDEBAR_W-rbarW,window.innerHeight);
    }
});

// ‚îÄ‚îÄ Sound system ‚îÄ‚îÄ
let audioCtx=null;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function playTone(freq,vol,dur,type){
    try{initAudio();const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
    osc.type=type||'sine';osc.frequency.value=freq;
    gain.gain.setValueAtTime(vol,audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
    osc.connect(gain);gain.connect(audioCtx.destination);osc.start();osc.stop(audioCtx.currentTime+dur);}catch(e){}
}
function playCatchSound(isPlayer){
    if(isPlayer){playTone(880,0.15,0.12,'sine');setTimeout(()=>playTone(1100,0.12,0.15,'sine'),60);setTimeout(()=>playTone(1320,0.08,0.2,'sine'),120);}
    else{playTone(440,0.03,0.06,'triangle');}
}

// ‚îÄ‚îÄ Camera controls (manual: MMB rotate, RMB pan, scroll zoom) ‚îÄ‚îÄ
const camTarget=new THREE.Vector3(W3/2,0,H3/2);
let camDist=550, camTheta=0, camPhi=Math.PI/4.5;
let dragging=0; // 0=none,1=middle(rotate),2=right(pan)
let dragStart={x:0,y:0};
let camFollowPlayer=true; // snap camera to player when moving
let fpvMode=false; // first-person camera view
let fpvDist=55; // distance behind boat in FPV
let fpvHeightBase=32; // base height in FPV
let fpvAngleOffset=0; // horizontal rotation offset in FPV
let fpvSmoothedAngle=0; // smoothed version of player angle for camera

function updateCamera(){
    const x=camTarget.x+camDist*Math.sin(camPhi)*Math.sin(camTheta);
    const y=camTarget.y+camDist*Math.cos(camPhi);
    const z=camTarget.z+camDist*Math.sin(camPhi)*Math.cos(camTheta);
    camera.position.set(x,y,z);
    camera.lookAt(camTarget);
}
updateCamera();

const cvs=renderer.domElement;
cvs.addEventListener('mousedown',e=>{
    if(e.button===1){dragging=1;dragStart={x:e.clientX,y:e.clientY};if(!fpvMode)camFollowPlayer=false;e.preventDefault();}
    if(e.button===2){dragging=2;dragStart={x:e.clientX,y:e.clientY};if(!fpvMode)camFollowPlayer=false;e.preventDefault();}
});
window.addEventListener('mousemove',e=>{
    if(dragging===1){
        if(fpvMode){
            // In FPV: rotate around the boat
            fpvAngleOffset+=(e.clientX-dragStart.x)*0.005;
            fpvHeightBase=Math.max(5,Math.min(120,fpvHeightBase-(e.clientY-dragStart.y)*0.3));
        } else {
            camTheta+=(e.clientX-dragStart.x)*0.005;
            camPhi=Math.max(0.1,Math.min(Math.PI/2-0.05,camPhi-(e.clientY-dragStart.y)*0.005));
        }
        dragStart={x:e.clientX,y:e.clientY};
        if(!fpvMode)updateCamera();
    }
    if(dragging===2){
        if(fpvMode){
            // In FPV: same as rotate
            fpvAngleOffset+=(e.clientX-dragStart.x)*0.005;
            fpvHeightBase=Math.max(5,Math.min(120,fpvHeightBase-(e.clientY-dragStart.y)*0.3));
        } else {
            const camRight=new THREE.Vector3();
            camRight.crossVectors(camera.getWorldDirection(new THREE.Vector3()),new THREE.Vector3(0,1,0)).normalize();
            const camFwd=new THREE.Vector3();
            camFwd.crossVectors(new THREE.Vector3(0,1,0),camRight).normalize();
            const dx=-(e.clientX-dragStart.x)*camDist*0.002;
            const dz=-(e.clientY-dragStart.y)*camDist*0.002;
            camTarget.add(camRight.multiplyScalar(dx));
            camTarget.add(camFwd.multiplyScalar(dz));
        }
        dragStart={x:e.clientX,y:e.clientY};
        if(!fpvMode)updateCamera();
    }
});
window.addEventListener('mouseup',()=>{dragging=0;});
cvs.addEventListener('wheel',e=>{
    if(fpvMode){
        // In FPV: zoom changes distance behind boat
        fpvDist=Math.max(15,Math.min(200,fpvDist+e.deltaY*0.08));
    } else {
        camDist=Math.max(150,Math.min(2500,camDist+e.deltaY*0.5));
        camFollowPlayer=false;
    }
    if(!fpvMode)updateCamera();
    e.preventDefault();
},{passive:false});
cvs.addEventListener('contextmenu',e=>e.preventDefault());

// ‚îÄ‚îÄ Lights ‚îÄ‚îÄ
scene.add(new THREE.AmbientLight(0x8899bb,0.6));
const sun=new THREE.DirectionalLight(0xffeedd,0.9);
sun.position.set(300,500,200);scene.add(sun);
const hemi=new THREE.HemisphereLight(0x88bbff,0x225588,0.3);scene.add(hemi);

// ‚îÄ‚îÄ Water: circular disc ‚îÄ‚îÄ
const waterGeo=new THREE.CircleGeometry(WORLD_R+30,80);
const waterMat=new THREE.MeshStandardMaterial({color:0x1a6a8a,transparent:true,opacity:0.32,roughness:0.15,metalness:0.1,side:THREE.DoubleSide});
const waterMesh=new THREE.Mesh(waterGeo,waterMat);
waterMesh.rotation.x=-Math.PI/2;waterMesh.position.set(WORLD_CX,-2,WORLD_CZ);
scene.add(waterMesh);

// Sea floor with radial gradient via vertex colors
const floorGeo=new THREE.CircleGeometry(WORLD_R+50,64);
const floorColors=new Float32Array(floorGeo.attributes.position.count*3);
for(let i=0;i<floorGeo.attributes.position.count;i++){
    const px=floorGeo.attributes.position.getX(i),py=floorGeo.attributes.position.getY(i);
    const d=Math.hypot(px,py)/(WORLD_R+50);
    // Deep blue center ‚Üí teal edge
    floorColors[i*3]=0.02+d*0.04; floorColors[i*3+1]=0.08+d*0.12; floorColors[i*3+2]=0.12+d*0.08;
}
floorGeo.setAttribute('color',new THREE.BufferAttribute(floorColors,3));
const floorMat=new THREE.MeshStandardMaterial({vertexColors:true,roughness:0.9});
const floorMesh=new THREE.Mesh(floorGeo,floorMat);
floorMesh.rotation.x=-Math.PI/2;floorMesh.position.set(WORLD_CX,-30,WORLD_CZ);
scene.add(floorMesh);

// Seabed details: rocks, sand patches, kelp
const seabedGroup=new THREE.Group();scene.add(seabedGroup);
function addSeabedDetails(){
    const rockMat=new THREE.MeshStandardMaterial({color:0x3a4a3a,roughness:0.95});
    const rockMat2=new THREE.MeshStandardMaterial({color:0x4a5a4a,roughness:0.9});
    const kelpMat=new THREE.MeshStandardMaterial({color:0x1a5a2a,roughness:0.7,transparent:true,opacity:0.7});
    const kelpMat2=new THREE.MeshStandardMaterial({color:0x2a6a3a,roughness:0.7,transparent:true,opacity:0.6});
    const kelpMat3=new THREE.MeshStandardMaterial({color:0x1a7a3a,roughness:0.6,transparent:true,opacity:0.5});
    // Scatter rocks
    for(let i=0;i<40;i++){
        const p=randomInCircle();
        const sz=1.5+Math.random()*4;
        const geo=new THREE.DodecahedronGeometry(sz,0);
        const m=new THREE.Mesh(geo,Math.random()>0.5?rockMat:rockMat2);
        m.position.set(p.x,-28+Math.random()*3,p.z);
        m.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);
        m.scale.set(1,0.4+Math.random()*0.4,1);
        seabedGroup.add(m);
    }
    // Kelp/seaweed clusters (75)
    for(let i=0;i<75;i++){
        const p=randomInCircle();
        const cluster=new THREE.Group();
        const blades=2+Math.floor(Math.random()*5);
        const mats=[kelpMat,kelpMat2,kelpMat3];
        for(let j=0;j<blades;j++){
            const h=5+Math.random()*12;
            const geo=new THREE.PlaneGeometry(1.2+Math.random()*0.8,h);
            const m=new THREE.Mesh(geo,mats[Math.floor(Math.random()*3)]);
            m.position.set((Math.random()-.5)*4,-28+h/2,(Math.random()-.5)*4);
            m.rotation.y=Math.random()*Math.PI;
            m.rotation.x=(Math.random()-.5)*0.3;
            cluster.add(m);
        }
        cluster.position.set(p.x,0,p.z);
        cluster.userData.swayOffset=Math.random()*Math.PI*2;
        seabedGroup.add(cluster);
    }
}
addSeabedDetails();

// Boundary ring so you can see the edge
const ringOuterGeo=new THREE.RingGeometry(WORLD_R-2,WORLD_R+2,96);
const ringOuterMat=new THREE.MeshBasicMaterial({color:0x2277aa,transparent:true,opacity:0.3,side:THREE.DoubleSide});
const ringOuter=new THREE.Mesh(ringOuterGeo,ringOuterMat);
ringOuter.rotation.x=-Math.PI/2;ringOuter.position.set(WORLD_CX,0.2,WORLD_CZ);
scene.add(ringOuter);

// ‚îÄ‚îÄ Helper: 3D mesh builders ‚îÄ‚îÄ
function makeBoatMesh(color){
    // Boat faces -Z by default (matches angle=0 ‚Üí vx=0, vz=-1)
    // rotation.y = angle directly
    const g=new THREE.Group();
    const hullMat=new THREE.MeshStandardMaterial({color,roughness:0.4,metalness:0.15});
    const whiteMat=new THREE.MeshStandardMaterial({color:0xeeeeee,roughness:0.5});
    const darkMat=new THREE.MeshStandardMaterial({color:0x333333,roughness:0.7});

    // Hull: top-down profile in XZ plane, bow at -Z, stern at +Z
    // Build as extruded shape in XY, then rotate to lie in XZ
    const hullShape=new THREE.Shape();
    hullShape.moveTo(-2.5,6);   // stern-left (wide)
    hullShape.lineTo(2.5,6);    // stern-right
    hullShape.quadraticCurveTo(3.5,-2, 0,-8); // right side tapers to bow
    hullShape.quadraticCurveTo(-3.5,-2, -2.5,6); // left side back
    const hullGeo=new THREE.ExtrudeGeometry(hullShape,{depth:3,bevelEnabled:true,bevelThickness:0.3,bevelSize:0.2,bevelSegments:2});
    const hull=new THREE.Mesh(hullGeo,hullMat);
    hull.rotation.x=Math.PI/2; // lay flat: XY shape ‚Üí XZ world, extrude goes -Y (into water)
    hull.position.set(0,0,0);
    g.add(hull);

    // Deck
    const deckGeo=new THREE.BoxGeometry(5,0.3,12);
    const deck=new THREE.Mesh(deckGeo,whiteMat);
    deck.position.set(0,0.5,0);g.add(deck);

    // Cabin (slightly aft = +Z)
    const cabGeo=new THREE.BoxGeometry(3.5,3,4);
    const cab=new THREE.Mesh(cabGeo,new THREE.MeshStandardMaterial({color:0xdddddd,roughness:0.5}));
    cab.position.set(0,2.2,1.5);g.add(cab);

    // Roof
    const roofGeo=new THREE.BoxGeometry(3.9,0.3,4.4);
    const roof=new THREE.Mesh(roofGeo,darkMat);
    roof.position.set(0,3.75,1.5);g.add(roof);

    // Windows facing bow (-Z)
    const winMat=new THREE.MeshStandardMaterial({color:0xaaddff,emissive:0x88bbff,emissiveIntensity:0.4,transparent:true,opacity:0.8});
    for(let i=-1;i<=1;i++){
        const win=new THREE.Mesh(new THREE.PlaneGeometry(0.8,1.2),winMat);
        win.position.set(i*1.1,2.4,-0.52);
        // face -Z
        g.add(win);
    }

    // Mast (forward of cabin)
    const mastGeo=new THREE.CylinderGeometry(0.12,0.15,8,6);
    const mast=new THREE.Mesh(mastGeo,new THREE.MeshStandardMaterial({color:0xaaaaaa,roughness:0.6}));
    mast.position.set(0,4.7,-2);g.add(mast);

    // Flag
    const flagGeo=new THREE.PlaneGeometry(2.5,1.5);
    const flagMat=new THREE.MeshStandardMaterial({color,side:THREE.DoubleSide,emissive:color,emissiveIntensity:0.3});
    const flag=new THREE.Mesh(flagGeo,flagMat);
    flag.position.set(1.5,8.2,-2);g.add(flag);
    g.userData.flag=flag;

    // Bow rail
    const rail=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,2.5,4),new THREE.MeshStandardMaterial({color:0x999999,metalness:0.3}));
    rail.position.set(0,1.7,-5);g.add(rail);

    return g;
}

function makeFishMesh(color){
    // Fish faces -Z at rotation.y=0
    const g=new THREE.Group();
    const bodyMat=new THREE.MeshStandardMaterial({color,roughness:0.3,metalness:0.15,emissive:color,emissiveIntensity:0.3});
    // Body: elongated sphere, long axis = Z
    const bodyGeo=new THREE.SphereGeometry(1,10,8);
    bodyGeo.scale(1.1,0.9,2.5); // wide on Z
    const body=new THREE.Mesh(bodyGeo,bodyMat);g.add(body);
    // Tail fin ‚Äî at +Z (rear)
    const tailGeo=new THREE.ConeGeometry(1.2,2.5,4);
    const tail=new THREE.Mesh(tailGeo,bodyMat);
    tail.rotation.x=-Math.PI/2; // point +Z
    tail.position.set(0,0,3.5);g.add(tail);
    // Dorsal fin (points up)
    const finMat=new THREE.MeshStandardMaterial({color,roughness:0.4,transparent:true,opacity:0.8});
    const dorsal=new THREE.Mesh(new THREE.ConeGeometry(0.6,1.8,4),finMat);
    dorsal.position.set(0,1.2,0.3);g.add(dorsal);
    // Eyes (on sides, near front = -Z)
    const eyeWhiteMat=new THREE.MeshStandardMaterial({color:0xffffff});
    const eyePupilMat=new THREE.MeshStandardMaterial({color:0x111111});
    const eyeR=new THREE.Mesh(new THREE.SphereGeometry(0.3,6,6),eyeWhiteMat);eyeR.position.set(0.8,0.3,-1.8);g.add(eyeR);
    const pupilR=new THREE.Mesh(new THREE.SphereGeometry(0.15,6,6),eyePupilMat);pupilR.position.set(0.95,0.3,-2.0);g.add(pupilR);
    const eyeL=eyeR.clone();eyeL.position.x=-0.8;g.add(eyeL);
    const pupilL=pupilR.clone();pupilL.position.x=-0.95;g.add(pupilL);
    return g;
}

// ‚îÄ‚îÄ Game Constants ‚îÄ‚îÄ
let FISH_CAPACITY=200,ALLEE_FRAC=0.40,initialBotCount=2;
const GROWTH_LEVELS=[0.00009,0.000169,0.000338,0.000563,0.0009,0.001125,0.001688,0.00225,0.003375,0.005625,0.009,0.0135,0.02025,0.028125,0.045];
let growthIdx=0;let GROWTH_RATE=GROWTH_LEVELS[0];
const SPEED_LEVELS=[1.5,2,2.8,3.5,4.2,5,6,7.5,9,11,13,15,18,22,28];
let speedIdx=7; // default speed
const MOMENTUM_LEVELS=[0.92,0.94,0.96,0.975,0.985,0.99,0.994,0.997];
let momentumIdx=1; // default 2
const SIZE_LEVELS=[0.5,0.7,1,1.4,1.9,2.5,3.2,4];
let sizeIdx=5;
let taxRate=0,schoolStrength=0;
let discountRate=0.05; // annual discount rate for NPV
const FISH_SPEED_LEVELS=[0.15,0.3,0.5,0.7,1.0,1.4,1.8,2.5];
let fishSpeedIdx=2; // default 3
const GREED_LEVELS=[0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0];
let greedIdx=0; // default 1 (avg greed 0.1)
const HYPE_LEVELS=[0.2,0.5,0.8,1.0,1.5,2.0,3.0,4.0,6.0,10.0];
let hypeIdx=4; // default 5 ‚Üí multiplier 1.5 on prior
let allowSpawn=true;
let rammingEnabled=false;
let sharksEnabled=false;
let sharks=[];
let sharkGroup=new THREE.Group();
let cumulativeFishingTime=0; // frames of all boats fishing
let sharkThreshold=100; // seconds of fishing before shark spawns
let sharkBaseSpeed=7;
let sharkSpawnCount=0; // how many sharks have spawned total

const COLLAPSE_THRESHOLD=3,BASE_FISH_PRICE=5,QUOTA_LIMIT=50,SANCTUARY_RADIUS=60;
const BASE_CATCH_RADIUS=16,BOAT_COST_PER_SEC=2;
const DEMAND_LEVELS=[4,6,8,10,12,16,20,26,35,50];
let demandIdx=7;
let DEMAND_INTERCEPT=DEMAND_LEVELS[7];
const DEMAND_SLOPE=0.8;

function getCatchR(){return BASE_CATCH_RADIUS*SIZE_LEVELS[sizeIdx];}

// Circular world helpers
function randomInCircle(){
    const a=Math.random()*Math.PI*2,r=Math.sqrt(Math.random())*WORLD_R*0.92;
    return{x:WORLD_CX+Math.cos(a)*r,z:WORLD_CZ+Math.sin(a)*r};
}
function clampToCircle(x,z){
    const dx=x-WORLD_CX,dz=z-WORLD_CZ,d=Math.hypot(dx,dz);
    if(d>WORLD_R){return{x:WORLD_CX+dx/d*WORLD_R,z:WORLD_CZ+dz/d*WORLD_R};}
    return{x,z};
}
function distFromCenter(x,z){return Math.hypot(x-WORLD_CX,z-WORLD_CZ);}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let fish=[],player,bots=[],policy='open',gameTime=0,collapsed=false;
let particles3d=[],catchLines=[],botTotalCatch=0,sanctuaries=[];
let placingSanctuary=false;
let currentPrice=DEMAND_INTERCEPT,supplySmooth=0,totalHarvestRate=0;
const GRAPH_LEN=90;
let profitHist=[],stockHist=[],priceHist=[],boatsHist=[];
let profitThisSec=0,harvestThisSec=0,lastHarvest=0;
let profitWindow=[];totalWelfare=0;welfareThisSec=0;welfareHist=[];scenarioTimeLeft=90*60;scenarioActive=true; // last 60 seconds of profit for moving average
const PROFIT_AVG_WINDOW=30;

// 3D containers
const fishGroup=new THREE.Group();scene.add(fishGroup);
const boatGroup=new THREE.Group();scene.add(boatGroup);
const effectGroup=new THREE.Group();scene.add(effectGroup);
const sanctGroup=new THREE.Group();scene.add(sanctGroup);
scene.add(sharkGroup);

// ‚îÄ‚îÄ Raycaster for click-to-place ‚îÄ‚îÄ
const raycaster=new THREE.Raycaster();
const mouse=new THREE.Vector2();
const waterPlane=new THREE.Plane(new THREE.Vector3(0,1,0),0);

function $(id){return document.getElementById(id)}
const keys={};
window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;keys[e.code]=true;});
window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;keys[e.code]=false;});

// ‚îÄ‚îÄ Touch button controls ‚îÄ‚îÄ
const isMobile=()=>window.innerWidth<=900;
document.querySelectorAll('.touch-btn').forEach(btn=>{
    const key=btn.dataset.tdir;
    const start=()=>{keys[key]=true;btn.classList.add('pressed');};
    const end=()=>{keys[key]=false;btn.classList.remove('pressed');};
    btn.addEventListener('touchstart',e=>{e.preventDefault();start();},{passive:false});
    btn.addEventListener('touchend',e=>{e.preventDefault();end();},{passive:false});
    btn.addEventListener('touchcancel',()=>{end();});
    btn.addEventListener('mousedown',e=>{e.preventDefault();start();});
    btn.addEventListener('mouseup',()=>{end();});
    btn.addEventListener('mouseleave',()=>{end();});
});

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ
$('boatMinus').onclick=()=>{
    if(bots.length>0){
        const b=bots[bots.length-1];if(b.mesh)boatGroup.remove(b.mesh);if(b.dockMesh)sanctGroup.remove(b.dockMesh);if(b.coinPile)sanctGroup.remove(b.coinPile);bots.pop();
    }
    initialBotCount=Math.max(0,bots.length);
    const ab=bots.filter(b=>!b.docked);$('boatVal').textContent=ab.length+'/'+bots.length;
};
$('boatPlus').onclick=()=>{
    const nb=makeBotData();bots.push(nb);addBot3D(nb);
    initialBotCount=bots.length;
    const ab=bots.filter(b=>!b.docked);$('boatVal').textContent=ab.length+'/'+bots.length;
};
$('spdMinus').onclick=()=>{speedIdx=Math.max(0,speedIdx-1);$('spdVal').textContent=speedIdx+1;};
$('spdPlus').onclick=()=>{speedIdx=Math.min(SPEED_LEVELS.length-1,speedIdx+1);$('spdVal').textContent=speedIdx+1;};
$('momMinus').onclick=()=>{momentumIdx=Math.max(0,momentumIdx-1);$('momVal').textContent=momentumIdx+1;};
$('momPlus').onclick=()=>{momentumIdx=Math.min(MOMENTUM_LEVELS.length-1,momentumIdx+1);$('momVal').textContent=momentumIdx+1;};
$('sizeMinus').onclick=()=>{sizeIdx=Math.max(0,sizeIdx-1);$('sizeVal').textContent=sizeIdx+1;};
$('sizePlus').onclick=()=>{sizeIdx=Math.min(SIZE_LEVELS.length-1,sizeIdx+1);$('sizeVal').textContent=sizeIdx+1;};
$('growMinus').onclick=()=>{growthIdx=Math.max(0,growthIdx-1);GROWTH_RATE=GROWTH_LEVELS[growthIdx];$('growVal').textContent=growthIdx+1;};
$('growPlus').onclick=()=>{growthIdx=Math.min(GROWTH_LEVELS.length-1,growthIdx+1);GROWTH_RATE=GROWTH_LEVELS[growthIdx];$('growVal').textContent=growthIdx+1;};
$('capMinus').onclick=()=>{FISH_CAPACITY=Math.max(50,FISH_CAPACITY-50);$('capVal').textContent=FISH_CAPACITY;$('alleeMarker').style.left=(ALLEE_FRAC*100)+'%';};
$('capPlus').onclick=()=>{FISH_CAPACITY=Math.min(800,FISH_CAPACITY+50);$('capVal').textContent=FISH_CAPACITY;$('alleeMarker').style.left=(ALLEE_FRAC*100)+'%';};
$('alleeMinus').onclick=()=>{ALLEE_FRAC=Math.max(0,Math.round((ALLEE_FRAC-.05)*100)/100);$('alleeVal').textContent=Math.round(ALLEE_FRAC*100)+'%';$('alleeMarker').style.left=(ALLEE_FRAC*100)+'%';};
$('alleePlus').onclick=()=>{ALLEE_FRAC=Math.min(.8,Math.round((ALLEE_FRAC+.05)*100)/100);$('alleeVal').textContent=Math.round(ALLEE_FRAC*100)+'%';$('alleeMarker').style.left=(ALLEE_FRAC*100)+'%';};
$('taxMinus').onclick=()=>{taxRate=Math.max(0,Math.round((taxRate-0.5)*10)/10);$('taxVal').textContent='$'+taxRate;};
$('taxPlus').onclick=()=>{taxRate=Math.min(50,Math.round((taxRate+0.5)*10)/10);$('taxVal').textContent='$'+taxRate;};
$('discMinus').onclick=()=>{discountRate=Math.max(0,Math.round((discountRate-0.01)*100)/100);$('discVal').textContent=Math.round(discountRate*100)+'%';};
$('discPlus').onclick=()=>{discountRate=Math.min(0.50,Math.round((discountRate+0.01)*100)/100);$('discVal').textContent=Math.round(discountRate*100)+'%';};
$('demMinus').onclick=()=>{demandIdx=Math.max(0,demandIdx-1);DEMAND_INTERCEPT=DEMAND_LEVELS[demandIdx];$('demVal').textContent=demandIdx+1;};
$('demPlus').onclick=()=>{demandIdx=Math.min(DEMAND_LEVELS.length-1,demandIdx+1);DEMAND_INTERCEPT=DEMAND_LEVELS[demandIdx];$('demVal').textContent=demandIdx+1;};
$('resetFishBtn').onclick=()=>{
    // Replenish fish to capacity without resetting anything else
    while(fish.length<FISH_CAPACITY){const f=spawnFishData();fish.push(f);addFish3D(f);}
    collapsed=false;$('collapseAlert').classList.remove('show');
};

// ‚îÄ‚îÄ Scenarios & Timer ‚îÄ‚îÄ
let currentScenario='solo';
const SCENARIO_DURATION=90*60; // 90 seconds at 60fps
const highScores={}; // keyed by scenario name, stores {profit, welfare}

function updateBestScoresDisplay(){
    const el=$('scenarioBestScores');if(!el)return;
    const names={freeplay:'Free Play',simple:'Simple',solo:'Solo',freeentry:'Free Entry',fast:'Speed',policy:'Policy',hype:'Hype',pirate:'Pirate',sharks:'Sharks'};
    const parts=[];
    for(const key in SCENARIOS){
        if(highScores[key]!==undefined){
            parts.push(`<span style="color:var(--gold)">üèÜ</span> ${names[key]||key}: <span style="color:var(--gold)">$${highScores[key].profit.toFixed(0)}</span> <span style="color:var(--green);font-size:.35rem">W$${highScores[key].welfare.toFixed(0)}</span>`);
        }
    }
    el.innerHTML=parts.length?parts.join(' ¬∑ '):'<span style="color:var(--text-dim)">No scores yet</span>';
}

const SCENARIOS={
    freeplay:{name:'Free Play',spawn:false,boats:0,speed:7,mom:1,growth:1,hype:5,allee:0.01,fpv:true,desc:'Sandbox mode. Tweak any parameter.'},
    simple:{name:'Simple',spawn:true,speed:7,mom:1,growth:0,hype:6,allee:0.05,fpv:true,desc:'Minimal Allee effect. Fish recover easily. Learn the basics.'},
    solo:{name:'Solo Fisher',spawn:false,speed:7,mom:1,growth:3,hype:3,allee:0.40,fpv:true,desc:'Just you. Maximize your profit.'},
    freeentry:{name:'Free Entry',spawn:true,speed:7,mom:1,growth:3,hype:6,allee:0.40,fpv:false,desc:'Firms can enter. Manage the commons.'},
    fast:{name:'Speed Race',spawn:true,speed:11,mom:4,growth:3,hype:7,allee:0.40,fpv:false,desc:'Fast boats, high stakes.'},
    policy:{name:'Policy',spawn:true,speed:7,mom:1,growth:3,hype:7,allee:0.40,fpv:false,taxStart:3,policyStart:'open',policyEnabled:true,desc:'Use tax or sanctuary to maximize welfare.'},
    hype:{name:'Hype Bubble',spawn:true,speed:7,mom:1,growth:1,hype:9,allee:0.40,fpv:false,desc:'Extreme hype! Survive the bubble.'},
    pirate:{name:'Pirate',spawn:true,speed:9,mom:2,growth:3,hype:7,allee:0.40,fpv:true,ramming:true,school:2,desc:'Ram other boats to send them to dock! Aggressive strategy.'},
    sharks:{name:'Sharks',spawn:true,speed:9,mom:2,growth:3,hype:7,allee:0.40,fpv:true,ramming:true,school:2,sharksEnabled:true,sharkThresh:100,sharkSpd:7,desc:'Overfishing attracts sharks! They destroy boats permanently.'}
};

function applyScenario(s){
    currentScenario=s;
    const sc=SCENARIOS[s];
    document.querySelectorAll('[data-scenario]').forEach(b=>b.classList.remove('active'));
    document.querySelector(`[data-scenario="${s}"]`).classList.add('active');
    allowSpawn=sc.spawn;$('spawnChk').checked=sc.spawn;
    initialBotCount=(sc.boats!==undefined)?sc.boats:2;
    speedIdx=sc.speed;$('spdVal').textContent=sc.speed+1;
    momentumIdx=sc.mom;$('momVal').textContent=sc.mom+1;
    growthIdx=sc.growth;GROWTH_RATE=GROWTH_LEVELS[sc.growth];$('growVal').textContent=sc.growth+1;
    hypeIdx=sc.hype;$('hypeVal').textContent=sc.hype+1;
    ALLEE_FRAC=sc.allee;$('alleeVal').textContent=Math.round(sc.allee*100)+'%';
    $('alleeMarker').style.left=(sc.allee*100)+'%';
    if(sc.taxStart){taxRate=sc.taxStart;$('taxVal').textContent='$'+sc.taxStart;}else{taxRate=0;$('taxVal').textContent='$0';}
    $('scenarioName').textContent=sc.name;
    $('highScore').textContent=highScores[s]!==undefined?'$'+highScores[s].profit.toFixed(0):'‚Äî';
    initGame();
    // Set FPV mode based on scenario
    fpvMode=!!sc.fpv;
    $('fpvChk').checked=fpvMode;
    if(fpvMode){fpvAngleOffset=0;fpvDist=55;fpvHeightBase=32;fpvSmoothedAngle=player.angle;camFollowPlayer=true;}
    else{camFollowPlayer=true;}
    rammingEnabled=!!sc.ramming;
    $('ramChk').checked=rammingEnabled;
    sharksEnabled=!!sc.sharksEnabled;
    $('sharkChk').checked=sharksEnabled;
    if(sc.sharkThresh!==undefined){sharkThreshold=sc.sharkThresh;$('sharkThreshVal').textContent=sharkThreshold;}
    if(sc.sharkSpd!==undefined){sharkBaseSpeed=sc.sharkSpd;$('sharkSpdVal').textContent=sharkBaseSpeed;}
    if(sc.school!==undefined){schoolStrength=sc.school;$('schoolVal').textContent=sc.school;}
    // Enable/disable policy buttons based on scenario
    const policyEnabled=!!sc.policyEnabled;
    document.querySelectorAll('[data-policy]').forEach(b=>{
        if(b.dataset.policy==='open')return; // always enabled
        if(policyEnabled){
            b.style.opacity='1';b.style.pointerEvents='auto';
        } else {
            b.style.opacity='0.3';b.style.pointerEvents='none';
        }
    });
    // Set policy AFTER initGame so it doesn't get overwritten
    document.querySelectorAll('.policy-btn').forEach(b=>b.classList.remove('active'));
    if(sc.policyStart==='tax'){
        policy='tax';
        document.querySelector('[data-policy="tax"]').classList.add('active');
        placingSanctuary=false;$('placingIndicator').style.display='none';
    } else if(sc.policyStart==='sanctuary'){
        policy='sanctuary';placingSanctuary=true;
        document.querySelector('[data-policy="sanctuary"]').classList.add('active');
        $('placingIndicator').style.display='block';
    } else {
        policy='open';
        document.querySelector('[data-policy="open"]').classList.add('active');
        placingSanctuary=false;$('placingIndicator').style.display='none';
    }
}

function makeVerifyCode(scenario,profit,welfare,catch_n,fishLeft){
    // Simple hash: combine inputs into a verification string
    const raw=`${scenario}|${Math.round(profit*100)}|${Math.round(welfare*100)}|${catch_n}|${fishLeft}|FC3D`;
    let h=0;for(let i=0;i<raw.length;i++){h=((h<<5)-h)+raw.charCodeAt(i);h|=0;}
    return 'FC3D-'+Math.abs(h).toString(36).toUpperCase().slice(0,4)+'-'+Math.abs(h*7+catch_n).toString(36).toUpperCase().slice(0,4);
}

function endScenario(){
    scenarioActive=false;
    const sc=SCENARIOS[currentScenario];
    const elapsedSecsEnd=Math.max(1,Math.floor(gameTime/60));
    const discFactorEnd=discountRate>0?Math.pow(1+discountRate,elapsedSecsEnd):1;
    const fishStockValue=(fish.length*currentPrice)/discFactorEnd;
    const finalWelfare=totalWelfare+fishStockValue;
    const isNew=highScores[currentScenario]===undefined||player.profit>highScores[currentScenario].profit;
    if(isNew)highScores[currentScenario]={profit:player.profit,welfare:finalWelfare};
    else if(highScores[currentScenario]===undefined)highScores[currentScenario]={profit:player.profit,welfare:finalWelfare};
    $('highScore').textContent='$'+(highScores[currentScenario]?highScores[currentScenario].profit:0).toFixed(0);
    updateBestScoresDisplay();
    const code=makeVerifyCode(currentScenario,player.profit,finalWelfare,player.catch,fish.length);
    // Build all-scenario scores summary
    const scenarioNames={freeplay:'Free Play',simple:'Simple',solo:'Solo',freeentry:'Free Entry',fast:'Speed',policy:'Policy',hype:'Hype',pirate:'Pirate',sharks:'Sharks'};
    let allScoresHtml='<div style="margin-top:8px;padding-top:6px;border-top:1px solid rgba(79,195,247,.15)"><div style="font-size:.44rem;text-transform:uppercase;letter-spacing:.6px;color:var(--text-dim);margin-bottom:4px">All Scenario Best Scores</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px 8px;font-size:.48rem">';
    for(const key in SCENARIOS){
        const name=scenarioNames[key]||key;
        const score=highScores[key];
        const isCurrent=key===currentScenario;
        const color=score!==undefined?(isCurrent?'var(--gold)':'var(--text)'):'var(--text-dim)';
        const val=score!==undefined?'P$'+score.profit.toFixed(0)+' W$'+score.welfare.toFixed(0):'‚Äî';
        allScoresHtml+=`<span style="color:${color};font-family:'JetBrains Mono',monospace;font-weight:${isCurrent?'700':'500'}">${isCurrent?'‚ñ∏ ':''}${name}: ${val}</span>`;
    }
    allScoresHtml+='</div></div>';
    const al=$('collapseAlert');
    al.innerHTML=`
        <h2 style="color:var(--gold)">‚è±Ô∏è Scenario Complete!</h2>
        <p>${sc.name}: ${sc.desc}</p>
        <div class="score-grid">
            <span class="sg-label">Your Profit</span><span class="sg-val" style="color:var(--gold)">$${player.profit.toFixed(0)}</span>
            <span class="sg-label">Total Welfare</span><span class="sg-val" style="color:var(--green)">$${finalWelfare.toFixed(0)}</span>
            <span class="sg-label">Your Catch</span><span class="sg-val" style="color:var(--boat-you)">${player.catch}</span>
            <span class="sg-label">Fish Remaining</span><span class="sg-val">${fish.length}/${FISH_CAPACITY}</span>
            <span class="sg-label">Fish Stock Value</span><span class="sg-val" style="color:var(--green)">$${fishStockValue.toFixed(0)}</span>
            <span class="sg-label">Avg $/sec</span><span class="sg-val" style="color:var(--gold)">$${(player.profit/Math.max(1,Math.floor(gameTime/60))).toFixed(1)}</span>
            <span class="sg-label">Boats (final)</span><span class="sg-val">${bots.length}</span>
        </div>
        ${isNew?'<div class="highscore">üèÜ New High Score!</div>':''}
        ${allScoresHtml}
        <div class="verify">Verify: ${code}</div>
        <button class="restart-btn" onclick="window.applyScenario('${currentScenario}')">üîÑ Retry</button>
        <button class="restart-btn" style="margin-left:8px;border-color:var(--gold);color:var(--gold)" onclick="document.getElementById('collapseAlert').classList.remove('show')">Continue Playing</button>
    `;
    al.classList.add('show');
}

document.querySelectorAll('[data-scenario]').forEach(b=>{
    b.addEventListener('click',()=>applyScenario(b.dataset.scenario));
});
$('schoolMinus').onclick=()=>{schoolStrength=Math.max(-20,schoolStrength-1);$('schoolVal').textContent=schoolStrength;};
$('schoolPlus').onclick=()=>{schoolStrength=Math.min(20,schoolStrength+1);$('schoolVal').textContent=schoolStrength;};
$('fishSpdMinus').onclick=()=>{fishSpeedIdx=Math.max(0,fishSpeedIdx-1);$('fishSpdVal').textContent=fishSpeedIdx+1;};
$('fishSpdPlus').onclick=()=>{fishSpeedIdx=Math.min(FISH_SPEED_LEVELS.length-1,fishSpeedIdx+1);$('fishSpdVal').textContent=fishSpeedIdx+1;};
$('greedMinus').onclick=()=>{greedIdx=Math.max(0,greedIdx-1);$('greedVal').textContent=greedIdx+1;bots.forEach(b=>{b.greed=GREED_LEVELS[greedIdx]*(0.7+Math.random()*0.6);});};
$('greedPlus').onclick=()=>{greedIdx=Math.min(GREED_LEVELS.length-1,greedIdx+1);$('greedVal').textContent=greedIdx+1;bots.forEach(b=>{b.greed=GREED_LEVELS[greedIdx]*(0.7+Math.random()*0.6);});};
$('hypeMinus').onclick=()=>{hypeIdx=Math.max(0,hypeIdx-1);$('hypeVal').textContent=hypeIdx+1;};
$('hypePlus').onclick=()=>{hypeIdx=Math.min(HYPE_LEVELS.length-1,hypeIdx+1);$('hypeVal').textContent=hypeIdx+1;};
const spawnChkEl=$('spawnChk');
spawnChkEl.onchange=function(){allowSpawn=this.checked;};
spawnChkEl.onclick=function(){allowSpawn=this.checked;};
const ramChkEl=$('ramChk');
ramChkEl.onchange=function(){rammingEnabled=this.checked;};
ramChkEl.onclick=function(){rammingEnabled=this.checked;};
const sharkChkEl=$('sharkChk');
sharkChkEl.onchange=function(){sharksEnabled=this.checked;};
sharkChkEl.onclick=function(){sharksEnabled=this.checked;};
$('sharkThreshMinus').onclick=()=>{sharkThreshold=Math.max(25,sharkThreshold-25);$('sharkThreshVal').textContent=sharkThreshold;};
$('sharkThreshPlus').onclick=()=>{sharkThreshold=Math.min(2000,sharkThreshold+25);$('sharkThreshVal').textContent=sharkThreshold;};
$('sharkSpdMinus').onclick=()=>{sharkBaseSpeed=Math.max(1,sharkBaseSpeed-1);$('sharkSpdVal').textContent=sharkBaseSpeed;};
$('sharkSpdPlus').onclick=()=>{sharkBaseSpeed=Math.min(15,sharkBaseSpeed+1);$('sharkSpdVal').textContent=sharkBaseSpeed;};
const fpvChkEl=$('fpvChk');
fpvChkEl.onchange=function(){fpvMode=this.checked;camFollowPlayer=true;if(this.checked)fpvSmoothedAngle=player.angle;};
fpvChkEl.onclick=function(){fpvMode=this.checked;camFollowPlayer=true;if(this.checked)fpvSmoothedAngle=player.angle;};

// ‚îÄ‚îÄ Basic / Advanced mode toggle ‚îÄ‚îÄ
function setMode(adv){
    advancedMode=adv;
    if(adv){
        document.body.classList.remove('basic-mode');
        $('modeToggleBtn').textContent='üìä Basic Mode';
        $('modeToggleBtn').style.borderColor='var(--boat-you)';
        $('modeToggleBtn').style.color='var(--boat-you)';
    } else {
        document.body.classList.add('basic-mode');
        $('modeToggleBtn').textContent='‚öôÔ∏è Advanced Mode';
        $('modeToggleBtn').style.borderColor='var(--gold)';
        $('modeToggleBtn').style.color='var(--gold)';
    }
    // Resize renderer for rbar width change
    setTimeout(()=>{
        if(window.innerWidth<=900){
            const w=window.innerWidth;
            const h=Math.min(420,Math.max(260,w*0.55));
            camera.aspect=w/h;
            camera.updateProjectionMatrix();
            renderer.setSize(w,h);
        } else {
            const rbarW=adv?280:230;
            camera.aspect=(window.innerWidth-SIDEBAR_W-rbarW)/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth-SIDEBAR_W-rbarW,window.innerHeight);
        }
    },10);
}
$('modeToggleBtn').onclick=()=>setMode(!advancedMode);
// Start in basic mode
setMode(false);

// ‚îÄ‚îÄ How to play popup ‚îÄ‚îÄ
$('startPlayBtn').onclick=()=>{$('howToPlay').style.display='none';};


// Policy
document.querySelectorAll('.policy-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        const p=btn.dataset.policy;
        if(p==='sanctuary'){
            placingSanctuary=!placingSanctuary;
            $('placingIndicator').style.display=placingSanctuary?'block':'none';
            if(placingSanctuary){
                policy='sanctuary';
                document.querySelectorAll('.policy-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
            }
            return;
        }
        placingSanctuary=false;$('placingIndicator').style.display='none';
        document.querySelectorAll('.policy-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');policy=p;
        if(p==='open'){sanctuaries=[];while(sanctGroup.children.length)sanctGroup.remove(sanctGroup.children[0]);}
    });
});

// Click handler: inspect boats or place sanctuaries
let selectedBot=null;
$('biClose').onclick=()=>{$('boatInfo').classList.remove('show');selectedBot=null;};

cvs.addEventListener('click',e=>{
    if(dragging)return;
    mouse.x=((e.clientX-SIDEBAR_W)/(window.innerWidth-SIDEBAR_W-RBAR_W))*2-1;
    mouse.y=-(e.clientY/window.innerHeight)*2+1;
    raycaster.setFromCamera(mouse,camera);

    // Try to hit a boat first
    if(!placingSanctuary){
        const allEntries=[];
        if(playerMesh)allEntries.push({mesh:playerMesh,bot:null,isPlayer:true});
        bots.forEach((b,i)=>{if(b.mesh)allEntries.push({mesh:b.mesh,bot:b,idx:i,isPlayer:false});});
        let closest=null,closestDist=Infinity;
        for(const entry of allEntries){
            const hits=raycaster.intersectObject(entry.mesh,true);
            if(hits.length>0&&hits[0].distance<closestDist){closestDist=hits[0].distance;closest=entry;}
        }
        if(closest){
            selectedBot=closest.isPlayer?'player':closest.bot;
            updateBoatInfoPanel();
            $('boatInfo').classList.add('show');
            $('boatInfo').style.left=Math.min(e.clientX+10,window.innerWidth-240)+'px';
            $('boatInfo').style.top=Math.min(e.clientY+10,window.innerHeight-300)+'px';
            return;
        }
    }

    // Otherwise: sanctuary placement
    if(placingSanctuary){
        const pt=new THREE.Vector3();
        if(raycaster.ray.intersectPlane(waterPlane,pt)){
            sanctuaries.push({x:pt.x,z:pt.z,r:SANCTUARY_RADIUS});policy='sanctuary';
            const ringGeo2=new THREE.RingGeometry(SANCTUARY_RADIUS-1,SANCTUARY_RADIUS,48);
            const ringMat2=new THREE.MeshBasicMaterial({color:0x4caf50,transparent:true,opacity:0.4,side:THREE.DoubleSide});
            const ring2=new THREE.Mesh(ringGeo2,ringMat2);ring2.rotation.x=-Math.PI/2;ring2.position.set(pt.x,0.5,pt.z);sanctGroup.add(ring2);
            const discGeo2=new THREE.CircleGeometry(SANCTUARY_RADIUS,48);
            const discMat2=new THREE.MeshBasicMaterial({color:0x4caf50,transparent:true,opacity:0.06,side:THREE.DoubleSide});
            const disc2=new THREE.Mesh(discGeo2,discMat2);disc2.rotation.x=-Math.PI/2;disc2.position.set(pt.x,0.3,pt.z);sanctGroup.add(disc2);
        }
    } else {
        // Clicked empty water ‚Äî close info panel
        $('boatInfo').classList.remove('show');selectedBot=null;
    }
});

function updateBoatInfoPanel(){
    if(!selectedBot)return;
    if(selectedBot==='player'){
        $('biName').textContent='‚õµ Your Boat';$('biName').style.color='var(--boat-you)';
        const secs=Math.max(1,Math.floor(gameTime/60));
        $('biStatus').textContent='Fishing';$('biStatus').style.color='var(--green)';
        $('biCatch').textContent=player.catch;
        const avgP=profitWindow.length>0?profitWindow.reduce((a,b)=>a+b,0)/profitWindow.length:0;
        $('biRevenue').textContent='$'+avgP.toFixed(1)+'/s';
        $('biCost').textContent='N/A';
        $('biProfit').textContent='$'+(player.profit/secs).toFixed(1)+'/s avg';$('biProfit').style.color='var(--gold)';
        $('biGreed').textContent='‚Äî';$('biShutdownBar').style.width='0%';$('biExitBar').style.width='0%';
        $('biHistory').textContent='Total: $'+player.profit.toFixed(0)+' over '+secs+'s';
    } else {
        const bot=selectedBot;if(!bots.includes(bot)){$('boatInfo').classList.remove('show');selectedBot=null;return;}
        const idx=bots.indexOf(bot);
        $('biName').textContent='üö§ Boat #'+(idx+2);$('biName').style.color='var(--boat-bot)';
        const status=bot.docked?'‚öì Docked':bot.returning?'‚Ü©Ô∏è Returning to Dock':'üêü Fishing';
        $('biStatus').textContent=status;$('biStatus').style.color=bot.docked?'var(--text-dim)':bot.returning?'#ff9800':'var(--green)';
        $('biCatch').textContent=bot.catch;
        $('biRevenue').textContent='$'+(bot._recentRevenue||0).toFixed(2)+'/s';
        $('biCost').textContent='$3/s (FC $1 + VC $2)';
        const econ=bot._econProfit||0;
        $('biProfit').textContent='$'+econ.toFixed(2)+'/s';$('biProfit').style.color=econ>=0?'var(--green)':'var(--red)';
        $('biGreed').textContent=bot.greed.toFixed(2);
        const opProf=bot._opProfit||0;
        $('biShutdownBar').style.width=Math.min(100,opProf<0?Math.abs(opProf)*50:0)+'%';
        $('biExitBar').style.width=Math.min(100,econ<0?Math.abs(econ)*30:0)+'%';
        const recent=bot.profitHist.slice(-10);
        const trend=recent.length>1?(recent[recent.length-1]>recent[0])?'üìà':'üìâ':'‚Äî';
        const conf=Math.min(100,bot.belief_n*5);
        $('biHistory').textContent=`Belief: ${(bot.belief_catchRate*60).toFixed(2)} catch/s (${conf.toFixed(0)}% conf) ¬∑ Opt: ${bot.belief_optimism.toFixed(1)} ¬∑ ${trend}`;
    }
}

if($('restartBtn'))$('restartBtn').onclick=initGame;

function isInSanctuary(x,z){for(const s of sanctuaries){if(Math.hypot(x-s.x,z-s.z)<s.r)return true;}return false;}
function getActiveTax(){return policy==='tax'?taxRate:0;}

// ‚îÄ‚îÄ Factories ‚îÄ‚îÄ
function spawnFishData(near){
    let x,z;
    if(near){x=near.x+(Math.random()-.5)*40;z=near.z+(Math.random()-.5)*40;const c=clampToCircle(x,z);x=c.x;z=c.z;}
    else{const p=randomInCircle();x=p.x;z=p.z;}
    return{x,z,vx:(Math.random()-.5)*.15,vz:(Math.random()-.5)*.15,schoolAng:Math.random()*Math.PI*2,turnTimer:60+Math.floor(Math.random()*120),mesh:null,wobble:Math.random()*Math.PI*2};
}

function addFish3D(f){
    const color=Math.random()>.3?0xf6c643:0xa8d8ea;
    const m=makeFishMesh(color);
    const s=1.5+Math.random()*0.8;
    m.scale.set(s,s,s);
    m.position.set(f.x,-2.5-Math.random()*2,f.z);
    fishGroup.add(m);f.mesh=m;
}

function getMarketPrior(){
    // Shared naive estimate of catch rate based on observable conditions
    const fishDensity=fish.length/Math.max(1,FISH_CAPACITY);
    return fishDensity*getCatchR()*0.005*SPEED_LEVELS[speedIdx]*0.2;
}

function makeBotData(){
    const dockAng=Math.random()*Math.PI*2;
    const dockX=WORLD_CX+Math.cos(dockAng)*(WORLD_R+15);
    const dockZ=WORLD_CZ+Math.sin(dockAng)*(WORLD_R+15);
    // Bayesian belief: prior catch rate with agent-specific noise and hype
    const basePrior=getMarketPrior();
    const hype=HYPE_LEVELS[hypeIdx];
    const agentNoise=0.7+Math.random()*0.6; // individual optimism/pessimism
    return{x:dockX,z:dockZ,vx:0,vz:0,angle:Math.random()*Math.PI*2,speed:0,
        catch:0,totalProfit:0,targetFish:null,thinkTimer:0,greed:GREED_LEVELS[greedIdx]*(0.7+Math.random()*0.6),
        turnRate:.04+Math.random()*.03,
        docked:true,dockTimer:60+Math.floor(Math.random()*60),returning:false,
        dockX,dockZ,dockAng,
        profitHist:[],spawnTime:gameTime,
        mesh:null,dockMesh:null,coinPile:null,crewMeshes:[],
        // Bayesian belief system
        belief_catchRate:basePrior*hype*agentNoise, // prior expected catch/frame
        belief_n:2, // "observations" backing the belief (low=uncertain, high=confident)
        belief_optimism:agentNoise*hype, // agent's initial optimism factor
        actualCatchesThisSec:0, // running count for this second
        actualSecsFishing:0, // seconds spent actively fishing
        _recentRevenue:0,_recentCatch:0,_econProfit:0,_opProfit:0};
}

// 3D dock: small pier on circle edge
function makeDockMesh(dockX,dockZ,dockAng){
    const g=new THREE.Group();
    // Pier planks
    const plankMat=new THREE.MeshStandardMaterial({color:0x8B6914,roughness:0.8});
    const plank=new THREE.Mesh(new THREE.BoxGeometry(12,0.8,30),plankMat);
    plank.position.set(0,0.5,0);g.add(plank);
    // Posts
    const postMat=new THREE.MeshStandardMaterial({color:0x5a3e0a,roughness:0.9});
    for(const oz of[-12,12]){
        const post=new THREE.Mesh(new THREE.CylinderGeometry(0.8,0.8,6,6),postMat);
        post.position.set(4.5,-1.5,oz);g.add(post);
        const post2=post.clone();post2.position.x=-4.5;g.add(post2);
    }
    g.position.set(dockX,0,dockZ);
    g.rotation.y=-dockAng+Math.PI/2;
    return g;
}

function addBot3D(b){
    const m=makeBoatMesh(0xef5350);const s=SIZE_LEVELS[sizeIdx]*0.8;
    m.scale.set(s,s,s);m.position.set(b.x,0,b.z);
    boatGroup.add(m);b.mesh=m;
    // Create dock
    const dm=makeDockMesh(b.dockX,b.dockZ,b.dockAng);
    sanctGroup.add(dm);b.dockMesh=dm;
    // Create coin pile group at dock
    b.coinPile=new THREE.Group();
    b.coinPile.position.set(b.dockX,0,b.dockZ);
    sanctGroup.add(b.coinPile);
}

// Update coin pile at a dock based on profit
const coinMat=new THREE.MeshStandardMaterial({color:0xf6c643,roughness:0.3,metalness:0.5});
function updateCoinPile(coinGroup,profit){
    const targetCoins=Math.min(20,Math.floor(profit/15));
    while(coinGroup.children.length<targetCoins){
        const c=new THREE.Mesh(new THREE.CylinderGeometry(6,6,2,8),coinMat);
        const layer=Math.floor(coinGroup.children.length/5);
        const idx=coinGroup.children.length%5;
        c.position.set((idx-2)*5.5+(layer%2)*2.5,3+layer*2.2,(Math.random()-0.5)*6);
        coinGroup.add(c);
    }
    while(coinGroup.children.length>targetCoins&&coinGroup.children.length>0){
        coinGroup.remove(coinGroup.children[coinGroup.children.length-1]);
    }
}

// Crew cylinders on boat based on profit rate
const crewMat=new THREE.MeshStandardMaterial({color:0xffcc88,roughness:0.6});
const crewHatMat=new THREE.MeshStandardMaterial({color:0x2255aa,roughness:0.5});
function updateBoatCrew(entity){
    if(!entity.mesh)return;
    // Remove old crew
    if(entity.crewMeshes){entity.crewMeshes.forEach(c=>entity.mesh.remove(c));entity.crewMeshes=[];}
    // Add crew based on profit rate (0-4 crew)
    const profitRate=entity._recentRevenue||0;
    const numCrew=Math.min(4,Math.max(0,Math.floor(profitRate*0.8+0.3)));
    for(let i=0;i<numCrew;i++){
        const g=new THREE.Group();
        const body=new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,2.5,6),crewMat);
        body.position.y=2.0;g.add(body);
        const head=new THREE.Mesh(new THREE.SphereGeometry(0.55,6,6),crewMat);
        head.position.y=3.6;g.add(head);
        const hat=new THREE.Mesh(new THREE.CylinderGeometry(0.65,0.6,0.7,6),crewHatMat);
        hat.position.y=4.2;g.add(hat);
        // Spread across the stern deck area, standing on deck (Y=0.5 in boat local space)
        g.position.set(-1.8+i*1.2,0.5,3.0-i*0.6);
        entity.mesh.add(g);
        entity.crewMeshes.push(g);
    }
}

// Unprofitable indicator ‚Äî red tint + smoke-like particle
function updateProfitIndicator(bot){
    if(!bot.mesh)return;
    if(!bot.docked&&!bot.returning&&bot._econProfit<-0.5){
        // Flash hull reddish
        bot.mesh.traverse(c=>{
            if(c.material&&!c._origColor){c._origColor=c.material.color.getHex();}
            if(c.material&&c._origColor){
                const t=(Math.sin(gameTime*0.15)*0.5+0.5);
                const r=((c._origColor>>16)&0xff)/255;
                const g2=((c._origColor>>8)&0xff)/255;
                const b2=(c._origColor&0xff)/255;
                c.material.color.setRGB(r*0.6+0.4*t,g2*0.4,b2*0.4);
            }
        });
    }
}

// Coin trail from boat to dock on catch
const _coinGeo=new THREE.SphereGeometry(0.8,3,3);
const _coinMatProto=new THREE.MeshBasicMaterial({color:0xffd700,transparent:true,opacity:1});
let _coinParticleCount=0;
const MAX_COIN_PARTICLES=50;
function spawnCoinTrail(fromX,fromZ,toX,toZ,count){
    count=count||2;
    if(_coinParticleCount>=MAX_COIN_PARTICLES)return;
    for(let i=0;i<count;i++){
        const mat=_coinMatProto.clone();
        const m=new THREE.Mesh(_coinGeo,mat);
        m.position.set(fromX+(Math.random()-0.5)*3,3+Math.random()*4,fromZ+(Math.random()-0.5)*3);
        effectGroup.add(m);
        const dx=toX-fromX,dz=toZ-fromZ;
        const life=90+Math.floor(Math.random()*30);
        _coinParticleCount++;
        particles3d.push({mesh:m,
            vx:dx/life*1.2+(Math.random()-0.5)*0.4,
            vy:0.2+Math.random()*0.15,
            vz:dz/life*1.2+(Math.random()-0.5)*0.4,
            life:life,maxLife:life,coinFx:true});
    }
}

// Coin burst on ram
function spawnCoinBurst(x,z,count){
    for(let i=0;i<count;i++){
        const mat=_coinMatProto.clone();
        const m=new THREE.Mesh(_coinGeo,mat);
        m.position.set(x,4+Math.random()*2,z);
        effectGroup.add(m);
        const ang=Math.PI*2*i/count+Math.random()*0.5;
        particles3d.push({mesh:m,
            vx:Math.cos(ang)*(1.2+Math.random()*0.8),
            vy:0.8+Math.random()*0.6,
            vz:Math.sin(ang)*(1.2+Math.random()*0.8),
            life:40+Math.floor(Math.random()*20),maxLife:60,coinFx:true});
    }
}

let playerMesh;

// ‚îÄ‚îÄ Shark system ‚îÄ‚îÄ
function makeSharkMesh(){
    const g=new THREE.Group();
    const bodyMat=new THREE.MeshStandardMaterial({color:0x556677,roughness:0.4,metalness:0.2});
    // Body - elongated, aligned along Z (forward = -Z like boats)
    const body=new THREE.Mesh(new THREE.CylinderGeometry(2,3,18,8),bodyMat);
    body.rotation.x=Math.PI/2;body.position.set(0,0,0);g.add(body);
    // Nose cone pointing forward (-Z)
    const nose=new THREE.Mesh(new THREE.ConeGeometry(2,6,8),bodyMat);
    nose.rotation.x=-Math.PI/2;nose.position.set(0,0,-12);g.add(nose);
    // Dorsal fin
    const finMat=new THREE.MeshStandardMaterial({color:0x445566,roughness:0.5});
    const fin=new THREE.Mesh(new THREE.ConeGeometry(1.5,6,4),finMat);
    fin.position.set(0,5,0);g.add(fin);
    // Tail pointing back (+Z)
    const tail=new THREE.Mesh(new THREE.ConeGeometry(2.5,5,4),finMat);
    tail.rotation.x=Math.PI*0.15;tail.position.set(0,2,10);g.add(tail);
    // Eyes - red
    const eyeMat=new THREE.MeshBasicMaterial({color:0xff2222});
    const eyeL=new THREE.Mesh(new THREE.SphereGeometry(0.6,6,6),eyeMat);
    eyeL.position.set(1.8,1,-6);g.add(eyeL);
    const eyeR=eyeL.clone();eyeR.position.x=-1.8;g.add(eyeR);
    // Scale 2x
    g.scale.set(2,2,2);
    return g;
}

function spawnShark(){
    sharkSpawnCount++;
    const ang=Math.random()*Math.PI*2;
    const r=WORLD_R*0.7;
    const x=WORLD_CX+Math.cos(ang)*r;
    const z=WORLD_CZ+Math.sin(ang)*r;
    // Each shark is faster than the last
    const speedMult=1+sharkSpawnCount*0.15;
    const spd=sharkBaseSpeed*speedMult;
    const mesh=makeSharkMesh();
    mesh.position.set(x,-2,z);
    sharkGroup.add(mesh);
    const shark={x,z,angle:Math.random()*Math.PI*2,speed:spd,mesh,target:null,thinkTimer:0};
    sharks.push(shark);
    spawnStatusSprite(x,z,'ü¶à SHARK!','#d32f2f');
    playTone(150,0.25,0.5,'sawtooth');
}

function spawnExplosion(x,z){
    // Ring of fire particles
    const _explGeo=new THREE.SphereGeometry(1,3,3);
    for(let i=0;i<12;i++){
        const colors=[0xff5722,0xff9800,0xffeb3b,0xd32f2f,0xff6f00];
        const mat=new THREE.MeshBasicMaterial({color:colors[Math.floor(Math.random()*5)],transparent:true,opacity:1});
        const m=new THREE.Mesh(_explGeo,mat);
        m.position.set(x,2+Math.random()*3,z);
        effectGroup.add(m);
        const ang=Math.PI*2*i/12+Math.random()*0.3;
        const spd=1.5+Math.random()*2;
        particles3d.push({mesh:m,vx:Math.cos(ang)*spd,vy:1.5+Math.random()*1.5,vz:Math.sin(ang)*spd,life:40+Math.floor(Math.random()*15),maxLife:55});
    }
    // Debris chunks
    const _debrisGeo=new THREE.BoxGeometry(1.2,0.6,1.2);
    const debrisMat=new THREE.MeshStandardMaterial({color:0x8B6914,roughness:0.8,transparent:true,opacity:1});
    for(let i=0;i<5;i++){
        const m=new THREE.Mesh(_debrisGeo,debrisMat.clone());
        m.position.set(x,3,z);
        effectGroup.add(m);
        const ang=Math.PI*2*i/5;
        particles3d.push({mesh:m,vx:Math.cos(ang)*(1+Math.random()),vy:1+Math.random()*2,vz:Math.sin(ang)*(1+Math.random()),life:60,maxLife:60});
    }
    // Shockwave ring
    const ringGeo=new THREE.RingGeometry(0.5,2,24);
    const ringMat=new THREE.MeshBasicMaterial({color:0xffeb3b,transparent:true,opacity:0.8,side:THREE.DoubleSide});
    const ring=new THREE.Mesh(ringGeo,ringMat);
    ring.rotation.x=-Math.PI/2;ring.position.set(x,3,z);
    effectGroup.add(ring);
    particles3d.push({mesh:ring,vx:0,vy:0.05,vz:0,life:30,maxLife:30,shockwave:true});
    // Sound
    playTone(100,0.3,0.6,'sawtooth');
    setTimeout(()=>playTone(80,0.2,0.4,'square'),100);
    setTimeout(()=>playTone(200,0.15,0.3,'sine'),200);
}

function initGame(){
    // Clear 3D
    while(fishGroup.children.length)fishGroup.remove(fishGroup.children[0]);
    while(boatGroup.children.length)boatGroup.remove(boatGroup.children[0]);
    while(effectGroup.children.length)effectGroup.remove(effectGroup.children[0]);
    while(sanctGroup.children.length)sanctGroup.remove(sanctGroup.children[0]);

    fish=[];collapsed=false;gameTime=0;particles3d=[];catchLines=[];botTotalCatch=0;
    profitHist=[];stockHist=[];priceHist=[];boatsHist=[];profitThisSec=0;harvestThisSec=0;lastHarvest=0;
    profitWindow=[];totalWelfare=0;welfareThisSec=0;welfareHist=[];scenarioTimeLeft=90*60;scenarioActive=true;
    currentPrice=DEMAND_INTERCEPT;supplySmooth=0;totalHarvestRate=0;
    sanctuaries=[];placingSanctuary=false;$('placingIndicator').style.display='none';
    // Clear sharks
    while(sharkGroup.children.length)sharkGroup.remove(sharkGroup.children[0]);
    sharks=[];cumulativeFishingTime=0;sharkSpawnCount=0;

    player={x:W3/2,z:H3/2,vx:0,vz:0,angle:-Math.PI/2,speed:0,catch:0,profit:0,crewMeshes:[],_recentRevenue:0};
    // Player dock
    const pDockAng=-Math.PI/2;
    player.dockX=WORLD_CX+Math.cos(pDockAng)*(WORLD_R+15);
    player.dockZ=WORLD_CZ+Math.sin(pDockAng)*(WORLD_R+15);
    player.dockAng=pDockAng;
    const pDock=makeDockMesh(player.dockX,player.dockZ,player.dockAng);
    sanctGroup.add(pDock);
    // Player coin pile
    player.coinPile=new THREE.Group();
    player.coinPile.position.set(player.dockX,0,player.dockZ);
    sanctGroup.add(player.coinPile);

    playerMesh=makeBoatMesh(0x4fc3f7);
    const ps=SIZE_LEVELS[sizeIdx]*0.8;playerMesh.scale.set(ps,ps,ps);
    playerMesh.position.set(player.x,0,player.z);boatGroup.add(playerMesh);

    for(let i=0;i<FISH_CAPACITY;i++){const f=spawnFishData();fish.push(f);addFish3D(f);}
    bots=[];for(let i=0;i<initialBotCount;i++){const b=makeBotData();bots.push(b);addBot3D(b);}

    $('collapseAlert').classList.remove('show');
    allowSpawn=$('spawnChk').checked;
    updateInsight();
}

// ‚îÄ‚îÄ Particle effects ‚îÄ‚îÄ
function spawnBirthEffect(x,z){
    for(let i=0;i<6;i++){
        const geo=new THREE.SphereGeometry(0.4,4,4);
        const mat=new THREE.MeshBasicMaterial({color:Math.random()>.5?0x81c784:0xf6c643,transparent:true,opacity:1});
        const m=new THREE.Mesh(geo,mat);
        const ang=Math.PI*2*i/6;
        m.position.set(x,-3,z);
        effectGroup.add(m);
        particles3d.push({mesh:m,vx:Math.cos(ang)*0.5,vy:0.3,vz:Math.sin(ang)*0.5,life:40,maxLife:40});
    }
}
let _popupOffset=0; // stagger popups
const _catchGeoSmall=new THREE.SphereGeometry(0.3,3,3);
const _catchGeoLarge=new THREE.SphereGeometry(0.6,3,3);
let _botCatchCounter=0;
function spawnCatchEffect(x,z,isPlayer,earnAmount){
    const col=isPlayer?0xf6c643:0xef5350;
    // Fewer particles for bots, shared geometry
    const pCount=isPlayer?(fpvMode?2:4):(fpvMode?1:2);
    const geo=fpvMode?_catchGeoSmall:_catchGeoLarge;
    for(let i=0;i<pCount;i++){
        const mat=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:1});
        const m=new THREE.Mesh(geo,mat);
        const ang=Math.PI*2*i/pCount;
        m.position.set(x,-1,z);effectGroup.add(m);
        particles3d.push({mesh:m,vx:Math.cos(ang)*(fpvMode?0.4:0.8),vy:0.6+Math.random()*0.4,vz:Math.sin(ang)*(fpvMode?0.4:0.8),life:25,maxLife:25});
    }
    // Floating profit text
    if(isPlayer&&earnAmount>0){
        _popupOffset=(_popupOffset+1)%3;
        const canvas2=document.createElement('canvas');
        if(fpvMode){
            canvas2.width=256;canvas2.height=96;
            const ctx2=canvas2.getContext('2d');
            ctx2.font='bold 64px Fredoka';ctx2.textAlign='center';ctx2.textBaseline='middle';
            ctx2.fillStyle='#f6c643';
            const txt='+$'+earnAmount.toFixed(1);
            ctx2.fillText(txt,128,48);
            const tex=new THREE.CanvasTexture(canvas2);
            const spriteMat=new THREE.SpriteMaterial({map:tex,transparent:true,opacity:0.9,depthTest:false});
            const sprite=new THREE.Sprite(spriteMat);
            sprite.scale.set(12,4.5,1);
            const ox=(_popupOffset-1)*5;
            sprite.position.set(x+ox,6,z);
            effectGroup.add(sprite);
            particles3d.push({mesh:sprite,vx:ox*0.01,vy:0.25,vz:0,life:50,maxLife:50});
        } else {
            canvas2.width=512;canvas2.height=192;
            const ctx2=canvas2.getContext('2d');
            ctx2.font='bold 120px Fredoka';ctx2.textAlign='center';ctx2.textBaseline='middle';
            ctx2.shadowColor='#000000';ctx2.shadowBlur=4;
            ctx2.strokeStyle='#1a1200';ctx2.lineWidth=8;
            ctx2.fillStyle='#ffeb3b';
            const txt='+$'+earnAmount.toFixed(1);
            ctx2.strokeText(txt,256,96);ctx2.fillText(txt,256,96);
            const tex=new THREE.CanvasTexture(canvas2);
            const spriteMat=new THREE.SpriteMaterial({map:tex,transparent:true,opacity:1,depthTest:false});
            const sprite=new THREE.Sprite(spriteMat);
            sprite.scale.set(35,13,1);
            const ox=(_popupOffset-1)*12;
            sprite.position.set(x+ox,12,z);
            effectGroup.add(sprite);
            particles3d.push({mesh:sprite,vx:ox*0.02,vy:0.4,vz:0,life:70,maxLife:70});
        }
    }
    // Bot profit text ‚Äî only every 3rd catch to reduce canvas texture creation
    if(!isPlayer){
        _botCatchCounter++;
        if(_botCatchCounter%3===0){
            const canvas2=document.createElement('canvas');
            canvas2.width=256;canvas2.height=96;
            const ctx2=canvas2.getContext('2d');
            ctx2.font='bold 64px Fredoka';ctx2.textAlign='center';ctx2.textBaseline='middle';
            ctx2.shadowColor='#000';ctx2.shadowBlur=2;
            ctx2.strokeStyle='#1a0000';ctx2.lineWidth=4;
            ctx2.fillStyle='#ef5350';
            const profitText=earnAmount>0?'$'+earnAmount.toFixed(1):'$0';
            ctx2.strokeText(profitText,128,48);ctx2.fillText(profitText,128,48);
            const tex=new THREE.CanvasTexture(canvas2);
            const spriteMat=new THREE.SpriteMaterial({map:tex,transparent:true,opacity:1,depthTest:false});
            const sprite=new THREE.Sprite(spriteMat);
            sprite.scale.set(18,9,1);
            sprite.position.set(x,6,z);effectGroup.add(sprite);
            particles3d.push({mesh:sprite,vx:0,vy:0.2,vz:0,life:35,maxLife:35});
        }
    }
}

function spawnCatchLine(boatX,boatZ,fishX,fishZ){
    const geo=new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(boatX,2,boatZ),
        new THREE.Vector3(fishX,-1,fishZ)
    ]);
    const mat=new THREE.LineBasicMaterial({color:0xffffff,transparent:true,opacity:0.9,linewidth:2});
    const line=new THREE.Line(geo,mat);
    effectGroup.add(line);
    catchLines.push({mesh:line,life:12,maxLife:12});
}

// ‚îÄ‚îÄ Market ‚îÄ‚îÄ
// Pure inverse demand: price = DEMAND_INTERCEPT - DEMAND_SLOPE * Q
// Q = supplySmooth = smoothed harvest rate (fish/sec brought to market)
// High catch ‚Üí lots of fish on market ‚Üí low price. Low catch ‚Üí scarce ‚Üí high price.
function updateMarket(){
    supplySmooth=supplySmooth*.75+totalHarvestRate*.25; // responsive to harvest changes
    currentPrice=Math.max(0.5,Math.round((DEMAND_INTERCEPT-DEMAND_SLOPE*supplySmooth)*10)/10);
}
function spawnStatusSprite(x,z,text,color){
    const canvas2=document.createElement('canvas');
    canvas2.width=256;canvas2.height=64;
    const ctx2=canvas2.getContext('2d');
    ctx2.font='bold 32px Fredoka';ctx2.textAlign='center';ctx2.textBaseline='middle';
    ctx2.strokeStyle='#111';ctx2.lineWidth=4;ctx2.fillStyle=color;
    ctx2.strokeText(text,128,32);ctx2.fillText(text,128,32);
    const tex=new THREE.CanvasTexture(canvas2);
    const mat=new THREE.SpriteMaterial({map:tex,transparent:true,opacity:1,depthTest:false});
    const sprite=new THREE.Sprite(mat);
    sprite.scale.set(18,4.5,1);sprite.position.set(x,15,z);
    effectGroup.add(sprite);
    particles3d.push({mesh:sprite,vx:0,vy:0.15,vz:0,life:90,maxLife:90});
}

function updateBotEntryExit(){
    const FC_PER_SEC=1.0,VC_PER_SEC=BOAT_COST_PER_SEC;
    const totalCost=FC_PER_SEC+VC_PER_SEC;
    const revenuePerFish=Math.max(0,currentPrice-getActiveTax());
    const marketPrior=getMarketPrior();

    bots.forEach(bot=>{
        // Compute this bot's individual expected profitability from its belief
        const myRevPerSec=bot.belief_catchRate*revenuePerFish;
        const myEconProfit=myRevPerSec-totalCost;
        const myOpProfit=myRevPerSec-VC_PER_SEC;

        bot._recentRevenue=myRevPerSec;
        bot._recentCatch=bot.belief_catchRate;
        bot._econProfit=myEconProfit;
        bot._opProfit=myOpProfit;
        if(bot.profitHist.length>60)bot.profitHist.shift();
        bot.profitHist.push(myEconProfit);

        if(bot.docked&&!bot.returning){
            bot.dockTimer--;
            // Docked bots slowly update belief toward market prior (they hear rumors)
            if(gameTime%60===0){
                const rumorRate=marketPrior*HYPE_LEVELS[hypeIdx]*bot.belief_optimism;
                bot.belief_catchRate=(bot.belief_catchRate*bot.belief_n+rumorRate*0.5)/(bot.belief_n+0.5);
                // Recalc with updated belief
                const updatedRev=bot.belief_catchRate*revenuePerFish;
                const updatedEcon=updatedRev-totalCost;
                if(bot.dockTimer<=0&&updatedEcon>0.1&&allowSpawn){
                    bot.docked=false;bot.returning=false;
                    bot.actualCatchesThisSec=0;bot.actualSecsFishing=0;
                    spawnStatusSprite(bot.x,bot.z,'üìà Re-entering','#4caf50');
                }
            }
        } else if(bot.returning){
            // handled in movement
        } else if(!bot.docked){
            // Active fishing: update belief each second
            if(gameTime%60===0){
                bot.actualSecsFishing++;
                // Bayesian update: blend observed catch rate with prior
                // observedRate = catches this second (as a per-frame rate)
                const observed=bot.actualCatchesThisSec/60; // catches per frame this second
                const weight=Math.min(bot.belief_n,5); // prior weight (capped low for faster adaptation)
                const obsWeight=3.0; // high trust in direct observation
                bot.belief_catchRate=(bot.belief_catchRate*weight+observed*obsWeight)/(weight+obsWeight);
                bot.belief_n=Math.min(10,bot.belief_n+obsWeight); // grow confidence but cap lower
                // Decay confidence over time so bots stay responsive to changing conditions
                bot.belief_n=Math.max(2,bot.belief_n*0.85);
                bot.actualCatchesThisSec=0;

                // Also weakly observe market conditions
                const marketSignal=marketPrior*0.5;
                bot.belief_catchRate=(bot.belief_catchRate*bot.belief_n+marketSignal*0.2)/(bot.belief_n+0.2);
            }

            // Individual exit decisions based on THIS bot's belief
            // Much more responsive: higher base probabilities and steeper scaling
            if(myOpProfit<0){
                const exitProb=Math.min(0.30,0.04+Math.abs(myOpProfit)*0.10);
                if(Math.random()<exitProb){
                    bot.returning=true;
                    spawnStatusSprite(bot.x,bot.z,'‚ö†Ô∏è P < AVC','#ef5350');
                }
            } else if(myEconProfit<-0.1){
                const exitProb=Math.min(0.15,0.01+Math.abs(myEconProfit)*0.03);
                if(Math.random()<exitProb){
                    bot.returning=true;
                    spawnStatusSprite(bot.x,bot.z,'üìâ P < ATC','#ff9800');
                }
            }
        }
    });

    // New entry: a prospective firm evaluates with hype-inflated prior
    if(allowSpawn&&bots.length<30){
        const hype=HYPE_LEVELS[hypeIdx];
        const prospectCatchRate=marketPrior*hype*(0.8+Math.random()*0.4);
        const prospectRev=prospectCatchRate*revenuePerFish;
        const prospectProfit=prospectRev-totalCost;
        if(prospectProfit>0){
            const entryProb=Math.min(0.25,0.02+prospectProfit*0.03);
            if(Math.random()<entryProb){
                const nb=makeBotData();nb.docked=false;nb.dockTimer=0;
                // New entrant's belief is the hyped prospect
                nb.belief_catchRate=prospectCatchRate;
                nb.belief_n=2; // low confidence, will update quickly
                bots.push(nb);addBot3D(nb);{const ab=bots.filter(b=>!b.docked);$('boatVal').textContent=ab.length+'/'+bots.length;}
                spawnStatusSprite(nb.x,nb.z,'üö§ New entrant!','#4fc3f7');
            }
        }
    }

    // Permanent exit: pessimistic docked bots leave industry
    const docked=bots.filter(b=>b.docked&&!b.returning);
    if(docked.length>0){
        // Check each docked bot individually for exit
        for(let di=docked.length-1;di>=0;di--){
            const b=docked[di];
            const bRev=b.belief_catchRate*revenuePerFish;
            const bProf=bRev-totalCost;
            const dockedTime=gameTime-b.spawnTime;
            const dockedLong=b.actualSecsFishing<3&&dockedTime>180; // fished <3s but existed >3s
            // Exit if belief is negative OR been docked a long time with bad outlook
            if((bProf<-0.1&&Math.random()<0.08)||(dockedLong&&bProf<0&&Math.random()<0.06)){
                const idx=bots.indexOf(b);
                if(idx>=0){
                    spawnStatusSprite(b.x,b.z,'üö´ Exited industry','#ef5350');
                    if(b.mesh)boatGroup.remove(b.mesh);
                    if(b.dockMesh)sanctGroup.remove(b.dockMesh);
                    if(b.coinPile)sanctGroup.remove(b.coinPile);
                    if(selectedBot===b){$('boatInfo').classList.remove('show');selectedBot=null;}
                    bots.splice(idx,1);{const ab=bots.filter(b=>!b.docked);$('boatVal').textContent=ab.length+'/'+bots.length;}
                }
            }
        }
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function update(){
    if(collapsed)return;
    gameTime++;
    const pMaxSpd=SPEED_LEVELS[speedIdx];
    const bMaxBase=pMaxSpd*0.9;
    const catchR=getCatchR();
    const schoolF=Math.sign(schoolStrength)*(Math.abs(schoolStrength)/20)*(Math.abs(schoolStrength)/20)*4; // negative = repulsion

    // ‚îÄ Player ‚îÄ
    let tI=0,thI=0;
    if(keys['a']||keys['arrowleft'])tI-=1;if(keys['d']||keys['arrowright'])tI+=1;
    if(keys['w']||keys['arrowup'])thI=1;if(keys['s']||keys['arrowdown'])thI=-.5;

    // If player presses movement keys, snap camera back to follow
    if(tI!==0||thI!==0) camFollowPlayer=true;

    player.angle+=tI*.05;
    // Scale acceleration with speed level so high speeds are actually reachable
    const accelF=0.04+pMaxSpd*0.008;
    player.vx+=Math.sin(player.angle)*thI*accelF;player.vz+=-Math.cos(player.angle)*thI*accelF;
    const drag=MOMENTUM_LEVELS[momentumIdx];
    player.vx*=drag;player.vz*=drag;
    let spd=Math.hypot(player.vx,player.vz);
    if(spd>pMaxSpd){player.vx*=pMaxSpd/spd;player.vz*=pMaxSpd/spd;spd=pMaxSpd;}
    player.speed=spd;player.x+=player.vx;player.z+=player.vz;
    const pc=clampToCircle(player.x,player.z);player.x=pc.x;player.z=pc.z;

    // Camera follow player smoothly
    if(fpvMode){
        // Smooth the camera angle ‚Äî lerp toward player angle to avoid snap on turn
        let angleDiff=player.angle-fpvSmoothedAngle;
        while(angleDiff>Math.PI)angleDiff-=Math.PI*2;
        while(angleDiff<-Math.PI)angleDiff+=Math.PI*2;
        fpvSmoothedAngle+=angleDiff*0.025; // very gentle angle follow
        const fpvAngle=fpvSmoothedAngle+fpvAngleOffset;
        const lookDist=150;
        const camX=player.x-Math.sin(fpvAngle)*fpvDist;
        const camZ=player.z+Math.cos(fpvAngle)*fpvDist;
        const lookX=player.x+Math.sin(fpvAngle)*lookDist;
        const lookZ=player.z-Math.cos(fpvAngle)*lookDist;
        camera.position.x+=(camX-camera.position.x)*0.04;
        camera.position.y+=(fpvHeightBase-camera.position.y)*0.04;
        camera.position.z+=(camZ-camera.position.z)*0.04;
        camera.lookAt(lookX,1,lookZ);
    } else if(camFollowPlayer){
        camTarget.x+=(player.x-camTarget.x)*0.08;
        camTarget.z+=(player.z-camTarget.z)*0.08;
        updateCamera();
    }

    if(playerMesh){
        const sz=SIZE_LEVELS[sizeIdx]*0.8;playerMesh.scale.set(sz,sz,sz);
        playerMesh.position.set(player.x,Math.sin(gameTime*0.05)*0.3,player.z);
        playerMesh.rotation.y=-player.angle;
        if(playerMesh.userData.flag)playerMesh.userData.flag.rotation.y=Math.sin(gameTime*0.08)*0.3;
    }

    // ‚îÄ Bots ‚îÄ
    const activeBots=bots.filter(b=>!b.docked&&!b.returning);
    bots.forEach(bot=>{
        const bMax=bMaxBase*(.9+bot.greed*.1);
        const botAccelF=0.04+bMaxBase*0.008;

        if(bot.docked){
            // Sit at dock
            bot.x=bot.dockX;bot.z=bot.dockZ;bot.vx=0;bot.vz=0;
            if(bot.mesh){
                const sz=SIZE_LEVELS[sizeIdx]*0.8;bot.mesh.scale.set(sz,sz,sz);
                bot.mesh.position.set(bot.dockX,0.5,bot.dockZ);
                // Grey out
                bot.mesh.traverse(c=>{if(c.material&&!c._origColor){c._origColor=c.material.color.getHex();c.material.color.setHex(0x556677);}});
            }
        } else if(bot.returning){
            // Drive back to dock ‚Äî decelerate as approaching
            const dx=bot.dockX-bot.x,dz=bot.dockZ-bot.z,dd=Math.hypot(dx,dz);
            if(dd<12){
                // Close enough: snap to dock, kill velocity
                bot.returning=false;bot.docked=true;bot.dockTimer=15+Math.floor(Math.random()*30);
                bot.vx=0;bot.vz=0;bot.x=bot.dockX;bot.z=bot.dockZ;
            } else {
                // Steer toward dock
                const des=Math.atan2(dx,-dz);
                let diff=des-bot.angle;while(diff>Math.PI)diff-=Math.PI*2;while(diff<-Math.PI)diff+=Math.PI*2;
                bot.angle+=Math.sign(diff)*Math.min(Math.abs(diff),bot.turnRate*3);
                // Decelerate when getting close
                const speedFactor=Math.min(1,dd/60);
                bot.vx+=Math.sin(bot.angle)*speedFactor*1.0*botAccelF;
                bot.vz+=-Math.cos(bot.angle)*speedFactor*1.0*botAccelF;
                // Strong braking drag when close
                const brakeDrag=dd<30?0.90:MOMENTUM_LEVELS[momentumIdx];
                bot.vx*=brakeDrag;bot.vz*=brakeDrag;
            }
            const bs=Math.hypot(bot.vx,bot.vz);if(bs>bMax){bot.vx*=bMax/bs;bot.vz*=bMax/bs;}
            bot.x+=bot.vx;bot.z+=bot.vz;
            bot.speed=Math.hypot(bot.vx,bot.vz);
            if(bot.mesh){
                const sz=SIZE_LEVELS[sizeIdx]*0.8;bot.mesh.scale.set(sz,sz,sz);
                bot.mesh.traverse(c=>{if(c.material&&!c._origColor){c._origColor=c.material.color.getHex();c.material.color.setHex(0x887777);}});
                bot.mesh.position.set(bot.x,Math.sin(gameTime*0.05+bot.greed*5)*0.3,bot.z);
                bot.mesh.rotation.y=-bot.angle;
            }
        } else {
            // Fishing ‚Äî restore color
            if(bot.mesh){
                bot.mesh.traverse(c=>{if(c.material&&c._origColor){c.material.color.setHex(c._origColor);delete c._origColor;}});
            }
            bot.thinkTimer--;
            if(bot.thinkTimer<=0||!bot.targetFish||!fish.includes(bot.targetFish)){
                let best=null,bestD=Infinity;
                // Never target fish inside sanctuaries
                fish.forEach(f=>{if(isInSanctuary(f.x,f.z))return;const d=(f.x-bot.x)**2+(f.z-bot.z)**2;if(d<bestD){bestD=d;best=f;}});
                bot.targetFish=best;bot.thinkTimer=10+Math.floor(Math.random()*20);
            }
            let bt=0.85;
            if(bot.targetFish){
                const des=Math.atan2(bot.targetFish.x-bot.x,-(bot.targetFish.z-bot.z));
                let diff=des-bot.angle;while(diff>Math.PI)diff-=Math.PI*2;while(diff<-Math.PI)diff+=Math.PI*2;
                bot.angle+=Math.sign(diff)*Math.min(Math.abs(diff),bot.turnRate);
            }
            bot.vx+=Math.sin(bot.angle)*bt*botAccelF;bot.vz+=-Math.cos(bot.angle)*bt*botAccelF;
            const bDrag=MOMENTUM_LEVELS[momentumIdx];bot.vx*=bDrag;bot.vz*=bDrag;
            const bs=Math.hypot(bot.vx,bot.vz);if(bs>bMax){bot.vx*=bMax/bs;bot.vz*=bMax/bs;}
            bot.x+=bot.vx;bot.z+=bot.vz;
            // Sanctuary physical repulsion ‚Äî push bot out if inside
            for(const s of sanctuaries){
                const sdx=bot.x-s.x,sdz=bot.z-s.z,sd=Math.hypot(sdx,sdz);
                if(sd<s.r){
                    // Push out to edge
                    const pushStr=2.0*(1-sd/s.r);
                    bot.vx+=(sdx/sd)*pushStr;bot.vz+=(sdz/sd)*pushStr;
                    bot.x=s.x+sdx/sd*s.r;bot.z=s.z+sdz/sd*s.r;
                } else if(sd<s.r+30){
                    // Gentle repulsion near boundary
                    const pushStr=0.3*(1-(sd-s.r)/30);
                    bot.vx+=(sdx/sd)*pushStr;bot.vz+=(sdz/sd)*pushStr;
                }
            }
            const bc=clampToCircle(bot.x,bot.z);bot.x=bc.x;bot.z=bc.z;
            bot.speed=Math.hypot(bot.vx,bot.vz);
            if(bot.mesh){
                const sz=SIZE_LEVELS[sizeIdx]*0.8;bot.mesh.scale.set(sz,sz,sz);
                bot.mesh.position.set(bot.x,Math.sin(gameTime*0.05+bot.greed*5)*0.3,bot.z);
                bot.mesh.rotation.y=-bot.angle;
                if(bot.mesh.userData.flag)bot.mesh.userData.flag.rotation.y=Math.sin(gameTime*0.08+bot.greed)*0.3;
            }
        }
    });

    // ‚îÄ Fish ‚îÄ
    const cx=WORLD_CX,cz=WORLD_CZ;
    const fSpd=FISH_SPEED_LEVELS[fishSpeedIdx];
    for(let fi=0;fi<fish.length;fi++){
        const f=fish[fi];
        f.wobble+=0.03;f.turnTimer--;
        // Random direction changes ‚Äî frequent and lively
        if(f.turnTimer<=0){f.schoolAng+=(Math.random()-.5)*2.5;f.turnTimer=15+Math.floor(Math.random()*50);}
        // Base wandering drive ‚Äî scaled by fish speed, with strong active swimming
        f.vx+=Math.cos(f.schoolAng)*.006*fSpd;f.vz+=Math.sin(f.schoolAng)*.006*fSpd;
        // Random jitter for organic movement
        f.vx+=(Math.random()-.5)*.025*fSpd;f.vz+=(Math.random()-.5)*.025*fSpd;
        // Circular boundary repulsion (keep fish in bounds but no center pull)
        const fd=distFromCenter(f.x,f.z);
        if(fd>WORLD_R*0.82){
            const push=(fd-WORLD_R*0.82)/(WORLD_R*0.18)*0.015*fSpd;
            f.vx+=(WORLD_CX-f.x)/fd*push;f.vz+=(WORLD_CZ-f.z)/fd*push;
        }
        // Very gentle center drift only when far out (prevents permanent edge hugging)
        const dc=Math.hypot(cx-f.x,cz-f.z);
        if(dc>WORLD_R*0.7){f.vx+=(cx-f.x)/dc*.0005*fSpd;f.vz+=(cz-f.z)/dc*.0005*fSpd;}
        // Flee boats ‚Äî with lateral scatter to avoid ring formation
        for(const b of[player,...activeBots]){
            const dx=f.x-b.x,dz=f.z-b.z,d=Math.hypot(dx,dz);
            if(d<110&&d>1){
                const fl=.15*(1-d/110)*(1-d/110)*fSpd;
                // Add perpendicular scatter (random left or right of flee direction)
                const scatter=(Math.random()-.5)*0.7;
                f.vx+=(dx/d+scatter*(-dz/d))*fl;
                f.vz+=(dz/d+scatter*(dx/d))*fl;
            }
        }
        // Sanctuary attract
        for(const s of sanctuaries){const d=Math.hypot(s.x-f.x,s.z-f.z);if(d>s.r&&d<s.r*3){f.vx+=(s.x-f.x)/d*.003*fSpd;f.vz+=(s.z-f.z)/d*.003*fSpd;}}
        // Schooling
        if(schoolF!==0){let nx=0,nz=0,nc=0;const lo=Math.max(0,fi-30),hi=Math.min(fish.length,fi+30);
            for(let j=lo;j<hi;j++){if(j===fi)continue;const dx=fish[j].x-f.x,dz=fish[j].z-f.z,dd=dx*dx+dz*dz;
                if(dd<3000&&dd>80){nx+=dx;nz+=dz;nc++;}if(dd<200&&dd>0){const d=Math.sqrt(dd);f.vx-=(dx/d)*.01*schoolF;f.vz-=(dz/d)*.01*schoolF;}}
            if(nc>0){f.vx+=nx/nc*.002*schoolF;f.vz+=nz/nc*.002*schoolF;}}
        // Drag and max speed scaled by fish speed level
        f.vx*=.975;f.vz*=.975;
        const fMaxSpd=0.5+fSpd*0.7;
        const fs2=Math.hypot(f.vx,f.vz);if(fs2>fMaxSpd){f.vx*=fMaxSpd/fs2;f.vz*=fMaxSpd/fs2;}
        f.x+=f.vx;f.z+=f.vz;const fc=clampToCircle(f.x,f.z);f.x=fc.x;f.z=fc.z;
        // Update 3D
        if(f.mesh){f.mesh.position.set(f.x,-2.5+Math.sin(f.wobble)*0.5,f.z);const fspd=Math.hypot(f.vx,f.vz);if(fspd>0.05)f.mesh.rotation.y=-Math.atan2(f.vx,-f.vz);}
    }

    // ‚îÄ Catch ‚îÄ
    const aTax=getActiveTax();const effPrice=currentPrice-aTax;
    for(let i=fish.length-1;i>=0;i--){
        const f=fish[i];if(isInSanctuary(f.x,f.z))continue;
        const d=Math.hypot(f.x-player.x,f.z-player.z);
        if(d<catchR){
            const earn=Math.max(0,Math.round(effPrice*10)/10);
            player.catch++;player.profit+=earn;profitThisSec+=earn;welfareThisSec+=earn;harvestThisSec++;
            spawnCatchEffect(player.x,player.z,true,earn);
            spawnCatchLine(player.x,player.z,f.x,f.z);
            if(earn>0)spawnCoinTrail(player.x,player.z,player.dockX,player.dockZ,1);
            playCatchSound(true);
            if(f.mesh)fishGroup.remove(f.mesh);fish.splice(i,1);continue;
        }
        for(const bot of activeBots){
            const bd=Math.hypot(f.x-bot.x,f.z-bot.z);
            if(bd<catchR*.75){
                const botEarn=Math.max(0,currentPrice-getActiveTax());
                bot.catch++;bot.totalProfit+=botEarn;botTotalCatch++;harvestThisSec++;welfareThisSec+=botEarn;
                bot.actualCatchesThisSec++; // feeds Bayesian belief update
                spawnCatchEffect(bot.x,bot.z,false,botEarn);
                spawnCatchLine(bot.x,bot.z,f.x,f.z);
                if(botEarn>0&&bot.catch%3===0)spawnCoinTrail(bot.x,bot.z,bot.dockX,bot.dockZ,1);
                playCatchSound(false);
                if(f.mesh)fishGroup.remove(f.mesh);fish.splice(i,1);break;
            }
        }
    }

    // ‚îÄ Ramming (Pirate scenario) ‚îÄ
    if(rammingEnabled){
        const ramRadius=getCatchR()*1.2;
        for(const bot of activeBots){
            const rd=Math.hypot(player.x-bot.x,player.z-bot.z);
            if(rd<ramRadius&&player.speed>2){
                // Ram! Send bot back to dock
                bot.returning=true;
                bot.totalProfit=Math.max(0,bot.totalProfit*0.85); // 15% profit penalty
                bot.belief_catchRate*=0.5; // discourage re-entry
                spawnStatusSprite(bot.x,bot.z,'üí• Rammed!','#ff5722');
                spawnCoinBurst(bot.x,bot.z,8);
                // Knockback
                const kx=(bot.x-player.x)/rd,kz=(bot.z-player.z)/rd;
                bot.vx+=kx*3;bot.vz+=kz*3;
                player.vx-=kx*0.5;player.vz-=kz*0.5;
                playTone(200,0.2,0.3,'sawtooth');
            }
        }
    }

    // ‚îÄ Sharks ‚îÄ
    if(sharksEnabled){
        // Accumulate fishing time (1 frame per active bot + player)
        const activeBoatCount=activeBots.length+1; // +1 for player
        cumulativeFishingTime+=activeBoatCount;
        const threshFrames=sharkThreshold*60; // convert seconds to frames
        const progress=cumulativeFishingTime%threshFrames;
        // Spawn shark when threshold reached
        if(cumulativeFishingTime>0&&progress<activeBoatCount&&cumulativeFishingTime>=threshFrames*(sharks.length+1)){
            spawnShark();
        }
        // Update shark bar
        if(gameTime%10===0){
            const pct=Math.min(100,(progress/threshFrames)*100);
            $('sharkBar').style.width=pct+'%';
            $('sharkProgress').textContent=Math.floor(pct)+'%';
            $('sharkCount').textContent='ü¶à '+sharks.length;
        }
        // Shark AI: chase nearest active boat
        for(const shark of sharks){
            shark.thinkTimer--;
            if(shark.thinkTimer<=0){
                // Find nearest target (bot or player)
                let best=null,bestD=Infinity;
                // Player
                const pd=Math.hypot(player.x-shark.x,player.z-shark.z);
                if(pd<bestD){bestD=pd;best={x:player.x,z:player.z,isPlayer:true};}
                // Active bots
                for(const bot of activeBots){
                    const bd=Math.hypot(bot.x-shark.x,bot.z-shark.z);
                    if(bd<bestD){bestD=bd;best={x:bot.x,z:bot.z,isPlayer:false,bot};}
                }
                shark.target=best;
                shark.thinkTimer=15+Math.floor(Math.random()*10);
            }
            // Move toward target
            if(shark.target){
                const dx=shark.target.x-shark.x,dz=shark.target.z-shark.z;
                const des=Math.atan2(dx,-dz);
                let diff=des-shark.angle;while(diff>Math.PI)diff-=Math.PI*2;while(diff<-Math.PI)diff+=Math.PI*2;
                shark.angle+=Math.sign(diff)*Math.min(Math.abs(diff),0.06);
            }
            shark.x+=Math.sin(shark.angle)*shark.speed;
            shark.z+=-Math.cos(shark.angle)*shark.speed;
            // Clamp to world
            const sc2=clampToCircle(shark.x,shark.z);shark.x=sc2.x;shark.z=sc2.z;
            // Animate mesh
            if(shark.mesh){
                shark.mesh.position.set(shark.x,-2+Math.sin(gameTime*0.04)*1.5,shark.z);
                shark.mesh.rotation.y=-shark.angle;
                const wobble=Math.sin(gameTime*0.08)*0.1;
                shark.mesh.rotation.z=wobble;
            }
            // Check collision with boats
            const eatRadius=12;
            // Player
            if(Math.hypot(player.x-shark.x,player.z-shark.z)<eatRadius){
                spawnExplosion(player.x,player.z);
                // End scenario for player
                collapsed=true;scenarioActive=false;
                const colElapsedSecs=Math.max(1,Math.floor(gameTime/60));
                const colDiscFactor=discountRate>0?Math.pow(1+discountRate,colElapsedSecs):1;
                const colFishVal=(fish.length*currentPrice)/colDiscFactor;
                const colFinalWelfare=totalWelfare+colFishVal;
                const isNew=highScores[currentScenario]===undefined||player.profit>highScores[currentScenario].profit;
                if(isNew||!highScores[currentScenario])highScores[currentScenario]={profit:player.profit,welfare:colFinalWelfare};
                const al=$('collapseAlert');
                al.innerHTML=`<h2 style="color:var(--red)">ü¶à Eaten by Shark!</h2><p>A shark destroyed your boat!</p>
                    <div class="score-grid"><span class="sg-label">Your Profit</span><span class="sg-val" style="color:var(--gold)">$${player.profit.toFixed(0)}</span>
                    <span class="sg-label">Total Welfare</span><span class="sg-val" style="color:var(--green)">$${colFinalWelfare.toFixed(0)}</span></div>
                    <button class="restart-btn" onclick="window.applyScenario('${currentScenario}')">üîÑ Retry</button>`;
                al.classList.add('show');
                if(playerMesh){boatGroup.remove(playerMesh);playerMesh=null;}
                break;
            }
            // Bots
            for(let bi=bots.length-1;bi>=0;bi--){
                const bot=bots[bi];
                if(bot.docked)continue;
                if(Math.hypot(bot.x-shark.x,bot.z-shark.z)<eatRadius){
                    spawnExplosion(bot.x,bot.z);
                    spawnStatusSprite(bot.x,bot.z,'ü¶à DESTROYED','#d32f2f');
                    if(bot.mesh)boatGroup.remove(bot.mesh);
                    if(bot.dockMesh)sanctGroup.remove(bot.dockMesh);
                    if(bot.coinPile)sanctGroup.remove(bot.coinPile);
                    if(selectedBot===bot){$('boatInfo').classList.remove('show');selectedBot=null;}
                    bots.splice(bi,1);
                }
            }
        }
    }

    // ‚îÄ Coin piles + crew + profit indicators (every 30 frames) ‚îÄ
    if(gameTime%30===0){
        // Player coin pile + crew
        if(player.coinPile)updateCoinPile(player.coinPile,player.profit);
        // Track player revenue rate (smoothed)
        player._recentRevenue=(player._recentRevenue||0)*0.8+profitThisSec*0.2*60;
        updateBoatCrew(player);
        // Bot coin piles + crew + profit indicators
        for(const bot of bots){
            if(bot.coinPile)updateCoinPile(bot.coinPile,bot.totalProfit);
            if(!bot.docked&&!bot.returning)updateBoatCrew(bot);
            if(!bot.docked&&!bot.returning)updateProfitIndicator(bot);
        }
    }

    // ‚îÄ Reproduction ‚îÄ
    const N=fish.length,A=ALLEE_FRAC*FISH_CAPACITY,K=FISH_CAPACITY;
    const dNdt=-GROWTH_RATE*N*(1-N/A)*(1-N/K);
    if(dNdt>0&&N<K){
        if(Math.random()<dNdt&&fish.length>0){const par=fish[Math.floor(Math.random()*fish.length)];const baby=spawnFishData(par);fish.push(baby);addFish3D(baby);spawnBirthEffect(baby.x,baby.z);}
        if(dNdt>1&&Math.random()<dNdt-1&&fish.length>0){const par=fish[Math.floor(Math.random()*fish.length)];const baby=spawnFishData(par);fish.push(baby);addFish3D(baby);spawnBirthEffect(baby.x,baby.z);}
    }
    if(dNdt<0&&N>0&&Math.random()<Math.abs(dNdt)){
        const idx=Math.floor(Math.random()*fish.length);
        if(fish[idx].mesh)fishGroup.remove(fish[idx].mesh);fish.splice(idx,1);
    }

    // ‚îÄ Particles ‚îÄ
    particles3d=particles3d.filter(p=>{
        p.life--;p.mesh.position.x+=p.vx;p.mesh.position.y+=p.vy;p.mesh.position.z+=p.vz;
        if(p.coinFx){
            // Coin particles: decelerate gently, fade out smoothly, flicker color
            p.vx*=.985;p.vy*=.985;p.vz*=.985;
            const t=p.life/p.maxLife;
            p.mesh.material.opacity=t*t; // quadratic fade ‚Äî mostly visible early, fades fast at end
            const flicker=0.7+Math.sin(p.life*0.8)*0.3;
            const s=Math.max(0.05,t*1.2);
            p.mesh.scale.set(s*flicker,s*flicker,s*flicker);
            p.mesh.material.color.setRGB(1,0.7+t*0.3,0.2*t); // gold‚Üíorange as it fades
        } else if(p.shockwave){
            const t=1-p.life/p.maxLife;
            const s=1+t*25;
            p.mesh.scale.set(s,s,s);
            p.mesh.material.opacity=(1-t)*(1-t);
        } else {
            p.vx*=.95;p.vy*=.95;p.vz*=.95;
            p.mesh.material.opacity=p.life/p.maxLife;
            if(p.mesh.isSprite){/* keep sprite scale constant */}
            else{const s=Math.max(0.01,p.life/p.maxLife);p.mesh.scale.set(s,s,s);}
        }
        if(p.life<=0){effectGroup.remove(p.mesh);if(p.coinFx)_coinParticleCount--;return false;}return true;
    });

    // Catch lines fade quickly
    catchLines=catchLines.filter(cl=>{
        cl.life--;cl.mesh.material.opacity=cl.life/cl.maxLife;
        if(cl.life<=0){effectGroup.remove(cl.mesh);return false;}return true;
    });

    // ‚îÄ Water animation + shimmer ‚îÄ
    const pos=waterGeo.attributes.position;
    for(let i=0;i<pos.count;i++){
        const x=pos.getX(i),y=pos.getY(i);
        pos.setZ(i,Math.sin(x*0.04+gameTime*0.04)*0.6+Math.sin(y*0.03+gameTime*0.03)*0.4);
    }
    pos.needsUpdate=true;waterGeo.computeVertexNormals();
    // Shimmer: oscillate water emissive
    const shimmer=0.03+Math.sin(gameTime*0.02)*0.02+Math.sin(gameTime*0.07)*0.01;
    waterMat.emissive=waterMat.emissive||new THREE.Color();
    waterMat.emissive.setRGB(shimmer*0.3,shimmer*0.8,shimmer*1.2);
    waterMat.emissiveIntensity=1;
    // Animate seaweed sway
    seabedGroup.children.forEach(c=>{
        if(c.userData.swayOffset!==undefined){
            c.children.forEach((blade,bi)=>{
                blade.rotation.z=Math.sin(gameTime*0.02+c.userData.swayOffset+bi*0.5)*0.15;
            });
        }
    });

    // ‚îÄ Per second ‚îÄ
    if(gameTime%60===0){
        profitWindow.push(profitThisSec);
        if(profitWindow.length>PROFIT_AVG_WINDOW)profitWindow.shift();
        lastHarvest=harvestThisSec;totalHarvestRate=harvestThisSec;
        totalWelfare+=welfareThisSec;
        welfareHist.push(welfareThisSec);if(welfareHist.length>GRAPH_LEN)welfareHist.shift();
        profitHist.push(profitThisSec);stockHist.push(fish.length);priceHist.push(currentPrice);boatsHist.push(bots.filter(b=>!b.docked).length);
        if(profitHist.length>GRAPH_LEN)profitHist.shift();if(stockHist.length>GRAPH_LEN)stockHist.shift();if(priceHist.length>GRAPH_LEN)priceHist.shift();if(boatsHist.length>GRAPH_LEN)boatsHist.shift();
        profitThisSec=0;harvestThisSec=0;welfareThisSec=0;
        updateMarket();updateBotEntryExit();
    }
    // Scenario timer
    if(scenarioActive&&scenarioTimeLeft>0){
        scenarioTimeLeft--;
        const sLeft=Math.ceil(scenarioTimeLeft/60);
        $('scenarioTimer').textContent=Math.floor(sLeft/60)+':'+String(sLeft%60).padStart(2,'0');
        $('timerBar').style.width=(scenarioTimeLeft/SCENARIO_DURATION*100)+'%';
        const pct=Math.round((1-scenarioTimeLeft/SCENARIO_DURATION)*100);
        $('scenarioProgress').textContent=pct+'% complete';
        if(scenarioTimeLeft<=0)endScenario();
    }

    // Collapse
    if(fish.length<=COLLAPSE_THRESHOLD){
        collapsed=true;scenarioActive=false;
        const secs=Math.max(1,Math.floor(gameTime/60));
        const reason=N<=A?`Allee effect ‚Äî stock fell below ${Math.round(A)} fish.`:`Overharvested in ${secs}s.`;
        const colElapsedSecs=Math.max(1,Math.floor(gameTime/60));
        const colDiscFactor=discountRate>0?Math.pow(1+discountRate,colElapsedSecs):1;
        const colFishStockValue=(fish.length*currentPrice)/colDiscFactor;
        const colFinalWelfare=totalWelfare+colFishStockValue;
        const code=makeVerifyCode(currentScenario,player.profit,colFinalWelfare,player.catch,fish.length);
        const isNew=highScores[currentScenario]===undefined||player.profit>highScores[currentScenario].profit;
        if(highScores[currentScenario]===undefined)highScores[currentScenario]={profit:player.profit,welfare:colFinalWelfare};
        if(isNew&&player.profit>0)highScores[currentScenario]={profit:player.profit,welfare:colFinalWelfare};
        updateBestScoresDisplay();
        // Build all-scenario scores summary
        const scenarioNames2={freeplay:'Free Play',simple:'Simple',solo:'Solo',freeentry:'Free Entry',fast:'Speed',policy:'Policy',hype:'Hype',pirate:'Pirate',sharks:'Sharks'};
        let allScoresHtml2='<div style="margin-top:8px;padding-top:6px;border-top:1px solid rgba(79,195,247,.15)"><div style="font-size:.44rem;text-transform:uppercase;letter-spacing:.6px;color:var(--text-dim);margin-bottom:4px">All Scenario Best Scores</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px 8px;font-size:.48rem">';
        for(const key in SCENARIOS){
            const name=scenarioNames2[key]||key;
            const score=highScores[key];
            const isCurrent=key===currentScenario;
            const color=score!==undefined?(isCurrent?'var(--gold)':'var(--text)'):'var(--text-dim)';
            const val=score!==undefined?'P$'+score.profit.toFixed(0)+' W$'+score.welfare.toFixed(0):'‚Äî';
            allScoresHtml2+=`<span style="color:${color};font-family:'JetBrains Mono',monospace;font-weight:${isCurrent?'700':'500'}">${isCurrent?'‚ñ∏ ':''}${name}: ${val}</span>`;
        }
        allScoresHtml2+='</div></div>';
        const al=$('collapseAlert');
        al.innerHTML=`
            <h2 style="color:var(--red)">üêü Fishery Collapsed!</h2>
            <p>${reason}</p>
            <div class="score-grid">
                <span class="sg-label">Your Profit</span><span class="sg-val" style="color:var(--gold)">$${player.profit.toFixed(0)}</span>
                <span class="sg-label">Total Welfare</span><span class="sg-val" style="color:var(--green)">$${colFinalWelfare.toFixed(0)}</span>
                <span class="sg-label">Your Catch</span><span class="sg-val" style="color:var(--boat-you)">${player.catch}</span>
                <span class="sg-label">Fish Stock Value</span><span class="sg-val" style="color:var(--green)">$${colFishStockValue.toFixed(0)}</span>
                <span class="sg-label">Avg $/sec</span><span class="sg-val">$${(player.profit/secs).toFixed(1)}</span>
            </div>
            ${isNew&&player.profit>0?'<div class="highscore">üèÜ New High Score!</div>':''}
            ${allScoresHtml2}
            <div class="verify">Verify: ${code}</div>
            <button class="restart-btn" onclick="window.applyScenario('${currentScenario}')">üîÑ Retry</button>
        `;
        al.classList.add('show');
    }
    updateHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HUD & GRAPHS (2D overlay)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){
    $('yourCatch').textContent=player.catch;$('yourProfit').textContent='$'+player.profit.toFixed(0);
    const avgProfit=profitWindow.length>0?profitWindow.reduce((a,b)=>a+b,0)/profitWindow.length:0;
    $('profitRate').textContent=avgProfit.toFixed(1);
    const ab=bots.filter(b=>!b.docked);$('activeBoats').textContent=ab.length+'/'+bots.length;$('boatVal').textContent=ab.length+'/'+bots.length;
    $('fishPrice').textContent='$'+currentPrice.toFixed(1);
    $('marketPriceBasic').textContent='$'+currentPrice.toFixed(1);
    const eqPrice=DEMAND_INTERCEPT; // baseline price at zero harvest
    $('fishPrice').style.color=currentPrice>eqPrice*0.8?'var(--green)':currentPrice>eqPrice*0.4?'var(--gold)':'var(--red)';
    $('marketPriceBasic').style.color=currentPrice>eqPrice*0.8?'var(--green)':currentPrice>eqPrice*0.4?'var(--gold)':'var(--red)';
    // NPV of fish stock: each fish is worth currentPrice, discounted
    // Treat as perpetuity of fish value: if discount rate is r per second,
    // NPV = fish_count * price_per_fish / (1 + r)^t where t=elapsed seconds
    // Simpler: NPV = fish_count * price / (1 + annual_discount_rate)^(elapsed_years)
    // With per-second rate: r_sec = (1+r_annual)^(1/31536000) - 1 ‚âà r_annual/31536000
    // For game time: use r_per_game_second = discountRate (treat each game-sec as a period)
    const elapsedSecs=Math.floor(gameTime/60);
    const discFactor=discountRate>0?Math.pow(1+discountRate,elapsedSecs):1;
    const fishNPV=(fish.length*currentPrice)/discFactor;
    const totalWelfareWithStock=totalWelfare+fishNPV;
    $('totalWelfare').textContent='$'+totalWelfareWithStock.toFixed(0);
    $('catchRevenue').textContent='$'+totalWelfare.toFixed(0);
    $('fishNPV').textContent='$'+fishNPV.toFixed(0);
    const secs=Math.floor(gameTime/60),m=Math.floor(secs/60),s=secs%60;
    $('gameTime').textContent=`${m}:${s.toString().padStart(2,'0')}`;
    const frac=fish.length/FISH_CAPACITY,bar=$('stockBar');bar.style.width=(frac*100)+'%';
    bar.style.background=frac>.5?'linear-gradient(90deg,#4caf50,#81c784)':frac>.25?'linear-gradient(90deg,#ff9800,#ffb74d)':'linear-gradient(90deg,#ef5350,#e57373)';
    $('stockCount').textContent=`${fish.length} / ${FISH_CAPACITY}`;
    const ap=ALLEE_FRAC*FISH_CAPACITY,st=$('stockStatus');
    if(frac>.6){st.textContent='üü¢ Healthy';st.style.color='#4caf50';}
    else if(frac>.4){st.textContent='üü° Moderate';st.style.color='#ff9800';}
    else if(fish.length>ap){st.textContent='üü† Declining';st.style.color='#ff5722';}
    else{st.textContent='üî¥ Below Allee!';st.style.color='#ef5350';}
    if(selectedBot)updateBoatInfoPanel();
}

function updateInsight(){
    const p=$('insightPanel'),A=Math.round(ALLEE_FRAC*FISH_CAPACITY);
    let msyG=0;for(let n=1;n<FISH_CAPACITY;n++){const g=-GROWTH_RATE*n*(1-n/A)*(1-n/FISH_CAPACITY);if(g>msyG)msyG=g;}
    p.innerHTML=`<strong>Market:</strong> Price $${currentPrice.toFixed(1)}, Tax $${taxRate}/fish. FC=$1/s, VC=$${BOAT_COST_PER_SEC}/s. Boats enter when P &gt; ATC, shutdown when P &lt; AVC. MSY: ~${(msyG*60).toFixed(1)} fish/s.`;
}

// Graphs (same 2D canvas overlay)
function drawGraphs(){
    const A=ALLEE_FRAC*FISH_CAPACITY,K=FISH_CAPACITY;
    let msyG=0,msyN=0;for(let n=1;n<K;n++){const g=-GROWTH_RATE*n*(1-n/A)*(1-n/K);if(g>msyG){msyG=g;msyN=n;}}
    // Compute moving-averaged profit data for graph
    const profitMA=[];
    for(let i=0;i<profitHist.length;i++){
        let sum=0,cnt=0;
        for(let j=Math.max(0,i-PROFIT_AVG_WINDOW+1);j<=i;j++){sum+=profitHist[j];cnt++;}
        profitMA.push(sum/cnt);
    }
    drawScrollGraph('gProfit',profitMA,{color:'#f6c643',refLine:msyG*60*currentPrice,refColor:'rgba(246,198,67,.4)',refLabel:'MSY',valId:'gProfitVal',prefix:'$'});
    // Welfare graph (moving avg)
    const welfareMA=[];
    for(let i=0;i<welfareHist.length;i++){let s=0,c=0;for(let j=Math.max(0,i-PROFIT_AVG_WINDOW+1);j<=i;j++){s+=welfareHist[j];c++;}welfareMA.push(s/c);}
    drawScrollGraph('gWelfare',welfareMA,{color:'#f6c643',valId:'gWelfareVal',prefix:'$'});
    drawScrollGraph('gStock',stockHist,{color:'#4fc3f7',refLine:msyN,refColor:'rgba(79,195,247,.25)',refLabel:'MSY',refLine2:A,refColor2:'rgba(255,152,0,.35)',refLabel2:'Allee',maxY:FISH_CAPACITY,valId:'gStockVal',prefix:''});
    drawGrowthCurve(A,K,msyN);
    drawScrollGraph('gPrice',priceHist,{color:'#4caf50',refLine:BOAT_COST_PER_SEC,refColor:'rgba(239,83,80,.3)',refLabel:'AVC',valId:'gPriceVal',prefix:'$'});
    drawScrollGraph('gBoats',boatsHist,{color:'#ef5350',valId:'gBoatsVal',prefix:''});
    drawMarketGraph();
}
function drawScrollGraph(cid,data,opts){
    const c=$(cid);if(!c)return;const cx2=c.getContext('2d');const dpr=window.devicePixelRatio||1;const rect=c.getBoundingClientRect();c.width=rect.width*dpr;c.height=rect.height*dpr;cx2.setTransform(dpr,0,0,dpr,0,0);const w=rect.width,h=rect.height;cx2.fillStyle='rgba(15,40,71,.5)';cx2.fillRect(0,0,w,h);
    if(data.length<2){cx2.fillStyle='rgba(122,154,181,.3)';cx2.font='500 9px Fredoka';cx2.textAlign='center';cx2.fillText('...',w/2,h/2);return;}
    const pad={l:2,r:2,t:3,b:3},gw=w-4,gh=h-6;
    let maxY=opts.maxY||Math.max(...data,opts.refLine||0,(opts.refLine2||0))*1.15;if(maxY<=0)maxY=1;
    const X=i=>pad.l+(i/(GRAPH_LEN-1))*gw;const Y=v=>pad.t+gh*(1-Math.max(0,v)/maxY);
    if(opts.refLine>0){cx2.strokeStyle=opts.refColor;cx2.lineWidth=1;cx2.setLineDash([3,3]);cx2.beginPath();cx2.moveTo(pad.l,Y(opts.refLine));cx2.lineTo(w-pad.r,Y(opts.refLine));cx2.stroke();cx2.setLineDash([]);cx2.fillStyle=opts.refColor;cx2.font='500 7px Fredoka';cx2.textAlign='right';cx2.fillText(opts.refLabel,w-3,Y(opts.refLine)-2);}
    if(opts.refLine2>0){cx2.strokeStyle=opts.refColor2;cx2.lineWidth=1;cx2.setLineDash([2,2]);cx2.beginPath();cx2.moveTo(pad.l,Y(opts.refLine2));cx2.lineTo(w-pad.r,Y(opts.refLine2));cx2.stroke();cx2.setLineDash([]);cx2.fillStyle=opts.refColor2;cx2.font='500 7px Fredoka';cx2.textAlign='left';cx2.fillText(opts.refLabel2,3,Y(opts.refLine2)-2);}
    const off=GRAPH_LEN-data.length;cx2.beginPath();cx2.moveTo(X(off),Y(0));data.forEach((v,i)=>cx2.lineTo(X(off+i),Y(v)));cx2.lineTo(X(off+data.length-1),Y(0));cx2.closePath();cx2.fillStyle=opts.color+'15';cx2.fill();
    cx2.strokeStyle=opts.color;cx2.lineWidth=1.5;cx2.beginPath();data.forEach((v,i)=>{i===0?cx2.moveTo(X(off),Y(v)):cx2.lineTo(X(off+i),Y(v));});cx2.stroke();
    $(opts.valId).textContent=(opts.prefix||'')+Math.round(data[data.length-1]*10)/10;
}
function drawGrowthCurve(A,K,msyN){
    const c=$('gGrowth');if(!c)return;
    const cx2=c.getContext('2d');const dpr=window.devicePixelRatio||1;
    const rect=c.getBoundingClientRect();c.width=rect.width*dpr;c.height=rect.height*dpr;
    cx2.setTransform(dpr,0,0,dpr,0,0);const w=rect.width,h=rect.height;
    cx2.fillStyle='rgba(15,40,71,.5)';cx2.fillRect(0,0,w,h);
    const pad={l:4,r:4,t:4,b:4},gw=w-8,gh=h-8;
    // Compute growth curve
    let maxG=0;const growthData=[];
    for(let n=0;n<=K;n++){
        const g=-GROWTH_RATE*n*(1-n/A)*(1-n/K);
        growthData.push(g);if(g>maxG)maxG=g;
    }
    const minG=Math.min(0,...growthData);
    const rangeG=maxG-minG||1;
    const X=n=>pad.l+(n/K)*gw;
    const Y=g=>pad.t+gh*(1-(g-minG)/rangeG);
    // Zero line
    cx2.strokeStyle='rgba(255,255,255,.1)';cx2.lineWidth=0.5;
    cx2.beginPath();cx2.moveTo(pad.l,Y(0));cx2.lineTo(w-pad.r,Y(0));cx2.stroke();
    // Growth curve
    cx2.strokeStyle='rgba(76,175,80,.8)';cx2.lineWidth=1.5;cx2.beginPath();
    for(let n=0;n<=K;n++){n===0?cx2.moveTo(X(n),Y(growthData[n])):cx2.lineTo(X(n),Y(growthData[n]));}
    cx2.stroke();
    // Fill positive area
    cx2.beginPath();cx2.moveTo(X(A),Y(0));
    for(let n=Math.ceil(A);n<=K;n++)cx2.lineTo(X(n),Y(growthData[n]));
    cx2.lineTo(X(K),Y(0));cx2.closePath();cx2.fillStyle='rgba(76,175,80,.1)';cx2.fill();
    // Allee threshold
    cx2.strokeStyle='rgba(255,152,0,.5)';cx2.lineWidth=1;cx2.setLineDash([2,2]);
    cx2.beginPath();cx2.moveTo(X(A),Y(minG));cx2.lineTo(X(A),Y(maxG));cx2.stroke();cx2.setLineDash([]);
    cx2.fillStyle='rgba(255,152,0,.5)';cx2.font='500 6px Fredoka';cx2.textAlign='center';
    cx2.fillText('Allee',X(A),pad.t+6);
    // Current position dot
    const N=fish.length;const curG=N<=K?growthData[Math.min(N,K)]:0;
    cx2.fillStyle=curG>=0?'rgba(79,195,247,.9)':'rgba(239,83,80,.9)';
    cx2.beginPath();cx2.arc(X(N),Y(curG),4,0,Math.PI*2);cx2.fill();
    cx2.strokeStyle='rgba(255,255,255,.3)';cx2.lineWidth=0.5;cx2.setLineDash([2,2]);
    cx2.beginPath();cx2.moveTo(X(N),Y(curG));cx2.lineTo(X(N),Y(0));cx2.stroke();cx2.setLineDash([]);
    // Label
    const gPerSec=(curG*60).toFixed(1);
    $('gGrowthVal').textContent=(curG>=0?'+':'')+gPerSec+'/s';
}
function drawMarketGraph(){
    const c=$('gMarket');if(!c)return;const cx2=c.getContext('2d');const dpr=window.devicePixelRatio||1;const rect=c.getBoundingClientRect();c.width=rect.width*dpr;c.height=rect.height*dpr;cx2.setTransform(dpr,0,0,dpr,0,0);const w=rect.width,h=rect.height;cx2.fillStyle='rgba(15,40,71,.5)';cx2.fillRect(0,0,w,h);
    // Axis bounds: Q from 0 to where demand hits ~0, P from 0 to intercept + margin
    const maxP=DEMAND_INTERCEPT*1.15;
    const maxQ=Math.ceil(DEMAND_INTERCEPT/DEMAND_SLOPE)+2; // Q where P=0 on demand curve
    const pad={l:22,r:4,t:6,b:14},gw=w-26,gh=h-20;
    const X=q=>pad.l+(q/maxQ)*gw;const Y=p=>pad.t+gh*(1-Math.max(0,p)/maxP);
    const steps=50;
    const aTax=getActiveTax();
    // Axes
    cx2.strokeStyle='rgba(255,255,255,.15)';cx2.lineWidth=1;cx2.beginPath();cx2.moveTo(pad.l,pad.t);cx2.lineTo(pad.l,h-pad.b);cx2.lineTo(w-pad.r,h-pad.b);cx2.stroke();
    cx2.fillStyle='rgba(122,154,181,.4)';cx2.font='500 7px Fredoka';
    cx2.textAlign='center';cx2.fillText('Q (catch/s)',w/2,h-1);
    cx2.save();cx2.translate(6,h/2);cx2.rotate(-Math.PI/2);cx2.fillText('P ($)',0,0);cx2.restore();
    // ‚îÄ‚îÄ Demand curve: P = INTERCEPT - SLOPE * Q (this IS the price-setting mechanism) ‚îÄ‚îÄ
    cx2.strokeStyle='rgba(79,195,247,.7)';cx2.lineWidth=1.5;cx2.beginPath();
    for(let i=0;i<=steps;i++){
        const q=(i/steps)*maxQ;
        const p=Math.max(0,DEMAND_INTERCEPT-DEMAND_SLOPE*q);
        i===0?cx2.moveTo(X(q),Y(p)):cx2.lineTo(X(q),Y(p));
    }
    cx2.stroke();
    cx2.fillStyle='rgba(79,195,247,.6)';cx2.font='500 7px JetBrains Mono';cx2.textAlign='left';
    cx2.fillText('D',X(maxQ*0.12),Y(DEMAND_INTERCEPT-DEMAND_SLOPE*maxQ*0.12)-5);
    // ‚îÄ‚îÄ Compute equilibrium first so supply curve can reference it ‚îÄ‚îÄ
    const eqP=Math.max(0.5,DEMAND_INTERCEPT-DEMAND_SLOPE*supplySmooth);
    // ‚îÄ‚îÄ Supply curve: MC = intercept + slope*Q (shifts to intersect equilibrium) ‚îÄ‚îÄ
    const supplySlope=0.15;
    // Compute supply intercept so curve passes through equilibrium point (supplySmooth, eqP)
    // For S+T curve: supplyIntercept + slope*Q + tax = eqP at Q=supplySmooth
    const supplyIntercept=eqP-supplySlope*supplySmooth-aTax; // base supply intercept (pre-tax)
    const drawSupplyIntercept=supplyIntercept;
    cx2.strokeStyle='rgba(239,83,80,.7)';cx2.lineWidth=1.5;cx2.beginPath();
    for(let i=0;i<=steps;i++){
        const q=(i/steps)*maxQ;
        const p=drawSupplyIntercept+supplySlope*q+aTax;
        if(p>maxP*1.1)break;
        i===0?cx2.moveTo(X(q),Y(p)):cx2.lineTo(X(q),Y(p));
    }
    cx2.stroke();
    cx2.fillStyle='rgba(239,83,80,.6)';
    const sLabelQ=maxQ*0.55;const sLabelP=drawSupplyIntercept+supplySlope*sLabelQ+aTax;
    if(sLabelP<maxP)cx2.fillText('S'+(aTax>0?'+T':''),X(sLabelQ),Y(sLabelP)-5);
    // If tax active, show pre-tax supply as dashed
    if(aTax>0){
        cx2.strokeStyle='rgba(239,83,80,.25)';cx2.lineWidth=1;cx2.setLineDash([3,3]);cx2.beginPath();
        for(let i=0;i<=steps;i++){
            const q=(i/steps)*maxQ;
            const p=drawSupplyIntercept+supplySlope*q;
            if(p>maxP*1.1)break;
            i===0?cx2.moveTo(X(q),Y(p)):cx2.lineTo(X(q),Y(p));
        }
        cx2.stroke();cx2.setLineDash([]);
        cx2.fillStyle='rgba(239,83,80,.3)';cx2.fillText('S',X(maxQ*0.65),Y(drawSupplyIntercept+supplySlope*maxQ*0.65)-5);
    }
    // ‚îÄ‚îÄ Equilibrium: dot on the demand curve at Q=supplySmooth ‚îÄ‚îÄ
    // Consumer pays this price (read off demand curve)
    cx2.fillStyle='rgba(246,198,67,.9)';cx2.beginPath();cx2.arc(X(supplySmooth),Y(eqP),4,0,Math.PI*2);cx2.fill();
    // Crosshairs to axes
    cx2.strokeStyle='rgba(246,198,67,.3)';cx2.lineWidth=.5;cx2.setLineDash([2,2]);
    cx2.beginPath();cx2.moveTo(X(supplySmooth),Y(eqP));cx2.lineTo(X(supplySmooth),Y(0));cx2.stroke();
    cx2.beginPath();cx2.moveTo(X(supplySmooth),Y(eqP));cx2.lineTo(X(0),Y(eqP));cx2.stroke();cx2.setLineDash([]);
    // Price & Q labels
    cx2.fillStyle='rgba(246,198,67,.7)';cx2.font='500 7px JetBrains Mono';
    cx2.textAlign='right';cx2.fillText('$'+eqP.toFixed(1),pad.l-2,Y(eqP)+3);
    cx2.textAlign='center';cx2.fillText(supplySmooth.toFixed(1),X(supplySmooth),h-pad.b+9);
    // ‚îÄ‚îÄ Tax: show producer price (what fishers actually get = market price - tax) ‚îÄ‚îÄ
    if(aTax>0){
        const prodP=Math.max(0,eqP-aTax);
        // Producer price dot (red, smaller)
        cx2.fillStyle='rgba(239,83,80,.8)';cx2.beginPath();cx2.arc(X(supplySmooth),Y(prodP),3,0,Math.PI*2);cx2.fill();
        // Dashed line to P axis
        cx2.strokeStyle='rgba(239,83,80,.3)';cx2.lineWidth=.5;cx2.setLineDash([2,2]);
        cx2.beginPath();cx2.moveTo(X(supplySmooth),Y(prodP));cx2.lineTo(X(0),Y(prodP));cx2.stroke();cx2.setLineDash([]);
        cx2.fillStyle='rgba(239,83,80,.7)';cx2.textAlign='right';
        cx2.fillText('$'+prodP.toFixed(1),pad.l-2,Y(prodP)+3);
        // Tax wedge bracket
        const bx=X(supplySmooth)+8;
        cx2.strokeStyle='rgba(255,152,0,.6)';cx2.lineWidth=1;cx2.setLineDash([]);
        cx2.beginPath();cx2.moveTo(bx-3,Y(eqP));cx2.lineTo(bx,Y(eqP));
        cx2.lineTo(bx,Y(prodP));cx2.lineTo(bx-3,Y(prodP));cx2.stroke();
        cx2.fillStyle='rgba(255,152,0,.8)';cx2.font='500 6px Fredoka';cx2.textAlign='left';
        cx2.fillText('Tax $'+aTax,bx+3,(Y(eqP)+Y(prodP))/2+2);
    }
    $('gMarketVal').textContent='$'+currentPrice.toFixed(1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loop(){
    update();
    drawGraphs();
    renderer.render(scene,camera);
    requestAnimationFrame(loop);
}
applyScenario('freeplay');loop();
// Expose applyScenario globally for inline onclick handlers in alerts
window.applyScenario=applyScenario;
})();
</script>
</body>
</html>
