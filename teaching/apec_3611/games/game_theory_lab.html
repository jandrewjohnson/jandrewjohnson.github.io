<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Theory Lab</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;color:#2d3748;min-height:100vh;padding:16px}
        h1{text-align:center;color:#1a202c;font-size:1.7rem;font-weight:700;margin-bottom:2px}
        .subtitle{text-align:center;color:#718096;font-size:.92rem;margin-bottom:16px}
        .app-grid{max-width:1440px;margin:0 auto;display:grid;grid-template-columns:270px 1fr 1fr;grid-template-rows:auto auto auto;gap:14px}
        .panel{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
        .panel-title{font-size:.78rem;text-transform:uppercase;letter-spacing:1.1px;color:#718096;margin-bottom:12px;font-weight:600}
        .controls-panel{grid-row:1/4}
        .slider-group{margin-bottom:12px}.slider-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .slider-label span:first-child{font-size:.8rem;color:#4a5568;font-weight:500}
        .slider-value{background:#edf2f7;color:#2b6cb0;padding:2px 8px;border-radius:6px;font-size:.76rem;font-weight:600;font-family:'Consolas',monospace;min-width:28px;text-align:center}
        input[type="range"]{-webkit-appearance:none;width:100%;height:5px;border-radius:3px;background:#e2e8f0;outline:none}
        input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#4299e1;cursor:pointer;box-shadow:0 1px 3px rgba(66,153,225,.4)}
        input[type="range"]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#4299e1;cursor:pointer;border:none}
        .section-divider{border:none;border-top:1px solid #e2e8f0;margin:14px 0}
        .info-box{background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;margin-top:10px;font-size:.78rem;line-height:1.5;color:#4a5568}
        .info-box.highlight{border-left:3px solid #4299e1}.info-box.warning{border-left:3px solid #e53e3e;background:#fff5f5}.info-box.success{border-left:3px solid #38a169;background:#f0fff4}.info-box strong{color:#1a202c}
        .equation-box{background:#f7fafc;border:1px solid #e2e8f0;border-radius:6px;padding:7px 10px;font-size:.78rem;color:#4a5568;margin:6px 0;line-height:1.5}
        .game-type-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.82rem;font-weight:700;margin-bottom:8px}
        .matrix-container{margin:10px 0}
        .payoff-table{width:100%;border-collapse:collapse;font-size:.85rem}
        .payoff-table th{padding:8px 6px;font-size:.72rem;text-transform:uppercase;letter-spacing:.8px;color:#718096;font-weight:600}
        .payoff-table td{padding:12px 8px;text-align:center;border:1px solid #e2e8f0;font-family:'Consolas',monospace;font-size:.9rem;position:relative;transition:all .2s;cursor:default}
        .payoff-table td .p1{color:#2b6cb0;font-weight:700}.payoff-table td .p2{color:#e53e3e;font-weight:700}
        .payoff-table td.nash{background:#f0fff4;border-color:#38a169;box-shadow:inset 0 0 0 2px rgba(56,161,105,.3)}
        .payoff-table td.pareto-optimal::after{content:'‚òÖ';position:absolute;top:2px;right:4px;font-size:.6rem;color:#d69e2e}
        .payoff-table .row-label{text-align:right;padding-right:12px;border:none;font-weight:600;color:#2b6cb0;font-family:'Segoe UI',sans-serif;font-size:.82rem}
        .payoff-table .col-header{text-align:center;color:#e53e3e}.payoff-table .corner{border:none}
        .action-buttons{display:flex;gap:10px;margin:14px 0}
        .action-btn{flex:1;padding:14px 8px;border:2px solid #e2e8f0;border-radius:10px;background:#fff;cursor:pointer;text-align:center;transition:all .15s;font-family:'Segoe UI',sans-serif}
        .action-btn:hover{border-color:#4299e1;background:#ebf8ff;transform:translateY(-1px)}.action-btn:active{transform:translateY(0)}
        .action-btn .btn-label{font-size:.9rem;font-weight:700;color:#1a202c;display:block}.action-btn .btn-sub{font-size:.7rem;color:#718096;margin-top:2px}
        .action-btn.cooperate:hover{border-color:#38a169;background:#f0fff4}.action-btn.defect:hover{border-color:#e53e3e;background:#fff5f5}
        .action-btn.disabled{opacity:0.5;pointer-events:none;filter:grayscale(1);}
        .round-result{padding:12px;border-radius:10px;margin:10px 0;text-align:center;font-size:.88rem;line-height:1.5;display:none}.round-result.show{display:block}
        .history-scroll{max-height:180px;overflow-y:auto;margin-top:8px}
        .history-row{display:grid;grid-template-columns:30px 1fr 1fr 50px 50px;gap:4px;padding:5px 4px;font-size:.74rem;border-bottom:1px solid #edf2f7;align-items:center}
        .history-row.header{font-weight:600;color:#718096;text-transform:uppercase;letter-spacing:.5px;font-size:.68rem;border-bottom:2px solid #e2e8f0;position:sticky;top:0;background:#fff}
        .history-row .rn{color:#a0aec0;text-align:center}.history-row .you-act{color:#2b6cb0;font-weight:600;text-align:center}.history-row .opp-act{color:#e53e3e;font-weight:600;text-align:center}
        .history-row .you-pay{font-family:'Consolas',monospace;color:#2b6cb0;font-weight:600;text-align:center}.history-row .opp-pay{font-family:'Consolas',monospace;color:#e53e3e;font-weight:600;text-align:center}
        .score-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#f7fafc;border:1px solid #e2e8f0;border-radius:10px;margin-bottom:12px}
        .score-item{text-align:center}.score-item .sc-label{font-size:.68rem;text-transform:uppercase;letter-spacing:.8px;color:#718096}
        .score-item .sc-value{font-size:1.3rem;font-weight:700;font-family:'Consolas',monospace}
        .score-item .sc-value.blue{color:#2b6cb0}.score-item .sc-value.red{color:#e53e3e}.score-item .sc-value.gray{color:#718096}
        .strat-select{width:100%;padding:8px 10px;border:1px solid #e2e8f0;border-radius:8px;background:#f7fafc;font-size:.82rem;color:#2d3748;font-family:'Segoe UI',sans-serif;cursor:pointer;margin-bottom:8px}
        .chart-wrap{position:relative;overflow:hidden}.chart-wrap canvas{display:block;width:100%;height:auto}
        .plot-actions{position:absolute;top:4px;right:4px;z-index:10;display:flex;gap:4px;opacity:0;transition:opacity .2s}
        .chart-wrap:hover .plot-actions{opacity:1}
        .plot-action-btn{background:rgba(255,255,255,.85);backdrop-filter:blur(4px);border:1px solid rgba(226,232,240,.7);border-radius:6px;padding:3px 6px;font-size:.65rem;color:#a0aec0;cursor:pointer;display:flex;align-items:center;gap:3px;font-family:'Segoe UI',system-ui,sans-serif;transition:all .15s;line-height:1}
        .plot-action-btn:hover{background:#fff;color:#4a5568;border-color:#cbd5e0}.plot-action-btn.copied{color:#38a169;border-color:#c6f6d5;background:rgba(240,255,244,.9)}.plot-action-btn svg{width:10px;height:10px;flex-shrink:0}
        .preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px}
        .preset-btn{padding:7px 6px;border:1px solid #e2e8f0;border-radius:8px;background:#f7fafc;cursor:pointer;text-align:center;font-size:.74rem;font-weight:600;color:#4a5568;transition:all .15s;font-family:'Segoe UI',sans-serif}
        .preset-btn:hover{border-color:#4299e1;background:#ebf8ff;color:#2b6cb0}.preset-btn.active{border-color:#4299e1;background:#ebf8ff;color:#2b6cb0}
        .bottom-panel{grid-column:1/-1}
        .concepts-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:10px}
        .concept-card{background:#f7fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px}
        .concept-card .cc-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.8px;color:#718096;margin-bottom:6px;font-weight:600}
        .concept-card .cc-value{font-size:.88rem;font-weight:700;color:#1a202c;margin-bottom:4px}.concept-card .cc-desc{font-size:.72rem;color:#718096;line-height:1.4}
        .reset-btn{width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer;font-size:.78rem;color:#718096;font-weight:600;transition:all .15s;font-family:'Segoe UI',sans-serif}
        .reset-btn:hover{border-color:#e53e3e;color:#e53e3e;background:#fff5f5}
        .legend{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:8px}.legend-item{display:flex;align-items:center;gap:4px;font-size:.74rem;color:#4a5568}.legend-swatch{width:14px;height:4px;border-radius:2px}

        .explanation{grid-column:1/-1;background:#fff;border-radius:12px;padding:24px 28px;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,.08)}
        .explanation p{margin:0 0 14px;line-height:1.7;font-size:.95rem;color:#4a5568}.explanation p:last-child{margin-bottom:0}

        .display-options-wrapper{grid-column:1/-1;margin-top:0}.display-options-toggle{background:none;border:none;color:#a0aec0;font-size:.78rem;cursor:pointer;padding:4px 0;display:flex;align-items:center;gap:4px}.display-options-toggle:hover{color:#718096}
        .display-options-toggle .arrow{font-size:.6rem;transition:transform .2s}.display-options-toggle .arrow.open{transform:rotate(90deg)}
        .display-options-panel{display:none;margin-top:8px;background:#fff;border-radius:12px;padding:16px 20px;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,.08)}.display-options-panel.open{display:block}
        .display-options-panel .panel-title{font-size:.75rem;margin-bottom:12px}
        .opt-row{display:flex;align-items:center;gap:8px;padding:3px 0}.opt-row label{font-size:.8rem;color:#4a5568;cursor:pointer;white-space:nowrap}
        .opt-row input[type="checkbox"]{accent-color:#4299e1;cursor:pointer;margin:0;width:14px;height:14px}
        .opt-section-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;color:#a0aec0;margin:10px 0 4px;font-weight:600}.opt-section-label:first-child{margin-top:0}

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; animation: fadeIn 0.3s ease; }
        .modal-content {
            background: #fff; padding: 32px; border-radius: 16px;
            max-width: 440px; width: 90%; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: #2d3748; margin-bottom: 8px; }
        .modal-score { font-size: 3rem; font-weight: 800; color: #2b6cb0; margin: 16px 0; font-family: 'Consolas', monospace; }
        .modal-desc { color: #718096; font-size: 0.95rem; line-height: 1.6; margin-bottom: 24px; }
        .reveal-box { background: #ebf8ff; border: 1px solid #bee3f8; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
        .reveal-label { font-size: 0.75rem; text-transform: uppercase; color: #718096; font-weight: 700; letter-spacing: 0.5px; }
        .reveal-val { font-size: 1.2rem; font-weight: 700; color: #2c5282; margin-top: 4px; }
        .perf-bar { height: 8px; background: #edf2f7; border-radius: 4px; overflow: hidden; margin: 0 auto 8px; width: 100%; }
        .perf-fill { height: 100%; background: linear-gradient(90deg, #4299e1, #48bb78); width: 0%; transition: width 1s ease 0.3s; }
        .modal-btn { background: #2b6cb0; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .modal-btn:hover { background: #2c5282; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media(max-width:1100px){.app-grid{grid-template-columns:1fr}.controls-panel{grid-row:auto}.bottom-panel{grid-column:auto}.concepts-grid{grid-template-columns:repeat(2,1fr)}}
        .katex{font-size:1em}
    </style>
</head>
<body>
    <h1>Game Theory Lab</h1>
    <p class="subtitle">Play simultaneous-move games against a simulated opponent ‚Äî explore Nash equilibria, dominant strategies &amp; cooperation</p>

    <div class="app-grid">
        <!-- LEFT CONTROLS -->
        <div class="panel controls-panel">
            <div class="panel-title">Game Presets</div>
            <div class="preset-grid">
                <div class="preset-btn active" data-preset="pd">üîí Prisoner's Dilemma</div>
                <div class="preset-btn" data-preset="stag">ü¶å Stag Hunt</div>
                <div class="preset-btn" data-preset="chicken">üêî Chicken</div>
                <div class="preset-btn" data-preset="bos">üíÉ Battle of Sexes</div>
                <div class="preset-btn" data-preset="matching">ü™ô Matching Pennies</div>
                <div class="preset-btn" data-preset="harmony">üïäÔ∏è Harmony</div>
                <div class="preset-btn" data-preset="deadlock">üíÄ Deadlock</div>
                <div class="preset-btn" data-preset="custom">‚öôÔ∏è Custom</div>
            </div>
            <hr class="section-divider">
            <div class="panel-title">Payoff Matrix (You, Opponent)</div>
            <div class="slider-group"><div class="slider-label"><span>Both Cooperate \((R)\)</span><span class="slider-value" id="vR">3</span></div><input type="range" id="sR" min="-5" max="10" value="3" step="1"></div>
            <div class="slider-group"><div class="slider-label"><span>You Defect, They Coop \((T)\)</span><span class="slider-value" id="vT">5</span></div><input type="range" id="sT" min="-5" max="10" value="5" step="1"></div>
            <div class="slider-group"><div class="slider-label"><span>You Coop, They Defect \((S)\)</span><span class="slider-value" id="vS">0</span></div><input type="range" id="sS" min="-5" max="10" value="0" step="1"></div>
            <div class="slider-group"><div class="slider-label"><span>Both Defect \((P)\)</span><span class="slider-value" id="vP">1</span></div><input type="range" id="sP" min="-5" max="10" value="1" step="1"></div>
            <div class="equation-box" id="payoffNote">Symmetric game: \(T > R > P > S\)<br><strong>Prisoner's Dilemma:</strong> Defection dominates, but mutual cooperation is better for both.</div>
            <hr class="section-divider">
            <div class="panel-title">Opponent Strategy</div>
            <select class="strat-select" id="stratSelect">
                <option value="hidden_random" selected>‚ùì Random (Hidden)</option>
                <option value="tft">Tit-for-Tat</option><option value="random">Random (50/50)</option><option value="always_c">Always Cooperate</option><option value="always_d">Always Defect</option><option value="grudger">Grudger (Grim Trigger)</option><option value="pavlov">Pavlov (Win-Stay Lose-Shift)</option><option value="suspicious_tft">Suspicious Tit-for-Tat</option><option value="nash">Play Nash Equilibrium</option>
            </select>
            <div class="info-box" id="stratDesc"><strong>Hidden Strategy:</strong> The bot has picked a strategy from the list below, but won't tell you which one. Play 10 rounds to reveal the truth and see your score report.</div>
            <hr class="section-divider">
            <button class="reset-btn" id="resetBtn">‚Ü∫ Reset Game History</button>
        </div>

        <!-- CENTER TOP -->
        <div class="panel">
            <div id="gameTypeBadge" class="game-type-badge" style="background:#fff5f5;color:#e53e3e;">üîí Prisoner's Dilemma</div>
            <div class="score-bar">
                <div class="score-item"><div class="sc-label">Your Total</div><div class="sc-value blue" id="scoreYou">0</div></div>
                <div class="score-item"><div class="sc-label">Round</div><div class="sc-value gray" id="roundNum">0 / 10</div></div>
                <div class="score-item"><div class="sc-label">Opponent Total</div><div class="sc-value red" id="scoreOpp">0</div></div>
            </div>
            <div class="matrix-container">
                <table class="payoff-table" id="payoffTable">
                    <tr><th class="corner"></th><th class="col-header">Opp: Cooperate</th><th class="col-header">Opp: Defect</th></tr>
                    <tr><td class="row-label">You: Cooperate</td><td id="cell_CC"><span class="p1">3</span>, <span class="p2">3</span></td><td id="cell_CD"><span class="p1">0</span>, <span class="p2">5</span></td></tr>
                    <tr><td class="row-label">You: Defect</td><td id="cell_DC"><span class="p1">5</span>, <span class="p2">0</span></td><td id="cell_DD"><span class="p1">1</span>, <span class="p2">1</span></td></tr>
                </table>
            </div>
            <div style="text-align:center;margin:4px 0;font-size:.72rem;color:#a0aec0"><span style="color:#38a169">‚ñ†</span> Nash Equilibrium &nbsp;<span style="color:#d69e2e">‚òÖ</span> Pareto Optimal</div>
            <div class="action-buttons">
                <div class="action-btn cooperate" id="btnCoop"><span class="btn-label">ü§ù Cooperate</span><span class="btn-sub">Trust your opponent</span></div>
                <div class="action-btn defect" id="btnDefect"><span class="btn-label">üó°Ô∏è Defect</span><span class="btn-sub">Pursue self-interest</span></div>
            </div>
            <div class="round-result" id="roundResult"></div>
            <div class="info-box highlight" id="insightBox">Choose an action above to play a round. The payoff matrix shows (your payoff, opponent's payoff) for each outcome.</div>
        </div>

        <!-- RIGHT TOP: History + Chart -->
        <div class="panel">
            <div class="panel-title">Game History</div>
            <div class="legend"><div class="legend-item"><div class="legend-swatch" style="background:#2b6cb0"></div> Your Score</div><div class="legend-item"><div class="legend-swatch" style="background:#e53e3e"></div> Opponent Score</div></div>
            <div class="chart-wrap" id="scoreChartWrap">
                <div class="plot-actions">
                    <button class="plot-action-btn" onclick="copyCanvas(scoreCanvas,this)" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span></button>
                    <button class="plot-action-btn" onclick="saveCanvas(scoreCanvas,'game_theory_score.png',this)" title="Save"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Save</span></button>
                </div>
                <canvas id="scoreCanvas" height="320"></canvas>
            </div>
            <div class="history-scroll" id="historyScroll">
                <div class="history-row header"><div class="rn">#</div><div class="you-act">You</div><div class="opp-act">Opponent</div><div class="you-pay">Yours</div><div class="opp-pay">Theirs</div></div>
                <div id="historyBody"></div>
            </div>
        </div>

        <!-- BOTTOM: Best Response Chart -->
        <div class="panel" style="grid-column:2/4;">
            <div class="panel-title">Best Response &amp; Mixed Strategy Analysis</div>
            <div class="legend"><div class="legend-item"><div class="legend-swatch" style="background:#2b6cb0"></div> \(\mathbb{E}[\text{Cooperate}]\)</div><div class="legend-item"><div class="legend-swatch" style="background:#e53e3e"></div> \(\mathbb{E}[\text{Defect}]\)</div><div class="legend-item"><div class="legend-swatch" style="background:#38a169;height:8px;width:8px;border-radius:50%"></div> Nash Equilibrium</div></div>
            <div class="chart-wrap" id="brChartWrap">
                <div class="plot-actions">
                    <button class="plot-action-btn" onclick="copyCanvas(brCanvas,this)" title="Copy"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>Copy</span></button>
                    <button class="plot-action-btn" onclick="saveCanvas(brCanvas,'game_theory_best_response.png',this)" title="Save"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Save</span></button>
                </div>
                <canvas id="brCanvas" height="440"></canvas>
            </div>
        </div>

        <!-- CONCEPTS -->
        <div class="panel bottom-panel"><div class="panel-title">Game Analysis</div><div class="concepts-grid" id="conceptsGrid"></div></div>

        <!-- EXPLANATION -->
        <div class="explanation">
            <div class="panel-title">Explanation</div>
            <p>This lab lets you explore the structure of \(2 \times 2\) simultaneous-move games. Each cell in the payoff matrix shows \((\text{your payoff}, \text{opponent's payoff})\). In a symmetric game the opponent's payoffs mirror yours: when you cooperate and they defect, you receive the "sucker's" payoff \(S\) while they receive the "temptation" \(T\), and vice versa. The four payoff parameters ‚Äî \(R\) (reward for mutual cooperation), \(T\) (temptation to defect), \(S\) (sucker's payoff), and \(P\) (punishment for mutual defection) ‚Äî fully determine the game's strategic structure.</p>
            <p>The best-response chart shows how your expected payoff from each action varies with the probability \(q\) that your opponent cooperates. Where the cooperate line lies above the defect line, cooperation is your best response; where it lies below, defection is. If the lines cross in the interior, the intersection gives the mixed-strategy Nash equilibrium ‚Äî the probability at which you are exactly indifferent between your two actions: \(q^* = (P - S)/(R - T + P - S)\). The famous games differ precisely in the ordering of \(R, T, S, P\): the Prisoner's Dilemma has \(T > R > P > S\), making defection dominant despite mutual cooperation being Pareto superior.</p>
            <p>By playing repeated rounds against different AI strategies, you can experience how the shadow of the future transforms one-shot incentives. Tit-for-Tat, for instance, sustains cooperation in the iterated Prisoner's Dilemma by making defection costly ‚Äî your opponent retaliates next round. Try switching between game presets and opponent strategies to see how the equilibrium structure and cooperative possibilities change across different strategic environments.</p>
        </div>

        <!-- Display Options -->
        <div class="display-options-wrapper">
            <button class="display-options-toggle" id="display-toggle-btn"><span class="arrow" id="display-arrow">‚ñ∂</span> Display options</button>
            <div class="display-options-panel" id="display-panel">
                <div class="panel-title">Chart Element Visibility</div>
                <div class="opt-section-label">Score Chart</div>
                <div class="opt-row"><input type="checkbox" id="show-score-grid" checked><label for="show-score-grid">Grid lines</label></div>
                <div class="opt-row"><input type="checkbox" id="show-score-labels" checked><label for="show-score-labels">Axis labels</label></div>
                <div class="opt-section-label">Best Response Chart</div>
                <div class="opt-row"><input type="checkbox" id="show-br-grid" checked><label for="show-br-grid">Grid lines</label></div>
                <div class="opt-row"><input type="checkbox" id="show-br-shading" checked><label for="show-br-shading">Best response shading</label></div>
                <div class="opt-row"><input type="checkbox" id="show-br-mixed" checked><label for="show-br-mixed">Mixed NE point &amp; label</label></div>
                <div class="opt-row"><input type="checkbox" id="show-br-endpoints" checked><label for="show-br-endpoints">Endpoint labels</label></div>
                <div class="opt-row"><input type="checkbox" id="show-br-annotation" checked><label for="show-br-annotation">Dominance annotation</label></div>
            </div>
        </div>
    </div>

    <!-- GAME OVER MODAL -->
    <div class="modal-overlay" id="gameOverModal">
        <div class="modal-content">
            <div class="modal-title">Game Over</div>
            <div class="modal-desc">10 Rounds Completed</div>
            
            <div class="reveal-box">
                <div class="reveal-label">Your Final Score</div>
                <div class="modal-score" id="finalScoreDisplay">0</div>
            </div>
            
            <div class="reveal-box" style="background:#fffaf0; border-color:#fbd38d;">
                <div class="reveal-label">Opponent Strategy Revealed</div>
                <div class="reveal-val" id="revealedStratName">???</div>
            </div>

            <div style="text-align:left; margin-bottom:4px; display:flex; justify-content:space-between;">
                <span class="reveal-label">Performance Rating</span>
                <span class="reveal-label" id="perfPercent">0%</span>
            </div>
            <div class="perf-bar"><div class="perf-fill" id="perfFill"></div></div>
            <div style="font-size:0.75rem; color:#a0aec0; margin-bottom:24px;">Based on max possible single-round payoff</div>

            <button class="modal-btn" id="modalResetBtn">Play Again</button>
        </div>
    </div>

<script>
function renderAllMath(){if(typeof renderMathInElement!=='undefined')renderMathInElement(document.body,{delimiters:[{left:"\\[",right:"\\]",display:true},{left:"\\(",right:"\\)",display:false}],throwOnError:false});}
document.addEventListener("DOMContentLoaded",renderAllMath);window.addEventListener('load',renderAllMath);
function isVis(id){const e=document.getElementById(id);return e?e.checked:true;}

// Copy/save helpers
async function copyCanvas(canvas,btn){const lbl=btn.querySelector('span');try{const blob=await new Promise(r=>canvas.toBlob(r,'image/png'));await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);btn.classList.add('copied');lbl.textContent='Copied!';setTimeout(()=>{btn.classList.remove('copied');lbl.textContent='Copy';},1500);}catch(e){lbl.textContent='Failed';setTimeout(()=>{lbl.textContent='Copy';},1500);}}
function saveCanvas(canvas,name,btn){const lbl=btn.querySelector('span');const a=document.createElement('a');a.href=canvas.toDataURL('image/png');a.download=name;a.click();btn.classList.add('copied');lbl.textContent='Saved!';setTimeout(()=>{btn.classList.remove('copied');lbl.textContent='Save';},1500);}

(function(){
    let R=3,T=5,S=0,P=1;
    let history=[],yourScore=0,oppScore=0;
    let hiddenStrat = 'tft'; // Default placeholder

    const sR=document.getElementById('sR'),sT=document.getElementById('sT'),sS=document.getElementById('sS'),sP=document.getElementById('sP');
    const vR=document.getElementById('vR'),vT=document.getElementById('vT'),vS=document.getElementById('vS'),vP=document.getElementById('vP');
    const scoreCanvas=document.getElementById('scoreCanvas'),sCtx=scoreCanvas.getContext('2d');
    const brCanvas=document.getElementById('brCanvas'),brCtx=brCanvas.getContext('2d');
    window.scoreCanvas=scoreCanvas;window.brCanvas=brCanvas;

    const presets={pd:{R:3,T:5,S:0,P:1,name:'üîí Prisoner\'s Dilemma',color:'#e53e3e',bg:'#fff5f5'},stag:{R:5,T:3,S:0,P:1,name:'ü¶å Stag Hunt',color:'#2b6cb0',bg:'#ebf8ff'},chicken:{R:3,T:5,S:1,P:0,name:'üêî Chicken (Hawk-Dove)',color:'#d69e2e',bg:'#fffff0'},bos:{R:5,T:0,S:0,P:3,name:'üíÉ Battle of Sexes',color:'#805ad5',bg:'#faf5ff'},matching:{R:1,T:-1,S:-1,P:1,name:'ü™ô Matching Pennies',color:'#718096',bg:'#f7fafc'},harmony:{R:5,T:3,S:3,P:1,name:'üïäÔ∏è Harmony Game',color:'#38a169',bg:'#f0fff4'},deadlock:{R:1,T:5,S:0,P:3,name:'üíÄ Deadlock',color:'#4a5568',bg:'#f7fafc'},custom:{R:R,T:T,S:S,P:P,name:'‚öôÔ∏è Custom',color:'#4299e1',bg:'#ebf8ff'}};
    let activePreset='pd';

    const stratDescs={
        hidden_random:'<strong>Hidden Strategy:</strong> The bot has picked a strategy from the list below, but won\'t tell you which one. Play 10 rounds to reveal the truth and see your score report.',
        tft:'<strong>Tit-for-Tat:</strong> Cooperates first, then copies your last move. Simple, forgiving, retaliatory.',
        random:'<strong>Random:</strong> Cooperates 50% of the time, independent of history.',
        always_c:'<strong>Always Cooperate:</strong> Cooperates unconditionally. Exploitable but maximizes joint payoff.',
        always_d:'<strong>Always Defect:</strong> Never cooperates. Maximizes own payoff against cooperators.',
        grudger:'<strong>Grim Trigger:</strong> Cooperates until you defect once, then defects forever.',
        pavlov:'<strong>Pavlov:</strong> Repeats last action if high payoff; switches if low. "Win-stay, lose-shift."',
        suspicious_tft:'<strong>Suspicious TfT:</strong> Like Tit-for-Tat but defects first.',
        nash:'<strong>Nash Strategy:</strong> Plays the Nash equilibrium strategy (pure or mixed).'
    };

    const stratNamesForReveal = {
        tft: "Tit-for-Tat",
        random: "Random (50/50)",
        always_c: "Always Cooperate",
        always_d: "Always Defect",
        grudger: "Grim Trigger",
        pavlov: "Pavlov",
        suspicious_tft: "Suspicious Tit-for-Tat",
        nash: "Nash Strategy"
    };

    function rerollHiddenStrat() {
        const options = ['tft', 'random', 'always_c', 'always_d', 'grudger', 'pavlov', 'suspicious_tft', 'nash'];
        hiddenStrat = options[Math.floor(Math.random() * options.length)];
        console.log("Secret strategy selected (shh!):", hiddenStrat);
    }
    rerollHiddenStrat();

    document.querySelectorAll('.preset-btn').forEach(btn=>{btn.addEventListener('click',()=>{activePreset=btn.dataset.preset;document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');if(activePreset!=='custom'){const p=presets[activePreset];R=p.R;T=p.T;S=p.S;P=p.P;sR.value=R;sT.value=T;sS.value=S;sP.value=P;}resetGame();updateAll();});});
    [sR,sT,sS,sP].forEach(s=>{s.addEventListener('input',()=>{R=parseInt(sR.value);T=parseInt(sT.value);S=parseInt(sS.value);P=parseInt(sP.value);let matched=false;for(const[key,p]of Object.entries(presets)){if(key==='custom')continue;if(p.R===R&&p.T===T&&p.S===S&&p.P===P){activePreset=key;matched=true;break;}}if(!matched)activePreset='custom';document.querySelectorAll('.preset-btn').forEach(b=>{b.classList.toggle('active',b.dataset.preset===activePreset);});updateAll();});});

    document.getElementById('stratSelect').addEventListener('change',function(){
        document.getElementById('stratDesc').innerHTML=stratDescs[this.value];
        resetGame(); 
    });

    // Updated Classification Logic to fix Harmony/BoS/Matching confusion
    function classifyGame(){
        // PD: T > R > P > S
        if(T>R && R>P && P>S) return 'pd';
        // Stag Hunt: R > T > P > S (In preset T=3, P=1, S=0. T>S)
        if(R>T && R>P && P>S && T>S) return 'stag';
        // Chicken: T > R > S > P
        if(T>R && R>S && S>P) return 'chicken';
        // Deadlock: T > P > R > S (Input file logic was slightly different, but this matches the preset)
        if(P>R && T>R && R>S) return 'deadlock';
        
        // Matching Pennies: Cyclic zero-sum structure. 
        // Preset: R=1, T=-1, S=-1, P=1. R=P, T=S, R!=T.
        if(R===P && T===S && R!==T) return 'matching';
        
        // Battle of Sexes: Coordination.
        // Preset: R=5, T=0, S=0, P=3. R > P > T = S.
        // Specific check: R > T, P > S, T=S.
        if(R>T && T===S && S<P) return 'bos';
        
        // Harmony: Cooperation Dominates.
        // Preset: R=5, T=3, S=3, P=1. R > T, S > P.
        if(R>T && S>P) return 'harmony';
        
        return 'custom';
    }

    function findNashEquilibria(){const nash=[];if(R>=T)nash.push({you:'C',opp:'C'});if(S>=P&&T>=R)nash.push({you:'C',opp:'D'});if(T>=R&&S>=P)nash.push({you:'D',opp:'C'});if(P>=S)nash.push({you:'D',opp:'D'});const denom=R-T+P-S;let mixedQ=null,mixedP_you=null;if(Math.abs(denom)>.001){mixedQ=(P-S)/denom;mixedP_you=mixedQ;} return{pure:nash,mixedQ,mixedP_you};}
    function findDominantStrategies(){if(R>T&&S>P)return'C';if(R>=T&&S>=P&&(R>T||S>P))return'C (weakly)';if(T>R&&P>S)return'D';if(T>=R&&P>=S&&(T>R||P>S))return'D (weakly)';return null;}
    function findParetoOptimal(){const o=[{you:'C',opp:'C',y:R,o:R},{you:'C',opp:'D',y:S,o:T},{you:'D',opp:'C',y:T,o:S},{you:'D',opp:'D',y:P,o:P}];return o.filter(a=>!o.some(b=>b.y>=a.y&&b.o>=a.o&&(b.y>a.y||b.o>a.o)));}

    function opponentMove(strat){
        const n=history.length;
        if(strat === 'hidden_random') strat = hiddenStrat;
        if(strat==='always_c')return'C';
        if(strat==='always_d')return'D';
        if(strat==='random')return Math.random()<.5?'C':'D';
        if(strat==='tft')return n===0?'C':history[n-1].you;
        if(strat==='suspicious_tft')return n===0?'D':history[n-1].you;
        if(strat==='grudger')return history.some(h=>h.you==='D')?'D':'C';
        if(strat==='pavlov'){if(n===0)return'C';const last=history[n-1],oppLA=last.opp,oppLP=last.oppPay;return oppLP>=R?oppLA:(oppLA==='C'?'D':'C');}
        if(strat==='nash'){const ne=findNashEquilibria();if(ne.pure.length>0)return ne.pure[0].opp;if(ne.mixedQ!==null&&ne.mixedQ>=0&&ne.mixedQ<=1)return Math.random()<ne.mixedQ?'C':'D';return Math.random()<.5?'C':'D';}
        return'C';
    }
    
    function payoffs(you,opp){if(you==='C'&&opp==='C')return[R,R];if(you==='C'&&opp==='D')return[S,T];if(you==='D'&&opp==='C')return[T,S];return[P,P];}

    function playRound(yourAction){
        if(history.length >= 10) return;

        const strat=document.getElementById('stratSelect').value;
        const oppAction=opponentMove(strat);
        const [yPay,oPay]=payoffs(yourAction,oppAction);
        
        history.push({you:yourAction,opp:oppAction,youPay:yPay,oppPay:oPay});
        yourScore+=yPay;oppScore+=oPay;
        
        const res=document.getElementById('roundResult');
        const youL=yourAction==='C'?'Cooperated':'Defected';
        const oppL=oppAction==='C'?'Cooperated':'Defected';
        const yC=yourAction==='C'?'#38a169':'#e53e3e';
        const oC=oppAction==='C'?'#38a169':'#e53e3e';
        res.style.background=yPay>=oPay?'#f0fff4':'#fff5f5';
        res.style.border=`1px solid ${yPay>=oPay?'#c6f6d5':'#fed7d7'}`;
        res.innerHTML=`<span style="color:${yC};font-weight:700">You ${youL}</span> vs <span style="color:${oC};font-weight:700">Opponent ${oppL}</span><br><span style="color:#2b6cb0;font-weight:700">+${yPay}</span> for you, <span style="color:#e53e3e;font-weight:700">+${oPay}</span> for opponent`;
        res.classList.add('show');
        
        updateScores();
        addHistoryRow();
        drawScoreChart();
        updateInsight();

        if (history.length === 10) triggerGameOver();
    }

    function triggerGameOver() {
        const stratSelect = document.getElementById('stratSelect').value;
        const usedStrat = stratSelect === 'hidden_random' ? hiddenStrat : stratSelect;
        
        document.getElementById('btnCoop').classList.add('disabled');
        document.getElementById('btnDefect').classList.add('disabled');

        const modal = document.getElementById('gameOverModal');
        document.getElementById('finalScoreDisplay').textContent = yourScore;
        document.getElementById('revealedStratName').textContent = stratNamesForReveal[usedStrat];
        
        const maxSingle = Math.max(R, T, S, P);
        const maxPossible = maxSingle * 10; 
        const pct = Math.max(0, Math.min(100, (yourScore / maxPossible) * 100));
        
        document.getElementById('perfPercent').textContent = pct.toFixed(1) + "%";
        document.getElementById('perfFill').style.width = pct + "%";
        
        modal.classList.add('show');
    }

    document.getElementById('btnCoop').addEventListener('click',()=>playRound('C'));
    document.getElementById('btnDefect').addEventListener('click',()=>playRound('D'));

    function resetGame(){
        history=[];yourScore=0;oppScore=0;
        rerollHiddenStrat();
        document.getElementById('btnCoop').classList.remove('disabled');
        document.getElementById('btnDefect').classList.remove('disabled');
        document.getElementById('gameOverModal').classList.remove('show');
        updateScores();
        document.getElementById('historyBody').innerHTML='';
        document.getElementById('roundResult').classList.remove('show');
        drawScoreChart();
        updateInsight();
    }
    document.getElementById('resetBtn').addEventListener('click',resetGame);
    document.getElementById('modalResetBtn').addEventListener('click',resetGame);

    function updateScores(){
        document.getElementById('scoreYou').textContent=yourScore;
        document.getElementById('scoreOpp').textContent=oppScore;
        document.getElementById('roundNum').textContent=history.length + " / 10";
    }

    function addHistoryRow(){const h=history[history.length-1],body=document.getElementById('historyBody'),row=document.createElement('div');row.className='history-row';row.innerHTML=`<div class="rn">${history.length}</div><div class="you-act">${h.you==='C'?'ü§ù':'üó°Ô∏è'}</div><div class="opp-act">${h.opp==='C'?'ü§ù':'üó°Ô∏è'}</div><div class="you-pay">${h.youPay>=0?'+':''}${h.youPay}</div><div class="opp-pay">${h.oppPay>=0?'+':''}${h.oppPay}</div>`;body.appendChild(row);document.getElementById('historyScroll').scrollTop=99999;}

    function updateMatrix(){vR.textContent=R;vT.textContent=T;vS.textContent=S;vP.textContent=P;const ne=findNashEquilibria(),pareto=findParetoOptimal();const cells={CC:document.getElementById('cell_CC'),CD:document.getElementById('cell_CD'),DC:document.getElementById('cell_DC'),DD:document.getElementById('cell_DD')};cells.CC.innerHTML=`<span class="p1">${R}</span>, <span class="p2">${R}</span>`;cells.CD.innerHTML=`<span class="p1">${S}</span>, <span class="p2">${T}</span>`;cells.DC.innerHTML=`<span class="p1">${T}</span>, <span class="p2">${S}</span>`;cells.DD.innerHTML=`<span class="p1">${P}</span>, <span class="p2">${P}</span>`;Object.values(cells).forEach(c=>{c.className='';});ne.pure.forEach(n=>{const k=n.you+n.opp;if(cells[k])cells[k].classList.add('nash');});pareto.forEach(p=>{const k=p.you+p.opp;if(cells[k])cells[k].classList.add('pareto-optimal');});}
    function updateGameBadge(){const badge=document.getElementById('gameTypeBadge'),type=classifyGame(),p=presets[type]||presets.custom;badge.textContent=p.name;badge.style.background=p.bg;badge.style.color=p.color;}

    const gameStories = {
        pd: 'The <strong>Prisoner\'s Dilemma</strong> gets its name from a scenario where two suspects are arrested and interrogated separately. Each can either stay silent (cooperate) or betray the other (defect). If both stay silent, they get light sentences. If one betrays while the other stays silent, the betrayer goes free while the silent one gets the maximum sentence. If both betray, both get heavy sentences. The tragedy is that rational self-interest drives both to betray ‚Äî even though they\'d both be better off staying silent.',
        stag: 'The <strong>Stag Hunt</strong> comes from Jean-Jacques Rousseau\'s parable: two hunters can either cooperate to hunt a stag (high reward, but requires both) or individually hunt a hare (smaller but guaranteed reward). If one goes for the stag while the other chases a hare, the stag hunter gets nothing. The dilemma isn\'t about temptation to cheat ‚Äî it\'s about trust. Both <em>want</em> to cooperate, but only if they\'re confident the other will too.',
        chicken: 'The <strong>Chicken</strong> game (also called Hawk-Dove) is named after the dangerous driving contest where two cars speed toward each other head-on. Each driver can swerve (cooperate) or drive straight (defect). If one swerves and the other doesn\'t, the swerver is "chicken" but alive. If both swerve, both save face partially. But if neither swerves, both crash ‚Äî the worst outcome for everyone. The key tension is that you want to be tough, but only if the other person backs down.',
        bos: 'The <strong>Battle of the Sexes</strong> describes a couple who want to spend the evening together but prefer different activities ‚Äî say, one prefers opera and the other prefers a football game. Going to the same event (even if it\'s not your favorite) is better than going to different events alone. The challenge is coordination: there are two equilibria and no obvious way to pick between them without communication.',
        matching: '<strong>Matching Pennies</strong> is the simplest purely competitive game. Two players simultaneously show heads or tails. One player wins if they match; the other wins if they don\'t. Think of a penalty kick in soccer ‚Äî the kicker and goalkeeper must each commit to a direction simultaneously. There\'s no pure-strategy equilibrium; the only rational play is to randomize 50/50, keeping your opponent perpetually guessing.',
        harmony: 'The <strong>Harmony Game</strong> represents the happy case where self-interest and social welfare are perfectly aligned. Cooperation is the dominant strategy for both players ‚Äî there\'s no temptation to defect because cooperating always yields a higher payoff regardless of what the other player does. Real-world examples include many market transactions where trade is mutually beneficial. There is no dilemma here at all.',
        deadlock: '<strong>Deadlock</strong> is like the Prisoner\'s Dilemma except that both players actually <em>prefer</em> mutual defection over mutual cooperation. Neither player has any incentive to cooperate, and unlike the PD, there\'s no tragic inefficiency ‚Äî the Nash equilibrium (both defect) is also Pareto optimal. Think of two rival firms who both prefer competing aggressively over colluding, perhaps because reputation or market position matters more than short-term profits.',
        custom: 'You\'ve set <strong>custom payoffs</strong> that don\'t match any of the classic named games. The strategic structure depends on the ordering of your four payoff values. Try adjusting the sliders to see how different orderings of \\(R\\), \\(T\\), \\(S\\), and \\(P\\) create fundamentally different strategic environments ‚Äî each with its own equilibrium structure and cooperation dynamics.',
    };

    function updateInsight(){const box=document.getElementById('insightBox'),ne=findNashEquilibria(),dom=findDominantStrategies(),n=history.length;
        const type=classifyGame();
        const story=gameStories[type]||gameStories.custom;

        if(n===0){
            let analysis='';
            if(ne.pure.length===1){const eq=ne.pure[0];analysis+=`This game has a unique pure-strategy NE at <strong>(${eq.you}, ${eq.opp})</strong>. `;}
            else if(ne.pure.length>1)analysis+=`This game has <strong>${ne.pure.length} pure-strategy NE</strong>: ${ne.pure.map(n=>`(${n.you},${n.opp})`).join(', ')}. `;
            else analysis+='No pure-strategy NE. ';
            if(ne.mixedQ!==null&&ne.mixedQ>.001&&ne.mixedQ<.999)analysis+=`Mixed NE: each cooperates with probability <strong>${(ne.mixedQ*100).toFixed(0)}%</strong>. `;
            if(dom)analysis+=`Dominant strategy: <strong>${dom}</strong>. `;
            analysis+='Make your first move!';
            box.className='info-box highlight';
            box.innerHTML=`<div style="margin-bottom:8px;line-height:1.55">${story}</div><div style="border-top:1px solid #e2e8f0;padding-top:8px">${analysis}</div>`;
        }else if(history.length < 10){
            const cr=history.filter(h=>h.you==='C').length/n,or=history.filter(h=>h.opp==='C').length/n,ay=yourScore/n,ao=oppScore/n;
            let v='';if(ay>ao+.5)v='You\'re winning! ';else if(ao>ay+.5)v='Opponent is ahead. ';else v='Scores are close. ';
            if(cr>.7&&or>.7)v+='Mutual cooperation sustaining high joint payoffs.';else if(cr<.3&&or<.3)v+='Mutual defection ‚Äî the classic trap.';else if(cr>.7&&or<.3)v+='You\'re being exploited!';else if(cr<.3&&or>.7)v+='You\'re exploiting a cooperator.';else v+='Mixed play pattern.';
            box.className='info-box highlight';
            box.innerHTML=`<div style="margin-bottom:8px;line-height:1.55">${story}</div><div style="border-top:1px solid #e2e8f0;padding-top:8px"><strong>After ${n} rounds:</strong> ${v}<br>Your avg: ${ay.toFixed(1)}/round (${(cr*100).toFixed(0)}% coop) | Opp avg: ${ao.toFixed(1)}/round (${(or*100).toFixed(0)}% coop)</div>`;
        } else {
             box.innerHTML=`<div style="margin-bottom:8px;line-height:1.55"><strong>Game Over!</strong> Check the score report to see who you were playing against.</div>`;
        }
        renderAllMath();
    }

    function updateConcepts(){const ne=findNashEquilibria(),dom=findDominantStrategies(),pareto=findParetoOptimal(),type=classifyGame();const pStr=pareto.map(p=>`(${p.you},${p.opp})`).join(', '),nStr=ne.pure.length>0?ne.pure.map(n=>`(${n.you},${n.opp})`).join(', '):'None (pure)';let mStr='N/A';if(ne.mixedQ!==null&&ne.mixedQ>.001&&ne.mixedQ<.999)mStr=`p(C) = ${(ne.mixedQ*100).toFixed(0)}%`;else if(ne.pure.length>0)mStr='Pure NE exists';let dil='None';if(type==='pd')dil='Individual rationality ‚Üí mutual defection, but mutual cooperation is Pareto superior.';else if(type==='stag')dil='Two equilibria ‚Äî risk-dominant (D,D) vs payoff-dominant (C,C). Trust is key.';else if(type==='chicken')dil='Both want the other to yield. Two asymmetric NE plus mixed NE.';else if(type==='harmony')dil='No dilemma ‚Äî cooperation is individually rational.';document.getElementById('conceptsGrid').innerHTML=`<div class="concept-card"><div class="cc-label">Nash Equilibria</div><div class="cc-value">${nStr}</div><div class="cc-desc">No player can improve their payoff by unilaterally switching.</div></div><div class="concept-card"><div class="cc-label">Dominant Strategy</div><div class="cc-value">${dom||'None'}</div><div class="cc-desc">A strategy yielding higher payoff regardless of opponent's choice.</div></div><div class="concept-card"><div class="cc-label">Pareto Optimal</div><div class="cc-value">${pStr}</div><div class="cc-desc">No outcome makes someone better off without hurting the other. ‚òÖ in matrix.</div></div><div class="concept-card"><div class="cc-label">Social Dilemma</div><div class="cc-value" style="font-size:.8rem">${type==='custom'?'Custom':presets[type].name}</div><div class="cc-desc">${dil}</div></div>`;}

    // ---- CHARTS (BUG FIX: use parentElement width, not canvas getBoundingClientRect) ----
    function setupCanvas(canvas,ctx,cssHeight){
        const dpr=window.devicePixelRatio||1;
        const parent=canvas.parentElement;
        const w=parent.clientWidth;
        const h=cssHeight;
        canvas.style.width=w+'px';
        canvas.style.height=h+'px';
        canvas.width=w*dpr;
        canvas.height=h*dpr;
        ctx.setTransform(dpr,0,0,dpr,0,0);
        return{w,h};
    }

    function drawScoreChart(){
        const{w,h}=setupCanvas(scoreCanvas,sCtx,160);const ctx=sCtx;
        ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h);
        if(history.length===0){ctx.fillStyle='#a0aec0';ctx.font='12px Segoe UI';ctx.textAlign='center';ctx.fillText('Play rounds to see cumulative score chart',w/2,h/2);return;}
        const pad={top:10,right:15,bottom:24,left:40};
        let cumYou=[],cumOpp=[],sy=0,so=0;history.forEach(h=>{sy+=h.youPay;so+=h.oppPay;cumYou.push(sy);cumOpp.push(so);});
        const maxVal=Math.max(...cumYou,...cumOpp,1),minVal=Math.min(...cumYou,...cumOpp,0),range=maxVal-minVal||1;
        function X(i){return pad.left+(i/Math.max(history.length-1,1))*(w-pad.left-pad.right);}
        function Y(v){return h-pad.bottom-((v-minVal)/range)*(h-pad.top-pad.bottom);}
        if(isVis('show-score-grid')){ctx.strokeStyle='#edf2f7';ctx.lineWidth=.5;for(let i=0;i<=4;i++){const v=minVal+range*i/4;ctx.beginPath();ctx.moveTo(pad.left,Y(v));ctx.lineTo(w-pad.right,Y(v));ctx.stroke();}}
        if(isVis('show-score-labels')){ctx.fillStyle='#a0aec0';ctx.font='9px Consolas';ctx.textAlign='right';for(let i=0;i<=4;i++){const v=minVal+range*i/4;ctx.fillText(v.toFixed(0),pad.left-4,Y(v)+3);}}
        function drawLine(data,color){ctx.strokeStyle=color;ctx.lineWidth=2;ctx.beginPath();data.forEach((v,i)=>{if(i===0)ctx.moveTo(X(i),Y(v));else ctx.lineTo(X(i),Y(v));});ctx.stroke();}
        drawLine(cumYou,'#2b6cb0');drawLine(cumOpp,'#e53e3e');
        if(isVis('show-score-labels')){ctx.fillStyle='#a0aec0';ctx.font='9px Consolas';ctx.textAlign='center';const step=Math.max(1,Math.floor(history.length/8));for(let i=0;i<history.length;i+=step)ctx.fillText(i+1,X(i),h-6);if(history.length>1)ctx.fillText(history.length,X(history.length-1),h-6);}
    }

    function drawBRChart(){
        const{w,h}=setupCanvas(brCanvas,brCtx,220);const ctx=brCtx;
        ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h);
        const pad={top:14,right:20,bottom:32,left:48};
        const allVals=[R,T,S,P],maxP=Math.max(...allVals)+1,minP=Math.min(...allVals)-1,range=maxP-minP;
        function X(q){return pad.left+q*(w-pad.left-pad.right);}
        function Y(v){return h-pad.bottom-((v-minP)/range)*(h-pad.top-pad.bottom);}

        if(isVis('show-br-grid')){ctx.strokeStyle='#edf2f7';ctx.lineWidth=.5;for(let i=0;i<=5;i++){const v=minP+range*i/5;ctx.beginPath();ctx.moveTo(pad.left,Y(v));ctx.lineTo(w-pad.right,Y(v));ctx.stroke();ctx.fillStyle='#a0aec0';ctx.font='10px Consolas';ctx.textAlign='right';ctx.fillText(v.toFixed(1),pad.left-5,Y(v)+3);}for(let i=0;i<=10;i++){const q=i/10,x=X(q);ctx.beginPath();ctx.moveTo(x,pad.top);ctx.lineTo(x,h-pad.bottom);ctx.stroke();ctx.fillStyle='#a0aec0';ctx.font='10px Consolas';ctx.textAlign='center';if(i%2===0)ctx.fillText(q.toFixed(1),x,h-pad.bottom+14);}}

        ctx.strokeStyle='#a0aec0';ctx.lineWidth=1.2;ctx.beginPath();ctx.moveTo(pad.left,pad.top);ctx.lineTo(pad.left,h-pad.bottom);ctx.lineTo(w-pad.right,h-pad.bottom);ctx.stroke();
        ctx.fillStyle='#4a5568';ctx.font='11px Segoe UI';ctx.textAlign='center';ctx.fillText('Opponent\'s Probability of Cooperating (q)',(pad.left+w-pad.right)/2,h-2);ctx.save();ctx.translate(14,(pad.top+h-pad.bottom)/2);ctx.rotate(-Math.PI/2);ctx.fillText('Your Expected Payoff',0,0);ctx.restore();

        if(isVis('show-br-shading')){for(let qi=0;qi<100;qi++){const q=qi/100,ec=q*R+(1-q)*S,ed=q*T+(1-q)*P,x=X(q),xn=X((qi+1)/100);if(ec>ed+.05){ctx.fillStyle='rgba(43,108,176,0.06)';ctx.fillRect(x,pad.top,xn-x,h-pad.top-pad.bottom);}else if(ed>ec+.05){ctx.fillStyle='rgba(229,62,62,0.06)';ctx.fillRect(x,pad.top,xn-x,h-pad.top-pad.bottom);}}}

        ctx.strokeStyle='#2b6cb0';ctx.lineWidth=2.5;ctx.beginPath();ctx.moveTo(X(0),Y(S));ctx.lineTo(X(1),Y(R));ctx.stroke();
        ctx.strokeStyle='#e53e3e';ctx.lineWidth=2.5;ctx.beginPath();ctx.moveTo(X(0),Y(P));ctx.lineTo(X(1),Y(T));ctx.stroke();

        const denom=R-T+P-S;
        if(isVis('show-br-mixed')&&Math.abs(denom)>.001){const qStar=(P-S)/denom;if(qStar>.01&&qStar<.99){const eStar=qStar*R+(1-qStar)*S;ctx.setLineDash([3,3]);ctx.strokeStyle='#38a169';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(X(qStar),Y(minP));ctx.lineTo(X(qStar),Y(eStar));ctx.stroke();ctx.beginPath();ctx.moveTo(pad.left,Y(eStar));ctx.lineTo(X(qStar),Y(eStar));ctx.stroke();ctx.setLineDash([]);ctx.fillStyle='#38a169';ctx.beginPath();ctx.arc(X(qStar),Y(eStar),6,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();ctx.fillStyle='#38a169';ctx.font='bold 11px Segoe UI';ctx.textAlign='left';ctx.fillText(`Mixed NE: q*=${qStar.toFixed(2)}`,X(qStar)+10,Y(eStar)-4);ctx.font='10px Segoe UI';ctx.fillText(`E[payoff]=${eStar.toFixed(1)}`,X(qStar)+10,Y(eStar)+12);}}

        if(isVis('show-br-endpoints')){ctx.font='bold 10px Segoe UI';ctx.fillStyle='#2b6cb0';ctx.textAlign='left';ctx.fillText('E[C]',X(1)+4,Y(R)+3);ctx.textAlign='right';ctx.fillText(`S=${S}`,X(0)-4,Y(S)+3);ctx.fillStyle='#e53e3e';ctx.textAlign='left';ctx.fillText('E[D]',X(1)+4,Y(T)+3);ctx.textAlign='right';ctx.fillText(`P=${P}`,X(0)-4,Y(P)+3);}

        if(isVis('show-br-annotation')){ctx.fillStyle='#718096';ctx.font='10px Segoe UI';ctx.textAlign='center';if(R>T&&S>P)ctx.fillText('C always dominates ‚Üí always cooperate',(pad.left+w-pad.right)/2,pad.top+14);else if(T>R&&P>S)ctx.fillText('D always dominates ‚Üí always defect',(pad.left+w-pad.right)/2,pad.top+14);else if(Math.abs(denom)>.001){const qS2=(P-S)/denom;if(qS2>.01&&qS2<.99)ctx.fillText(`Best response switches at q = ${qS2.toFixed(2)}`,(pad.left+w-pad.right)/2,pad.top+14);}}
    }

    function updateAll(){updateMatrix();updateGameBadge();updateConcepts();updateInsight();drawScoreChart();drawBRChart();
        const type=classifyGame(),note=document.getElementById('payoffNote');
        if(type==='pd')note.innerHTML='Symmetric game: \\(T > R > P > S\\)<br><strong>Prisoner\'s Dilemma:</strong> Defection dominates, but mutual cooperation is better for both.';
        else if(type==='stag')note.innerHTML='Symmetric game: \\(R > T > P > S\\)<br><strong>Stag Hunt:</strong> Cooperation is best if both trust; defection is safe.';
        else if(type==='chicken')note.innerHTML='Symmetric game: \\(T > R > S > P\\)<br><strong>Chicken:</strong> Both want the other to yield. Worst outcome is mutual defection.';
        else if(type==='harmony')note.innerHTML='Symmetric game: \\(R > T, S > P\\)<br><strong>Harmony:</strong> Cooperation dominates ‚Äî no dilemma!';
        else if(type==='deadlock')note.innerHTML='Symmetric game: \\(P > R\\), \\(T\\) dominant<br><strong>Deadlock:</strong> Both prefer defection.';
        else note.innerHTML='Symmetric game: opponent\'s payoffs mirror yours.<br>Adjust sliders to explore different game structures.';
        renderAllMath();
    }

    updateAll();
    window.addEventListener('resize',()=>{drawScoreChart();drawBRChart();});
    document.getElementById('display-toggle-btn').addEventListener('click',()=>{const p=document.getElementById('display-panel'),a=document.getElementById('display-arrow');const o=p.classList.toggle('open');a.classList.toggle('open',o);});
    document.querySelectorAll('.display-options-panel input').forEach(i=>{i.addEventListener('input',()=>{drawScoreChart();drawBRChart();});i.addEventListener('change',()=>{drawScoreChart();drawBRChart();});});
})();
</script>
</body>
</html>