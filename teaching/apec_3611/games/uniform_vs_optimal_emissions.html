<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ Uniform vs. Optimal Emissions Permits</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --firm1: #059669;
            --firm1-light: #10b981;
            --firm2: #dc2626;
            --firm2-light: #ef4444;
            --optimal: #7c3aed;
            --savings: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 1.9rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 750px;
            margin: 0 auto;
        }

        .steps {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 1.5rem;
            background: white;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1100px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 2px;
        }

        .card-title.firm1::before { background: var(--firm1); }
        .card-title.firm2::before { background: var(--firm2); }

        .control-group {
            margin-bottom: 1.25rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.5rem;
        }

        .control-label span {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .control-value {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 500;
        }

        .control-value.firm1 { color: var(--firm1); }
        .control-value.firm2 { color: var(--firm2); }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
            transition: transform 0.15s ease;
        }

        input[type="range"].firm1::-webkit-slider-thumb { background: var(--firm1); }
        input[type="range"].firm2::-webkit-slider-thumb { background: var(--firm2); }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        .formula-box {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            color: var(--text);
            margin-top: 0.5rem;
            border-left: 3px solid var(--primary);
        }

        .formula-box.firm1 { border-left-color: var(--firm1); }
        .formula-box.firm2 { border-left-color: var(--firm2); }

        .results-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
        }

        .results-card .card-title {
            color: #92400e;
        }

        .results-card .card-title::before {
            background: var(--savings);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #fcd34d;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #92400e;
        }

        .result-value {
            font-family: 'Fira Code', monospace;
            font-weight: 600;
            color: #b45309;
        }

        .result-value.savings {
            color: #047857;
            font-size: 1.1rem;
        }

        .graphs-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .graphs-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .graphs-row {
                grid-template-columns: 1fr;
            }
        }

        .graph-card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .graph-card.firm1 {
            border-top: 3px solid var(--firm1);
        }

        .graph-card.firm2 {
            border-top: 3px solid var(--firm2);
        }

        .graph-card.combined {
            border-top: 3px solid var(--optimal);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .graph-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        .graph-subtitle {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .canvas-container {
            position: relative;
            width: 100%;
        }

        canvas {
            display: block;
            width: 100%;
        }

        .legend-custom {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 600;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .legend-color.line {
            height: 3px;
            border-radius: 2px;
        }

        .cost-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .cost-box {
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .cost-box.uniform {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }

        .cost-box.optimal {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.3);
        }

        .cost-box-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 0.25rem;
        }

        .cost-box.uniform .cost-box-label { color: var(--firm2); }
        .cost-box.optimal .cost-box-label { color: var(--firm1); }

        .cost-box-value {
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .explanation-card {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
        }

        .explanation-text {
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .explanation-text strong {
            color: var(--primary);
        }

        .firm-costs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.85rem;
        }

        .firm-cost {
            padding: 0.5rem;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
        }

        .firm-cost.firm1 {
            background: rgba(5, 150, 105, 0.1);
        }

        .firm-cost.firm2 {
            background: rgba(220, 38, 38, 0.1);
        }

        .firm-cost-label {
            font-weight: 600;
        }

        .firm-cost.firm1 .firm-cost-label { color: var(--firm1); }
        .firm-cost.firm2 .firm-cost-label { color: var(--firm2); }

        .firm-cost-value {
            font-family: 'Fira Code', monospace;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üè≠ Uniform vs. Optimal Emissions Permits</h1>
        <p>MAC curves plotted against emissions ‚Äî see how downward-sloping MACs horizontally sum to an aggregate emissions demand curve</p>
    </header>

    <div class="steps">
        <div class="step">
            <div class="step-number">1</div>
            <span>Set Firm MAC Curves</span>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <span>Choose Emissions Cap</span>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <span>Compare Uniform vs. Optimal</span>
        </div>
    </div>

    <div class="container">
        <div class="controls-panel">
            <div class="card">
                <div class="card-title">üéØ Emissions Cap</div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Total Emissions Allowed</span>
                        <span class="control-value" id="total-emissions-value">40 units</span>
                    </div>
                    <input type="range" id="total-emissions" min="10" max="90" value="40" step="5">
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                        Combined baseline emissions: 100 units<br>
                        Required abatement: <span id="abatement-amount">60</span> units
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-title firm1">üè≠ Firm 1 (Low-Cost Abater)</div>
                <div class="control-group">
                    <div class="control-label">
                        <span>MAC Slope (c‚ÇÅ)</span>
                        <span class="control-value firm1" id="mac1-value">0.5</span>
                    </div>
                    <input type="range" class="firm1" id="mac1-slope" min="0.2" max="2" value="0.5" step="0.1">
                </div>
                <div class="formula-box firm1">
                    MAC‚ÇÅ(E‚ÇÅ) = c‚ÇÅ √ó (ƒí‚ÇÅ ‚àí E‚ÇÅ) = <span id="mac1-formula">0.5</span> √ó (50 ‚àí E‚ÇÅ)
                </div>
                <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                    Baseline emissions ƒí‚ÇÅ = 50 units
                </p>
            </div>

            <div class="card">
                <div class="card-title firm2">üè≠ Firm 2 (High-Cost Abater)</div>
                <div class="control-group">
                    <div class="control-label">
                        <span>MAC Slope (c‚ÇÇ)</span>
                        <span class="control-value firm2" id="mac2-value">2.0</span>
                    </div>
                    <input type="range" class="firm2" id="mac2-slope" min="0.2" max="4" value="2" step="0.1">
                </div>
                <div class="formula-box firm2">
                    MAC‚ÇÇ(E‚ÇÇ) = c‚ÇÇ √ó (ƒí‚ÇÇ ‚àí E‚ÇÇ) = <span id="mac2-formula">2.0</span> √ó (50 ‚àí E‚ÇÇ)
                </div>
                <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">
                    Baseline emissions ƒí‚ÇÇ = 50 units
                </p>
            </div>

            <div class="card results-card">
                <div class="card-title">üí∞ Cost Savings</div>
                <div class="result-item">
                    <span class="result-label">Uniform Permits Cost</span>
                    <span class="result-value" id="uniform-total-cost">$1,125</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Optimal Permits Cost</span>
                    <span class="result-value" id="optimal-total-cost">$900</span>
                </div>
                <div class="result-item">
                    <span class="result-label">üíµ Savings from Trading</span>
                    <span class="result-value savings" id="cost-savings">$225 (20%)</span>
                </div>
            </div>

            <div class="card explanation-card">
                <div class="card-title">üí° Key Insight</div>
                <p class="explanation-text">
                    <strong>With emissions on the x-axis, MACs slope downward:</strong> 
                    as a firm emits more (abates less), its marginal cost of further abatement falls. 
                    <br><br>
                    The aggregate MAC is the horizontal sum ‚Äî at each price, total emissions equals the sum of each firm's emissions. Trading permits until MAC‚ÇÅ = MAC‚ÇÇ minimizes total cost.
                </p>
            </div>
        </div>

        <div class="graphs-panel">
            <div class="graphs-row">
                <div class="graph-card firm1">
                    <div class="graph-header">
                        <div>
                            <div class="graph-title">Firm 1: Low-Cost Abater</div>
                            <div class="graph-subtitle">Baseline emissions: 50 units</div>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="firm1-canvas" height="280"></canvas>
                    </div>
                    <div class="firm-costs">
                        <div class="firm-cost firm1">
                            <span class="firm-cost-label">Uniform E‚ÇÅ:</span>
                            <span class="firm-cost-value" id="firm1-uniform-e">20</span>
                        </div>
                        <div class="firm-cost firm1">
                            <span class="firm-cost-label">Optimal E‚ÇÅ:</span>
                            <span class="firm-cost-value" id="firm1-optimal-e">2</span>
                        </div>
                    </div>
                </div>

                <div class="graph-card firm2">
                    <div class="graph-header">
                        <div>
                            <div class="graph-title">Firm 2: High-Cost Abater</div>
                            <div class="graph-subtitle">Baseline emissions: 50 units</div>
                        </div>
                    </div>
                    <div class="canvas-container">
                        <canvas id="firm2-canvas" height="280"></canvas>
                    </div>
                    <div class="firm-costs">
                        <div class="firm-cost firm2">
                            <span class="firm-cost-label">Uniform E‚ÇÇ:</span>
                            <span class="firm-cost-value" id="firm2-uniform-e">20</span>
                        </div>
                        <div class="firm-cost firm2">
                            <span class="firm-cost-label">Optimal E‚ÇÇ:</span>
                            <span class="firm-cost-value" id="firm2-optimal-e">38</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="graph-card combined">
                <div class="graph-header">
                    <div>
                        <div class="graph-title">Combined: Aggregate MAC (Emissions Axis)</div>
                        <div class="graph-subtitle">Horizontal sum of firm MACs ‚Äî total emissions at each permit price</div>
                    </div>
                </div>
                <div class="canvas-container">
                    <canvas id="combined-canvas" height="300"></canvas>
                </div>
                <div class="legend-custom">
                    <div class="legend-item">
                        <div class="legend-color line" style="background: var(--firm1);"></div>
                        <span>MAC‚ÇÅ (Firm 1)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color line" style="background: var(--firm2);"></div>
                        <span>MAC‚ÇÇ (Firm 2)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color line" style="background: var(--optimal);"></div>
                        <span>Aggregate MAC</span>
                    </div>
                </div>
                <div class="cost-comparison">
                    <div class="cost-box uniform">
                        <div class="cost-box-label">Uniform Permits</div>
                        <div class="cost-box-value" id="uniform-cost-display">$1,125</div>
                    </div>
                    <div class="cost-box optimal">
                        <div class="cost-box-label">Tradeable Permits</div>
                        <div class="cost-box-value" id="optimal-cost-display">$900</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Parameters
        let totalEmissions = 40;  // emissions cap (E_cap)
        let c1 = 0.5;  // Firm 1 MAC slope (low cost)
        let c2 = 2.0;  // Firm 2 MAC slope (high cost)

        const baseline1 = 50;
        const baseline2 = 50;
        const totalBaseline = baseline1 + baseline2;

        // Canvas references
        const firm1Canvas = document.getElementById('firm1-canvas');
        const firm2Canvas = document.getElementById('firm2-canvas');
        const combinedCanvas = document.getElementById('combined-canvas');

        // Colors
        const colors = {
            firm1: '#059669',
            firm2: '#dc2626',
            optimal: '#7c3aed',
            grid: '#e2e8f0',
            text: '#64748b',
            uniformFill: 'rgba(220, 38, 38, 0.2)',
            optimalFill: 'rgba(5, 150, 105, 0.2)',
            dwlFill: 'rgba(220, 38, 38, 0.35)'
        };

        function init() {
            setupCanvases();
            setupEventListeners();
            updateAll();
        }

        function setupCanvases() {
            const dpr = window.devicePixelRatio || 1;
            
            [firm1Canvas, firm2Canvas, combinedCanvas].forEach((canvas, i) => {
                const rect = canvas.getBoundingClientRect();
                const h = i < 2 ? 280 : 300;
                canvas.width = rect.width * dpr;
                canvas.height = h * dpr;
                canvas.style.height = h + 'px';
                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr);
            });
        }

        function setupEventListeners() {
            document.getElementById('total-emissions').addEventListener('input', (e) => {
                totalEmissions = parseFloat(e.target.value);
                updateAll();
            });

            document.getElementById('mac1-slope').addEventListener('input', (e) => {
                c1 = parseFloat(e.target.value);
                updateAll();
            });

            document.getElementById('mac2-slope').addEventListener('input', (e) => {
                c2 = parseFloat(e.target.value);
                updateAll();
            });

            window.addEventListener('resize', () => {
                setupCanvases();
                updateAll();
            });
        }

        // Economic functions ‚Äî MAC as function of EMISSIONS
        // MAC_i(E_i) = c_i * (baseline_i - E_i)  ‚Äî downward sloping in E
        // Abatement A_i = baseline_i - E_i, so MAC_i = c_i * A_i as before
        function MAC1_E(e) { return c1 * (baseline1 - e); }
        function MAC2_E(e) { return c2 * (baseline2 - e); }

        // Total abatement cost = 0.5 * c * A^2 = 0.5 * c * (baseline - E)^2
        function TAC1_E(e) { return 0.5 * c1 * Math.pow(baseline1 - e, 2); }
        function TAC2_E(e) { return 0.5 * c2 * Math.pow(baseline2 - e, 2); }

        // Optimal allocation: equate MACs
        // c1*(baseline1 - E1) = c2*(baseline2 - E2) and E1 + E2 = totalEmissions
        // c1*baseline1 - c1*E1 = c2*baseline2 - c2*(totalEmissions - E1)
        // c1*baseline1 - c1*E1 = c2*baseline2 - c2*totalEmissions + c2*E1
        // c1*baseline1 - c2*baseline2 + c2*totalEmissions = (c1 + c2)*E1
        // E1 = (c1*baseline1 - c2*baseline2 + c2*totalEmissions) / (c1 + c2)
        // Equivalently via abatement: A1 = c2/(c1+c2) * totalAbatement
        // E1 = baseline1 - A1 = baseline1 - c2/(c1+c2) * (totalBaseline - totalEmissions)
        function getOptimalAllocation() {
            const totalAbatement = totalBaseline - totalEmissions;
            const a1 = (c2 / (c1 + c2)) * totalAbatement;
            const a2 = totalAbatement - a1;
            const e1 = baseline1 - a1;
            const e2 = baseline2 - a2;
            return { e1, e2, a1, a2 };
        }

        // Uniform: each firm gets equal share of emissions cap
        function getUniformAllocation() {
            const e1 = totalEmissions / 2;
            const e2 = totalEmissions / 2;
            return { e1, e2, a1: baseline1 - e1, a2: baseline2 - e2 };
        }

        // Aggregate MAC as function of total emissions
        // At price p: E1 = baseline1 - p/c1, E2 = baseline2 - p/c2
        // Total E = totalBaseline - p*(1/c1 + 1/c2)
        // So p = (totalBaseline - E) / (1/c1 + 1/c2) = (totalBaseline - E) * c1*c2/(c1+c2)
        function aggMAC_E(e) {
            const aggSlope = (c1 * c2) / (c1 + c2);
            return aggSlope * (totalBaseline - e);
        }

        function updateAll() {
            const uniform = getUniformAllocation();
            const optimal = getOptimalAllocation();

            const uniformCost = TAC1_E(uniform.e1) + TAC2_E(uniform.e2);
            const optimalCost = TAC1_E(optimal.e1) + TAC2_E(optimal.e2);
            const savings = uniformCost - optimalCost;
            const savingsPct = uniformCost > 0 ? (savings / uniformCost * 100).toFixed(0) : '0';

            const totalAbatement = totalBaseline - totalEmissions;

            // Update displays
            document.getElementById('total-emissions-value').textContent = `${totalEmissions} units`;
            document.getElementById('abatement-amount').textContent = totalAbatement;
            document.getElementById('mac1-value').textContent = c1.toFixed(1);
            document.getElementById('mac1-formula').textContent = c1.toFixed(1);
            document.getElementById('mac2-value').textContent = c2.toFixed(1);
            document.getElementById('mac2-formula').textContent = c2.toFixed(1);

            document.getElementById('uniform-total-cost').textContent = `$${uniformCost.toFixed(0)}`;
            document.getElementById('optimal-total-cost').textContent = `$${optimalCost.toFixed(0)}`;
            document.getElementById('cost-savings').textContent = `$${savings.toFixed(0)} (${savingsPct}%)`;

            document.getElementById('firm1-uniform-e').textContent = uniform.e1.toFixed(0);
            document.getElementById('firm1-optimal-e').textContent = optimal.e1.toFixed(1);
            document.getElementById('firm2-uniform-e').textContent = uniform.e2.toFixed(0);
            document.getElementById('firm2-optimal-e').textContent = optimal.e2.toFixed(1);

            document.getElementById('uniform-cost-display').textContent = `$${uniformCost.toFixed(0)}`;
            document.getElementById('optimal-cost-display').textContent = `$${optimalCost.toFixed(0)}`;

            drawFirmChart(firm1Canvas, 1, uniform.e1, optimal.e1);
            drawFirmChart(firm2Canvas, 2, uniform.e2, optimal.e2);
            drawCombinedChart();
        }

        function drawFirmChart(canvas, firmNum, uniformE, optimalE) {
            const ctx = canvas.getContext('2d');
            const width = canvas.getBoundingClientRect().width;
            const height = 280;
            
            ctx.clearRect(0, 0, width, height);

            const margin = { top: 20, right: 25, bottom: 40, left: 50 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const baseline = firmNum === 1 ? baseline1 : baseline2;
            const MAC_E = firmNum === 1 ? MAC1_E : MAC2_E;
            const color = firmNum === 1 ? colors.firm1 : colors.firm2;
            const c = firmNum === 1 ? c1 : c2;

            const maxE = 60; // x-axis range for emissions
            const maxY = Math.ceil(MAC_E(0) / 10) * 10 + 5; // MAC is highest at E=0

            const scaleX = (e) => margin.left + (e / maxE) * chartWidth;
            const scaleY = (y) => margin.top + chartHeight - (y / maxY) * chartHeight;

            // Grid
            ctx.strokeStyle = colors.grid;
            ctx.lineWidth = 1;
            for (let y = 0; y <= maxY; y += maxY / 5) {
                ctx.beginPath();
                ctx.moveTo(margin.left, scaleY(y));
                ctx.lineTo(width - margin.right, scaleY(y));
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, height - margin.bottom);
            ctx.lineTo(width - margin.right, height - margin.bottom);
            ctx.stroke();

            // Labels
            ctx.fillStyle = colors.text;
            ctx.font = '600 11px Source Sans Pro';
            ctx.textAlign = 'center';
            ctx.fillText(`Emissions E${firmNum}`, width / 2, height - 8);

            ctx.save();
            ctx.translate(14, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('$/unit', 0, 0);
            ctx.restore();

            // Ticks
            ctx.font = '11px Source Sans Pro';
            for (let e = 0; e <= maxE; e += 10) {
                ctx.textAlign = 'center';
                ctx.fillText(e.toString(), scaleX(e), height - margin.bottom + 15);
            }
            ctx.textAlign = 'right';
            for (let y = 0; y <= maxY; y += maxY / 5) {
                ctx.fillText(y.toFixed(0), margin.left - 6, scaleY(y) + 4);
            }

            // Fill area showing abatement cost under MAC curve from uniformE to baseline
            // Cost of abatement = area under MAC curve from E to baseline (i.e., integrating the triangle)
            ctx.fillStyle = colors.uniformFill;
            ctx.beginPath();
            ctx.moveTo(scaleX(uniformE), scaleY(0));
            ctx.lineTo(scaleX(uniformE), scaleY(MAC_E(uniformE)));
            ctx.lineTo(scaleX(baseline), scaleY(0)); // MAC = 0 at baseline
            ctx.closePath();
            ctx.fill();

            // MAC line ‚Äî downward sloping from (0, c*baseline) to (baseline, 0)
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            const drawStart = 0;
            const drawEnd = Math.min(baseline, maxE);
            ctx.moveTo(scaleX(drawStart), scaleY(MAC_E(drawStart)));
            ctx.lineTo(scaleX(drawEnd), scaleY(MAC_E(drawEnd)));
            ctx.stroke();

            // Optimal price line (horizontal)
            const optimalPrice = MAC_E(optimalE);
            ctx.strokeStyle = colors.optimal;
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(margin.left, scaleY(optimalPrice));
            ctx.lineTo(scaleX(optimalE), scaleY(optimalPrice));
            ctx.stroke();
            ctx.setLineDash([]);

            // Vertical lines at uniform and optimal emissions
            ctx.strokeStyle = colors.firm2;
            ctx.lineWidth = 2;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(scaleX(uniformE), scaleY(0));
            ctx.lineTo(scaleX(uniformE), scaleY(MAC_E(uniformE)));
            ctx.stroke();

            ctx.strokeStyle = colors.optimal;
            ctx.beginPath();
            ctx.moveTo(scaleX(optimalE), scaleY(0));
            ctx.lineTo(scaleX(optimalE), scaleY(optimalPrice));
            ctx.stroke();
            ctx.setLineDash([]);

            // Baseline marker
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(scaleX(baseline), scaleY(0));
            ctx.lineTo(scaleX(baseline), scaleY(maxY * 0.15));
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = colors.text;
            ctx.font = '10px Source Sans Pro';
            ctx.textAlign = 'center';
            ctx.fillText(`ƒí${firmNum}=${baseline}`, scaleX(baseline), scaleY(0) + 13);

            // Points
            ctx.fillStyle = colors.firm2;
            ctx.beginPath();
            ctx.arc(scaleX(uniformE), scaleY(MAC_E(uniformE)), 6, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = colors.optimal;
            ctx.beginPath();
            ctx.arc(scaleX(optimalE), scaleY(optimalPrice), 6, 0, Math.PI * 2);
            ctx.fill();

            // Labels
            ctx.font = '600 11px Source Sans Pro';
            ctx.fillStyle = colors.firm2;
            ctx.textAlign = 'center';
            ctx.fillText('Uniform', scaleX(uniformE), height - margin.bottom + 28);

            ctx.fillStyle = colors.optimal;
            ctx.fillText('Optimal', scaleX(optimalE), scaleY(optimalPrice) - 10);

            // MAC label
            ctx.fillStyle = color;
            ctx.font = '600 13px Source Sans Pro';
            ctx.textAlign = 'left';
            const labelE = Math.min(baseline * 0.25, maxE * 0.25);
            ctx.fillText(`MAC${firmNum}`, scaleX(labelE) + 5, scaleY(MAC_E(labelE)) - 10);
        }

        function drawCombinedChart() {
            const ctx = combinedCanvas.getContext('2d');
            const width = combinedCanvas.getBoundingClientRect().width;
            const height = 300;
            
            ctx.clearRect(0, 0, width, height);

            const margin = { top: 20, right: 30, bottom: 45, left: 55 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const maxE = 110; // enough room for total baseline of 100
            const uniform = getUniformAllocation();
            const optimal = getOptimalAllocation();
            const optimalPrice = MAC1_E(optimal.e1); // = MAC2_E(optimal.e2)

            // Max Y: highest MAC is at E=0 for each firm
            const maxY = Math.ceil(Math.max(MAC1_E(0), MAC2_E(0), optimalPrice * 1.3) / 10) * 10;

            const scaleX = (e) => margin.left + (e / maxE) * chartWidth;
            const scaleY = (y) => margin.top + chartHeight - (y / maxY) * chartHeight;

            // Grid
            ctx.strokeStyle = colors.grid;
            ctx.lineWidth = 1;
            for (let y = 0; y <= maxY; y += maxY / 5) {
                ctx.beginPath();
                ctx.moveTo(margin.left, scaleY(y));
                ctx.lineTo(width - margin.right, scaleY(y));
                ctx.stroke();
            }

            // Axes
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, height - margin.bottom);
            ctx.lineTo(width - margin.right, height - margin.bottom);
            ctx.stroke();

            // Labels
            ctx.fillStyle = colors.text;
            ctx.font = '600 12px Source Sans Pro';
            ctx.textAlign = 'center';
            ctx.fillText('Total Emissions (E‚ÇÅ + E‚ÇÇ)', width / 2, height - 8);

            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('$/unit', 0, 0);
            ctx.restore();

            // Ticks
            ctx.font = '11px Source Sans Pro';
            for (let e = 0; e <= maxE; e += 20) {
                ctx.textAlign = 'center';
                ctx.fillText(e.toString(), scaleX(e), height - margin.bottom + 15);
            }
            ctx.textAlign = 'right';
            for (let y = 0; y <= maxY; y += maxY / 5) {
                ctx.fillText(y.toFixed(0), margin.left - 8, scaleY(y) + 4);
            }

            // Fill optimal cost area (under aggregate MAC from totalEmissions to totalBaseline)
            ctx.fillStyle = colors.optimalFill;
            ctx.beginPath();
            ctx.moveTo(scaleX(totalEmissions), scaleY(0));
            for (let e = totalEmissions; e <= totalBaseline; e += 2) {
                ctx.lineTo(scaleX(e), scaleY(aggMAC_E(e)));
            }
            ctx.lineTo(scaleX(totalBaseline), scaleY(0));
            ctx.closePath();
            ctx.fill();

            // Draw individual MAC curves ‚Äî both downward-sloping
            // Firm 1 MAC: from (0, c1*baseline1) down to (baseline1, 0)
            ctx.strokeStyle = colors.firm1;
            ctx.lineWidth = 2.5;
            ctx.setLineDash([]);
            ctx.beginPath();
            let started1 = false;
            for (let e = 0; e <= baseline1; e += 1) {
                const macVal = MAC1_E(e);
                if (macVal <= maxY) {
                    if (!started1) { ctx.moveTo(scaleX(e), scaleY(macVal)); started1 = true; }
                    else ctx.lineTo(scaleX(e), scaleY(macVal));
                }
            }
            ctx.lineTo(scaleX(baseline1), scaleY(0));
            ctx.stroke();

            // Firm 2 MAC: from (0, c2*baseline2) down to (baseline2, 0)
            ctx.strokeStyle = colors.firm2;
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            let started2 = false;
            for (let e = 0; e <= baseline2; e += 1) {
                const macVal = MAC2_E(e);
                if (macVal <= maxY) {
                    if (!started2) { ctx.moveTo(scaleX(e), scaleY(macVal)); started2 = true; }
                    else ctx.lineTo(scaleX(e), scaleY(macVal));
                }
            }
            ctx.lineTo(scaleX(baseline2), scaleY(0));
            ctx.stroke();

            // Aggregate MAC ‚Äî downward sloping from (0, high) to (totalBaseline, 0)
            ctx.strokeStyle = colors.optimal;
            ctx.lineWidth = 3;
            ctx.setLineDash([]);
            ctx.beginPath();
            let startedAgg = false;
            for (let e = 0; e <= totalBaseline; e += 2) {
                const macVal = aggMAC_E(e);
                if (macVal <= maxY) {
                    if (!startedAgg) { ctx.moveTo(scaleX(e), scaleY(macVal)); startedAgg = true; }
                    else ctx.lineTo(scaleX(e), scaleY(macVal));
                }
            }
            ctx.lineTo(scaleX(totalBaseline), scaleY(0));
            ctx.stroke();

            // Optimal price line
            ctx.strokeStyle = colors.optimal;
            ctx.lineWidth = 2;
            ctx.setLineDash([6, 4]);
            ctx.beginPath();
            ctx.moveTo(margin.left, scaleY(optimalPrice));
            ctx.lineTo(scaleX(totalEmissions), scaleY(optimalPrice));
            ctx.stroke();
            ctx.setLineDash([]);

            // Vertical line at emissions cap
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 2;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(scaleX(totalEmissions), scaleY(0));
            ctx.lineTo(scaleX(totalEmissions), scaleY(optimalPrice));
            ctx.stroke();
            ctx.setLineDash([]);

            // Mark uniform MACs ‚Äî each firm's MAC at uniform emissions allocation (half each)
            const uniE = totalEmissions / 2;
            ctx.fillStyle = colors.firm1;
            ctx.beginPath();
            ctx.arc(scaleX(uniE), scaleY(MAC1_E(uniE)), 5, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = colors.firm2;
            ctx.beginPath();
            ctx.arc(scaleX(uniE), scaleY(MAC2_E(uniE)), 5, 0, Math.PI * 2);
            ctx.fill();

            // Vertical dashed line at uniform emissions level
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 1.5;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(scaleX(uniE), scaleY(0));
            ctx.lineTo(scaleX(uniE), scaleY(Math.max(MAC1_E(uniE), MAC2_E(uniE))));
            ctx.stroke();
            ctx.setLineDash([]);

            // Optimal intersection point on aggregate
            ctx.fillStyle = colors.optimal;
            ctx.beginPath();
            ctx.arc(scaleX(totalEmissions), scaleY(optimalPrice), 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(scaleX(totalEmissions), scaleY(optimalPrice), 4, 0, Math.PI * 2);
            ctx.fill();

            // Baseline marker
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(scaleX(totalBaseline), scaleY(0));
            ctx.lineTo(scaleX(totalBaseline), scaleY(maxY * 0.1));
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = colors.text;
            ctx.font = '10px Source Sans Pro';
            ctx.textAlign = 'center';
            ctx.fillText(`ƒí=${totalBaseline}`, scaleX(totalBaseline), scaleY(0) + 13);

            // Curve labels
            ctx.font = '600 12px Source Sans Pro';
            ctx.fillStyle = colors.firm1;
            ctx.textAlign = 'left';
            const label1E = baseline1 * 0.15;
            if (MAC1_E(label1E) <= maxY) {
                ctx.fillText('MAC‚ÇÅ', scaleX(label1E) + 3, scaleY(MAC1_E(label1E)) - 8);
            }

            ctx.fillStyle = colors.firm2;
            const label2E = baseline2 * 0.35;
            if (MAC2_E(label2E) <= maxY) {
                ctx.fillText('MAC‚ÇÇ', scaleX(label2E) + 3, scaleY(MAC2_E(label2E)) - 8);
            }

            ctx.fillStyle = colors.optimal;
            ctx.textAlign = 'left';
            const labelAggE = totalBaseline * 0.15;
            if (aggMAC_E(labelAggE) <= maxY) {
                ctx.fillText('Aggregate MAC', scaleX(labelAggE) + 5, scaleY(aggMAC_E(labelAggE)) - 8);
            }

            // Price label
            ctx.fillStyle = colors.optimal;
            ctx.font = '11px Source Sans Pro';
            ctx.textAlign = 'right';
            ctx.fillText(`p* = $${optimalPrice.toFixed(1)}`, margin.left - 8, scaleY(optimalPrice) - 8);

            // Emissions cap label
            ctx.fillStyle = colors.text;
            ctx.textAlign = 'center';
            ctx.font = '600 11px Source Sans Pro';
            ctx.fillText('Cap', scaleX(totalEmissions), height - margin.bottom + 28);
            ctx.fillText(`E = ${totalEmissions}`, scaleX(totalEmissions), height - margin.bottom + 40);

            // Show uniform vs optimal annotations
            ctx.font = '10px Source Sans Pro';
            ctx.fillStyle = colors.firm1;
            ctx.textAlign = 'left';
            ctx.fillText(`Uniform: MAC‚ÇÅ = $${MAC1_E(uniE).toFixed(1)}`, scaleX(uniE) + 8, scaleY(MAC1_E(uniE)) + 4);
            ctx.fillStyle = colors.firm2;
            ctx.fillText(`Uniform: MAC‚ÇÇ = $${MAC2_E(uniE).toFixed(1)}`, scaleX(uniE) + 8, scaleY(MAC2_E(uniE)) + 4);

            // Arrow showing inefficiency gap
            const mac1AtUni = MAC1_E(uniE);
            const mac2AtUni = MAC2_E(uniE);
            if (Math.abs(mac2AtUni - mac1AtUni) > 3) {
                ctx.strokeStyle = colors.dwlFill;
                ctx.lineWidth = 2;
                ctx.beginPath();
                const lowMAC = Math.min(mac1AtUni, mac2AtUni);
                const highMAC = Math.max(mac1AtUni, mac2AtUni);
                ctx.moveTo(scaleX(uniE) + 3, scaleY(lowMAC) - 8);
                ctx.lineTo(scaleX(uniE) + 3, scaleY(highMAC) + 8);
                ctx.stroke();
                
                // Arrow head
                ctx.beginPath();
                ctx.moveTo(scaleX(uniE) + 3, scaleY(highMAC) + 8);
                ctx.lineTo(scaleX(uniE) - 2, scaleY(highMAC) + 3);
                ctx.lineTo(scaleX(uniE) + 8, scaleY(highMAC) + 3);
                ctx.closePath();
                ctx.fillStyle = colors.dwlFill;
                ctx.fill();

                ctx.fillStyle = colors.firm2;
                ctx.font = '600 10px Source Sans Pro';
                ctx.textAlign = 'center';
                ctx.fillText('MAC gap', scaleX(uniE) + 30, (scaleY(lowMAC) + scaleY(highMAC)) / 2 + 4);
                ctx.fillText('= DWL', scaleX(uniE) + 30, (scaleY(lowMAC) + scaleY(highMAC)) / 2 + 16);
            }
        }

        // Start
        init();
    </script>
</body>
</html>
