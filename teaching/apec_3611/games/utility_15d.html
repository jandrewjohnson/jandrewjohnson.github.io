<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15D Utility Maximization</title>
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0d0d1a 0%, #1a1a2e 100%);
            color: #e8e8e8;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }
        
        .container { max-width: 1800px; margin: 0 auto; }
        
        h1 {
            text-align: center;
            font-weight: 300;
            font-size: 1.5rem;
            margin: 0 0 5px 0;
            color: #fff;
        }
        
        .subtitle {
            text-align: center;
            color: #8892b0;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }
        
        .top-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .utility-display {
            text-align: center;
        }
        
        .utility-label {
            font-size: 0.7rem;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .utility-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Monaco', monospace;
            color: #4ecdc4;
            text-shadow: 0 0 20px rgba(78, 205, 196, 0.5);
        }
        
        .utility-value.infeasible { color: #ff4757; text-shadow: 0 0 20px rgba(255, 71, 87, 0.5); }
        .utility-value.optimal { color: #ffd93d; text-shadow: 0 0 25px rgba(255, 217, 61, 0.7); }
        
        .status-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        
        .status-badge.affordable { background: rgba(78, 205, 196, 0.2); color: #4ecdc4; }
        .status-badge.over { background: rgba(255, 71, 87, 0.3); color: #ff4757; animation: pulse-red 1s infinite; }
        .status-badge.optimal { background: rgba(255, 217, 61, 0.3); color: #ffd93d; animation: pulse-gold 1s infinite; }
        
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes pulse-gold { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .proximity-compact {
            width: 150px;
        }
        
        .proximity-compact .prox-label {
            font-size: 0.65rem;
            color: #8892b0;
            display: flex;
            justify-content: space-between;
        }
        
        .proximity-compact .prox-bar {
            height: 6px;
            background: #2a2a4a;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 3px;
        }
        
        .proximity-compact .prox-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757, #ffd93d, #4ecdc4);
            border-radius: 3px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 10px;
        }
        
        @media (max-width: 1400px) {
            .main-grid { grid-template-columns: 1fr; }
        }
        
        .panel {
            background: #0f0f1a;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #2a2a4a;
        }
        
        .panel-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8892b0;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .goods-panel {
            max-height: 75vh;
            overflow-y: auto;
        }
        
        .good-row {
            display: grid;
            grid-template-columns: 55px 1fr 40px;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            padding: 4px 6px;
            background: rgba(255,255,255,0.02);
            border-radius: 4px;
        }
        
        .good-row:hover { background: rgba(78, 205, 196, 0.05); }
        
        .good-name {
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .good-color {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }
        
        .good-row input[type="range"] {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #2a2a4a;
            -webkit-appearance: none;
        }
        
        .good-row input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
        }
        
        .good-value {
            font-family: 'Monaco', monospace;
            font-size: 0.7rem;
            color: #64ffda;
            text-align: right;
        }
        
        .viz-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            height: 70vh;
        }
        
        .viz-panel {
            background: #0a0a12;
            border-radius: 8px;
            padding: 8px;
            border: 1px solid #2a2a4a;
            position: relative;
            overflow: hidden;
        }
        
        .viz-panel canvas {
            width: 100%;
            height: 100%;
        }
        
        .viz-title {
            position: absolute;
            top: 5px;
            left: 8px;
            font-size: 0.65rem;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 10;
            background: rgba(10,10,18,0.8);
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        #three-canvas {
            width: 100%;
            height: 100%;
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .params-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 6px;
            background: rgba(255,255,255,0.02);
            border-radius: 3px;
            font-size: 0.65rem;
        }
        
        .param-row input {
            width: 50px;
            height: 3px;
            -webkit-appearance: none;
            background: #2a2a4a;
            border-radius: 2px;
        }
        
        .param-row input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
        }
        
        .param-value {
            font-family: 'Monaco', monospace;
            color: #64ffda;
            font-size: 0.6rem;
            width: 25px;
            text-align: right;
        }
        
        .budget-section {
            background: rgba(255, 107, 107, 0.1);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid rgba(255, 107, 107, 0.2);
        }
        
        .budget-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 4px;
        }
        
        .budget-bar {
            height: 8px;
            background: #2a2a4a;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .budget-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #64ffda);
            transition: width 0.2s;
        }
        
        .budget-fill.over { background: linear-gradient(90deg, #ff4757, #ff6b6b); }
        
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            text-transform: uppercase;
        }
        
        .btn-primary { background: linear-gradient(135deg, #4ecdc4, #44a08d); color: #0f0f1a; }
        .btn-secondary { background: transparent; border: 1px solid #ffd93d !important; color: #ffd93d; }
        .btn-full { grid-column: span 2; }
        
        .optimal-display {
            background: rgba(255, 217, 61, 0.1);
            border: 1px solid rgba(255, 217, 61, 0.3);
            border-radius: 6px;
            padding: 8px;
            display: none;
        }
        
        .optimal-display.visible { display: block; }
        
        .optimal-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            font-size: 0.6rem;
        }
        
        .opt-item {
            background: #1a1a2e;
            padding: 3px;
            border-radius: 3px;
            text-align: center;
        }
        
        .opt-label { color: #8892b0; }
        .opt-val { color: #ffd93d; font-family: 'Monaco', monospace; }
        
        .equation-box {
            background: #1a1a2e;
            border-radius: 4px;
            padding: 6px;
            font-family: 'Monaco', monospace;
            font-size: 0.6rem;
            color: #ccd6f6;
            text-align: center;
        }
        
        .slice-section {
            background: rgba(155, 89, 182, 0.1);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid rgba(155, 89, 182, 0.2);
        }
        
        .slice-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        
        .slice-item {
            text-align: center;
            font-size: 0.6rem;
        }
        
        .slice-item input {
            width: 100%;
            height: 3px;
            -webkit-appearance: none;
            background: #2a2a4a;
            border-radius: 2px;
        }
        
        .slice-item input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #9b59b6;
        }
        
        .help-text {
            font-size: 0.6rem;
            color: #666;
            text-align: center;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåå 15-Dimensional Utility Maximization</h1>
        <p class="subtitle">Navigate a 15-good consumption space using multiple coordinated visualizations</p>
        
        <div class="top-bar">
            <div class="utility-display">
                <div class="utility-label">Total Utility</div>
                <div class="utility-value" id="utility-value">0.0</div>
            </div>
            <div class="status-badge affordable" id="status-badge">Within Budget</div>
            <div class="proximity-compact">
                <div class="prox-label">
                    <span>Proximity</span>
                    <span id="prox-pct">0%</span>
                </div>
                <div class="prox-bar">
                    <div class="prox-fill" id="prox-fill" style="width: 0%"></div>
                </div>
            </div>
            <div style="font-size: 0.7rem; color: #8892b0;">
                Optimal U*: <span id="opt-util" style="color: #ffd93d; font-family: Monaco;">0.0</span>
            </div>
        </div>
        
        <div class="main-grid">
            <div class="panel goods-panel">
                <div class="panel-title">
                    <span>üéØ 15 Goods (Quantities)</span>
                </div>
                <div id="goods-container"></div>
                
                <div class="budget-section" style="margin-top: 10px;">
                    <div class="budget-row">
                        <span>Budget</span>
                        <span id="budget-text">$0 / $200</span>
                    </div>
                    <div class="budget-bar">
                        <div class="budget-fill" id="budget-fill"></div>
                    </div>
                </div>
            </div>
            
            <div class="viz-container">
                <div class="viz-panel">
                    <div class="viz-title">3D Projection (Goods 1-3) + Color/Size (4-5)</div>
                    <div id="three-canvas"></div>
                </div>
                <div class="viz-panel">
                    <div class="viz-title">Parallel Coordinates (All 15 Goods)</div>
                    <canvas id="parallel-canvas"></canvas>
                </div>
                <div class="viz-panel">
                    <div class="viz-title">Radar Chart (Normalized)</div>
                    <canvas id="radar-canvas"></canvas>
                </div>
                <div class="viz-panel">
                    <div class="viz-title">2D Heatmap Grid (Goods vs Optimal)</div>
                    <canvas id="heatmap-canvas"></canvas>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="panel">
                    <div class="panel-title">Budget & Prices</div>
                    <div class="param-row" style="margin-bottom: 6px;">
                        <span>Income (M)</span>
                        <input type="range" id="income" min="100" max="500" value="200">
                        <span class="param-value" id="income-val">200</span>
                    </div>
                    <div class="params-grid" id="prices-container"></div>
                </div>
                
                <div class="panel">
                    <div class="panel-title">Preference Weights (Œ±‚ÇÅ...Œ±‚ÇÅ‚ÇÖ)</div>
                    <div class="params-grid" id="alphas-container"></div>
                    <div class="equation-box" style="margin-top: 6px;">
                        U = ‚àè·µ¢ Q·µ¢^Œ±·µ¢ where Œ£Œ±·µ¢ = 1
                    </div>
                </div>
                
                <div class="panel slice-section">
                    <div class="panel-title">4D+ Slice Controls</div>
                    <div class="slice-grid" id="slice-container"></div>
                    <div class="help-text">Fix dimensions 4-15 to view 3D slices</div>
                </div>
                
                <div class="panel">
                    <div class="btn-grid">
                        <button class="btn btn-primary" onclick="resetGame()">üîÑ New</button>
                        <button class="btn btn-secondary" onclick="toggleOptimal()">üí° Optimal</button>
                        <button class="btn btn-primary btn-full" onclick="autoSolve()">üéØ Auto-Solve</button>
                    </div>
                    
                    <div class="optimal-display" id="optimal-display">
                        <div class="panel-title" style="color: #ffd93d;">Optimal Bundle (Q*)</div>
                        <div class="optimal-grid" id="optimal-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const N = 15;
        const goodNames = ['Food', 'Housing', 'Transport', 'Health', 'Education', 
                          'Entertainment', 'Clothing', 'Tech', 'Travel', 'Savings',
                          'Fitness', 'Beauty', 'Hobbies', 'Social', 'Luxury'];
        const goodColors = [
            '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
            '#dfe6e9', '#fd79a8', '#a29bfe', '#6c5ce7', '#00b894',
            '#e17055', '#74b9ff', '#55efc4', '#ffeaa7', '#fab1a0'
        ];
        
        // State
        let quantities = Array(N).fill(8);
        let prices = Array(N).fill(2);
        let alphas = Array(N).fill(1/N);
        let sliceValues = Array(N).fill(8);
        let income = 200;
        let showOptimal = false;
        
        // Three.js
        let scene, camera, renderer, userPoint, optPoint, budgetMesh;
        
        function init() {
            createGoodsUI();
            createPricesUI();
            createAlphasUI();
            createSlicesUI();
            initThreeJS();
            updateAll();
            animate();
        }
        
        function createGoodsUI() {
            const container = document.getElementById('goods-container');
            for (let i = 0; i < N; i++) {
                const row = document.createElement('div');
                row.className = 'good-row';
                row.innerHTML = `
                    <div class="good-name">
                        <div class="good-color" style="background: ${goodColors[i]}"></div>
                        Q${i+1}
                    </div>
                    <input type="range" id="q${i}" min="0" max="30" value="${quantities[i]}" step="0.5">
                    <div class="good-value" id="qv${i}">${quantities[i]}</div>
                `;
                container.appendChild(row);
                document.getElementById(`q${i}`).addEventListener('input', (e) => {
                    quantities[i] = parseFloat(e.target.value);
                    document.getElementById(`qv${i}`).textContent = quantities[i].toFixed(1);
                    updateAll();
                });
            }
        }
        
        function createPricesUI() {
            const container = document.getElementById('prices-container');
            for (let i = 0; i < N; i++) {
                const row = document.createElement('div');
                row.className = 'param-row';
                row.innerHTML = `
                    <span style="color: ${goodColors[i]}">P${i+1}</span>
                    <input type="range" id="p${i}" min="0.5" max="5" value="${prices[i]}" step="0.25">
                    <span class="param-value" id="pv${i}">${prices[i]}</span>
                `;
                container.appendChild(row);
                document.getElementById(`p${i}`).addEventListener('input', (e) => {
                    prices[i] = parseFloat(e.target.value);
                    document.getElementById(`pv${i}`).textContent = prices[i].toFixed(1);
                    updateAll();
                });
            }
        }
        
        function createAlphasUI() {
            const container = document.getElementById('alphas-container');
            for (let i = 0; i < N; i++) {
                const row = document.createElement('div');
                row.className = 'param-row';
                row.innerHTML = `
                    <span style="color: ${goodColors[i]}">Œ±${i+1}</span>
                    <input type="range" id="a${i}" min="0.02" max="0.2" value="${alphas[i].toFixed(3)}" step="0.005">
                    <span class="param-value" id="av${i}">${alphas[i].toFixed(2)}</span>
                `;
                container.appendChild(row);
                document.getElementById(`a${i}`).addEventListener('input', (e) => {
                    alphas[i] = parseFloat(e.target.value);
                    // Renormalize
                    const sum = alphas.reduce((a,b) => a+b, 0);
                    alphas = alphas.map(a => a / sum);
                    for (let j = 0; j < N; j++) {
                        document.getElementById(`av${j}`).textContent = alphas[j].toFixed(2);
                        document.getElementById(`a${j}`).value = alphas[j];
                    }
                    updateAll();
                });
            }
        }
        
        function createSlicesUI() {
            const container = document.getElementById('slice-container');
            for (let i = 3; i < N; i++) {
                const item = document.createElement('div');
                item.className = 'slice-item';
                item.innerHTML = `
                    <div style="color: ${goodColors[i]}">D${i+1}=${sliceValues[i].toFixed(0)}</div>
                    <input type="range" id="sl${i}" min="1" max="25" value="${sliceValues[i]}">
                `;
                container.appendChild(item);
                document.getElementById(`sl${i}`).addEventListener('input', (e) => {
                    sliceValues[i] = parseFloat(e.target.value);
                    item.querySelector('div').textContent = `D${i+1}=${sliceValues[i].toFixed(0)}`;
                    updateAll();
                });
            }
        }
        
        function initThreeJS() {
            const container = document.getElementById('three-canvas');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a12);
            
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(40, 30, 40);
            camera.lookAt(15, 15, 15);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // Controls
            let drag = false, prev = {x:0, y:0};
            let sph = { theta: Math.PI/4, phi: Math.PI/3, r: 55 };
            
            function updCam() {
                camera.position.set(
                    sph.r * Math.sin(sph.phi) * Math.cos(sph.theta) + 15,
                    sph.r * Math.cos(sph.phi) + 15,
                    sph.r * Math.sin(sph.phi) * Math.sin(sph.theta) + 15
                );
                camera.lookAt(15, 15, 15);
            }
            
            renderer.domElement.addEventListener('mousedown', e => { drag = true; prev = {x: e.clientX, y: e.clientY}; });
            renderer.domElement.addEventListener('mousemove', e => {
                if (!drag) return;
                sph.theta -= (e.clientX - prev.x) * 0.01;
                sph.phi = Math.max(0.1, Math.min(Math.PI-0.1, sph.phi - (e.clientY - prev.y) * 0.01));
                prev = {x: e.clientX, y: e.clientY};
                updCam();
            });
            renderer.domElement.addEventListener('mouseup', () => drag = false);
            renderer.domElement.addEventListener('mouseleave', () => drag = false);
            renderer.domElement.addEventListener('wheel', e => {
                e.preventDefault();
                sph.r = Math.max(20, Math.min(100, sph.r + e.deltaY * 0.05));
                updCam();
            });
            
            updCam();
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const dir = new THREE.DirectionalLight(0xffffff, 0.8);
            dir.position.set(30, 50, 30);
            scene.add(dir);
            
            // Axes
            [[30,0,0,0xff6b6b], [0,30,0,0x4ecdc4], [0,0,30,0x45b7d1]].forEach(([x,y,z,c]) => {
                const g = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(x,y,z)]);
                scene.add(new THREE.Line(g, new THREE.LineBasicMaterial({color: c})));
            });
            
            const grid = new THREE.GridHelper(30, 6, 0x2a2a4a, 0x1a1a2e);
            grid.position.set(15, 0, 15);
            scene.add(grid);
        }
        
        function calcOptimal() {
            const opt = alphas.map((a, i) => (a * income) / prices[i]);
            const util = opt.reduce((u, q, i) => u * Math.pow(Math.max(q, 0.01), alphas[i]), 1);
            return { opt, util };
        }
        
        function calcUtility(qs) {
            return qs.reduce((u, q, i) => u * Math.pow(Math.max(q, 0.01), alphas[i]), 1);
        }
        
        function calcSpending(qs) {
            return qs.reduce((s, q, i) => s + q * prices[i], 0);
        }
        
        function updateAll() {
            income = parseFloat(document.getElementById('income').value);
            document.getElementById('income-val').textContent = income;
            
            const spending = calcSpending(quantities);
            const affordable = spending <= income * 1.001;
            const userUtil = calcUtility(quantities);
            const { opt, util: optUtil } = calcOptimal();
            const nearOpt = affordable && Math.abs(userUtil - optUtil) / optUtil < 0.05;
            
            // Update UI
            const utilEl = document.getElementById('utility-value');
            utilEl.textContent = affordable ? userUtil.toFixed(1) : '‚Äî';
            utilEl.className = 'utility-value' + (!affordable ? ' infeasible' : (nearOpt ? ' optimal' : ''));
            
            const badge = document.getElementById('status-badge');
            if (!affordable) {
                badge.className = 'status-badge over';
                badge.textContent = '‚ö†Ô∏è Over Budget!';
            } else if (nearOpt) {
                badge.className = 'status-badge optimal';
                badge.textContent = 'üéâ Optimal!';
            } else {
                badge.className = 'status-badge affordable';
                badge.textContent = '‚úì Within Budget';
            }
            
            const prox = affordable ? Math.min(100, (userUtil / optUtil) * 100) : 0;
            document.getElementById('prox-pct').textContent = `${prox.toFixed(0)}%`;
            document.getElementById('prox-fill').style.width = `${prox}%`;
            document.getElementById('opt-util').textContent = optUtil.toFixed(1);
            
            document.getElementById('budget-text').textContent = `$${spending.toFixed(0)} / $${income}`;
            const budgetFill = document.getElementById('budget-fill');
            budgetFill.style.width = `${Math.min(100, (spending/income)*100)}%`;
            budgetFill.className = 'budget-fill' + (!affordable ? ' over' : '');
            
            // Optimal display
            if (showOptimal) {
                const grid = document.getElementById('optimal-grid');
                grid.innerHTML = opt.map((v, i) => `
                    <div class="opt-item">
                        <div class="opt-label" style="color:${goodColors[i]}">Q${i+1}*</div>
                        <div class="opt-val">${v.toFixed(1)}</div>
                    </div>
                `).join('');
            }
            
            update3D(quantities, opt, affordable, nearOpt);
            drawParallel(quantities, opt, affordable);
            drawRadar(quantities, opt, affordable);
            drawHeatmap(quantities, opt, affordable);
        }
        
        function update3D(qs, opt, affordable, nearOpt) {
            // Remove old points
            if (userPoint) { scene.remove(userPoint); userPoint.geometry.dispose(); userPoint.material.dispose(); }
            if (optPoint) { scene.remove(optPoint); optPoint.geometry.dispose(); optPoint.material.dispose(); }
            
            // Map dims 1-3 to position, 4 to color, 5 to size
            const x = qs[0], y = qs[1], z = qs[2];
            const colorVal = qs[3] / 30;
            const sizeVal = 0.5 + (qs[4] / 30) * 1.5;
            
            const col = new THREE.Color().setHSL(colorVal * 0.8, 0.7, 0.5);
            const finalCol = affordable ? (nearOpt ? new THREE.Color(0xffd93d) : col) : new THREE.Color(0xff4757);
            
            userPoint = new THREE.Mesh(
                new THREE.SphereGeometry(sizeVal, 32, 32),
                new THREE.MeshPhongMaterial({ color: finalCol, emissive: finalCol, emissiveIntensity: 0.3 })
            );
            userPoint.position.set(x, y, z);
            scene.add(userPoint);
            
            // Add rings for higher dimensions
            for (let i = 5; i < 8 && i < N; i++) {
                const ringSize = sizeVal + 0.3 * (i - 4);
                const ring = new THREE.Mesh(
                    new THREE.TorusGeometry(ringSize, 0.05, 8, 32),
                    new THREE.MeshBasicMaterial({ color: goodColors[i], transparent: true, opacity: 0.5 })
                );
                ring.rotation.x = Math.PI / 2 * (i % 3);
                ring.rotation.y = Math.PI / 4 * (i % 2);
                userPoint.add(ring);
            }
            
            if (showOptimal) {
                const ox = opt[0], oy = opt[1], oz = opt[2];
                const osize = 0.5 + (opt[4] / 30) * 1.5;
                optPoint = new THREE.Mesh(
                    new THREE.SphereGeometry(osize * 0.8, 32, 32),
                    new THREE.MeshPhongMaterial({ color: 0xffd93d, emissive: 0xffd93d, emissiveIntensity: 0.5 })
                );
                optPoint.position.set(ox, oy, oz);
                scene.add(optPoint);
            }
        }
        
        function drawParallel(qs, opt, affordable) {
            const canvas = document.getElementById('parallel-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const w = canvas.offsetWidth, h = canvas.offsetHeight;
            ctx.fillStyle = '#0a0a12';
            ctx.fillRect(0, 0, w, h);
            
            const margin = { l: 25, r: 15, t: 25, b: 20 };
            const plotW = w - margin.l - margin.r;
            const plotH = h - margin.t - margin.b;
            
            // Axes
            ctx.strokeStyle = '#2a2a4a';
            ctx.lineWidth = 1;
            for (let i = 0; i < N; i++) {
                const x = margin.l + (i / (N-1)) * plotW;
                ctx.beginPath();
                ctx.moveTo(x, margin.t);
                ctx.lineTo(x, margin.t + plotH);
                ctx.stroke();
                
                ctx.fillStyle = goodColors[i];
                ctx.font = '8px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`Q${i+1}`, x, margin.t + plotH + 12);
            }
            
            // Optimal line
            if (showOptimal) {
                ctx.strokeStyle = 'rgba(255, 217, 61, 0.6)';
                ctx.lineWidth = 2;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                for (let i = 0; i < N; i++) {
                    const x = margin.l + (i / (N-1)) * plotW;
                    const y = margin.t + plotH - (opt[i] / 30) * plotH;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                ctx.setLineDash([]);
            }
            
            // User line
            ctx.strokeStyle = affordable ? '#4ecdc4' : '#ff4757';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < N; i++) {
                const x = margin.l + (i / (N-1)) * plotW;
                const y = margin.t + plotH - (qs[i] / 30) * plotH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Points
            for (let i = 0; i < N; i++) {
                const x = margin.l + (i / (N-1)) * plotW;
                const y = margin.t + plotH - (qs[i] / 30) * plotH;
                ctx.fillStyle = goodColors[i];
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function drawRadar(qs, opt, affordable) {
            const canvas = document.getElementById('radar-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const w = canvas.offsetWidth, h = canvas.offsetHeight;
            ctx.fillStyle = '#0a0a12';
            ctx.fillRect(0, 0, w, h);
            
            const cx = w / 2, cy = h / 2;
            const r = Math.min(w, h) / 2 - 30;
            
            // Grid
            ctx.strokeStyle = '#2a2a4a';
            ctx.lineWidth = 0.5;
            for (let ring = 1; ring <= 4; ring++) {
                ctx.beginPath();
                ctx.arc(cx, cy, r * ring / 4, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Axes
            for (let i = 0; i < N; i++) {
                const angle = (i / N) * Math.PI * 2 - Math.PI / 2;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                ctx.strokeStyle = goodColors[i];
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Label
                const lx = cx + Math.cos(angle) * (r + 12);
                const ly = cy + Math.sin(angle) * (r + 12);
                ctx.fillStyle = goodColors[i];
                ctx.font = '7px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${i+1}`, lx, ly);
            }
            
            // Optimal polygon
            if (showOptimal) {
                ctx.fillStyle = 'rgba(255, 217, 61, 0.15)';
                ctx.strokeStyle = 'rgba(255, 217, 61, 0.6)';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                for (let i = 0; i < N; i++) {
                    const angle = (i / N) * Math.PI * 2 - Math.PI / 2;
                    const val = Math.min(opt[i] / 30, 1);
                    const x = cx + Math.cos(angle) * r * val;
                    const y = cy + Math.sin(angle) * r * val;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            
            // User polygon
            ctx.fillStyle = affordable ? 'rgba(78, 205, 196, 0.2)' : 'rgba(255, 71, 87, 0.2)';
            ctx.strokeStyle = affordable ? '#4ecdc4' : '#ff4757';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < N; i++) {
                const angle = (i / N) * Math.PI * 2 - Math.PI / 2;
                const val = Math.min(qs[i] / 30, 1);
                const x = cx + Math.cos(angle) * r * val;
                const y = cy + Math.sin(angle) * r * val;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        
        function drawHeatmap(qs, opt, affordable) {
            const canvas = document.getElementById('heatmap-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            ctx.scale(2, 2);
            
            const w = canvas.offsetWidth, h = canvas.offsetHeight;
            ctx.fillStyle = '#0a0a12';
            ctx.fillRect(0, 0, w, h);
            
            const margin = { l: 25, r: 10, t: 20, b: 25 };
            const plotW = w - margin.l - margin.r;
            const plotH = h - margin.t - margin.b;
            const cellW = plotW / N;
            const cellH = plotH / 3;
            
            // Row labels
            ctx.fillStyle = '#8892b0';
            ctx.font = '8px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText('You', margin.l - 5, margin.t + cellH * 0.5 + 3);
            ctx.fillText('Opt', margin.l - 5, margin.t + cellH * 1.5 + 3);
            ctx.fillText('Diff', margin.l - 5, margin.t + cellH * 2.5 + 3);
            
            for (let i = 0; i < N; i++) {
                const x = margin.l + i * cellW;
                
                // User row
                const userNorm = qs[i] / 30;
                ctx.fillStyle = goodColors[i];
                ctx.globalAlpha = 0.2 + userNorm * 0.8;
                ctx.fillRect(x + 1, margin.t + 1, cellW - 2, cellH - 2);
                ctx.globalAlpha = 1;
                
                // Optimal row
                const optNorm = opt[i] / 30;
                ctx.fillStyle = '#ffd93d';
                ctx.globalAlpha = 0.2 + optNorm * 0.8;
                ctx.fillRect(x + 1, margin.t + cellH + 1, cellW - 2, cellH - 2);
                ctx.globalAlpha = 1;
                
                // Difference row
                const diff = (qs[i] - opt[i]) / 30;
                if (diff > 0) {
                    ctx.fillStyle = '#ff6b6b';
                    ctx.globalAlpha = Math.min(Math.abs(diff) * 2, 1);
                } else {
                    ctx.fillStyle = '#4ecdc4';
                    ctx.globalAlpha = Math.min(Math.abs(diff) * 2, 1);
                }
                ctx.fillRect(x + 1, margin.t + cellH * 2 + 1, cellW - 2, cellH - 2);
                ctx.globalAlpha = 1;
                
                // Column label
                ctx.fillStyle = goodColors[i];
                ctx.font = '7px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${i+1}`, x + cellW/2, margin.t + plotH + 12);
            }
            
            // Legend
            ctx.font = '7px sans-serif';
            ctx.fillStyle = '#ff6b6b';
            ctx.fillText('Over', w - 40, margin.t + 10);
            ctx.fillStyle = '#4ecdc4';
            ctx.fillText('Under', w - 40, margin.t + 22);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        
        function resetGame() {
            income = 100 + Math.random() * 200;
            document.getElementById('income').value = income;
            
            prices = Array(N).fill(0).map(() => 1 + Math.random() * 3);
            alphas = Array(N).fill(0).map(() => 0.5 + Math.random());
            const sum = alphas.reduce((a,b) => a+b, 0);
            alphas = alphas.map(a => a / sum);
            
            quantities = Array(N).fill(0).map(() => 3 + Math.random() * 12);
            
            // Update UI
            for (let i = 0; i < N; i++) {
                document.getElementById(`q${i}`).value = quantities[i];
                document.getElementById(`qv${i}`).textContent = quantities[i].toFixed(1);
                document.getElementById(`p${i}`).value = prices[i];
                document.getElementById(`pv${i}`).textContent = prices[i].toFixed(1);
                document.getElementById(`a${i}`).value = alphas[i];
                document.getElementById(`av${i}`).textContent = alphas[i].toFixed(2);
            }
            
            showOptimal = false;
            document.getElementById('optimal-display').classList.remove('visible');
            updateAll();
        }
        
        function toggleOptimal() {
            showOptimal = !showOptimal;
            document.getElementById('optimal-display').classList.toggle('visible', showOptimal);
            updateAll();
        }
        
        function autoSolve() {
            const { opt } = calcOptimal();
            quantities = [...opt];
            for (let i = 0; i < N; i++) {
                document.getElementById(`q${i}`).value = quantities[i];
                document.getElementById(`qv${i}`).textContent = quantities[i].toFixed(1);
            }
            updateAll();
        }
        
        document.getElementById('income').addEventListener('input', updateAll);
        
        window.addEventListener('resize', () => {
            const container = document.getElementById('three-canvas');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
            updateAll();
        });
        
        init();
    </script>
</body>
</html>
