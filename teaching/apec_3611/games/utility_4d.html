<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4D Utility Maximization</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1500px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            font-weight: 300;
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .subtitle {
            text-align: center;
            color: #8892b0;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .graph-container {
            background: #0f0f1a;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2a2a4a;
            position: relative;
            min-height: 600px;
        }
        
        #three-canvas {
            width: 100%;
            height: 550px;
            border-radius: 8px;
        }
        
        .utility-display {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }
        
        .utility-label {
            font-size: 1rem;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
        }
        
        .utility-value {
            font-size: 4rem;
            font-weight: 700;
            font-family: 'Monaco', monospace;
            color: #4ecdc4;
            text-shadow: 0 0 30px rgba(78, 205, 196, 0.5);
            transition: all 0.1s ease;
        }
        
        .utility-value.infeasible {
            color: #ff4757;
            text-shadow: 0 0 30px rgba(255, 71, 87, 0.5);
        }
        
        .utility-value.optimal {
            color: #ffd93d;
            text-shadow: 0 0 40px rgba(255, 217, 61, 0.7);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(-50%); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(calc(-50% - 5px)); }
            20%, 40%, 60%, 80% { transform: translateX(calc(-50% + 5px)); }
        }
        
        .error-banner {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff4757 0%, #c0392b 100%);
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 20px rgba(255, 71, 87, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        
        .error-banner.visible {
            opacity: 1;
            animation: shake 0.5s ease-in-out;
        }
        
        .success-banner {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffd93d 0%, #f39c12 100%);
            color: #1a1a2e;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 20px rgba(255, 217, 61, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        
        .success-banner.visible {
            opacity: 1;
        }
        
        .dimension-explanation {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #ccd6f6;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .dim-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .dim-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .w-gradient {
            width: 60px;
            height: 12px;
            border-radius: 2px;
            background: linear-gradient(90deg, #3498db 0%, #9b59b6 50%, #e74c3c 100%);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: 92vh;
            overflow-y: auto;
        }
        
        .control-panel {
            background: #0f0f1a;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #2a2a4a;
        }
        
        .control-panel.choice-panel {
            border: 2px solid #4ecdc4;
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.05) 0%, #0f0f1a 100%);
        }
        
        .panel-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8892b0;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .panel-title.highlight {
            color: #4ecdc4;
            font-size: 0.9rem;
        }
        
        .goods-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .slider-group {
            margin-bottom: 12px;
        }
        
        .slider-group:last-child {
            margin-bottom: 0;
        }
        
        .slider-group.compact {
            margin-bottom: 8px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }
        
        .slider-value {
            background: #1a1a2e;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', monospace;
            font-size: 0.75rem;
            color: #64ffda;
        }
        
        .slider-value.large {
            font-size: 0.95rem;
            padding: 4px 10px;
            color: #4ecdc4;
        }
        
        .good-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .good-indicator {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 3px;
            background: #2a2a4a;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(100, 255, 218, 0.3);
        }
        
        input[type="range"].choice-slider {
            height: 7px;
        }
        
        input[type="range"].choice-slider::-webkit-slider-thumb {
            width: 18px;
            height: 18px;
            background: #4ecdc4;
        }
        
        .budget-bar {
            margin-top: 12px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 8px;
        }
        
        .budget-label {
            font-size: 0.7rem;
            color: #8892b0;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .budget-label .over {
            color: #ff4757;
            font-weight: 600;
        }
        
        .budget-track {
            height: 8px;
            background: #2a2a4a;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .budget-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4 0%, #64ffda 100%);
            border-radius: 4px;
            transition: width 0.15s ease, background 0.15s ease;
        }
        
        .budget-fill.over {
            background: linear-gradient(90deg, #ff4757 0%, #ff6b6b 100%);
        }
        
        .score-panel {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .score-label {
            font-size: 0.7rem;
            color: #8892b0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .score-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #ffd93d;
            font-family: 'Monaco', monospace;
        }
        
        .score-optimal {
            font-size: 0.75rem;
            color: #64ffda;
            margin-top: 3px;
        }
        
        .proximity-meter {
            margin-top: 8px;
            padding: 8px;
            background: #1a1a2e;
            border-radius: 8px;
        }
        
        .proximity-label {
            font-size: 0.7rem;
            color: #8892b0;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .proximity-bar {
            height: 5px;
            background: #2a2a4a;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .proximity-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757 0%, #ffd93d 50%, #4ecdc4 100%);
            border-radius: 3px;
            transition: width 0.1s ease;
        }
        
        .btn {
            width: 100%;
            padding: 9px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: #0f0f1a;
        }
        
        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.4);
        }
        
        .hint-btn {
            background: transparent;
            border: 2px solid #ffd93d !important;
            color: #ffd93d;
            margin-top: 6px;
        }
        
        .hint-btn:hover {
            background: rgba(255, 217, 61, 0.1);
        }
        
        .equation-box {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 8px 12px;
            font-family: 'Monaco', monospace;
            font-size: 0.7rem;
            color: #ccd6f6;
            text-align: center;
            margin-top: 8px;
        }
        
        .w-slider-container {
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.1) 0%, rgba(231, 76, 60, 0.05) 100%);
            border-radius: 8px;
            border: 1px solid rgba(155, 89, 182, 0.3);
        }
        
        .w-slider-container .slider-label {
            color: #bb8fce;
        }
        
        .w-slider-container input[type="range"].choice-slider::-webkit-slider-thumb {
            background: linear-gradient(135deg, #9b59b6 0%, #e74c3c 100%);
        }
        
        .slice-info {
            background: rgba(155, 89, 182, 0.15);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #bb8fce;
            text-align: center;
        }
        
        .preferences-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .gamma-display {
            background: #1a1a2e;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            margin-top: 8px;
        }
        
        .gamma-label {
            font-size: 0.7rem;
            color: #8892b0;
        }
        
        .gamma-value {
            font-family: 'Monaco', monospace;
            color: #64ffda;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ 4D Utility Maximization</h1>
        <p class="subtitle">4 goods visualized: X, Y, Z in space + W as color intensity. Find the optimal 4D bundle!</p>
        
        <div class="main-content">
            <div class="graph-container">
                <div class="utility-display">
                    <div class="utility-label">Total Utility</div>
                    <div class="utility-value" id="big-utility">0.0</div>
                </div>
                <div class="error-banner" id="error-banner">
                    ‚ö†Ô∏è UNAFFORDABLE! Over Budget!
                </div>
                <div class="success-banner" id="success-banner">
                    üéâ OPTIMAL! Maximum Utility!
                </div>
                <div id="three-canvas"></div>
                <div class="dimension-explanation">
                    <div class="dim-item"><div class="dim-color" style="background: #ff6b6b;"></div> X-axis</div>
                    <div class="dim-item"><div class="dim-color" style="background: #6bff6b;"></div> Y-axis</div>
                    <div class="dim-item"><div class="dim-color" style="background: #6b6bff;"></div> Z-axis</div>
                    <div class="dim-item"><div class="w-gradient"></div> W (4th dim)</div>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-panel choice-panel">
                    <div class="panel-title highlight">üéØ Your 4D Bundle</div>
                    
                    <div class="goods-grid">
                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="good-label"><div class="good-indicator" style="background: #ff6b6b;"></div> Good X</span>
                                <span class="slider-value large" id="user-x-value">10</span>
                            </div>
                            <input type="range" class="choice-slider" id="user-x" min="0" max="40" value="10" step="0.5">
                        </div>
                        
                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="good-label"><div class="good-indicator" style="background: #6bff6b;"></div> Good Y</span>
                                <span class="slider-value large" id="user-y-value">10</span>
                            </div>
                            <input type="range" class="choice-slider" id="user-y" min="0" max="40" value="10" step="0.5">
                        </div>
                        
                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="good-label"><div class="good-indicator" style="background: #6b6bff;"></div> Good Z</span>
                                <span class="slider-value large" id="user-z-value">10</span>
                            </div>
                            <input type="range" class="choice-slider" id="user-z" min="0" max="40" value="10" step="0.5">
                        </div>
                        
                        <div class="slider-group">
                            <div class="slider-label">
                                <span class="good-label"><div class="good-indicator" style="background: linear-gradient(90deg, #9b59b6, #e74c3c);"></div> Good W</span>
                                <span class="slider-value large" id="user-w-value">10</span>
                            </div>
                            <input type="range" class="choice-slider" id="user-w" min="0" max="40" value="10" step="0.5">
                        </div>
                    </div>
                    
                    <div class="w-slider-container">
                        <div class="slider-label">
                            <span>W Slice View (4th dimension)</span>
                            <span class="slider-value" id="w-slice-value">10</span>
                        </div>
                        <input type="range" class="choice-slider" id="w-slice" min="1" max="40" value="10" step="1">
                        <div class="slice-info">
                            Viewing 3D slice where W = <span id="w-slice-display">10</span>
                        </div>
                    </div>
                    
                    <div class="budget-bar">
                        <div class="budget-label">
                            <span>Budget Used</span>
                            <span id="budget-status">$80 / $100</span>
                        </div>
                        <div class="budget-track">
                            <div class="budget-fill" id="budget-fill" style="width: 80%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="control-panel">
                    <div class="panel-title">Your Score</div>
                    <div class="score-panel">
                        <div class="score-label">Current Utility</div>
                        <div class="score-value" id="score-value">0.0</div>
                        <div class="score-optimal">Optimal: <span id="optimal-utility">??.?</span></div>
                    </div>
                    
                    <div class="proximity-meter">
                        <div class="proximity-label">
                            <span>Proximity to Optimal</span>
                            <span id="proximity-pct">0%</span>
                        </div>
                        <div class="proximity-bar">
                            <div class="proximity-fill" id="proximity-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <button class="btn reset-btn" onclick="resetGame()">üîÑ New Challenge</button>
                    <button class="btn hint-btn" onclick="toggleHint()">üí° Show Optimal</button>
                </div>
                
                <div class="control-panel">
                    <div class="panel-title">Budget Constraint</div>
                    
                    <div class="goods-grid">
                        <div class="slider-group compact">
                            <div class="slider-label">
                                <span>Income (M)</span>
                                <span class="slider-value" id="income-value">100</span>
                            </div>
                            <input type="range" id="income" min="50" max="200" value="100">
                        </div>
                        
                        <div class="slider-group compact">
                            <div class="slider-label">
                                <span>P‚Çì</span>
                                <span class="slider-value" id="px-value">2</span>
                            </div>
                            <input type="range" id="px" min="1" max="6" value="2" step="0.5">
                        </div>
                        
                        <div class="slider-group compact">
                            <div class="slider-label">
                                <span>P·µß</span>
                                <span class="slider-value" id="py-value">2</span>
                            </div>
                            <input type="range" id="py" min="1" max="6" value="2" step="0.5">
                        </div>
                        
                        <div class="slider-group compact">
                            <div class="slider-label">
                                <span>P_z</span>
                                <span class="slider-value" id="pz-value">2</span>
                            </div>
                            <input type="range" id="pz" min="1" max="6" value="2" step="0.5">
                        </div>
                        
                        <div class="slider-group compact">
                            <div class="slider-label">
                                <span>P_w</span>
                                <span class="slider-value" id="pw-value">2</span>
                            </div>
                            <input type="range" id="pw" min="1" max="6" value="2" step="0.5">
                        </div>
                    </div>
                    
                    <div class="equation-box">
                        P‚Çì¬∑X + P·µß¬∑Y + P_z¬∑Z + P_w¬∑W ‚â§ M
                    </div>
                </div>
                
                <div class="control-panel">
                    <div class="panel-title">Preferences (4-Good Cobb-Douglas)</div>
                    
                    <div class="preferences-grid">
                        <div class="slider-group compact">
                            <div class="slider-label">
                                <span>Œ± (X)</span>
                                <span class="slider-value" id="alpha-value">0.25</span>
                            </div>
                            <input type="range" id="alpha" min="0.1" max="0.4" value="0.25" step="0.01">
                        </div>
                        
                        <div class="slider-group compact">
                            <div class="slider-label">
                                <span>Œ≤ (Y)</span>
                                <span class="slider-value" id="beta-value">0.25</span>
                            </div>
                            <input type="range" id="beta" min="0.1" max="0.4" value="0.25" step="0.01">
                        </div>
                        
                        <div class="slider-group compact">
                            <div class="slider-label">
                                <span>Œ≥ (Z)</span>
                                <span class="slider-value" id="gamma-value">0.25</span>
                            </div>
                            <input type="range" id="gamma" min="0.1" max="0.4" value="0.25" step="0.01">
                        </div>
                    </div>
                    
                    <div class="gamma-display">
                        <span class="gamma-label">Œ¥ (W) = 1 - Œ± - Œ≤ - Œ≥ = </span>
                        <span class="gamma-value" id="delta-value">0.25</span>
                    </div>
                    
                    <div class="equation-box">
                        U = X<sup>Œ±</sup> ¬∑ Y<sup>Œ≤</sup> ¬∑ Z<sup>Œ≥</sup> ¬∑ W<sup>Œ¥</sup>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Three.js setup
        let scene, camera, renderer;
        let budgetMesh, indifferenceMesh, userPoint, optimalPoint;
        let pointCloud;
        let showOptimal = false;
        let wasAffordable = true;
        
        const container = document.getElementById('three-canvas');
        
        // Sliders
        const userXSlider = document.getElementById('user-x');
        const userYSlider = document.getElementById('user-y');
        const userZSlider = document.getElementById('user-z');
        const userWSlider = document.getElementById('user-w');
        const wSliceSlider = document.getElementById('w-slice');
        const incomeSlider = document.getElementById('income');
        const pxSlider = document.getElementById('px');
        const pySlider = document.getElementById('py');
        const pzSlider = document.getElementById('pz');
        const pwSlider = document.getElementById('pw');
        const alphaSlider = document.getElementById('alpha');
        const betaSlider = document.getElementById('beta');
        const gammaSlider = document.getElementById('gamma');
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f0f1a);
            
            camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(60, 45, 60);
            camera.lookAt(20, 20, 20);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            
            // Orbit controls
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            let spherical = { theta: Math.PI / 4, phi: Math.PI / 3, radius: 85 };
            
            function updateCamera() {
                camera.position.x = spherical.radius * Math.sin(spherical.phi) * Math.cos(spherical.theta) + 20;
                camera.position.y = spherical.radius * Math.cos(spherical.phi) + 20;
                camera.position.z = spherical.radius * Math.sin(spherical.phi) * Math.sin(spherical.theta) + 20;
                camera.lookAt(20, 20, 20);
            }
            
            renderer.domElement.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            renderer.domElement.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                spherical.theta -= deltaX * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi - deltaY * 0.01));
                previousMousePosition = { x: e.clientX, y: e.clientY };
                updateCamera();
            });
            
            renderer.domElement.addEventListener('mouseup', () => isDragging = false);
            renderer.domElement.addEventListener('mouseleave', () => isDragging = false);
            
            renderer.domElement.addEventListener('wheel', (e) => {
                e.preventDefault();
                spherical.radius = Math.max(30, Math.min(150, spherical.radius + e.deltaY * 0.1));
                updateCamera();
            });
            
            // Touch
            renderer.domElement.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isDragging = true;
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });
            
            renderer.domElement.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length !== 1) return;
                e.preventDefault();
                const deltaX = e.touches[0].clientX - previousMousePosition.x;
                const deltaY = e.touches[0].clientY - previousMousePosition.y;
                spherical.theta -= deltaX * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi - deltaY * 0.01));
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                updateCamera();
            }, { passive: false });
            
            renderer.domElement.addEventListener('touchend', () => isDragging = false);
            
            updateCamera();
            
            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            scene.add(dirLight);
            
            createAxes();
            updateVisualization();
            animate();
        }
        
        function createAxes() {
            const axisLength = 45;
            
            // X axis
            const xGeom = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(axisLength, 0, 0)
            ]);
            scene.add(new THREE.Line(xGeom, new THREE.LineBasicMaterial({ color: 0xff6b6b })));
            
            // Y axis (up)
            const yGeom = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(0, axisLength, 0)
            ]);
            scene.add(new THREE.Line(yGeom, new THREE.LineBasicMaterial({ color: 0x6bff6b })));
            
            // Z axis
            const zGeom = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(0, 0, axisLength)
            ]);
            scene.add(new THREE.Line(zGeom, new THREE.LineBasicMaterial({ color: 0x6b6bff })));
            
            // Grid
            const grid = new THREE.GridHelper(40, 8, 0x2a2a4a, 0x1a1a2e);
            grid.position.set(20, 0, 20);
            scene.add(grid);
        }
        
        function getWColor(w, maxW) {
            // Blue -> Purple -> Red gradient for W dimension
            const t = Math.min(w / maxW, 1);
            const r = Math.floor(52 + t * 179);  // 52 -> 231
            const g = Math.floor(152 - t * 76);   // 152 -> 76
            const b = Math.floor(219 - t * 155);  // 219 -> 64
            return new THREE.Color(`rgb(${r}, ${g}, ${b})`);
        }
        
        function calculateOptimal(M, Px, Py, Pz, Pw, alpha, beta, gamma) {
            const delta = 1 - alpha - beta - gamma;
            if (delta <= 0.01) return { xStar: 0, yStar: 0, zStar: 0, wStar: 0, utility: 0 };
            
            const xStar = (alpha * M) / Px;
            const yStar = (beta * M) / Py;
            const zStar = (gamma * M) / Pz;
            const wStar = (delta * M) / Pw;
            const utility = Math.pow(xStar, alpha) * Math.pow(yStar, beta) * Math.pow(zStar, gamma) * Math.pow(wStar, delta);
            
            return { xStar, yStar, zStar, wStar, utility };
        }
        
        function calculateUtility(x, y, z, w, alpha, beta, gamma) {
            const delta = 1 - alpha - beta - gamma;
            if (x <= 0 || y <= 0 || z <= 0 || w <= 0 || delta <= 0.01) return 0;
            return Math.pow(x, alpha) * Math.pow(y, beta) * Math.pow(z, gamma) * Math.pow(w, delta);
        }
        
        function createBudgetSlice(M, Px, Py, Pz, Pw, wSlice) {
            if (budgetMesh) {
                scene.remove(budgetMesh);
                budgetMesh.geometry.dispose();
                budgetMesh.material.dispose();
            }
            
            // Budget remaining after W allocation
            const remainingBudget = M - Pw * wSlice;
            if (remainingBudget <= 0) return;
            
            const xInt = Math.min(remainingBudget / Px, 40);
            const yInt = Math.min(remainingBudget / Py, 40);
            const zInt = Math.min(remainingBudget / Pz, 40);
            
            const geometry = new THREE.BufferGeometry();
            const vertices = new Float32Array([
                xInt, 0, 0,
                0, yInt, 0,
                0, 0, zInt
            ]);
            geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            geometry.computeVertexNormals();
            
            const color = getWColor(wSlice, 40);
            const material = new THREE.MeshBasicMaterial({
                color: color,
                transparent: true,
                opacity: 0.4,
                side: THREE.DoubleSide,
                depthWrite: false
            });
            
            budgetMesh = new THREE.Mesh(geometry, material);
            scene.add(budgetMesh);
            
            // Edges
            const edgeGeom = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(xInt, 0, 0),
                new THREE.Vector3(0, yInt, 0),
                new THREE.Vector3(0, 0, zInt),
                new THREE.Vector3(xInt, 0, 0)
            ]);
            const edgeMat = new THREE.LineBasicMaterial({ color: color });
            budgetMesh.add(new THREE.Line(edgeGeom, edgeMat));
        }
        
        function createIndifferenceSlice(utility, alpha, beta, gamma, wSlice, affordable) {
            if (indifferenceMesh) {
                scene.remove(indifferenceMesh);
                indifferenceMesh.geometry.dispose();
                indifferenceMesh.material.dispose();
            }
            
            if (utility <= 0) return;
            
            const delta = 1 - alpha - beta - gamma;
            if (delta <= 0.01 || wSlice <= 0) return;
            
            // U = x^Œ± * y^Œ≤ * z^Œ≥ * w^Œ¥
            // At fixed W: x^Œ± * y^Œ≤ * z^Œ≥ = U / w^Œ¥
            const reducedU = utility / Math.pow(wSlice, delta);
            if (reducedU <= 0) return;
            
            // Now solve for z: z = (reducedU / (x^Œ± * y^Œ≤))^(1/Œ≥)
            const segments = 25;
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const indices = [];
            
            const maxVal = 40;
            const minVal = 0.5;
            
            for (let i = 0; i <= segments; i++) {
                for (let j = 0; j <= segments; j++) {
                    const x = minVal + (i / segments) * (maxVal - minVal);
                    const y = minVal + (j / segments) * (maxVal - minVal);
                    
                    const base = reducedU / (Math.pow(x, alpha) * Math.pow(y, beta));
                    const z = Math.pow(base, 1 / gamma);
                    
                    if (z > 0 && z <= maxVal && isFinite(z)) {
                        vertices.push(x, y, z);
                    } else {
                        vertices.push(x, y, 0);
                    }
                }
            }
            
            for (let i = 0; i < segments; i++) {
                for (let j = 0; j < segments; j++) {
                    const a = i * (segments + 1) + j;
                    const b = a + 1;
                    const c = a + (segments + 1);
                    const d = c + 1;
                    indices.push(a, b, c);
                    indices.push(b, d, c);
                }
            }
            
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.setIndex(indices);
            geometry.computeVertexNormals();
            
            const wColor = getWColor(wSlice, 40);
            const material = new THREE.MeshPhongMaterial({
                color: affordable ? wColor : 0xff4757,
                transparent: true,
                opacity: 0.35,
                side: THREE.DoubleSide,
                depthWrite: false,
                shininess: 30
            });
            
            indifferenceMesh = new THREE.Mesh(geometry, material);
            scene.add(indifferenceMesh);
        }
        
        function createPointCloud(M, Px, Py, Pz, Pw, utility, alpha, beta, gamma, affordable) {
            if (pointCloud) {
                scene.remove(pointCloud);
                pointCloud.geometry.dispose();
                pointCloud.material.dispose();
            }
            
            // Show sample points across different W values on the indifference surface
            const delta = 1 - alpha - beta - gamma;
            if (delta <= 0.01 || utility <= 0) return;
            
            const positions = [];
            const colors = [];
            
            for (let w = 2; w <= 35; w += 3) {
                const reducedU = utility / Math.pow(w, delta);
                if (reducedU <= 0) continue;
                
                // Sample some (x, y) points and compute z
                for (let i = 0; i < 8; i++) {
                    const x = 2 + Math.random() * 30;
                    const y = 2 + Math.random() * 30;
                    const base = reducedU / (Math.pow(x, alpha) * Math.pow(y, beta));
                    const z = Math.pow(base, 1 / gamma);
                    
                    if (z > 0 && z <= 40 && isFinite(z)) {
                        positions.push(x, y, z);
                        const color = getWColor(w, 40);
                        colors.push(color.r, color.g, color.b);
                    }
                }
            }
            
            if (positions.length === 0) return;
            
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({
                size: 0.8,
                vertexColors: true,
                transparent: true,
                opacity: 0.6
            });
            
            pointCloud = new THREE.Points(geometry, material);
            scene.add(pointCloud);
        }
        
        function createUserPoint(x, y, z, w, affordable, nearOptimal) {
            if (userPoint) {
                scene.remove(userPoint);
                userPoint.geometry.dispose();
                userPoint.material.dispose();
            }
            
            const geometry = new THREE.SphereGeometry(1.2, 32, 32);
            const wColor = getWColor(w, 40);
            let color = affordable ? (nearOptimal ? 0xffd93d : wColor) : new THREE.Color(0xff4757);
            
            const material = new THREE.MeshPhongMaterial({
                color: color,
                emissive: color,
                emissiveIntensity: 0.4
            });
            
            userPoint = new THREE.Mesh(geometry, material);
            userPoint.position.set(x, y, z);
            scene.add(userPoint);
            
            // Glow
            const glowGeom = new THREE.SphereGeometry(2, 32, 32);
            const glowMat = new THREE.MeshBasicMaterial({
                color: color,
                transparent: true,
                opacity: 0.25
            });
            userPoint.add(new THREE.Mesh(glowGeom, glowMat));
            
            // W indicator ring
            const ringGeom = new THREE.TorusGeometry(1.8, 0.1, 8, 32);
            const ringMat = new THREE.MeshBasicMaterial({ color: wColor });
            const ring = new THREE.Mesh(ringGeom, ringMat);
            ring.rotation.x = Math.PI / 2;
            userPoint.add(ring);
        }
        
        function createOptimalPoint(x, y, z, w) {
            if (optimalPoint) {
                scene.remove(optimalPoint);
                optimalPoint.geometry.dispose();
                optimalPoint.material.dispose();
            }
            
            if (!showOptimal) return;
            
            const geometry = new THREE.SphereGeometry(1, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: 0xffd93d,
                emissive: 0xffd93d,
                emissiveIntensity: 0.6
            });
            
            optimalPoint = new THREE.Mesh(geometry, material);
            optimalPoint.position.set(x, y, z);
            scene.add(optimalPoint);
            
            // Rings
            const ringGeom = new THREE.TorusGeometry(2, 0.12, 16, 32);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0xffd93d });
            const ring1 = new THREE.Mesh(ringGeom, ringMat);
            ring1.rotation.x = Math.PI / 2;
            optimalPoint.add(ring1);
            
            const ring2 = new THREE.Mesh(ringGeom, ringMat);
            ring2.rotation.y = Math.PI / 2;
            optimalPoint.add(ring2);
        }
        
        function updateVisualization() {
            const M = parseFloat(incomeSlider.value);
            const Px = parseFloat(pxSlider.value);
            const Py = parseFloat(pySlider.value);
            const Pz = parseFloat(pzSlider.value);
            const Pw = parseFloat(pwSlider.value);
            const alpha = parseFloat(alphaSlider.value);
            const beta = parseFloat(betaSlider.value);
            const gamma = parseFloat(gammaSlider.value);
            const delta = Math.max(0, 1 - alpha - beta - gamma);
            
            const userX = parseFloat(userXSlider.value);
            const userY = parseFloat(userYSlider.value);
            const userZ = parseFloat(userZSlider.value);
            const userW = parseFloat(userWSlider.value);
            const wSlice = parseFloat(wSliceSlider.value);
            
            // Update displays
            document.getElementById('income-value').textContent = M;
            document.getElementById('px-value').textContent = Px;
            document.getElementById('py-value').textContent = Py;
            document.getElementById('pz-value').textContent = Pz;
            document.getElementById('pw-value').textContent = Pw;
            document.getElementById('alpha-value').textContent = alpha.toFixed(2);
            document.getElementById('beta-value').textContent = beta.toFixed(2);
            document.getElementById('gamma-value').textContent = gamma.toFixed(2);
            document.getElementById('delta-value').textContent = delta.toFixed(2);
            document.getElementById('user-x-value').textContent = userX.toFixed(1);
            document.getElementById('user-y-value').textContent = userY.toFixed(1);
            document.getElementById('user-z-value').textContent = userZ.toFixed(1);
            document.getElementById('user-w-value').textContent = userW.toFixed(1);
            document.getElementById('w-slice-value').textContent = wSlice;
            document.getElementById('w-slice-display').textContent = wSlice;
            
            const { xStar, yStar, zStar, wStar, utility: optimalUtility } = calculateOptimal(M, Px, Py, Pz, Pw, alpha, beta, gamma);
            const userUtility = calculateUtility(userX, userY, userZ, userW, alpha, beta, gamma);
            const spending = Px * userX + Py * userY + Pz * userZ + Pw * userW;
            const affordable = spending <= M * 1.001;
            const nearOptimal = affordable && optimalUtility > 0 && Math.abs(userUtility - optimalUtility) / optimalUtility < 0.04;
            
            // Budget bar
            const budgetPct = Math.min((spending / M) * 100, 150);
            document.getElementById('budget-fill').style.width = `${Math.min(budgetPct, 100)}%`;
            document.getElementById('budget-fill').className = 'budget-fill' + (!affordable ? ' over' : '');
            document.getElementById('budget-status').innerHTML = affordable
                ? `$${spending.toFixed(0)} / $${M}`
                : `<span class="over">$${spending.toFixed(0)} / $${M}</span>`;
            
            // Scores
            document.getElementById('score-value').textContent = affordable ? userUtility.toFixed(1) : '‚Äî';
            document.getElementById('optimal-utility').textContent = optimalUtility.toFixed(1);
            
            const proximity = affordable && optimalUtility > 0 ? Math.min(100, (userUtility / optimalUtility) * 100) : 0;
            document.getElementById('proximity-pct').textContent = `${proximity.toFixed(0)}%`;
            document.getElementById('proximity-fill').style.width = `${proximity}%`;
            
            // Big utility
            const bigUtility = document.getElementById('big-utility');
            bigUtility.textContent = affordable ? userUtility.toFixed(1) : '‚Äî';
            bigUtility.className = 'utility-value' + (!affordable ? ' infeasible' : (nearOptimal ? ' optimal' : ''));
            
            // Banners
            const errorBanner = document.getElementById('error-banner');
            const successBanner = document.getElementById('success-banner');
            
            if (!affordable && wasAffordable) {
                errorBanner.classList.remove('visible');
                void errorBanner.offsetWidth;
                errorBanner.classList.add('visible');
            } else if (!affordable) {
                errorBanner.classList.add('visible');
            } else {
                errorBanner.classList.remove('visible');
            }
            wasAffordable = affordable;
            
            successBanner.className = 'success-banner' + (nearOptimal ? ' visible' : '');
            
            // 3D viz
            createBudgetSlice(M, Px, Py, Pz, Pw, wSlice);
            createIndifferenceSlice(userUtility, alpha, beta, gamma, wSlice, affordable);
            createPointCloud(M, Px, Py, Pz, Pw, userUtility, alpha, beta, gamma, affordable);
            createUserPoint(userX, userY, userZ, userW, affordable, nearOptimal);
            createOptimalPoint(xStar, yStar, zStar, wStar);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        
        function resetGame() {
            incomeSlider.value = 80 + Math.random() * 80;
            pxSlider.value = 1 + Math.random() * 4;
            pySlider.value = 1 + Math.random() * 4;
            pzSlider.value = 1 + Math.random() * 4;
            pwSlider.value = 1 + Math.random() * 4;
            
            const a = 0.15 + Math.random() * 0.2;
            const b = 0.15 + Math.random() * 0.2;
            const g = 0.15 + Math.random() * 0.2;
            alphaSlider.value = a;
            betaSlider.value = b;
            gammaSlider.value = g;
            
            userXSlider.value = 5 + Math.random() * 12;
            userYSlider.value = 5 + Math.random() * 12;
            userZSlider.value = 5 + Math.random() * 12;
            userWSlider.value = 5 + Math.random() * 12;
            wSliceSlider.value = Math.round(5 + Math.random() * 15);
            
            showOptimal = false;
            updateVisualization();
        }
        
        function toggleHint() {
            showOptimal = !showOptimal;
            updateVisualization();
        }
        
        // Events
        [userXSlider, userYSlider, userZSlider, userWSlider, wSliceSlider].forEach(s => {
            s.addEventListener('input', updateVisualization);
        });
        
        [incomeSlider, pxSlider, pySlider, pzSlider, pwSlider, alphaSlider, betaSlider, gammaSlider].forEach(s => {
            s.addEventListener('input', () => {
                showOptimal = false;
                updateVisualization();
            });
        });
        
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
        
        init();
    </script>
</body>
</html>
